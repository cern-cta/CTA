stages:
  - prepare
  - analysis
  - build
  - build:image
  - build:tagged
  - test
  - release:changelog
  - release:internal
  - release:external

variables:
  CTA_PIPELINE_NAME: "Default Pipeline"
  CTA_VERSION: 5
  SCHED_TYPE: "objectstore"
  ORACLE_SUPPORT: "ON"
  UNIT_TEST: "ON"
  SYSTEMTESTS_ONLY: "FALSE"
  BUILD_GENERATOR: "Unix Makefiles"
  BUILD_CACHE_POLICY: pull-push # Change to e.g. push to not use the cache at all
  CTA_BUILD_ID: ${CI_PIPELINE_ID}git${CI_COMMIT_SHORT_SHA}
  # Images
  EL9_IMAGE: gitlab-registry.cern.ch/linuxsupport/alma9-base
  PYTHON3_IMAGE: python:3-alpine
  DOCKER_IMAGE_BUILDER_IMAGE: gitlab-registry.cern.ch/ci-tools/docker-image-builder
  CPPCHECK_IMAGE: neszt/cppcheck-docker:2.14.2
  GITLAB_RELEASE_CLI_IMAGE: registry.gitlab.com/gitlab-org/release-cli:latest

default:
  interruptible: true

workflow:
  name: $CTA_PIPELINE_NAME
  auto_cancel:
    on_job_failure: all
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      auto_cancel:
        on_job_failure: none
    - if: $CI_PIPELINE_SOURCE != "merge_request_event"
      variables:
          CTA_PIPELINE_NAME: "$CI_COMMIT_MESSAGE -- Scheduler: $SCHED_TYPE, Oracle support: $ORACLE_SUPPORT"

include:
  - local: .gitlab/ci/*.gitlab-ci.yml
