stages:
  - build:srpm
  - build:rpm
  - analysis:check
  - analysis:report
  - build:dockerimage
  - test
  - regressions
  - shouldfail
  - publish_rpm
  - release_rpm

variables:
  XROOTD_VERSION: 4
  SCHED_TYPE: "objectstore"
  ORACLE_SUPPORT: "ON"
  CTA_VERSION: "${XROOTD_VERSION}"
  CMAKE_OPTIONS: ""

.prepare-xrootd5: &prepare-xrootd5
  - if [[ ${XROOTD_VERSION} -eq 5 ]];
    then echo "Using XRootD version 5";
      ./continuousintegration/docker/ctafrontend/cc7/opt/run/bin/cta-versionlock --file ./continuousintegration/docker/ctafrontend/cc7/etc/yum/pluginconf.d/versionlock.list config xrootd5;
      yum-config-manager --enable cta-ci-xrootd5;
    else echo "Using XRootD version 4";
    fi

.prepare-scheduler-type: &prepare-scheduler-type
  - if [[ ${SCHED_TYPE} != "objectstore" ]]; then
      echo "Using specified scheduler database type $SCHED_TYPE";
      sched_opt="-DCTA_USE_$(echo ${SCHED_TYPE} | tr '[:lower:]' '[:upper:]'):Bool=true";
      sched_version=$(echo ${SCHED_TYPE} | cut -c 1-3);
      CTA_VERSION="${CTA_VERSION}${sched_version}";
      CMAKE_OPTIONS="-DSKIP_UNIT_TESTS:STRING=1 ${sched_opt}";
    fi

.prepare-no-oracle: &prepare-no-oracle
  - if [[ ${ORACLE_SUPPORT} != "ON" ]]; then
      echo "Disabling Oracle Support";
      CMAKE_OPTIONS="-DDISABLE_ORACLE_SUPPORT:BOOL=ON";
    fi

default:
  interruptible: true
  before_script:
    - export CTA_BUILD_ID=${CI_PIPELINE_ID}git${CI_COMMIT_SHA:0:8}
    - echo "Exporting CTA_BUILD_ID=${CTA_BUILD_ID}"
    - cp -f continuousintegration/docker/ctafrontend/cc7/etc/yum.repos.d/*.repo /etc/yum.repos.d/
    - test -n "${CI_COMMIT_TAG}" && export TAG_VERSION=$(echo ${CI_COMMIT_TAG} | sed -e 's/^v//;s/-.*$//')
    - test -n "${CI_COMMIT_TAG}" && export TAG_RELEASE=$(echo ${CI_COMMIT_TAG} | sed -e 's/^[^-]*-//')
    - major_version=$(echo ${TAG_VERSION} | cut -d. -f1)
    - if [[ ${major_version} == 5 ]]; then
        echo "Setting to compile with XRootD version 5";
        XROOTD_VERSION=5;
      fi
    - *prepare-xrootd5
    - *prepare-scheduler-type
    - *prepare-no-oracle

include:
  - local: .gitlab/ci/*.gitlab-ci.yml
