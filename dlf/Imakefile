COMM
COMM  Copyright (C) 2003 by CERN/IT/ADC
COMM  All rights reserved
COMM
COMM     @(#)$RCSfile: Imakefile,v $ $Revision: 1.1 $ $Date: 2004/12/21 22:38:39 $ CERN IT-ADC Vitaly Motyakov
COMM    Make dlf programs.

#include <Project.tmpl>

INCLUDES = FileName(..,h)
#if _AIX
LIBS = -L../shlib -lshift
#else
#if defined(__alpha) && defined(__osf__)
LIBS = -no_so -L../shlib -lshift -so_archive
#else
#if hpux
LIBS = -L../shlib -lshift
#else
#if linux
LIBS = -L../shlib -lshift $(ADNSLIB) -lnsl
#else
#if sgi
LIBS = -L../shlib -lshift
#else
#if SOLARIS
LIBS = -L../shlib -lshift -lsocket -lnsl
#else
#if _WIN32
LIBS = ..\lib\shift.lib wsock32.lib advapi32.lib
#endif
#endif
#endif
#endif
#endif
#endif
#endif
#if _WIN32
DLFLIB = dlf.lib
#else
DLFLIB = -L. -ldlf
#endif
OPSGRP = OperatorGid
SPOOL = DlfSpool
LOGFILE = FileName($(SPOOL),log)
#if Accounting
SACCTDIR = SacctDir
SACCTFILE = FileName(SacctDir,sacct)
ACCTFILE = -DACCTFILE=\"$(SACCTFILE)\"
#endif
DLFCONFIG = DlfConfigFile
DLF_HOST = DlfHost
#if UseOracle
DBOBJS = dlf_oracle_ifce.Osuf
ORAFLG = -DUSE_ORACLE
#if defined(_WIN32)
ORAINC = -I$(ORACLE_HOME)\PRO80\C\INCLUDE
LIBORA = $(ORACLE_HOME)\PRO80\LIB\MSVC\SQLLIB80.LIB
WNT_SYS_INCLUDE = "INCLUDE=$(MSDEVDIR)\..\Vc\Include"
#else
ORAINC = -I$(ORACLE_HOME)/precomp/public
#endif
#else
#if UseMySQL
DBOBJS = dlf_mysql_ifce.Osuf
MYSFLG = -DUSE_MYSQL
MYSINC = -I/usr/include/mysql
MYSLIB = /usr/lib/mysql/libmysqlclient.a
LIBMYS = -L/usr/lib/mysql -lmysqlclient -lz
#else
#if UseRaima
DBOBJS = dlf_raima_ifce.Osuf
#if _WIN32
RDSFLG = -DUSE_RAIMA -DWIN32_NT
#else
RDSFLG = -DUSE_RAIMA -DUNIX
#endif
RDSHOME = RaimaDir
RDSINC = -I$(RDSHOME)/include
RDSLIB = $(RDSHOME)/lib/libCadm.so $(RDSHOME)/lib/libCrdm.so \
	 $(RDSHOME)/lib/libCncp.so $(RDSHOME)/lib/libCrpc.so \
	 $(RDSHOME)/lib/libCrm.so $(RDSHOME)/lib/libCenc.so
LIBRDS = -L$(RDSHOME)/lib -lCadm -lCrdm -lCncp -lCrpc -lCrm -lCenc
#else
CDBANA = FileName(FileName(..,db),ProgramTargetName(Cdbana))
DBOBJS = Dlf_db.Osuf dlf_Cdb_ifce.Osuf
#endif
#endif
#endif
 
COMM######################### FLAGS ##############################
 
DFLAGS = -DBIN=\"$(BIN)\" -DDLF_HOST=\"$(DLF_HOST)\" \
         -DLOGFILE=\"$(LOGFILE)\" \
         -DDLFCONFIG=\"$(DLFCONFIG)\" \
         $(ACCTFLAG) $(ACCTFILE) $(RDSFLG) $(ORAFLG) $(MYSFLG)
 
CFLAGS =        -I$(INCLUDES) $(MTCCFLAGS) $(DFLAGS) $(RDSINC) $(ORAINC) $(MYSINC)
 
COMM######################### DEPENDENCY LIBRARIES ###############
 
DEPLIB = DepSharedLibraryTargetName(shlib,shift)
 
COMM######################### RULES ##############################

MANPAGES = $(MANDIR)/dlfserver.$(MANSUFFIX) \
	   $(MANDIR)/dlf.$(MANSUFFIX) \
	   $(MANDIR)/dlfshutdown.$(MANSUFFIX) \
	   $(MANDIR)/dlfenterfacility.$(MANSUFFIX) \
	   $(MANDIR)/dlfdeletefacility.$(MANSUFFIX) \
	   $(MANDIR)/dlfmodifyfacility.$(MANSUFFIX) \
	   $(MANDIR)/dlflistfacility.$(MANSUFFIX) \
	   $(MANDIR)/dlfentertext.$(MANSUFFIX) \
	   $(MANDIR)/dlfdeletetext.$(MANSUFFIX) \
	   $(MANDIR)/dlfmodifytext.$(MANSUFFIX) \
	   $(MANDIR)/dlflisttext.$(MANSUFFIX) \
	   $(MANDIR)/dlflogstore.$(MANSUFFIX) \
	   $(MANDIR)/dlf_init.$(MANSUFFIX) \
	   $(MANDIR)/dlf_seterrbuf.$(MANSUFFIX) \
	   $(MANDIR)/dlf_write.$(MANSUFFIX)

EXPORTMANPAGES = $(EXPORTMAN)/man1/dlfserver.$(MANSUFFIX) \
	   $(EXPORTMAN)/man1/dlf.$(MANSUFFIX) \
	   $(EXPORTMAN)/man1/dlfshutdown.$(MANSUFFIX) \
	   $(EXPORTMAN)/man1/dlfenterfacility.$(MANSUFFIX) \
	   $(EXPORTMAN)/man1/dlfdeletefacility.$(MANSUFFIX) \
	   $(EXPORTMAN)/man1/dlfmodifyfacility.$(MANSUFFIX) \
	   $(EXPORTMAN)/man1/dlflistfacility.$(MANSUFFIX) \
	   $(EXPORTMAN)/man1/dlfentertext.$(MANSUFFIX) \
	   $(EXPORTMAN)/man1/dlfdeletetext.$(MANSUFFIX) \
	   $(EXPORTMAN)/man1/dlfmodifytext.$(MANSUFFIX) \
	   $(EXPORTMAN)/man1/dlflisttext.$(MANSUFFIX) \
	   $(EXPORTMAN)/man1/dlflogstore.$(MANSUFFIX) \
	   $(EXPORTMAN)/man3/dlf_init.$(MANSUFFIX) \
	   $(EXPORTMAN)/man3/dlf_seterrbuf.$(MANSUFFIX) \
	   $(EXPORTMAN)/man3/dlf_write.$(MANSUFFIX)

#if BuildDlfLibrary
DLFLIBTARGET=LibraryTargetName(dlf)
#endif

#if BuildDlfClient
CLIENT = ProgramTargetName(dlfshutdown) \
	 ProgramTargetName(dlfenterfacility) \
	 ProgramTargetName(dlfdeletefacility) \
	 ProgramTargetName(dlfmodifyfacility) \
	 ProgramTargetName(dlflistfacility) \
	 ProgramTargetName(dlfentertext) \
	 ProgramTargetName(dlfdeletetext) \
	 ProgramTargetName(dlfmodifytext) \
	 ProgramTargetName(dlflisttext) \
	 ProgramTargetName(dlflogstore)

IPROGS_C = FileName($(BIN),ProgramTargetName(dlfshutdown)) \
	   FileName($(BIN),ProgramTargetName(dlfenterfacility)) \
	   FileName($(BIN),ProgramTargetName(dlfdeletefacility)) \
	   FileName($(BIN),ProgramTargetName(dlfmodifyfacility)) \
	   FileName($(BIN),ProgramTargetName(dlflistfacility)) \
	   FileName($(BIN),ProgramTargetName(dlfentertext)) \
	   FileName($(BIN),ProgramTargetName(dlfdeletetext)) \
	   FileName($(BIN),ProgramTargetName(dlfmodifytext)) \
	   FileName($(BIN),ProgramTargetName(dlflisttext)) \
	   FileName($(BIN),ProgramTargetName(dlflogstore))
EPROGS_C = $(EXPORTBIN)/dlfshutdown \
	   $(EXPORTBIN)/dlfenterfacility \
	   $(EXPORTBIN)/dlfdeletefacility \
	   $(EXPORTBIN)/dlfmodifyfacility \
	   $(EXPORTBIN)/dlflistfacility \
	   $(EXPORTBIN)/dlfentertext \
	   $(EXPORTBIN)/dlfdeletetext \
	   $(EXPORTBIN)/dlfmodifytext \
	   $(EXPORTBIN)/dlflisttext \
	   $(EXPORTBIN)/dlflogstore
#endif
#if BuildDlfDaemon
PROGS_D = ProgramTargetName(dlfserver)
IPROGS_D = FileName($(BIN),ProgramTargetName(dlfserver))
EPROGS_D = $(EXPORTBIN)/dlfserver
#endif

DLFSERVER_OBJS	=	dlfserver.Osuf \
			dlf_procreq.Osuf \
			sendrep.Osuf \
			dlflogit.Osuf \
			$(DBOBJS)
DLFLIB_OBJS	=	send2dlf.Osuf \
			dlf_api.Osuf \
			dlf_apiinit.Osuf \
			dlf_lib.Osuf \
			dlf_errmsg.Osuf

all: $(DLFLIBTARGET) $(CLIENT) $(PROGS_D)

#undef YES
dlf_oracle_ifce.c: dlf_oracle_ifce.pc
	proc INAME=dlf_oracle_ifce INCLUDE=$(INCLUDES) THREADS=YES CHAR_MAP=STRING PARSE=FULL $(WNT_SYS_INCLUDE)
#define YES 1

dlf_db.c dlf_db.h: $(CDBANA) dlf_db.des FileName($(INCLUDES),Castor_limits.h)
	$(CDBANA) -c dlf_db.c -h dlf_db.h dlf_db.des

#if UseOracle && !defined(_WIN32)
dlfserver: $(DLFSERVER_OBJS) $(DEPLIB)
	$(MAKE) -f oralink.mk dlfserver DLFSERVER_OBJS="$(DLFSERVER_OBJS)" CLDFLAGS=$(MTLDFLAGS) LIBS="$(DLFLIB) $(LIBS) $(MTLDLIBS)"
#else
NormalProgramTarget(dlfserver,$(DLFSERVER_OBJS), $(DEPLIB), $(DLFLIB) $(MTLDFLAGS) $(LIBS) $(MTLDLIBS) $(LIBORA) $(LIBRDS) $(LIBMYS))
#endif
NormalProgramTarget(dlfshutdown,dlfshutdown.Osuf,LibraryTargetName(dlf) $(DEPLIB),$(DLFLIB) $(LIBS))

NormalProgramTarget(dlfenterfacility,dlfenterfacility.Osuf,LibraryTargetName(dlf) $(DEPLIB),$(DLFLIB) $(LIBS))

NormalProgramTarget(dlfdeletefacility,dlfdeletefacility.Osuf,LibraryTargetName(dlf) $(DEPLIB),$(DLFLIB) $(LIBS))

NormalProgramTarget(dlfmodifyfacility,dlfmodifyfacility.Osuf,LibraryTargetName(dlf) $(DEPLIB),$(DLFLIB) $(LIBS))

NormalProgramTarget(dlflistfacility,dlflistfacility.Osuf,LibraryTargetName(dlf) $(DEPLIB),$(DLFLIB) $(LIBS))

NormalProgramTarget(dlfentertext,dlfentertext.Osuf,LibraryTargetName(dlf) $(DEPLIB),$(DLFLIB) $(LIBS))

NormalProgramTarget(dlfdeletetext,dlfdeletetext.Osuf,LibraryTargetName(dlf) $(DEPLIB),$(DLFLIB) $(LIBS))

NormalProgramTarget(dlfmodifytext,dlfmodifytext.Osuf,LibraryTargetName(dlf) $(DEPLIB),$(DLFLIB) $(LIBS))

NormalProgramTarget(dlflisttext,dlflisttext.Osuf,LibraryTargetName(dlf) $(DEPLIB),$(DLFLIB) $(LIBS))

NormalProgramTarget(dlflogstore,dlflogstore.Osuf,LibraryTargetName(dlf) $(DEPLIB),$(DLFLIB) $(LIBS))

NormalLibraryTarget(dlf,$(DLFLIB_OBJS))

MakeDepSharedLibrary(shlib,shift)

#if UseOracle == NO && UseRaima == NO && UseMySQL == NO
#if defined(_WIN32)
$(CDBANA): FORCE
	pushd ..\db & $(MAKE) Cdbana.exe & popd
#else
$(CDBANA): FORCE
	cd ../db ; $(MAKE) Cdbana
#endif
#endif

#if BuildDlfDaemon
install: $(BIN) $(IPROGS_C) $(IPROGS_D) $(SPOOL) $(SACCTDIR)
#else
install: $(BIN) $(IPROGS_C)
#endif

InstallProgram(dlfserver,$(BIN),root,bin,750)
IEXPORT(dlfserver,$(EXPORTBIN),750);

InstallProgram(dlfshutdown,$(BIN),root,bin,755)
IEXPORT(dlfshutdown,$(EXPORTBIN),755);

InstallProgram(dlfenterfacility,$(BIN),root,bin,755)
IEXPORT(dlfenterfacility,$(EXPORTBIN),755);

InstallProgram(dlfdeletefacility,$(BIN),root,bin,755)
IEXPORT(dlfdeletefacility,$(EXPORTBIN),755);

InstallProgram(dlfmodifyfacility,$(BIN),root,bin,755)
IEXPORT(dlfmodifyfacility,$(EXPORTBIN),755);

InstallProgram(dlflistfacility,$(BIN),root,bin,755)
IEXPORT(dlflistfacility,$(EXPORTBIN),755);

InstallProgram(dlfentertext,$(BIN),root,bin,755)
IEXPORT(dlfentertext,$(EXPORTBIN),755);

InstallProgram(dlfdeletetext,$(BIN),root,bin,755)
IEXPORT(dlfdeletetext,$(EXPORTBIN),755);

InstallProgram(dlfmodifytext,$(BIN),root,bin,755)
IEXPORT(dlfmodifytext,$(EXPORTBIN),755);

InstallProgram(dlflisttext,$(BIN),root,bin,755)
IEXPORT(dlflisttext,$(EXPORTBIN),755);

InstallProgram(dlflogstore,$(BIN),root,bin,755)
IEXPORT(dlflogstore,$(EXPORTBIN),755);

MakeDir($(BIN),root,bin,0755)
MakeDir($(SPOOL),root,bin,0755)
 
#if Accounting
MakeDir($(SACCTDIR),root,bin,0777)
#endif

install.man: $(MANDIR) $(MANPAGES)

MakeDir($(MANDIR),root,bin,0755)

IMANPAGE(dlf,$(MANDIR),$(MANSUFFIX))
IMANPAGE(dlfserver,$(MANDIR),$(MANSUFFIX))
IMANPAGE(dlfshutdown,$(MANDIR),$(MANSUFFIX))
IMANPAGE(dlfenterfacility,$(MANDIR),$(MANSUFFIX))
IMANPAGE(dlfdeletefacility,$(MANDIR),$(MANSUFFIX))
IMANPAGE(dlfmodifyfacility,$(MANDIR),$(MANSUFFIX))
IMANPAGE(dlflistfacility,$(MANDIR),$(MANSUFFIX))
IMANPAGE(dlfentertext,$(MANDIR),$(MANSUFFIX))
IMANPAGE(dlfdeletetext,$(MANDIR),$(MANSUFFIX))
IMANPAGE(dlfmodifytext,$(MANDIR),$(MANSUFFIX))
IMANPAGE(dlflisttext,$(MANDIR),$(MANSUFFIX))
IMANPAGE(dlflogstore,$(MANDIR),$(MANSUFFIX))
IMANPAGE(dlf_init,$(MANDIR),$(MANSUFFIX))
IMANPAGE(dlf_write,$(MANDIR),$(MANSUFFIX))
IMANPAGE(dlf_seterrbuf,$(MANDIR),$(MANSUFFIX))

EMANPAGE(dlf,$(EXPORTMAN)/man1,$(MANSUFFIX))
EMANPAGE(dlfserver,$(EXPORTMAN)/man1,$(MANSUFFIX))
EMANPAGE(dlfshutdown,$(EXPORTMAN)/man1,$(MANSUFFIX))
EMANPAGE(dlfenterfacility,$(EXPORTMAN)/man1,$(MANSUFFIX))
EMANPAGE(dlfdeletefacility,$(EXPORTMAN)/man1,$(MANSUFFIX))
EMANPAGE(dlfmodifyfacility,$(EXPORTMAN)/man1,$(MANSUFFIX))
EMANPAGE(dlflistfacility,$(EXPORTMAN)/man1,$(MANSUFFIX))
EMANPAGE(dlfentertext,$(EXPORTMAN)/man1,$(MANSUFFIX))
EMANPAGE(dlfdeletetext,$(EXPORTMAN)/man1,$(MANSUFFIX))
EMANPAGE(dlfmodifytext,$(EXPORTMAN)/man1,$(MANSUFFIX))
EMANPAGE(dlflisttext,$(EXPORTMAN)/man1,$(MANSUFFIX))
EMANPAGE(dlflogstore,$(EXPORTMAN)/man1,$(MANSUFFIX))
EMANPAGE(dlf_init,$(EXPORTMAN)/man3,$(MANSUFFIX))
EMANPAGE(dlf_write,$(EXPORTMAN)/man3,$(MANSUFFIX))
EMANPAGE(dlf_seterrbuf,$(EXPORTMAN)/man3,$(MANSUFFIX))

export: $(EPROGS_C) $(EPROGS_D)

exportman: $(EXPORTMANPAGES)

exportshr:

COMM###################### CLEANING RULES ########################
 
clean:
	-@RemoveFiles(FilesToClean)
 
clobber:        clean
	-@RemoveFiles($(CLIENT) $(PROGS_D))
 
#if _WIN32
depend:
	@echo Not supported on this platform
#else
depend:
	makedepend -Y$(INCLUDES) *.c 2> /dev/null
#endif

Makefiles:
 
FORCE:

COMM###################### DEPENDENCIES ##########################

COMM DO NOT DELETE THIS LINE -- make  depend  depends  on  it.
