<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta name="author" content="Dennis Waldron" />
<meta name="description" content="Distributed Logging Facility" />
<meta http-equiv="Content-Type" content="text/html; charset=" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Cache-Control" content="no-cache" />
<meta http-equiv="Default-Style" content="compact" />
<meta http-equiv="Content-Style-Type" content="text/css" />
<!-- $Id: index.html,v 1.13 2007/02/21 06:59:45 waldron Exp $ -->
<title>Distributed Logging Facility - Documentation</title>
<style type="text/css">

a:link       {
color: #0033CC;
font-weight: bold
}
a:hover      {
color: #3366CC;
 font-weight: bold
 }
a:active     {
color: #0033CC;
font-weight: bold
}
a:visited    {
color: #0033CC;
font-weight: bold
}
a            {
color: #0033CC;
font-weight: bold;
text-decoration:none
}

BODY {
	font-family: Arial, Helvetica, sans-serif;
	font-size: 12px;
}

TABLE.noborder {
	border-top-width: 0px;
	border-left-width: 0px;
	border-bottom-width: 0px;
	border-right-width: 0px;
}

TABLE.border {
	border: 1px solid #666666;
}

TR.header {
	font-family: Arial, Helvetica, sans-serif;
	font-size: 24px;
	font-style: italic;
	color: #FFFFFF;
	background-color: #999999;
}

TR.subheader {
	font-family: Arial, Helvetica, sans-serif;
	font-size: 18px;
	font-style: italic;
	color: #FFFFFF;
	background-color: #999999;
}
.style2 {color: #0033CC; font-weight: bold; }
</style>
</head>
<body>
<!-- header -->
<table class="noborder" cellspacing="0" cellpadding="0" width="100%">
  <tr class="header">
    <td>&nbsp;CASTOR Distributed Logging Facility - Documentation</td>
  </tr>
</table>
<!-- break 1 -->
<hr align="left" size="1" />
<ol>
  <li><a href="index.html#Introduction">Introduction</a></li>
  <li><a href="index.html#requirements">Requirements</a></li>
  <li><a href="index.html#Installation">Installation</a></li>
  <li><a href="index.html#Configuration">Configuration</a></li>
  <li><a href="index.html#FAQ">Frequently Asked Questions</a>
  <li><a href="index.html#Contacts">Contacts</a>
    <!-- header -->
  </li>
</ol>
<table class="noborder" cellspacing="0" cellpadding="0" width="100%">
  <tr class="subheader">
    <td>&nbsp;<a name="Introduction" id="Introduction"></a>1. Introduction</td>
  </tr>
  <tr>
    <td><p>&nbsp;</p>
      <p>The Distributed Logging Facility (DLF) is a facility provided by the CASTOR2 project (<a href="http://castor.web.cern.ch/castor/">http://castor.web.cern.ch/castor/</a>) and is designed for centrally logging messages and accounting information from CASTOR 2 services/facilities to a relational database backend. The framework consists of a DLF server daemon acting as a centralised collector of log messages, a client API for writing log messages and a web interface for retrieving the messages once they have been stored in the database. </p>
      <p>The DLF framework was completely re-written in 2006 to address issues of data management, scalability and recoverability within the numerous framework components. In particular, partitioning was added to the Oracle Enterprise backend version of the DLF server. With partitioning enabled, messages are partitioned by day allowing for quicker archival and retrieval times of the data and faster SQL execution. </p>
      <p>Numerous enhancements have also been made to the core DLF server to increase the message throughput performance and decrease message acknowledgement times between server and client. As a result the server now has the capability of easily handling 2,500 messages per second with an average of 5 parameters each (3.75 million rows of data every 5 minutes).</p>
      <p>The client API has also undergoing some major modifications. Most noticeable is that the API is now asynchronous meaning the client application no longer waits for the DLF server to acknowledge receipt of a message and can now continue normal functionality unhindered or unaffected by any DLF server related issues or network problems. Furthermore, all threads of a given process now communicate via one socket connection to the server as opposed to one for each thread. The underlying API will now also deal transparently and recovery from any errors which may occur during runtime such as central database interventions or the DLF server not being available. </p>
      <p>The DLF server itself is essentially a memory cache acting as a gateway between the DLF clients and a relational database. The internal cache or queue has the capacity to store by default 250,000 messages pending database insertion.</p>
      <p>Currently DLF supports the following relational database backends:</p>
      <ul>
        <li><a href="http://www.oracle.com/technology/products/database/oracle10g/index.html">Oracle Database 10g Enterprise Edition</a></li>
        <li><a href="http://www.oracle.com/technology/products/database/xe/index.html">Oracle Database 10g Express Edition</a> (Free Download available) </li>
        <li><a href="http://www.mysql.com/products/database/">MySQL 5.0</a></li>
      </ul>
      <p>Please Note: </p>
      <ul>
        <li>Partitioning functionality is only offered via the Enterprise Edition of Oracle. </li>
        <li>Any site wishing to use the Express Edition of oracle should be aware that the amount of data that can be stored is limited to 4GB, no backups are available and no support is given by Oracle. </li>
        <li>The MySQL support is intended for small sites only!!! </li>
        <li>Only the Oracle versions provide statistics on jobs and requests. </li>
      </ul>
      <p>Thanks goes to Vitaly Motyakov and Victor Kotlyar for their previous work on DLF v1. </p></td>
  </tr>
</table>
<p />
<!-- header -->
<table class="noborder" cellspacing="0" cellpadding="0" width="100%">
  <tr class="subheader">
    <td>&nbsp;<a name="Requirements" id="Requirements"></a>2. Software Requirements</td>
  </tr>
  <tr>
    <td><p>&nbsp;</p>
      <p>To install the DLF framework you will need some or all of the following components: </p>
      <ul>
        <li>Apache web server 1.3 or 2.0 or newer.</li>
        <li>PHP v4.3.2 or newer compiled with OCI (if using an oracle backend)</li>
        <li>Relational database server, one of:
          <ul>
            <li><a href="http://www.oracle.com/technology/products/database/oracle10g/index.html">Oracle Database 10g Enterprise Edition</a></li>
            <li><a href="http://www.oracle.com/technology/products/database/xe/index.html">Oracle Database 10g Express Edition</a></li>
            <li><a href="http://www.mysql.com/products/database/">MySQL 5.0</a></li>
          </ul>
        </li>
        <li>The DLF CASTOR2 software available from <a href="http://castor.web.cern.ch/castor/software.htm">http://castor.web.cern.ch/castor/software.htm</a> </li>
      </ul>
      <p>Caution:</p>
      <ul>
        <li>In PHP 5 MySQL support was removed from the default binary distribution. If you intend on using MySQL and the web interface together you will need to recompile the PHP sources to utilise the correct mysql-devel libraries for building MySQL support natively into PHP. Please refer to your PHP documentation. </li>
        <li>If using the Oracle backend please make sure that you have setup the Oracle Environment variables <strong>ORACLE_HOME</strong>, <strong>LD_LIBRARY_PATH</strong> and <strong>TNS_NAMES</strong> correctly. This can be done by modifying <strong>/etc/profile</strong> or in <strong>/etc/sysconfig/httpd</strong> and must be accessible to user <strong>apache</strong> which runs the PHP scripts. </li>
      </ul></td>
  </tr>
</table>
<p />
<!-- header -->
<table class="noborder" cellspacing="0" cellpadding="0" width="100%">
  <tr class="subheader">
    <td>&nbsp;<a name="Installation" id="Installation"></a>3. Installation</td>
  </tr>
  <tr>
    <td><p>&nbsp;</p>
      <p>The following installation notes are designed specifically for setting up the DLF framework and are not concerned with any other CASTOR2 related software components. If you wish to use a more general installation procedure for CASTOR2 software please refer to: <a href="http://castor.web.cern.ch/castor/docs.htm">http://castor.web.cern.ch/castor/docs.htm</a> (Guides and Administration -&gt; Operations)</p>
      <p>This guide assumes all DLF related packages will be installed using RPMs and that those RPM's have already been generated for the correct database version from the source RPM </p>
      <p>To install the DLF server use:</p>
      <blockquote>
        <p><strong>rpm -Uvh &lt;path_to_rpms&gt;/castor-dlf-server-2.<em>x.x-x.arch.rpm</em></strong></p>
      </blockquote>
      <p>To install the DLF web interface use:</p>
      <blockquote>
        <p><strong>rpm -Uvh &lt;path_to_rpms/castor-dlf-web-2<em>.x.x-x.arch.rpm</em></strong></p>
      </blockquote></td>
  </tr>
</table>
<p />
<!-- header -->
<table class="noborder" cellspacing="0" cellpadding="0" width="100%">
  <tr class="subheader">
    <td>&nbsp;<a name="Configuration" id="Configuration"></a>4. Configuration</td>
  </tr>
  <tr>
    <td><p>&nbsp;</p>
      <p><strong>Server and Database Schema </strong></p>
      <p>Before running the DLF server for the first time. The DLF database schema must first be created. The scripts for creating the database schema can be found in CVS in the subdirectory dlf/scripts. Different creation scripts exist for Oracle, Oracle Express (XE) and MySQL. If upgrade from a previous schema, that schema must be dropped first!! </p>
      <p class="style2">For Oracle:</p>
      <p>Prior to creating the schema two tablespaces must exist. One called DLF_DATA and another called DLF_INDX to store the table data and indexes respectively. Creation of the schema must be done as &quot;sysdba&quot; or the user must have privileges to add DBMS jobs to the database. Using your favourite sql client (e.g. sqlplus) you can then execute the creation script (dlf_oracle_create.sqlplus)</p>
      <p>For the automatic exporting of partitions to disk, a directory object must be created in oracle. The location of the directory should not be /var/ or /tmp/ and should be significantly large enough to store dlf data.</p>
      <p>CREATE DIRECTORY DLF_DATAPUMP_DIR AS '&lt;full path to directory&gt;';<br />
      GRANT READ, WRITE ON DIRECTORY DLF_DATAPUMP_DIR TO &lt;dlf_username&gt;;</p>
      <p>Please make sure to check that the file permissions of the DLF_DATAPUMP_DIR object are set correctly e.g. oracle:ci      </p>
      <p class="style2">For Oracle Express:</p>
      <p>The only prerequisite that exists before creating the DLF schema is that two tablespaces must exist. One called DLF_DATA and another called DLF_INDX to store the table data and indexes respectively.  Using your favourite sql client (e.g. sqlplus) you can then execute the creation script (dlf_oracle_create.sql) </p>
      <p class="style2">For MySQL:</p>
      <p>There are no special requirements simply run the creation script.</p>
      <p align="center"><strong>At anytime the DLF schema can be dropped using the (dlf_[oracle|mysql]_drop.sql) customised for each database backend. </strong></p>
      <p><strong>Distributed Logging Facility Server </strong></p>
      <p>Once the schema is in place the username and password for connecting to the database needs to be configured in <strong>/etc/castor/DLFCONFIG</strong>. The format of this file is:</p>
      <blockquote>
        <p align="left"><em>&lt;username&gt;/&lt;password&gt;@&lt;[database_name | server_name]&gt; </em></p>
      </blockquote>
      <p>The DLF server can the be started using the init.d script: <strong>service dlfserver start</strong>. The init.d script supports the following options:</p>
      <blockquote>
        <p align="left"><em>service dlfserver [ start | stop | status | restart | condrestart ] </em></p>
      </blockquote>
      <p align="left">Alternatively the server can be started manually using<strong> /usr/bin/dlfserver</strong> and support the following command line options:</p>
      <blockquote>
        <table width="483" border="0">
          <tr>
            <td width="85"><em>-d</em></td>
            <td width="382"><em>enable debugging mode </em></td>
          </tr>
          <tr>
            <td><em>-f</em></td>
            <td><em>keep process in the foreground, do not fork</em></td>
          </tr>
          <tr>
            <td><em>-h</em></td>
            <td><em>display this help and exit</em></td>
          </tr>
          <tr>
            <td><em>-l &lt;path&gt;</em></td>
            <td><em>path to log file</em></td>
          </tr>
          <tr>
            <td><em>-p &lt;int&gt; </em></td>
            <td><em>servers listening port</em></td>
          </tr>
          <tr>
            <td><em>-T &lt;int&gt; </em></td>
            <td><em>number of handler/transport threads</em></td>
          </tr>
          <tr>
            <td><em>-D &lt;int&gt; </em></td>
            <td><em>number of database threads</em></td>
          </tr>
        </table>
      </blockquote>
      <p align="left">Further documentation about the DLF server can be found using <strong>man dlfserver</strong> - By default the server logs its own error messages to /var/spool/dlf/log</p>
      <p><strong>Web Interface</strong></p>
      <p>All the configuration for the web interface can be found in /<strong>var/www/html/dlf/config.php</strong>. This file contains the configuration options plus usernames and passwords for connecting to the various CASTOR 2 instances that you may have setup. One interface can support multiple  instances. To add a new instance to the interface you need to modify the <strong>$db_instances</strong> variable within the config.php file. For example</p>
      <pre>$db_instances = array(
	&quot;castor1&quot; =&gt; array(
		&quot;type&quot;	   =&gt; &quot;MySQL&quot;,
		&quot;username&quot; =&gt; &quot;castor_dlf&quot;,
		&quot;password&quot; =&gt; &quot;password&quot;,
		&quot;server&quot;   =&gt; &quot;dbserver2.domain.com&quot;,
		&quot;database&quot; =&gt; &quot;dlf&quot;                   /* only required for mysql! */  ,
	),

	&quot;castor2&quot; =&gt; array(
		&quot;type&quot;	   =&gt; &quot;Oracle&quot;,
		&quot;username&quot; =&gt; &quot;castor_dlf&quot;,
		&quot;password&quot; =&gt; &quot;password&quot;,
		&quot;server&quot;   =&gt; &quot;dbserver1.domain.com&quot;,
	),
);
</pre>
      <p>Modifications to the config.php take immediate effect upon saving. </p></td>
  </tr>
</table>
<p />
<!-- header -->
<table class="noborder" cellspacing="0" cellpadding="0" width="100%">
  <tr class="subheader">
    <td>&nbsp;<a name="FAQ" id="FAQ"></a>5. Frequently Asked Questions - FAQ </td>
  </tr>
  <tr>
    <td><p>&nbsp;</p>
      <p><strong>Question: How do I add a new facility to DLF?</strong></p>
      <p><span class="style2">Answer:</span> There is no tool which allows a client to self-register itself or for a user to run a command to enter a facility into the schema. This must be done by manually using a query such as</p>
      <p>INSERT INTO dlf_facilities (fac_no, fac_name) VALUES (X, 'facility_name');</p>
      <p><strong>Question: Can I use an old client with the new server?</strong></p>
      <p><span class="style2">Answer:</span> No, the new server is not backwards compatible with older client versions. </p>
      <p><strong>Question: How do I change a message text for a given facility ? </strong></p>
      <p><span class="style2">Caution:</span> You should never change a message text number to mean something else. This will invalidate data within the database!!!!!!!!!! However, if you are simply changing the text to elaborate more on the subject matter or need to correct a spelling mistake then simply alter your text at the client level and the API will automatically update the text in the database. </p>
      <p><strong>Question: I need to perform maintenance on the database server. But I don't want to lose any messages which would normally be recorded centrally. can this be done?</strong></p>
      <p><span class="style2">Answer:</span> Yes, The DLF server is basically a memory cache in front of a database server. By default this cache has the capacity to store 250,000 messages pending insertion into the database. If your intervention is not for a long time you can change the internal status of the DLF Server by modifying the dlf_config table. The following query will terminated database insertion</p>
      <p>UPDATE dlf_config SET enabled = 1 WHERE name = 'suspend_db';</p>
      <p>Please note however, that  the memory consumption of the DLF server process can increase very rapidly under this state as all messages will be cached in memory until the cache is full. It can also take anything up to 1 minute for the status to be propageted to the DLF server. A message will appear in the log file indicating the state change. </p>
      <p>It is also possible to take down the DLF server for very short periods of time as clients also have an internal queue which can store 5,000 messages awaiting transmission to the server.</p>
      <p><strong>Question: How do I know if my server is performing well?</strong></p>
      <p><span class="style2">Answer:</span> In the new version of DLF a dlf_monitoring table exists which details performance related statistics about the server every 5 minutes. You can examine the data in here to see for example how many inserts, commits, connection for clients and messages the server processing.</p>
      <p><strong>Question: The dlf_monitoring statistics table shows me that the S_QUEUE value is very high, should I be concerned?</strong></p>
      <p><span class="style2">Answer:</span> It depends, If the value is static there is very little cause for concern. If the number if growing steadily or rapidly this is a clear indication that the DLF server is not capable of handling the number of incoming messages  that it is buffering. If your are using the MySQL backend it is suggested that if this problem persists to move to Oracle. The reason being that the MySQL version inserts row into the database one by one which is extremely costly whereas the Oracle version uses bulk insertion of many thousands of rows in one go. The performance gained from the Oracle version far exceeds MySQL. </p>
      <p><strong>Question: Why are the dlf_reqstats and dlf_jobstats entries always slightly delayed in comparison to entries in dlf_monitoring? </strong></p>
      <p><span class="style2">Answer:</span> This delay or offset is deliberate. The entries in these two tables are generated by SQL statements called from within the DLF server itself and utilise data from multiple sources (facilities). As data entered into the database is not guaranteed to be entered in the sequence in which it arrives at the server, the server offsets the stats by 10 minutes. This effectively gives data 10 minutes to make it into the database before being  processed for statistics.</p>
      <p><strong>Question: My server is running and so are my clients, but nothing appears to be recorded in the database. What should I do? </strong></p>
      <p><span class="style2">Answer:</span></p>
      <ol>
        <li> Check that your client is configured to report to the correct server. If you are using environment variables make sure they are in UPPERCASE.</li>
        <li> Confirm that the facility name of the client is registered with the dlfserver. If the server doesn't not recognise the facility name the API will not complete initialisation with the server and therefore not attempt to send any data to it. (Facility names are cAsE sEnSiTiVe)</li>
        <li> Check your &lt;FACILITY_NAME&gt;_LOGERROR output. Look for DLF facility messages which may indicate the reason why data is not being sent.</li>
        <li> Take a look at the dlf_monitoring statistics table of the server. Maybe the server is full or database insertion has been suspended. </li>
      </ol>
      <p><strong>Question: I've initialised my interface and forked my process to daemonise, but messages are no longer sent to the central server? </strong></p>
      <p><span class="style2">Answer:</span> The DLF library uses threads and shared memory structures protected by mutexes to connect to DLF servers. When a call to fork(2) is done after a call to dlf_init(3) those mutexes may not be in a valid state any longer causing the whole api to block. Also fork(2) only duplicates the memory area of its main calling thread and no other additional threads such as the DLF server transport threads. Therefore, the child process is configured but the threads are no longer present after a fork. The solution is to use the calls dlf_prepare(), dlf_child() and dlf_parent() during the forking phase. </p>
      <p><strong>Question:</strong> My DLF server has lost its connection to its database and has not detected this, can it be recovered?</p>
      <p><span class="style2">Answer:</span> DLF tries as best as possible to detect when a database connection has been dropped. Unfortunately and especially for the oracle interface sometimes strange error messages returned by oracle are not interrupted correctly and DLF does not acknowledge  a connection has been lost. To recover from this situation without restarting DLF you can send the DLF server process a SIGHUP command (kill -1 &lt;pid&gt;). This should be used as a last attempt solution to recover a dead connection!!!!  </p>
      <p><strong>Question: How do I import old data back into the DLF schema?</strong> (ORACLE ENTERPRISE EDITION ONLY) </p>
      <p><span class="style2">Answer:</span> DLF partitions its data on a daily basis and keeps 30 days online by default. After 30 days internal DLF plsql procedures  automatically export the data to the database directory object  DLF_DATAPUMP_DIR. The location of the directory to which exports are exported can  be found by executing the query 'SELECT directory_path FROM dba_directories  WHERE directory_name = 'DLF_DATAPUMP_DIR';'.</p>
      <p>Depending on your backup solution this  directory maybe empty as the files may have been migrated to an external storage system such as TSM (Tivoli Storage Manager) or into CASTOR. If this is  the case you will need to re-import the required files back on to a  file  system accessible by the DLF database. The files are named using the following  format: 'YYYYMMDD.dmp and YYYYMMDD.log'. E.g 20060920.dmp represents September 20th 2006. Each dmp file  presents 1 day of dlf logging data. Once you are happy that the files are  present or been restored from backup you must instruct dlf to create a set of partitions for the data then do an import.</p>
      <p>sqlplus&gt; BEGIN dlf_partition(YYYYMMDD); END; /</p>
      <p>impdp &lt;username&gt;/&lt;password&gt;  DIRECTORY=DLF_DATAPUMP_DIR DUMPFILE=YYYYMMDD.dmp TABLE_EXISTS_ACTION=APPEND</p>
      <p><strong>Note:</strong> Data that has been re-imported into DLF will not be archive, compressed or removed by any of the DLF plsql procedures. Once the user has finished the activity requiring this data it is the user's responsiblity to truncate the involved partitions in order to reclaim the space taken. This can be done using the sql commands below:</p>
      ALTER TABLE DLF_MESSAGES DROP PARTITION P_YYYYMMDD;<br />
      ALTER TABLE DLF_STR_PARAM_VALUES DROP PARTITION P_YYYYMMDD;<br />
      ALTER TABLE DLF_NUM_PARAM_VALUES DROP PARTITION P_YYYYMMDD;<br />
      ALTER TABLE DLF_REQID_MAP DROP PARTITION P_YYYYMMDD;</td>
  </tr>
</table>
<p />
<table class="noborder" cellspacing="0" cellpadding="0" width="100%">
  <tr class="subheader">
    <td>&nbsp;<a name="Installation" id="Installation"></a>6. Contacts </td>
  </tr>
  <tr>
    <td><p>&nbsp;</p>
      <p>Should you have any questions or comments, please write to <a href="mailto:castor.support@cern.ch">castor.support@cern.ch</a></p></td>
  </tr>
</table>
<p />
<!-- break 1 -->
<hr align="left" size="1" />
Page last modified by <a href="mailto:Dennis.Waldron@cern.ch">Dennis Waldron</a> on:
<script language="javascript" type="text/javascript">
    	document.write(document.lastModified);
	</script>
</body>
</html>
