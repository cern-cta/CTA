.\" $Id: stagewrt_hsm.man,v 1.1 2002/10/08 09:20:36 jdurand Exp $
.\"
.\" @(#)$RCSfile: stagewrt_hsm.man,v $ $Revision: 1.1 $ $Date: 2002/10/08 09:20:36 $ CERN IT-DS/HSM Jean-Damien Durand
.\" Copyright (C) 2002 by CERN/IT/DS/HSM
.\" All rights reserved
.\"
.TH STAGEWRT_HSM "3" "$Date: 2002/10/08 09:20:36 $" "CASTOR" "Stage Library Functions"
.SH NAME
stagewrt_hsm \- Asks for one or more HSM files to be migrated
.SH SYNOPSIS
.BI "#include <" stage_api.h ">"
.sp
.BI "int stagewrt_hsm(u_signed64 " flags ,
.BI "int " openflag ,
.BI "char *" hostname ,
.BI "char *" pooluser ,
.BI "int " nstcp_input ,
.BI "struct stgcat_entry *" stcp_input ,
.BI "int *" nstcp_output ,
.BI "struct stgcat_entry **" stcp_output ,
.BI "int " nstpp_input ,
.BI "struct stgpath_entry *" stpp_input ");"

.SH DESCRIPTION
The \fBstagewrt_hsm\fP API method asks the stager for one or more HSM files to be migrated on their third\-party store.
There are two ouputs: the default ttys (unless you use \fBstage_setlog\fP, see in the example below) and the output parameters, that are allocated on the fly (e.g. the user will have to free them if necessary/wanted).

.SH PARAMETERS
.TP 1.5i
.I flags
Can be zero or a bit-wise of the following values:
.RS
.TP
.I STAGE_REQID
The member reqid of all 
.I stcp_input
structures given in input must match a known record having exactly this request id. Otherwise, even it is set in the input structures, the reqid member will be ignored when processing the request.
.TP
.I STAGE_DEFERRED
For CASTOR files, entries are commited in the migration queue. The \fBstagewrt_hsm\fP call can then return immediately. This flag is recommended.
.TP
.I STAGE_SILENT
Print nothing (the log callback will never be notified neither).
.TP
.I STAGE_NORETRY
If data is to be recalled from tape, and there is a medium error, internal retries by the I/O process doing the recall will be skipped. It does not prevent stager daemon to decide to do a retry, nevertheless. This flag also prevents client to keep retrying in any case. Can be set with environment variable $STAGE_NORETRY to a non\-zero value.
.TP
.I STAGE_NOWAIT
If data is to be recalled from tape, this will be done in the background, and client will get an immediate return with ok status.
.TP
.I STAGE_NOHSMCREAT
For CASTOR files, if one of them is not yet present in the Name Server, do not try to create it, but ignore this entry. Default is to try to create the file.
.TP
.I STAGE_HSM_ENOENT_OK
For CASTOR files, if one of them is not yet present in the Name Server, and error is exactly ENOENT, ignore this entry.
.TP
.I STAGE_MIGLOG
For CASTOR files, log activity in a special log\-file used for automatic migration.
.TP
.I STAGE_VOLATILE_TPPOOL
For CASTOR files. Not yet supported. Is supposed to allow the migration process to switch between CASTOR tape pools if necessary when there is not enough space in one tape pool.
.RE
.TP
.I openflags
Not used here.
.TP
.I hostname
Gives explicitely the hostname where is the stager daemon. If it NULL, default value apply: either the environment variable $STAGE_HOST, an entry 'STG HOST' in /etc/shift.conf file, or the default "stagepublic".
.TP
.I pooluser
Not used here.
.TP
.I nstcp_input
Number of stcp_input entries.
.TP
.I stcp_input
Entries describing the files you want to be migrated. Only the member xfile of the structures is mandatory. Other members of interest are:
.RS
.TP
.I size
Gives how many bytes should be writen. Not recommended.
.TP
.I poolname
Specify explicitely a disk pool
.LP
Others members should all be setted to zero in order to avoid your request to possibly misbehave.
.RE
.TP
.I nstcp_output
Filled with the number of copied entries at return.
.TP
.I stcp_output
Filled with the address of an array containg the copied entries at return. Up to the user to free it if necessary.
.TP
.I nstpp_input
Filled with the number of stpp_input entries.
.TP
.I stpp_input
Array giving the list of link files pointing to disk files to be migrated. There are
.I nstpp_input
entries.

.SH RETURN VALUE
0 on success, -1 on failure.

.SH ERRORS
If failure, the serrno variable might contain one of the following error codes:
.TP 1.9i
.B SENOMAPFND
Can't open mapping database (Windows only)
.TP
.B EFAULT
Bad address
.TP
.B EINVAL
Invalid argument
.TP
.B ESTGROUP
Invalid group
.TP
.B SECONNDROP
Connection closed by remote end
.TP
.B SECOMERR
Communication error
.TP
.B SEINTERNAL
Internal error
.TP
.B SEUSERUNKN
User unknown
.TP
.B ESTLINKNAME
User link name processing error
.TP
.B SEOPNOTSUP
Operation not supported (should not happen)
.TP
.B ESTMEM
Request too big
.TP
.B ENOENT
No such file or directory
.TP
.B SESYSERR
System error
.TP
.B ESTCLEARED
Request cleared
.TP
.B ESTKILLED
Request killed
.TP
.B ENOSPC
No space left on device
.TP
.B EBUSY
Device or resource busy (can happen if you want to open for modification an HSM file being migrated)
.TP
.B ESTLNKNSUP
Symbolic link not supported
.TP
.B ESTNACT
Stager not active (if you specify the STAGE_NORETRY flag - default is to retry forever)
.TP
.B SENOSHOST
Host not known

.LP
It is highly recommended to use the RFIO interface, POSIX compliant, if you want to open one single file. RFIO interface will internally call the stage interface.

.SH SEE ALSO
\fBstagewrt\fP(1), \fBstage_limits\fP(3), \fBCastor_limits\fP(3), \fBstage_setlog\fP(3), \fBrc_castor2shift\fP(3), \fBstage_kill\fP(3), \fBstage_struct\fP(3), \fBstage_macros\fP(3), \fBstage_constants\fP(3)

.SH AUTHOR
\fBCASTOR\fP Team <castor.support@cern.ch>

