.\" $Id: stagestat.man,v 1.20 2003/08/28 14:20:40 jdurand Exp $
.\"
.\" @(#)$RCSfile: stagestat.man,v $ $Revision: 1.20 $ $Date: 2003/08/28 14:20:40 $ CERN IT-PDP/DM Jean-Philippe Baud Jean-Damien Durand
.\" Copyright (C) 1995-2002 by CERN/IT/DS/HSM
.\" All rights reserved
.\"
.TH STAGESTAT "1" "$Date: 2003/08/28 14:20:40 $" "CASTOR" "Stager User Commands"
.SH NAME
stagestat \- gives global statistics on stager usage and detailed statistics on
each file staged in 
.SH SYNOPSIS
.B stagestat
[
.BI \-a
] [
.BI \-d
] [
.BI \-D " diskfile"
] [
.BI \-e " end_time"
] [
.BI \-f " accounting_file"
] [
.BI \-g
] [
.BI \-H " min,max,bins"
] [
.BI \-h " hostname"
] [
.BI \-M " hsmfile"
] [
.BI \-n " nrecord_per_acctfile"
] [
.BI \-N " ntotalrecord"
] [
.BI \-p " pool_name"
] [
.BI \-r " reqid"
] [
.BI \-s " start_time"
] [
.BI \-S " sorting_criteria"
] [
.BI \-T " vid"
]
.BI \-v
] [
.BI \-w " week1[\-week2]"
] [
.BI \-z
]
.SH DESCRIPTION
.B stagestat
obtains information on the usage of a stager by reading the 
.B sacct
accounting file.  The information is given in tabular form in two 
sections.

The first section gives global statistics for the stager, which consists
of details on each stage command such as the number of requests, number 
of successful requests, warnings and errors. Also the number of mounts,
remounts, multifile requests and mounts avoided by the stager.

The second section gives file details by pool name, including
average lifetime per file and per group if garbage collected, and 
average number of accesses per file and per group.
.SH OPTIONS
.TP
.BI \-a
Considers deleted records by both administrator (considered as part of garbage collection) and user when computing average file lifetime. Default is deletion from administrator only.
.TP
.BI \-d
Turns debugging mode on.
.TP
.BI \-D " diskfile"
print records of disk type and matching
.I diskfile
.TP
.BI \-e " end_time"
The date and time up to which information should be collated.  If not
specified the default is the time of the last record in the accounting 
file.  The format for date input is
.BR mmddhhmm [ yy ].
.B yy
is the year in the century and is optional:
if yy between 00 and 37, 21th century is assumed,
if yy between 70 and 99, 20th century is assumed
else the command fails.
.TP
.BI \-f " accounting_file"
The file from which information is to be read.  If not specified the 
default is the current 
.B sacct
file. If you also use the \-w option, the week number is appended to
.I accounting_file
and then opened. For exampe
.BI \-f " /tmp/sacct"
used together with
.BI \-w " 0234"
will attempt to open
.I /tmp/sacct.0234
.TP
.BI \-g
Prints only global statistic \- For very fast analysis not interested in deep details about forked processes nor pools, but on the number of different calls accounted by the stager daemon
.TP
.BI \-H " min,max,bins"
will produce an histogram of the average lifetime, with
.I min
and
.I max
for the minimum and maximum lifetimes, using
.I bins
entries.
.TP
.BI \-h " hostname"
will analyse stage records from the accounting file belonging to 
.I hostname
stager.
.TP
.BI \-M " hsmfile"
print records of HSM type and matching
.I hsmfile
.TP
.BI \-n " nrecord_per_acctfile"
will not read more than
.I nrecord_per_acctfile
stage records per accounting file.
.TP
.BI \-N " ntotalrecord"
will not read more than
.I ntotalrecord
stage records over all accounting files.
.TP
.BI \-p " pool_name"
The name of the particular pool on which information is required.  If not 
specified information is given on all pools in the accounting file, but no 
file details are displayed
.TP
.BI \-r " reqid"
print record matching this request ID.
.TP
.BI \-S " sort_criteria"
To obtain file details this option must be used 
.br
.B a 
\- will give the file details sorted by number of accesses
.br
.B t
\- will give the file details sorted by average lifetime.  If
.B t
is specified only files staged in and cleared within the time period
will be displayed
.TP
.BI \-s " start_time"
The date and time from which to begin collating information.  If not
specified the default is the time of the first record in the accounting
file.  Format for date input is
.BR mmddhhmm [ yy ].
.B yy
is the year in the century and is optional:
if yy between 00 and 37, 21th century is assumed,
if yy between 70 and 99, 20th century is assumed
else the command fails.
.TP
.BI \-T " vid"
print records of tape type and matching
.I vid
.TP
.BI \-v
shows accounting records with problem and a progress bar
.TP
.BI \-w " week1[\-[week2]]"
will append the week number to accounting filename, except for current week when the accounting filename is left unchanged.
.I week1
and
.I week2
have the format yymm where yy are the year in current century (like 02 for year 2002), and ww is the week number.
.TP
.BI \-z
Do not admit stage records from a stager that was (supposed to be) compiled with different internal limits. Default is to silently accept them. This should be rare and depend on your setup. The correct solution is always to use a version of stagestat from the same package that produced the accounting records you want to analyse.

.SH NOTES
If, for a given
.I hostname
the accounting file is not found, this tool will try to open the archived castor file under
.I /castor/<domain>/c3/backup/sacct/<hostname>/sacct.yymm

.SH EXAMPLES
To get information on pool wacdr, stager on host wacdr, week 39 of year 2002, with an histogram view of files lifetime, type the following command:
.ft CW
.nf
.sp
\s-2
[] ~ > stagestat -h wacdr -p wacdr -w 0239 -H 170,260,30 -v     

You have requested accounting data for the stager wacdr

[INFO] Using account file "wacdr:/usr/spool/sacct/sacct.0239"
|========================================| ( 100.00 %) \
Number of read account records:      45659
Number of     accepted records:      45659
Number of     rejected records:          0
                                ...          0 (not a STAGE account record)
                                ...          0 (error)
                                ...          0 (filtered)

        wacdr Stager statistics (22/09/2002 23:56:43  -  29/09/2002 23:55:35)

Command    No Reqs API(%) Success Warning Userr Syserr Unerr Conferr Held Busy ENOSPC Cleared Killed

stagein       5994 100.00    5935       0     0      0    45       0    0   15      0       0      0
stageout      1931 100.00    1897       0     0      0    25       0    0    0      0       0      0
stagewrt       392 100.00     392       0     0      0     0       0    0    0      0       0      0
stageput         0   0.00       0       0     0      0     0       0    0    0      0       0      0
stagealloc       0   0.00       0       0     0      0     0       0    0    0      0       0      0
stageqry      5221   6.07
stageclr      1529   1.96
stagekill        0   0.00
stageupdc     9589   0.00
stageinit        7 100.00
stagecat         0   0.00
stageget         0   0.00
stagechng        0   0.00
stageshutdown    0   0.00
stageping        0   0.00
restart(s)       0

Stage Statistics :
        Number of forked I/O process                                    :        2420
        Number of tape remount requests (write mode)                    :           1
        Number of tape remount requests (read  mode)                    :           7
        Nb of read tape requests avoided by stager                      :        3515
        Number of multifile requests                                    :           1

File Request Details for Pool :      wacdr

Number of requests started before time period began                     :         697
Out of these:   Number accessed before being cleared                    :           0
                Number accessed but not cleared during time period      :         697

Number of requests started after beginning of time period               :        3700
Out of these:   Number accessed but not cleared                         :        3697
                Number accessed and then cleared                        :           3

Average number of file accesses                                         :           1.90
Average lifetime of staged and then garbaged file using creation time   :         207.34 hours
Number of files used in this calculation                                :        1331
Standard deviation of lifetime                                          :          21.20 hours



Histogram of the lifetime of files garbage collected for the pool wacdr
The number of entries for this  histogram is: 1331

The number of underflows is:   0         the number of overflows is:  0

for   170.00<lifetime<  173.00     0 
for   173.00<lifetime<  176.00     0 
for   176.00<lifetime<  179.00     0 
for   179.00<lifetime<  182.00    24    *******
for   182.00<lifetime<  185.00    70    **********************
for   185.00<lifetime<  188.00    93    ******************************
for   188.00<lifetime<  191.00   154    **************************************************
for   191.00<lifetime<  194.00   132    ******************************************
for   194.00<lifetime<  197.00   122    ***************************************
for   197.00<lifetime<  200.00    91    *****************************
for   200.00<lifetime<  203.00    51    ****************
for   203.00<lifetime<  206.00    67    *********************
for   206.00<lifetime<  209.00    68    **********************
for   209.00<lifetime<  212.00    34    ***********
for   212.00<lifetime<  215.00    37    ************
for   215.00<lifetime<  218.00    26    ********
for   218.00<lifetime<  221.00    44    **************
for   221.00<lifetime<  224.00    33    **********
for   224.00<lifetime<  227.00    22    *******
for   227.00<lifetime<  230.00    14    ****
for   230.00<lifetime<  233.00    11    ***
for   233.00<lifetime<  236.00     9    **
for   236.00<lifetime<  239.00    20    ******
for   239.00<lifetime<  242.00    18    *****
for   242.00<lifetime<  245.00    50    ****************
for   245.00<lifetime<  248.00    59    *******************
for   248.00<lifetime<  251.00    44    **************
for   251.00<lifetime<  254.00    30    *********
for   254.00<lifetime<  257.00     8    **
for   257.00<lifetime<  260.00     0 
for   260.00<lifetime<  263.00     0 
\s+2
.ft
.LP
.fi

.SH RETURN CODES
\
.br
0	Ok.
.br
1	User error.
.br
2	System error.
.br
3	Unknown error.

.SH AUTHOR
\fBCASTOR\fP Team <castor.support@cern.ch>
