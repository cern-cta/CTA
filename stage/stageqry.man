.\" $Id: stageqry.man,v 1.25 2002/10/27 23:29:13 jdurand Exp $
.\"
.\" @(#)$RCSfile: stageqry.man,v $ $Revision: 1.25 $ $Date: 2002/10/27 23:29:13 $ CERN IT-PDP/DM Jean-Philippe Baud
.\" Copyright (C) 1994-2002 by CERN/IT/DS/HSM
.\" All rights reserved
.\"
.TH STAGEQRY "1" "$Date: 2002/10/27 23:29:13 $" "CASTOR" "Stage User Commands"
.SH NAME
stageqry \- give the status of all files known to the stage system
.SH SYNOPSIS
.B stageqry
[
.BI \-a
] [
.BI \-f
] [
.BI \-h " host"
] [
.BI \-L
] [
.BI \-l
] [
.BI \-M " hsmfile | pattern"
] [
.BI \-P
] [
.BI \-p " pool"
] [
.BI \-S
] [
.BI \-u
] [
.BI \-x
] [
.BI \-\-dump
] [
.BI \-\-format " formatstring"
] [
.BI \-\-mintime
] [
.BI \-\-noheader
] [
.BI \-\-noregexp
] [ 
.BI \-\-noretry
] [
.BI \-\-output " filename"
] [
.BI \-\-reqid " reqid"
] [
.BI \-\-withna
] [
.BI \-\-withunit
] [
.BI \-\-withstatusnumber
] [
.BI \-\-withtimenumber
] [
.BI \-\-retenp
]
.LP
.B stageqry
[
.BI \-h " host"
] [
.BI \-p " pool"
] [
.BI \-s
] [
.BI \-\-class
] [
.BI \-\-counters
] [
.BI \-\-mintime
] [
.BI \-\-migrator
] [ 
.BI \-\-noretry
] [
.BI \-\-queue
] [
.BI \-\-retenp
]
.SH DESCRIPTION
In its first form, 
.B stageqry
gives the status of files which are staged or currently requested
in tabular form.
.LP
In its second form, 
.B stageqry
gives global status on pools, waiting queue, and more.
.LP
For the first form, default output start with a header which, for backward compatibility reasons, is mentionning Vid, Fseq, Lbl, Recfm and Blksiz, meaningful only for tape files. For HSM files (\-M option), the basename of the HSM name is printed instead under a column 'File name'. Then, a column 'status' gives current status of the found record, and can be:
.RS
STAGEALLOC	space has been reserved with stagealloc
.TP
STAGEIN	currently reading from tape to disk
.TP
STAGEOUT	space has been reserved for stageout file
.TP
STAGEWRT	currently copying from disk to tape
.TP
WAITING_SPC	waiting for space
.TP
WAITING_REQ	waiting for the same request by another job to complete
.TP
STAGED	successfully staged to EOF
.TP
STAGED_LSZ	successfully staged to specified size
.TP
STAGED_TPE	successfully staged but blocks were skipped
.TP
PUT_FAILED	stageput failed
.TP
CAN_BE_MIGR	candidate for the next automatic migration (CASTOR HSM only)
.TP
BEING_MIGR	being migrated by the automatic migrator (CASTOR HSM only)
.TP
WAITING_NS	waiting for creation in nameserver (CASTOR HSM only)
.TP
WAITING_MIGR	waiting for automatic migration request (CASTOR HSM only)
.RE
.HP
Nbaccess column gives the number of requests for this file.
.HP
Size gives the actual size / requested size (in Mbytes).
.SH OPTIONS
.TP
.BI \-a
gives the status for all files. If this option is absent, only the files
that belong to the requestor's group are displayed.
.TP
.BI \-f
gives on an extra line the full HSM filename.
.TP
.BI \-h " host"
sends the request to the stager on
.IR host .
This may also be specified thru the environment variable STAGE_HOST.
.BI \-L
gives the link name(s) for the selected files.
.TP
.BI \-l
gives more details for each file: the login name and the group name of the
user who requested the initial stage operation, the creation date and the
date of last access.
.TP
.BI \-M " pattern"
searches in the stager catalog for HSM files whose name matches the specified
pattern.
.B stageqry
treats a pattern as a basic regular expression which should be surrounded
by single quotes to avoid unwanted shell substitutions.
.TP
.BI \-P
gives the internal path name(s) for the selected files.
.TP
.BI \-p " poolname"
restricts the query to a given pool.
.TP
.BI \-S
gives on stdout a list of staged files sorted in ascending order of last access
time weighted by file size.
.br
        W = max (atime, mtime) \- (86400 * log (size / 1024))
.br
There are six fields per file: date of last access, time of last access, size
in Mbytes, number of accesses, internal path and user path.
.TP
.BI \-s
gives statistics on pool utilization.
.TP
.BI \-x
adds two columns to the output: they give the request id and the internal
pathname.
.TP
.BI \-\-class
gives CASTOR's file classes specifications. Please note that the fileclasses specifications listed will only be those that were concerned by any file that was or is beeing migrated. In particular if a given entry is already STAGED when the stager daemon starts up and no new file, belonging to the same fileclass, appears to be or have be a candidate for migration up to when you run this stageqry command, such a fileclass will not be listed. Used only if -s option is set.
.TP
.BI \-\-counters
gives CASTOR's read/write counters for stageout pools. Those counters are used to select the best filesystem while doing a stageout, taking into account other running stageout's as well as running migrations.
.TP
.BI \-\-dump
dumps the content of the found entry(ies) in the main catalog, or in the path catalog in case of \-L option.
.TP
.BI \-\-format
will switch off the default output in favour to a user defined
.I formatstring
, that is a comma separated list of structure members. If you don't specify the 
.BI \-L
option, the format string can be composed of
.BI blksize ,
.BI charconv ,
.BI keep ,
.BI lrecl ,
.BI nread ,
.BI poolname ,
.BI recfm ,
.BI size ,
.BI ipath ,
.BI t_or_d ,
.BI group ,
.BI user ,
.BI uid ,
.BI gid ,
.BI mask ,
.BI reqid ,
.BI status ,
.BI actual_size ,
.BI c_time ,
.BI a_time ,
.BI nbaccesses ,
.BI den ,
.BI dgn ,
.BI fid ,
.BI filstat ,
.BI fseq ,
.BI lbl ,
.BI retentd ,
.BI side ,
.BI tapesrvr ,
.BI E_Tflags ,
.BI vid ,
.BI vsn ,
.BI xfile ,
.BI server ,
.BI fileid ,
.BI fileclass ,
.BI tppool ,
.BI retenp_on_disk
and
.BI mintime_beforemigr .
With -L, it can composed of
.BI reqid
and
.BI upath
only.
.TP
.BI \-\-noheader
If you use the
.BI \-\-format
mode, this option will prevent the default header, that is taking all the arguments in the format string as input, to be printed.
.TP
.BI \-\-output
If you use the
.BI \-\-format
mode, this option will redirect all the output (including errors) to a given
.I filename.
.TP
.BI \-\-withna
If you use the
.BI \-\-format
mode, this option will print
.B N/A
instead of blanks, in case you want to parse the output and you depend on an exact number of columns.
.TP
.BI \-\-withunit
If you use the
.BI \-\-format
mode, this option will print the
.BI size
and
.BI actual_size
with an unit instead of the default, which is without unit, e.g. in bytes. Units can be
.I k
for kilo\-bytes,
.I M
for mega\-bytes,
.I G
for giga\-bytes,
.I T
for tera\-bytes and
.I P
for peta\-bytes.
.TP
.BI \-\-withstatusnumber
If you use the
.BI \-\-format
mode, this option will print
.I status
with an user-friendly string, instead of the default, that is its raw value. These strings can be
.I STAGEALLOC,
.I STAGEIN,
.I STAGEOUT,
.I STAGEWRT,
.I STAGEPUT,
.I STAGED_LSZ,
.I STAGED_TPE,
.I CAN_BE_MIGR,
.I WAITING_MIGR,
.I WAITING_NS,
.I WAITING_SPC,
.I WAITING_REQ
and
.I STAGED.
.TP
.BI \-\-withtimenumber
If you use the
.BI \-\-format
mode, this option will print
.I c_time
and
.I a_time
in a formatted string status instead of the default, that is its raw value (elapsed seconds since the Epoch (00:00:00 UTC, January 1, 1970).
.TP
.BI \-\-migrator
gives statistics on migration rules. Used only if \-s option is set.
.TP
.BI \-\-mintime
gives current minimum time before migration. This concerns only entries that are in the CAN_BE_MIGR state.
.TP
.BI \-\-noregexp
prevents regular expression to be applied in case of \-M option. You then have to give the full (hsm) name as it was given when the entry was created inside the stager.
.TP
.B \-\-noretry
There will be no retry in case of any failure. Can be set using environment variable STAGE_NORETRY to a non-zero value, or an entry 'STG NORETRY' in /etc/shift.conf.
.TP
.BI \-\-queue
gives CASTOR's waiting queue content.
.TP
.BI \-\-reqid " reqid "
outputs only entries that have this given reqid.
.TP
.BI \-\-retenp
gives current retention period on disk. This period will be showed in terms of either maximum timestamp, or generic keywords that are: AS_LONG_AS_POSSIBLE and INFINITE_LIFETIME, or Expired. The CASTOR files lifetime can be changed using the \fBstagechng\fP command. A retention period of INFINITE_LIFETIME guarantees that the corresponding entry will never be purged. A retention period of AS_LONG_AS_POSSIBLE says that the corresponding entry can be purged if there is missing space into internal disks. Another value specifies that the corresponding entry will be automatically removed if local time of the stager daemon exceeds printed value, or will be removed almost immediated if it says Expired.
.\" .TP
.\" .BI \-\-side " sidenumber "
.\" outputs only entries coming from multi-sided media (like DVD). Only with
.BI \-V
option.
.\" .TP
.\" .BI \-\-display_side
.\" Forces 'tape' files with a side number greater than zero to follow the multi-sided format as quoted in the NOTES section below. Please see the NOTES section.
.SH EXAMPLES
.TP
.nf
.cs R 18
stageqry -M $CASTOR_HOME -flx
File name                            State      Nbacc.     Size    Pool
file03                               STAGED          1    0.0/0    castordev         305 castordev:/tmp/stage_castordev/c3/stage/file03.305
 /castor/cern.ch/user/j/jdurand/2002/09/30/file03
                        created by  jdurand   c3  2002/09/30 18:47:37
                        last access               2002/09/30 18:48:10
testforstagecat                      STAGED          1    0.0/0    castordev         352 castordev:/tmp/stage_castordev/c3/stage/testfile02
 /castor/cern.ch/user/j/jdurand/testforstagecat
                        created by  jdurand   c3  2002/10/01 15:13:38
                        last access               2002/10/01 15:13:38
.cs R
.fi
.TP
stageqry \-s
.nf
.cs R 18
POOL stagetest DEFSIZE 200 MINFREE 10 GC shd02:/usr/local/bin/stage_clean
                              CAPACITY 492.00M FREE 476.39M ( 96.8%)
  shd02 /stage CAPACITY 492.00M FREE 476.39M ( 96.8%)
.cs R
.fi
.\" .SH NOTES
.\" \'Tape\' files coming from what is in fact multi-sided media (like DVD) and from a side number greater than zero (zero mean the first side) are shown with the following format in the first column: "%s/%d" where the string correspond to the VolumeID and the number to the side, respectively. For side zero (which is the default and only possible value for magnetic tape) the format of the first column is "%s", showing only the VolumeID.
.SH RETURN CODES
\
.br
0	Ok.
.br
1	Bad parameter.
.br
2	System error.

.SH SEE ALSO
\fBstage_other_options\fP(1), \fBstagechng\fP(1), \fBstage_struct\fP(3)

.SH AUTHOR
\fBCASTOR\fP Team <castor.support@cern.ch>

