.\" $Id: stgdaemon.man,v 1.21 2002/10/28 16:02:31 jdurand Exp $
.\"
.\" @(#)$RCSfile: stgdaemon.man,v $ $Revision: 1.21 $ $Date: 2002/10/28 16:02:31 $ CERN IT-PDP/DM Jean-Philippe Baud
.\" Copyright (C) 1994-2002 by CERN/IT/DS/HSM
.\" All rights reserved
.\"
.TH STGDAEMON 1 "$Date: 2002/10/28 16:02:31 $" CASTOR "Stage Administrator Commands"
.SH NAME
stgdaemon \- starts the stage daemon
.SH SYNOPSIS
.B stgdaemon
[
.BI \-f
] [
.BI \-h
] [
.BI \-I " configfile"
] [
.BI \-L " backlog"
] [
.BI \-\-rlimit_nproc " nproc"
] [
.BI \-\-rlimit_nofile " nofile"
]
.SH DESCRIPTION
.LP
The
.B stgdaemon
command starts the stage daemon.
This command is usually executed at system startup time
.RB ( /etc/rc.local ).
This will read the pool configuration file,
the stage catalog to remove uncompleted transactions
and look for requests.
Short requests like
.B stageclr
are processed in the main loop. The daemon forks overlays to execute
long requests like disk/tape copy or pool cleanup.
In case of system error, the commands are automatically retried from the
failing subrequest.
If a file
.B nomorestage
exists in the operator directory, new stage commands (stageqry and stageinit
excepted) will be rejected by the daemon and will wait on the client side.
If a file
.B nomoremigr
exists in the operator directory, automatic migration will not be started.
All error messages and statistical information are kept in a log.
.B stgdaemon
keeps the catalog in a database managed by
.BR Cdb .
On all client hosts and on the stager host the following default ports and protocol are used:
.RS
.ft CW
.nf
.sp
rfio    5001/tcp       # Remote File Access System
rtcopy  5003/tcp       # Remote Tape Access
stage   5007/tcp       # CASTOR stager
cns     5010/tcp       # CASTOR name server
vmgr    5013/tcp       # CASTOR volume manager
.ft
.LP
.fi
.RE
There should be entries in 
.B /etc/services
if you want to modify them site-wide.
.LP
On all client hosts there should be an entry in
.B /etc/shift.conf
giving the stager hostname.
For example:
.RS
.HP
STG     HOST            shd02
.RE
The stager hostname may also be specified thru the environment variable
STAGE_HOST. Otherwise default stager is "stagepublic".
.LP
If TMS is used, there should also be an entry in
.B /etc/services
like:
.RS
.HP
sysreq          4001/tcp                        # SYSREQ/TCP
.RE
.LP
On all disk servers having filesystems in the pool(s), there should be four entries in
.B /etc/shift.conf
giving permission to the stager to execute programs, unlink files or create directories as root. The server where
.B stgdaemon
runs does not need these entries. For example:
.RS
.LP
RFIOD   XTRUST     shd02
.br
RFIOD   FTRUST     shd02
.br
RFIOD   RTRUST     shd02
.br
RFIOD   WTRUST     shd02
.RE
.HP
There must be one entry in the configuration file per pool giving:
.RS
.TP
.BI POOL " name"
Name of the pool. this will be used as
.B \-p
parameter in user commands. This parameter is mandatory.
.I name
is limited to CA_MAXPOOLNAME characters.
.TP
.BI DEFSIZE " size"
is the maximum filesize if the
.B \-s
option is not specified on user commands. Default unit of
.I size
is MB, but can be specified with 'b','k','M','G','T' or 'P' for byte, kilobyte, megabyte, gigabyte, terabyte or petabyte respectively. This parameter is mandatory.
.TP
.BI MAX_SETRETENP " period"
sets the maximum retention period a user can give for a CASTOR file. Default unit for
.I period
is second, but can be specified with 's' or 'S','m' or 'M','h' or 'H','d' or 'D','y' or 'Y' for second, minute, hour, day, year respectively. Default value is \-1, e.g. it is not allowed to set retention period.
.TP
.BI PUT_FAILED_RETENP " period"
sets the retention period for a PUT_FAILED file. Default unit of 
.I period
is second, but can be specified with 's' or 'S','m' or 'M','h' or 'H','d' or 'D','y' or 'Y' for second, minute, hour, day, year respectively. When retention is expired a file in PUT_FAILED can be a candidate for garbage collection. Default value is \-1, e.g. illimited lifetime for PUT_FAILED files.
.TP
.BI STAGEOUT_RETENP " period"
sets the retention period for a STAGEOUT file. Default unit of
.I period
is second, but can be specified with 's' or 'S','m' or 'M','h' or 'H','d' or 'D','y' or 'Y' for second, minute, hour, day, year respectively. When retention is expired a file in STAGEOUT is removed. Default value is \-1, e.g. illimited lifetime for STAGEOUT files.
.TP
.BI STAGEALLOC_RETENP " period"
sets the retention period for a STAGEOUT file. Default unit of
.I period
is second, but can be specified with 's' or 'S','m' or 'M','h' or 'H','d' or 'D','y' or 'Y' for second, minute, hour, day, year respectively. When retention is expired a file in STAGEALLOC is removed. Default value is \-1, e.g. illimited lifetime for STAGEALLOC files.
.TP
.BI GC_START_THRESH " perc"
is the percentage of free space in the pool gets below which
the garbage collector is started. Default value of
.I perc
is 0, e.g. the garbage collector is started only if stager is notified of a space problem.
.TP
.BI GC_STOP_THRESH " perc"
is the percentage of free space in the pool above which the garbage collector is stopped. For backward compatibility with SHIFT, the keyword MINFREE can be used instead.For example,
.B MINFREE 10
corresponds to 10% of free space. Default value is 0, e.g no file is deleted if garbage collector starts.
.TP
.BI GC " fullpath"
is the name of the garbage collector program (RFIO syntax). It can be up to CA_MAXHOSTNAMELEN+MAXPATH characters. Default is to have no garbage collector.
.TP
.BI NO_FILE_CREATION
suppress the creation of an empty file (stageout only). Default is to create files.
.TP
.BI EXPORT_HSM
allows one pool to export its CASTOR files to another one, e.g. an internal disk to disk copy, instead of doing an explicit tape request when a CASTOR file does not exist in the destination pool. Works only if the user requests a CASTOR file in an explicit read\-only (O_RDONLY) mode, the file is not accessible in a pool, but already exists in another pool with the STAGED status. It is not recommended if the application can modify both disk versions of the file. Default is not to export hsm files across disk pools.
.TP
.BI MIGRATOR " name"
is a generic name of a migrator. Migrator name can be shared between several disk pools. Can have up to CA_MAXMIGRNAMELEN characters. Default is to have no migrator.
.TP
.BI MIG_START_THRESH " perc"
is the percentage of free space in the pool below which a migrator is started. Default is 0, e.g. obey to fileclass rules only.
.TP
.BI MIG_STOP_THRESH " perc"
is the percentage of free space in the pool above which migrator should stop. \fBNot yet supported\fP.
.TP
.BI MIG_DATA_THRESH " size"
is the amount of data ready to be migrated above which a migrator is started. Default unit is MB, but can be specified with 'b','k','M','G','T' or 'P' for byte, kilobyte, megabyte, gigabyte, terabyte or petabyte respectively.
For example,
.B MIG_DATA_THRESH 800G
specifies a 800 GB threshold.
.TP
.BI DEFPOOL " poolname"
is the default pool name for all requests. This parameter is mandatory.
.TP
.BI DEFPOOL_IN " poolin"
is the default pool name for stagein requests (if none, defaults to DEFPOOL value)
.TP
.BI DEFPOOL_OUT " poolout"
is the default pool name for stageout requests (if none, defaults to DEFPOOL value)
.TP
There must be also one entry per pool element giving:
.RS
.HP
server		full path of the stage directory
.RE
.TP
The stage catalog is split into sub-catalogs, one for each type of entry:
tape, disk, alloc, HSM. Each entry consists of 2 parts: non-specific and
specific.
The non-specific part contains the following information:
.br
maximum block size
.br character conversion
.br
keep flag; if non zero, keep data on disk after successful stagewrt
.br
record length
.br
number of blocks/records to be copied
.br
pool name
.br
record format
.br
size in Mbytes of data to be staged
.br
internal path
.br
user group
.br
login name
.br
uid
.br
gid
.br
umask
.br
request id
.br
status
.br
actual_size
.br
creation time
.br
last access time
.br
nb of accesses
.HP
The tape specific part contains:
.br
density
.br
device group
.br
file id
.br
file status: new = 'n', old = 'o'
.br
file sequence number requested by user
.br
label type: al, nl, sl, blp or aul
.br
retention period in days
.br
tape server specified by user
.br
E_Tflags; error processing flags
.br
visual_identifier(s)
.br
volume_serial_number(s)
.HP
The disk, alloc or HSM (but non\-CASTOR) specific part contains:
.br
external filename
.HP
The CASTOR specific part contains:
.br
castor filename
.br
castor name server
.br
invariant on this castor name server
.br
associated fileclass
.br
tape pool
.br
retention period on disk
.br
minimum time before migration
.br
internal flag
.LP
A secondary catalog contains the list of symbolic links to the staged files.
.LP
In the log each entry has a timestamp.
All entries corresponding to one request have the same request id.
For each user command there is one message STG98 giving the command,
one message STG97 per try to stage a file or one message STG96 if the file
was already staged and a final message STG99 giving the return code.
The message STG97 gives the following information:
internal file path, tape server, tape unit, network interface, actual file size,
waiting time and transfer time.
The message STG96 gives the internal file path and the current number of
accesses to the file.
A message STG95 giving the internal file path appears in the log every time
a file is deleted.
.SH OPTIONS
.TP
.BI \-f
Runs in foreground
.TP
.BI \-h
Print help
.TP
.BI \-I " configfile"
Sets stager configuration file. This file must be local and default to \fB/etc/STGCONFIG\fP.
.TP
.BI \-L " backlog"
Sets listening backlog. Default value is 5.
.TP
.BI \-\-rlimit_nproc " nproc"
Sets maximum number of processes.
.TP
.BI \-\-rlimit_nofile " nofile"
Sets maximum number of open files.

.SH FILES
.TP 1.5i
.B /etc/STGCONFIG
configuration file
.TP
.B /usr/spool/db/stage/stgcat_xxx
main catalog
.TP
.B /usr/spool/db/stage/stgcat_link
secondary catalog (symbolic links)
.TP
.B /usr/spool/stage/log
main log
.TP
.B /usr/spool/stage/mig_log
automatic migration output log
.TP
.B /etc/operator/nomoremigr
.TP
.B /etc/operator/nomorestage
.SH EXAMPLES
.TP
Here is an example of a configuration file:
.ft CW
.nf
.sp
POOL thispool EXPORT_HSM DEFSIZE 1 MIGRATOR thismigr MIG_START_THRESH 100 \\
STAGEALLOC_RETENP 12S MAX_SETRETENP 1
        thishost         /shift/thishost/data01
        thishost         /shift/thishost/data02
        thishost2        /shift/thishost2/data01
        thishost2        /shift/thishost2/data02
POOL thispool2 DEFSIZE 1 MIGRATOR thismigr MIG_START_THRESH 100 \\
STAGEALLOC_RETENP 12S MAX_SETRETENP 1
        thishost3        /shift/thishost3/data01
        thishost3        /shift/thishost3/data02
        thishost3        /shift/thishost3/data03
DEFPOOL thispool
.ft
.LP
.fi
that defines to pools, thispool and thispool2, each of them with 1MB default size allocation, sharing the same migrator, instructed to always migrate as soon as there is at least one file candidate for migration, with a retention period of 12 seconds to STAGEALLOCed files, and 1 day for maximum user\-defined retention period in case they would like to overwrite the default disk retention period on CASTOR files.
.TP
Here is a simple example of a stage_clean script:
.ft CW
.nf
.sp
stageqry \-a \-p $1 \-S  |  cut \-c33\- | cut \-d" " \-f1 | \\
stageclr \-c \-i \-p $1
.ft
.LP
.fi
.br

.TP
Here is an excerpt from a production log:
.ft CW
.nf
.sp
\s-2
10/03 11:36:51     0 migpoolfiles: ### Warning \- stream on tape pool default have size to be \\
migrated 680 < 2147483648
10/03 11:36:51     0 migpoolfiles: ... Original number of streams : 1
10/03 11:36:51     0 migpoolfiles: STG135 \- Stream No 1 : 1 HSM files \- 680 bytes \- \\
tape pool default
10/03 11:36:51     0 migpoolfiles: Setted environment variable STAGE_STGMAGIC=0x13140704
10/03 11:36:51    25 stgdaemon: STG92 \- stage_wrt request by stage (14029,1474) from \\
castordev.cern.ch
10/03 11:36:51    25 stgdaemon: stcp[1/1] : \-M \\
/castor/cern.ch/user/j/jdurand/2002/10/03/shift.conf \-\-server cnsuser.cern.ch \\
\-\-fileid 9372259 \-\-fileclass 2 \-\-req
id 22
10/03 11:36:51    25 stgdaemon: stpp[1/1] : \\
castordev:/tmp/stage_castordev/c3/stage/shift.conf.22
10/03 11:36:51    25 stgdaemon flags: STAGE_SILENT|STAGE_NOHSMCREAT|STAGE_REQID|\\
STAGE_HSM_ENOENT_OK|STAGE_NOLINKCHECK|STAGE_MIGLOG|STAGE_VOLATILE_TPPOOL
10/03 11:36:51    25 stgdaemon tppool: default
10/03 11:36:51    25 stgdaemon: execing stager_castor reqid=25 key=4019 rpfd=2 nbsubreqs=1 \\
nretry=0 Aflag=0 concat_off_fseq=0 silent=1 use_subreqid=1 api_flag=1 
flags=STAGE_SILENT|STAGE_NOHSMCREAT|STAGE_REQID|STAGE_HSM_ENOENT_OK|STAGE_NOLINKCHECK|\\
STAGE_MIGLOG|STAGE_VOLATILE_TPPOOL, pid=2540
10/03 11:36:51     0 stager_castor: function entered
10/03 11:36:51    25 stager_castor: Use [vid,side,vsn,dgn,aden,lbltype,fseqs]=[R09395,0,\\
R09395,9840R5,20GC,aul,253 to 253]
10/03 11:36:51    25 sendrep: selecting tape server ...
10/03 11:36:51    25 sendrep: * tpsrv001 is a possible tape server.
10/03 11:36:51    25 sendrep: ! selected tape server is tpsrv001.
10/03 11:38:07    25 stager_castor: R09395/0.253, File No 1 (\\
castordev:/tmp/stage_castordev/c3/stage/shift.conf.22), cprc=0, bytes_in=680, \\
bytes_out=0, host_byte
s=0
10/03 11:38:07    26 stgdaemon: STG92 \- stageupdc request by stage (14029,1474) from \\
tpsrv001.cern.ch
10/03 11:38:07    26 stgdaemon: STG98 \- stage_updc_tppos \-Z 25.4019@castordev \-i 0 \\
\-b 32760 \-D 984050A0 \-F F \-f /10/03/SHIFT.CONF \-L 32760 \-q 253
10/03 11:38:07    25 rwcountersfs: castordev:/tmp/stage_castordev read[+1]/write[+0]= 1/ 0
10/03 11:38:07    26 sendrep: STG99 \- stage returns 0
10/03 11:38:12    25 stager_castor: R09395/0.253, File No 1 (\\
castordev:/tmp/stage_castordev/c3/stage/shift.conf.22), cprc=0, bytes_in=680, \\
bytes_out=1024, host_bytes=1024
10/03 11:38:12    27 stgdaemon: STG92 \- stageupdc request by stage (14029,1474) from \\
tpsrv001.cern.ch
10/03 11:38:12    27 stgdaemon: STG98 \- stage_updc_filcp \-Z 25.4019@castordev \-b 32760 \\
\-i 0 \-D 984050A0 \-F F \-f /10/03/SHIFT.CONF \-I eth0 \-L 32760 \-s 680 \-R 0 \-T
 4 \-W 77 \-q 253
10/03 11:38:12    25 rwcountersfs: castordev:/tmp/stage_castordev read[\-1]/write[+0]= 0/ 0
10/03 11:38:12    25 stgdaemon: STG97 \- castordev:shift.conf.22 staged by (stage,st), \\
server tpsrv001.cern.ch  unit 984050A0  ifce eth0  size 680  wtim 77  ttim 
4 rc 0
10/03 11:38:12    25 sendrep: STG42 \- stagewrt succeeded for file \\
/castor/cern.ch/user/j/jdurand/2002/10/03/shift.conf, return code 0
10/03 11:38:12    25 stgdaemon: STG142 \- \\
/castor/cern.ch/user/j/jdurand/2002/10/03/shift.conf not removed \- Retention period is \\
AS_LONG_AS_POSSIBLE
10/03 11:38:12    27 sendrep: STG99 \- stage returns 0
10/03 11:38:12    25 stgdaemon: stager process 2540 exiting with status 0
10/03 11:38:12    25 sendrep: STG199 \- stage returns 0
10/03 11:38:12     0 migpoolfiles: Migration child pid=2539 exited, status 0
10/03 11:38:13     0 stgdaemon: migration process 2537 exiting with status 0
\s+2
.ft
.LP
.fi
.SH SEE ALSO
.BR stage_constants(3)
.BR Castor_limits(4) ,
.BR Cdbserver(1) ,
.BR stageinit(1) ,
.BR stgdump(1) ,
.B stgconvert(1)
.SH AUTHOR
\fBCASTOR\fP Team <castor.support@cern.ch>
