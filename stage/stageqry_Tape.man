.\" $Id: stageqry_Tape.man,v 1.1 2002/09/15 06:39:28 jdurand Exp $
.\"
.\" @(#)$RCSfile: stageqry_Tape.man,v $ $Revision: 1.1 $ $Date: 2002/09/15 06:39:28 $ CERN IT-DS/HSM Jean-Damien Durand
.\" Copyright (C) 2002 by CERN/IT/DS/HSM
.\" All rights reserved
.\"
.TH STAGEQRY_TAPE "3" "$Date: 2002/09/15 06:39:28 $" "CASTOR" "Stage Library Functions"
.SH NAME
stageqry_Tape \- Query the stager catalog about a tape
.SH SYNOPSIS
.BI "#include <" stage_api.h ">"
.sp
.BI "int stageqry_Tape(u_signed64 " flags ,
.BI "char *" hostname ,
.BI "char *" poolname ,
.BI "char *" tape ,
.BI "char *" fseq ,
.BI "int *" nstcp_output ,
.BI "struct stgcat_entry **" stcp_output ,
.BI "int *" nstpp_output ,
.BI "struct stgpath_entry **" stpp_output ");"

.SH DESCRIPTION
The \fBstageqry_Tape\fP API method queries the stager catalog for a given
.I tape.
There are two ouputs: the default ttys (unless you use \fBstage_setlog\fP, see in the example below) and the output parameters, that are allocated on the fly (e.g. the user will have to free them if necessary/wanted).

.SH PARAMETERS
.TP 2.0i
.BI flags
Flags that are driving the search in the stager catalog. It can be zero or a bit-wise of the following values:
.TP 2.0i
.HP
.I STAGE_DUMP
A dump of the found catalog entries is written to the output.
.TP
.HP
.I STAGE_ALL
Search over all entries. Default is to restrict to your group.
.TP
.HP
.I STAGE_LINKNAME
Only the eventual links to found catalog entries in written to the output
.TP
.HP
.I STAGE_LONG
Gives more details for each file: the login name, the group name of the user who requested the initial stage operation, the creation and the date of last access.
.TP
.HP
.I STAGE_PATHNAME
Gives the internal path for each found catalog entry.
.TP
.HP
.I STAGE_SORTED
List of staged files sorted in ascending order of last access time weighted by file size: W = atime \- (86400 * log (size / 1024)). There are six fields per file: date of last access, time of last access, size in Mbytes, number of accesses, internal path and user path.
.TP
.HP
.I STAGE_TAPEINFO
Gives  on standard output, as an option string, the main characteristics of a tape file. The information is taken from the header labels. This includes block size (-b), record format (-F),  file  identifier (-f) and record length (-L).
.TP
.HP
.I STAGE_USER
Restricts the query to files that belong to the requestor.
.TP
.HP
.I STAGE_EXTENDED
Adds  two  columns  to  the  output:  they give the request id and the internal pathname.
.TP
.HP
.I STAGE_MULTIFSEQ
If the file sequence given in input is a range, make the stageqry act for each of them individually, splitting the range into individual file sequences when processing the request. The default is to consider, in case of a range, that the found entry really correspond on disk to the respective concatenation of the range.
.TP
.HP
.I STAGE_DISPLAY_SIDE
Forces display of side with the volume id using the format vid/side. For real tape media, the side default to zero.
.TP
.HP
.I STAGE_REQID
Takes into account the request id member of input structure when seaching in the catalog.
.TP
.HP
.I STAGE_NORETRY
Prevent retry in case of communication failure with the stager daemon. Can be set using environment variable $STAGE_NORETRY with a non-wero value, or an entry 'STG NORETRY' with a non-null value in /etc/shift.conf.
.TP
.BI hostname
Gives explicitely the hostname where is the stager daemon. If it NULL, default value apply: either the environment variable STAGE_HOST, an entry 'STG HOST' in /etc/shift.conf file, or the default "stagepublic".
.TP
.BI poolname
Restrict search to a given poolname. Can be NULL.
.TP
.BI tape
Gives the tape identifier you want to query for.
.TP
.BI fseq
Gives the file sequence to restrict the search in the catalog. Default is empty and to output all file sequences for a given tape.
.TP
.BI nstcp_output
Filled with the number of found records.
.TP
.BI stcp_output
Filled with the address of an array containg the found records. Up to the user to free it if necessary.
.TP
.BI nstpp_output
Filled with the number of found records.
.TP
.BI stpp_output
Filled with the address of an array containg the link records. Only if STAGE_LINKNAME is used. Up to the user to free it if necessary.

.SH EXAMPLE
.ft CW
.nf
.sp
#include <stdlib.h>
#include <sys/types.h>
#include <signal.h>
#include <stdio.h>
#include <stage_api.h>
#include <serrno.h>
     
#define YOUR_TAPE "R02003"
#define YOUR_FSEQ "1-10"
#define VERBOSE 0
      
void stcplog _PROTO((int, char *));
void stcpprint _PROTO((struct stgcat_entry *, struct stgpath_entry *));

int main(argc,argv)
     int argc;
     char **argv;
{
  int nstcp_output;
  struct stgcat_entry *stcp_output = NULL;
  int rc, i, isstaged = 0;
 
  if (stage_setlog(&stcplog) != 0) {
    fprintf(stderr,"### stage_setlog error (%s)\\n", sstrerror(serrno));
    exit(EXIT_FAILURE);
  }
 
  rc = stageqry_Tape((u_signed64) STAGE_ALL|STAGE_MULTIFSEQ, /* Flags */
                    NULL,                        /* Hostname */
                    NULL,                        /* Poolname */
                    (argc > 1 ? argv[1] : YOUR_TAPE), /* Vid */
                    (argc > 2 ? argv[2] : YOUR_FSEQ), /* Fseq Range */
                    &nstcp_output,               /* Nb stcp output */
                    &stcp_output,                /* Stcp output */
                    NULL,                        /* Nb stpp output */
                    NULL);                       /* Stpp output */
  if (rc != 0) {
    fprintf(stderr,"### stageqry_Tape error (%s)\\n", sstrerror(serrno));
  } else {
    for (i = 0; i < nstcp_output; i++) {
#if VERBOSE
      stcpprint(stcp_output + i, NULL);
#endif
      if (ISSTAGED((&stcp_output[i]))) isstaged++;
    }
  }
  if (stcp_output != NULL) free (stcp_output);   /* User responsability ! */
  
  fprintf(stdout,"%s.%s : Found %d entr%s with the STAGED status\\n",
          (argc > 1 ? argv[1] : YOUR_TAPE),
          (argc > 2 ? argv[2] : YOUR_FSEQ),
          isstaged,
          (isstaged > 1) ? "ies" : "y");

  exit(isstaged ? 0 : 1);
}
 
void stcpprint(stcp,stpp)
     struct stgcat_entry *stcp;
     struct stgpath_entry *stpp;
{
  if (stcp != NULL) print_stcp(stcp);
  if (stpp != NULL) print_stpp(stpp);
}
 
void stcplog(level,msg)
     int level;
     char *msg;
{
#if VERBOSE
  fprintf(stdout, "%s", msg);
#endif
}
.ft
.LP
.fi

.SH RETURN VALUE
0 on success, -1 on failure.

.SH ERRORS
If failure, the serrno variable might contain one of the following error codes:
.TP 1.9i
.B SENOMAPFND
Can't open mapping database (Windows only)
.TP
.B EFAULT
Bad address
.TP
.B EINVAL
Invalid argument
.TP
.B SECONNDROP
Connection closed by remote end
.TP
.B SECOMERR
Communication error
.TP
.B SEINTERNAL
Internal error

.SH SEE ALSO
\fBstageqry\fP(1), \fBstage_setlog\fP(3), \fBprint_stcp\fP(3), \fBprint_stpp\fP(3), \fBstage_struct\fP(3), \fBstage_macros\fP(3)

.SH AUTHOR
\fBCASTOR\fP Team <castor.support@cern.ch>

