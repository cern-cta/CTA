name: Sonar Source Analysis

on:
  push:
    branches:
      - main
      - 336-add-sonarcloud-static-analysis-to-the-gitlab-ci-like-is-done-for-cppcheck
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build:
    runs-on: ubuntu-20.04
    container:
      image: centos:7
    
    env:
      XROOTD_VERSION: 4
      SCHED_TYPE: "objectstore"
      ORACLE_SUPPORT: "ON"
      CTA_VERSION: "${XROOTD_VERSION}"
      CMAKE_OPTIONS: ""
      BUILD_WRAPPER_OUT_DIR: build_wrapper_output_directory # Directory where build-wrapper output will be placed

    steps:
      - name: Download CTA
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Shallow clones should be disabled for a better relevancy of analysis
      - name: Set up JDK 11
        uses: actions/setup-java@v1
        with:
          java-version: 11
      - name: Cache SonarCloud packages
        uses: actions/cache@v1
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar
      - name: Install sonar-scanner and build-wrapper
        uses: SonarSource/sonarcloud-github-c-cpp@v1
      - name: Install dependencies
        run: |
          export CTA_BUILD_ID=${GITHUB_RUN_ID}git${GITHUB_SHA:0:8}
          echo "Exporting CTA_BUILD_ID=${CTA_BUILD_ID}"
          cp -f continuousintegration/docker/ctafrontend/cc7/etc/yum.repos.d-public/*.repo /etc/yum.repos.d/
          test [[ "${GITHUB_REF_TYPE}" == "tag" ]; then
            export TAG_VERSION=$(echo ${GITHUB_REF_NAME} | sed -e 's/^v//;s/-.*$//')
            export TAG_RELEASE=$(echo ${GITHUB_REF_NAME} | sed -e 's/^[^-]*-//')
          fi
          major_version=$(echo ${TAG_VERSION} | cut -d. -f1)
          if [[ ${major_version} == 5 ]]; then
            echo "Setting to compile with XRootD version 5"
            XROOTD_VERSION=5
          fi
          if [[ ${XROOTD_VERSION} -eq 5 ]]; then
            echo "Using XRootD version 5"
            ./continuousintegration/docker/ctafrontend/cc7/opt/run/bin/cta-versionlock --file ./continuousintegration/docker/ctafrontend/cc7/etc/yum/pluginconf.d/versionlock.list config xrootd5
            yum-config-manager --enable cta-ci-xrootd5
          else
            echo "Using XRootD version 4"
          fi
          if [[ ${SCHED_TYPE} != "objectstore" ]]; then
            echo "Using specified scheduler database type $SCHED_TYPE"
            sched_opt="-DCTA_USE_$(echo ${SCHED_TYPE} | tr '[:lower:]' '[:upper:]'):Bool=true"
            sched_version=$(echo ${SCHED_TYPE} | cut -c 1-3)
            CTA_VERSION="${CTA_VERSION}${sched_version}"
            CMAKE_OPTIONS+="-DSKIP_UNIT_TESTS:STRING=1 ${sched_opt} "
          fi
          if [[ ${ORACLE_SUPPORT} != "ON" ]]; then
            echo "Disabling Oracle Support"
            CMAKE_OPTIONS+="-DDISABLE_ORACLE_SUPPORT:BOOL=ON"
          fi          
          yum install -y devtoolset-11 cmake3 make rpm-build git
          source /opt/rh/devtoolset-11/enable
          git submodule update --init --recursive
          mkdir build_srpm
          cd build_srpm
          echo ${CMAKE_OPTIONS}
          cmake3 -DPackageOnly:Bool=true -DVCS_VERSION=${CTA_BUILD_ID} ${CMAKE_OPTIONS} ..
          make cta_srpm
      - name: Run build-wrapper
        run: |
          yum install -y devtoolset-11 cmake3 make rpm-build
          yum -y install yum-plugin-priorities yum-plugin-versionlock
          yum install -y git
          source /opt/rh/devtoolset-11/enable
          git submodule update --init --recursive
          cd xrootd-ssi-protobuf-interface && export XROOTD_SSI_PROTOBUF_INTERFACE_VERSION=$(git describe --tags --abbrev=0) && cd ..
          cp -f continuousintegration/docker/ctafrontend/cc7/etc/yum/pluginconf.d/versionlock.list /etc/yum/pluginconf.d/
          yum-builddep --nogpgcheck -y build_srpm/RPM/SRPMS/*
          mkdir build_rpm
          cd build_rpm
          echo ${CMAKE_OPTIONS}
          cmake3 -DVCS_VERSION=${CTA_BUILD_ID} ${CMAKE_OPTIONS} ..
          make cta_rpm
          build-wrapper-linux-x86-64 --out-dir ${{ env.BUILD_WRAPPER_OUT_DIR }} make cta_rpm
      - name: Run sonar-scanner
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          sonar-scanner --define sonar.cfamily.build-wrapper-output="${{ env.BUILD_WRAPPER_OUT_DIR }}"
