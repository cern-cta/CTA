COMM
COMM  Copyright (C) 2003-2005 by CERN/IT/ADC/CA
COMM  All rights reserved
COMM
COMM       @(#)$RCSfile: Imakefile,v $ $Revision: 1.22 $ $Date: 2009/06/03 09:26:02 $ CERN IT/ADC/CA  Ben Couturier
 
COMM    Make CASTOR Security package

INCLUDES = ../h

#if UseGSI
#define GSIMech GSI
#endif

#if UseKRB5
#define KRB5Mech KRB5
#endif

#define CSEC_Mechlist KRB5Mech GSIMech ID
CSEC_MECHLIST=CSEC_Mechlist
CFLAGS = $(DFLAGS) $(MTCCFLAGS) -g -DCSEC_DEFAULT_MECHS="\"$(CSEC_MECHLIST)\"" -I$(INCLUDES) 

SECLIB_OBJS = Csec_api_loader.Osuf Csec_protocol_policy.Osuf Csec_api.Osuf Csec_errmsg.Osuf Csec_apiinit.Osuf Csec_common.Osuf
DependsOnLibrary(common,castorcommon)
ClientSharedLibraryTarget(castorsecurity,$(SECLIB_OBJS),$(GLOBLIB),$(LIBS))

#if UseGSI
GLOBUS_LOCATION=GlobusLocation
#if UseVOMS
VOMS_LOCATION=VomsLocation
#endif
GLOBUS_FLAVOUR_NONPTHR=GlobusFlavour
VOMS_FLAVOUR_NONPTHR=GlobusFlavour
#if defined(__STDC__)
GLOBUS_FLAVOUR=GlobusFlavour##pthr
VOMS_FLAVOUR=GlobusFlavour##pthr
#else
GLOBUS_FLAVOUR=GlobusFlavour/**/pthr
VOMS_FLAVOUR=GlobusFlavour/**/pthr
#endif
#if UseVOMS
VOMS_INCLUDE=-I$(VOMS_LOCATION)/include/glite/security/voms -DUSE_VOMS
VOMS_LIB_NONPTHR=-L$(VOMS_LOCATION)/lib -lvomsc
VOMS_LIB_PTHR=-L$(VOMS_LOCATION)/lib -lvomsc_$(VOMS_FLAVOUR)
#endif
#define SecAuthMechGSI       -DGSI
#define SecIncludeDirGSI -I$(GLOBUS_LOCATION)/include/$(GLOBUS_FLAVOUR_NONPTHR) $(VOMS_INCLUDE) 
#define SecLibsGSI -L$(GLOBUS_LOCATION)/lib -lglobus_gssapi_gsi_$(GLOBUS_FLAVOUR_NONPTHR) -lglobus_gss_assist_$(GLOBUS_FLAVOUR_NONPTHR) $(VOMS_LIB_NONPTHR)
#define SecIncludeDirGSIpthr -I$(GLOBUS_LOCATION)/include/$(GLOBUS_FLAVOUR) $(VOMS_INCLUDE)
#define SecLibsGSIpthr -L$(GLOBUS_LOCATION)/lib -lglobus_gssapi_gsi_$(GLOBUS_FLAVOUR) -lglobus_gss_assist_$(GLOBUS_FLAVOUR)  $(VOMS_LIB_PTHR)

GSITLIB_OBJS = Csec_plugin_GSI_pthr.Osuf Csec_plugin_GSI_pthr_mapper.Osuf
GSITLIB = SecLibsGSIpthr -lc -lpthread -ldl
SharedLibraryTarget(Csec_plugin_GSI_thread,$(GSITLIB_OBJS),,$(GSITLIB))
GSILIB_OBJS = Csec_plugin_GSI.Osuf Csec_plugin_GSI_mapper.Osuf
GSILIB = SecLibsGSI -lc -lpthread -ldl
SharedLibraryTarget(Csec_plugin_GSI,$(GSILIB_OBJS),,$(GSILIB))

Csec_plugin_GSI.Osuf: Csec_plugin_GSS.c
	$(CC) $(CFLAGS) SecAuthMechGSI SecIncludeDirGSI	-o $@ -c Csec_plugin_GSS.c

Csec_plugin_GSI_mapper.Osuf:  Csec_plugin_GSS_mapper.c
	$(CC) $(CFLAGS) SecAuthMechGSI SecIncludeDirGSI	-o $@ -c Csec_plugin_GSS_mapper.c

Csec_plugin_GSI_pthr.Osuf: Csec_plugin_GSS.c
	$(CC) $(CFLAGS) -Dwith_pthr_suffix SecAuthMechGSI SecIncludeDirGSIpthr	-o $@ -c Csec_plugin_GSS.c

Csec_plugin_GSI_pthr_mapper.Osuf:  Csec_plugin_GSS_mapper.c
	$(CC) $(CFLAGS) -Dwith_pthr_suffix SecAuthMechGSI SecIncludeDirGSIpthr	-o $@ -c Csec_plugin_GSS_mapper.c
#endif

#if UseKRB5
#if UseHeimdalKrb5
#define SecAuthMechKRB5    -DKRB5 -DHEIMDAL
#else
#define SecAuthMechKRB5    -DKRB5 
#endif
#define SecIncludeDirKRB5 $(shell Krb5Config gssapi --cflags)
#define SecLibsKRB5 $(shell Krb5Config gssapi --libs)
KRB5LIB_OBJS = Csec_plugin_KRB5.Osuf Csec_plugin_KRB5_mapper.Osuf
KRB5LIB = SecLibsKRB5 -lc -lpthread -ldl
SharedLibraryTarget(Csec_plugin_KRB5,$(KRB5LIB_OBJS),,$(KRB5LIB))

Csec_plugin_KRB5.Osuf: Csec_plugin_GSS.c
	$(CC) $(CFLAGS) SecAuthMechKRB5 SecIncludeDirKRB5	-o $@ -c Csec_plugin_GSS.c

Csec_plugin_KRB5_mapper.Osuf:  Csec_plugin_GSS_mapper.c
	$(CC) $(CFLAGS) SecAuthMechKRB5 SecIncludeDirKRB5	-o $@ -c Csec_plugin_GSS_mapper.c
#endif

IDLIB_OBJS = Csec_plugin_ID.Osuf
IDLIB = -lc -lpthread -ldl
SharedLibraryTarget(Csec_plugin_ID,$(KRB5LIB_OBJS),,$(KRB5LIB))

LIBMANPAGE(Csec_api)
