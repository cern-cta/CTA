COMM
COMM  Copyright (C) 2003 by CERN/IT/ADC/CA
COMM  All rights reserved
COMM
COMM       @(#)Imakefile,v 1.1 2004/01/12 10:31:40 CERN IT/ADC/CA  Ben Couturier
 
COMM    Make CASTOR Security package

COMM######################### FLAGS ##############################

#include <Project.tmpl>

CSEC_LIBVER=1.0.1
CSEC_LIBMAJVER=1
CSEC_PLUGINVER=1.0.1
CSEC_PLUGINMAJVER=1

INCLUDES = FileName(..,h)
#if _AIX
LIBS = -L../lib -lshift
#else
#if defined(__alpha) && defined(__osf__)
LIBS = -no_so -L../lib -lshift -so_archive
#else
#if hpux
LIBS = -L../lib -lshift
#else
#if linux
LIBS = -L../lib -lshift $(ADNSLIB) -lnsl
#else
#if sgi
LIBS = -L../lib -lshift
#else
#if SOLARIS
LIBS = -L../lib -lshift -lsocket -lnsl
#else
#if _WIN32
LIBS = ..\lib\shift.lib wsock32.lib advapi32.lib
#endif
#endif
#endif
#endif
#endif
#endif
#endif

#if BuildSecurity 	
SECLIB = LibraryTargetName(security)
SECLIB_UTIL_OBJS = Csec_errmsg.Osuf Csec_apiinit.Osuf Csec_common.Osuf
SECLIB_OBJS = Csec_api.Osuf $(SECLIB_UTIL_OBJS)
#endif

#if SecMakeStaticLibrary
SECLIB_STATIC_OBJS =  Csec_static_loader.Osuf Csec_plugin_ID.Osuf 
#if UseKRB5
SECLIB_GSS_OBJS = Csec_plugin_KRB5.Osuf Csec_plugin_KRB5_mapper.Osuf
#else
#if UseGSI
SECLIB_GSS_OBJS = Csec_plugin_GSI.Osuf Csec_plugin_GSI_mapper.Osuf
#else
#if UseKRB4
SECLIB_KRB4_OBJS = Csec_plugin_KRB4.Osuf
#endif
#endif
#endif
SECLIB_OBJS = Csec_protocol_policy.Osuf Csec_api.Osuf  $(SECLIB_UTIL_OBJS) $(SECLIB_STATIC_OBJS) $(SECLIB_GSS_OBJS) $(SECLIB_KRB4_OBJS)
#endif

CSEC_MECHLIST=CSEC_Mechlist
CFLAGS = $(DFLAGS) $(MTCCFLAGS) -g -DCSEC_DEFAULT_MECHS="\"$(CSEC_MECHLIST)\"" -DCSEC_PLUGIN_LIBSUFFIX="\"$(CSEC_PLUGINMAJVER)\"" -I$(INCLUDES) 
LDFLAGS =  SecLibs

COMM######################### DEPENDENCY LIBRARIES ###############
 
DEPLIB = DepSharedLibraryTargetName(shlib,shift)
 
COMM######################### RULES ##############################

#if SecMakeStaticLibrary
ALL_TARGETS = $(SECLIB)
#else

ALL_TARGETS = $(SECLIB) SharedLibraryTargetName(Csec_plugin_ID)
#if UseGSI
ALL_TARGETS += SharedLibraryTargetName(Csec_plugin_GSI)
#endif
#if UseKRB5
ALL_TARGETS += SharedLibraryTargetName(Csec_plugin_KRB5)
#endif
#if UseKRB4
ALL_TARGETS += SharedLibraryTargetName(Csec_plugin_KRB4)
#endif
#endif

all: $(ALL_TARGETS)

#if  SecMakeStaticLibrary

NormalLibraryTarget(security,$(SECLIB_OBJS))

#if UseGSI
Csec_plugin_GSI.Osuf: Csec_plugin_GSS.c
	$(CC) $(CFLAGS) SecAuthMechGSI SecIncludeDirGSI	-o $@ -c Csec_plugin_GSS.c

Csec_plugin_GSI_mapper.Osuf:  Csec_plugin_GSS_mapper.c
	$(CC) $(CFLAGS) SecAuthMechGSI SecIncludeDirGSI	-o $@ -c Csec_plugin_GSS_mapper.c
#else
#if UseKRB5
Csec_plugin_KRB5.Osuf: Csec_plugin_GSS.c
	$(CC) $(CFLAGS) SecAuthMechKRB5 SecIncludeDirKRB5	-o $@ -c Csec_plugin_GSS.c

Csec_plugin_KRB5_mapper.Osuf:  Csec_plugin_GSS_mapper.c
	$(CC) $(CFLAGS) SecAuthMechKRB5 SecIncludeDirKRB5	-o $@ -c Csec_plugin_GSS_mapper.c
#else
#if UseKRB4

Csec_plugin_KRB4.Osuf: Csec_plugin_KRB4.c 
	$(CC) $(CFLAGS) SecIncludeDirKRB4	-o $@ -c Csec_plugin_KRB4.c
#endif
#endif
#endif
#else

NormalLibraryTarget(security,$(SECLIB_OBJS))

Csec_api_loader.Osuf: Csec_api_loader.c
	$(CC) $(CFLAGS) -rdynamic -c -o Csec_api_loader.Osuf Csec_api_loader.c

#if UseGSI
SharedLibraryTargetName(Csec_plugin_GSI): $(SECLIB_UTIL_OBJS) Csec_plugin_GSI.Osuf Csec_plugin_GSI_mapper.Osuf $(DEPLIB)
	ld  $(SHLIBLDFLAGS) -o $@ $?   SecLibsGSI  $(DEPLIB)

Csec_plugin_GSI.Osuf: Csec_plugin_GSS.c
	$(CC) $(CFLAGS) SecAuthMechGSI SecIncludeDirGSI	-o $@ -c Csec_plugin_GSS.c

Csec_plugin_GSI_mapper.Osuf:  Csec_plugin_GSS_mapper.c
	$(CC) $(CFLAGS) SecAuthMechGSI SecIncludeDirGSI	-o $@ -c Csec_plugin_GSS_mapper.c
#endif

#if UseKRB5
SharedLibraryTargetName(Csec_plugin_KRB5): $(SECLIB_UTIL_OBJS) Csec_plugin_KRB5.Osuf Csec_plugin_KRB5_mapper.Osuf $(DEPLIB)
	ld  $(SHLIBLDFLAGS) -o $@ $? SecLibsKRB5 $(DEPLIB)

Csec_plugin_KRB5.Osuf: Csec_plugin_GSS.c
	$(CC) $(CFLAGS) SecAuthMechKRB5 SecIncludeDirKRB5	-o $@ -c Csec_plugin_GSS.c

Csec_plugin_KRB5_mapper.Osuf:  Csec_plugin_GSS_mapper.c
	$(CC) $(CFLAGS) SecAuthMechKRB5 SecIncludeDirKRB5	-o $@ -c Csec_plugin_GSS_mapper.c
#endif

#if UseKRB4
SharedLibraryTargetName(Csec_plugin_KRB4): $(SECLIB_UTIL_OBJS) Csec_plugin_KRB4.Osuf  $(DEPLIB)
	ld  $(SHLIBLDFLAGS) -o $@ $? SecLibsKRB4 $(DEPLIB)

Csec_plugin_KRB4.Osuf: Csec_plugin_KRB4.c 
	$(CC) $(CFLAGS) SecIncludeDirKRB4	-o $@ -c Csec_plugin_KRB4.c
#endif


SharedLibraryTargetName(Csec_plugin_ID): $(SECLIB_UTIL_OBJS) Csec_plugin_ID.Osuf $(DEPLIB)
	ld  $(SHLIBLDFLAGS) -o $@ $?  $(DEPLIB)

Csec_plugin_ID.Osuf: Csec_plugin_ID.c
	$(CC) $(CFLAGS) -o $@ -c Csec_plugin_ID.c
#endif

MakeDepSharedLibrary(shlib,shift)

install:

export:

exportman:

exportshr:

COMM###################### CLEANING RULES ########################
 
clean:
	-@RemoveFiles(FilesToClean)
 
clobber:        clean
	-@RemoveFiles($(CLIENT))
 
#if _WIN32
depend:
	@echo Not supported on this platform
#else
depend:
	makedepend -Y$(INCLUDES) *.c 2> /dev/null
#endif

Makefiles:
 
FORCE:

COMM###################### DEPENDENCIES ##########################

COMM DO NOT DELETE THIS LINE -- make  depend  depends  on  it.
