/*
 * Copyright (C) 1993-2001 by CERN/IT/PDP/DM
 * All rights reserved
 */

/*
 */

#define NullParameter

#define ManPageTargetName(name,suffix) $(EXPORTMAN)/man/**/suffix/name.suffix/**/castor

#define MANPAGE(name,suffix,insttarget)                                   \
ManPageTargetName(name,suffix):	LOCAL_PATH/$(PREFIX(MANSUBDIR))name.man	@@\
	@echo Installing $@                                             @@\
	install -d $(EXPORTMAN)/man/**/suffix                           @@\
	cp LOCAL_PATH/$(PREFIX(MANSUBDIR))name.man ManPageTargetName(name,suffix) @@\
insttarget: ManPageTargetName(name,suffix)

#define EXEMANPAGE(name) MANPAGE(name,1,install)
#define SYSMANPAGE(name) MANPAGE(name,2,install)
#define LIBMANPAGE(name) MANPAGE(name,3,install)
#define FILEMANPAGE(name) MANPAGE(name,4,install)
#define ADMMANPAGE(name) MANPAGE(name,8,install)

#define TAPEEXEMANPAGE(name) MANPAGE(name,1,installtape)
#define TAPESYSMANPAGE(name) MANPAGE(name,2,installtape)
#define TAPELIBMANPAGE(name) MANPAGE(name,3,installtape)
#define TAPEFILEMANPAGE(name) MANPAGE(name,4,installtape)
#define TAPEADMMANPAGE(name) MANPAGE(name,8,installtape)

#define CLIENTEXEMANPAGE(name) MANPAGE(name,1,installclient)
#define CLIENTSYSMANPAGE(name) MANPAGE(name,2,installclient)
#define CLIENTLIBMANPAGE(name) MANPAGE(name,3,installclient)
#define CLIENTFILEMANPAGE(name) MANPAGE(name,4,installclient)
#define CLIENTADMMANPAGE(name) MANPAGE(name,8,installclient)

#define RemoveFiles(files) rm -f files
#define AddLdFlags(flags) PREFIX(LDFLAGS) += flags

#define PROC(file)                                    \
LOCAL_PATH/file.c: LOCAL_PATH/file.pc               @@\
	@echo "Preprocessing" $@                    @@\
	cd LOCAL_PATH; export ORACLE_HOME=$(ORACLE_HOME) LD_LIBRARY_PATH=$(LD_LIBRARY_PATH):$(ORACLE_LIBDIR); $(ORACLE_BIN)/proc iname=file $(ORACLE_PROCINC) include=__back_to_root__/h threads=yes char_map=string parse=full prefetch=1000; cd - @@\
COMM We overwrite here the default rule for the compilation of the Pro*C interface code @@\
COMM in order to be able to discard the -Werror present in the standard flags. The      @@\
COMM reason is that the code generated by proc is full of warnings...                   @@\
LOCAL_PATH/file.o: LOCAL_PATH/file.c                @@\
	@echo Compiling $@                          @@\
	$(COMPILE.c) $(OUTPUT_OPTION) -Wno-error $< @@\
PREFIX(FilesToClean) += LOCAL_PATH/file.c LOCAL_PATH/file.lis

#define InternalInstallTarget(file,mode,dest,insttarget,deps,subdir) \
$(DESTDIR)/dest/file: LOCAL_PATH/subdir/**/file deps               @@\
	@echo Installing $@                                        @@\
	install -d $(DESTDIR)/dest -m 0755                         @@\
	install -m mode $< $(DESTDIR)/dest                         @@\
insttarget: $(DESTDIR)/dest/file

#define InstallTarget(file,mode) \
InternalInstallTarget(file,mode,$(BINDIR),install,,)

#define InstallLink(tofile,fromfile,mode,dest,component) \
$(DESTDIR)/dest/tofile: fromfile                       @@\
	@echo Installing $@                            @@\
	install -d $(DESTDIR)/dest -m 0755             @@\
	RemoveFiles($@)                                @@\
	ln -s $< $@                                    @@\
install/**/component: $(DESTDIR)/dest/tofile

#define LinkFile(tofile,fromfile,mode,component) \
LOCAL_PATH/tofile: LOCAL_PATH/fromfile         @@\
	@echo Installing $@                    @@\
	RemoveFiles($@)                        @@\
	ln -s $< $@                            @@\
component: LOCAL_PATH/tofile                   @@\
FilesToClobber += LOCAL_PATH/tofile            @@\
InstallLink(tofile,LOCAL_PATH/fromfile,mode,$(BINDIR),component)

#define DepSourceName(dirname,source)../dirname/source
#define BareSharedLibraryTargetName(libname)libname.so
#define SharedLibraryName(libname)BareSharedLibraryTargetName(libname).$(MAJOR_CASTOR_VERSION)
#define SharedLibraryFullName(libname)SharedLibraryName(libname).$(MINOR_CASTOR_VERSION)
#define SharedLibraryTargetName(libname)SharedLibraryName(lib/**/libname)
#define InstallLibraryTargetNames(deplibs)$(if deplibs,$(addprefix $(DESTDIR)/$(LIBDIR)/,$(subst .$(MAJOR_CASTOR_VERSION),,$(notdir deplibs))))
#define DepSharedLibraryTargetName(directory,libname)$(CASTOR_ROOT)/directory/SharedLibraryName(lib/**/libname)

#define InternalSchModTarget(libname,obj,deplibs,libs,directory)                                                \
LOCAL_PATH/BareSharedLibraryTargetName(libname): obj deplibs $(PREFIX(DEPLIB))                                @@\
	@echo "  Linking" $@                                                                                  @@\
	$(CC) DYLIBLINKEROPTION -fPIC -o $@ obj libs $(PREFIX(LIBS)) $(LDFLAGS) $(PREFIX(LDFLAGS))            @@\
$(DESTDIR)/directory/BareSharedLibraryTargetName(libname): LOCAL_PATH/BareSharedLibraryTargetName(libname)    @@\
	install -d $(DESTDIR)/directory                                                                       @@\
	install -m 644 LOCAL_PATH/BareSharedLibraryTargetName(libname) $(DESTDIR)/directory/BareSharedLibraryTargetName(libname) @@\
install: directory $(DESTDIR)/directory/BareSharedLibraryTargetName(libname)                                  @@\
all: LOCAL_PATH/BareSharedLibraryTargetName(libname)                                                          @@\
PREFIX(FilesToClean) += obj $(patsubst %.o,%.d,obj)                                                           @@\
PREFIX(FilesToClobber) += LOCAL_PATH/BareSharedLibraryTargetName(libname)                                     @@\
obj: %.o: %.d

#define BareSharedLibraryTarget(libname,objects,deplibs,libs,directory,alltgt,installtgt,withso)     \
libname: LOCAL_PATH/SharedLibraryName(libname)                                                     @@\
BareSharedLibraryTargetName(libname): LOCAL_PATH/SharedLibraryName(libname)                        @@\
LOCAL_PATH/SharedLibraryName(libname): objects deplibs                                             @@\
	@echo "  Linking" $@                                                                       @@\
	$(CC) DYLIBLINKEROPTION NOUNDEFLINKEROPTION -o $@ -Wl,SONAMELINKEROPTION,SharedLibraryName(libname) objects $(LIBS) libs $(LDFLAGS) $(PREFIX(LDFLAGS))             @@\
$(DESTDIR)/directory/BareSharedLibraryTargetName(libname): LOCAL_PATH/SharedLibraryName(libname) InstallLibraryTargetNames(deplibs) InstallLibraryTargetNames(deplibs) @@\
	install -d $(DESTDIR)/directory                                                            @@\
	install $< $(DESTDIR)/directory/SharedLibraryFullName(libname)                             @@\
	rm -f $(DESTDIR)/directory/SharedLibraryName(libname) $@                                   @@\
	ln -s SharedLibraryFullName(libname) $(DESTDIR)/directory/SharedLibraryName(libname)       @@\
ifeq (installtgt,installclient)                                                                    @@\
	ln -s SharedLibraryName(libname) $@                                                        @@\
else                                                                                               @@\
ifeq (withso,yes)                                                                                  @@\
	ln -s SharedLibraryName(libname) $@                                                        @@\
endif                                                                                              @@\
endif                                                                                              @@\
installtgt: $(DESTDIR)/directory/BareSharedLibraryTargetName(libname)                              @@\
alltgt: LOCAL_PATH/SharedLibraryName(libname)                                                      @@\
PREFIX(FilesToClean) += objects $(patsubst %.o,%.d,objects)                                        @@\
PREFIX(FilesToClobber) += LOCAL_PATH/SharedLibraryName(libname)                                    @@\
objects: %.o: %.d

#define SchModTarget(libname,obj,deplibs,libs,directory) InternalSchModTarget(libname,$(patsubst %,LOCAL_PATH/%,obj),deplibs,libs,directory)
#define SharedLibraryTarget(libname,objects,deplibs,libs) BareSharedLibraryTarget(lib/**/libname,$(patsubst %,LOCAL_PATH/%,objects),$(PREFIX(COMMONDEPLIB)) $(PREFIX(DEPLIB)) deplibs,$(PREFIX(COMMONLIBS)) $(PREFIX(LIBS)) libs,$(LIBDIR),all,install,no)
#define PlacedSharedLibraryTarget(libname,objects,deplibs,libs,directory) BareSharedLibraryTarget(lib/**/libname,$(patsubst %,LOCAL_PATH/%,objects),$(PREFIX(COMMONDEPLIB)) $(PREFIX(DEPLIB)) deplibs,$(PREFIX(COMMONLIBS)) $(PREFIX(LIBS)) libs,directory,all,install,no)
#define PlacedSharedLibraryTargetWithSo(libname,objects,deplibs,libs,directory) BareSharedLibraryTarget(lib/**/libname,$(patsubst %,LOCAL_PATH/%,objects),$(PREFIX(COMMONDEPLIB)) $(PREFIX(DEPLIB)) deplibs,$(PREFIX(COMMONLIBS)) $(PREFIX(LIBS)) libs,directory,all,install,yes)
#define ClientSharedLibraryTarget(libname,objects,deplibs,libs) BareSharedLibraryTarget(lib/**/libname,$(patsubst %,LOCAL_PATH/%,objects),$(PREFIX(COMMONDEPLIB)) $(PREFIX(CLIENTDEPLIB)) deplibs,$(PREFIX(COMMONLIBS)) $(PREFIX(CLIENTLIBS)) libs,$(LIBDIR),client,installclient,no)
#define TapeSharedLibraryTarget(libname,objects,deplibs,libs) BareSharedLibraryTarget(lib/**/libname,$(patsubst %,LOCAL_PATH/%,objects),$(PREFIX(COMMONDEPLIB)) $(PREFIX(TAPEDEPLIB)) deplibs,$(PREFIX(COMMONLIBS)) $(PREFIX(TAPELIBS)) libs,$(LIBDIR),tape,installtape,no)

#define ClientInstallNonExecFile(file,dest,mode) \
InternalInstallTarget(file,mode,dest,installclient,,)

#define InstallNonExecFile(file,dest,mode) \
InternalInstallTarget(file,mode,dest,install,,)

#define InstallNonExecFileSubdir(file,dest,mode,subdir) \
InternalInstallTarget(file,mode,dest,install,,subdir)

#define InstallSubTree(dir,dest,mode,insttarget) \
$(DESTDIR)/dest/dir: LOCAL_PATH/dir            @@\
	@echo Installing $@                        @@\
	install -d $(DESTDIR)/dest -m 0755         @@\
	cp -R $< $(DESTDIR)/dest                   @@\
	find $@ -type f -exec chmod mode \{\} \;   @@\
	find $@ -type d -exec chmod 0755 \{\} \;   @@\
insttarget: $(DESTDIR)/dest/dir

#define GenericMakeDir(dirname,mode,insttarget) \
ifndef dirname                                @@\
  dirname = 1                                 @@\
$(DESTDIR)/dirname:                           @@\
	install -d $(DESTDIR)/dirname -m mode @@\
endif                                         @@\
insttarget: $(DESTDIR)/dirname

#define MakeDir(dirname,mode) GenericMakeDir(dirname,mode,install)
#define TapeMakeDir(dirname,mode) GenericMakeDir(dirname,mode,installtape)
#define ClientMakeDir(dirname,mode) GenericMakeDir(dirname,mode,installclient)

#define MakeDirWithOwnership(dirname,owner,group,mode)   \
ifndef dirname                                @@\
  dirname = 1                                 @@\
$(DESTDIR)/dirname:                           @@\
	if [ "`whoami`" = "root" ]; then install -d $(DESTDIR)dirname -o owner -g group -m mode; else install -d $(DESTDIR)dirname -m mode; fi @@\
endif                                         @@\
install: $(DESTDIR)/dirname

#define ProgramTarget(program,objects,deplibs,libs,mode,alltarget,installtarget)   \
program: LOCAL_PATH/program                                                      @@\
LOCAL_PATH/program: objects deplibs	                                         @@\
	@echo "  Linking" $@                                                     @@\
	$(CC) -o $@ objects libs $(LDFLAGS) $(PREFIX(LDFLAGS))                   @@\
alltarget: LOCAL_PATH/program                                                    @@\
InternalInstallTarget(program,mode,$(BINDIR),install/**/installtarget,InstallLibraryTargetNames(deplibs),) @@\
PREFIX(FilesToClean) += objects $(patsubst %.o,%.d,objects)                      @@\
PREFIX(FilesToClobber) += LOCAL_PATH/program                                     @@\
objects: %.o: %.d

#define NormalProgramTarget(program,objects,deplibs,libs,mode) \
ProgramTarget(program,$(patsubst %,LOCAL_PATH/%,objects),$(PREFIX(COMMONDEPLIB)) $(PREFIX(DEPLIB)) deplibs,$(PREFIX(COMMONLIBS)) $(PREFIX(LIBS)) libs,mode,all,)

#define ClientProgramTarget(program,objects,deplibs,libs,mode) \
ProgramTarget(program,$(patsubst %,LOCAL_PATH/%,objects),$(PREFIX(COMMONDEPLIB)) $(PREFIX(CLIENTDEPLIB)) deplibs,$(PREFIX(COMMONLIBS)) $(PREFIX(CLIENTLIBS)) libs,mode,client,client)

#define TapeProgramTarget(program,objects,deplibs,libs,mode) \
ProgramTarget(program,$(patsubst %,LOCAL_PATH/%,objects),$(PREFIX(COMMONDEPLIB)) $(PREFIX(TAPEDEPLIB)) deplibs,$(PREFIX(COMMONLIBS)) $(PREFIX(TAPELIBS)) libs,mode,tape,tape)

/* manual list of dependencies to solve the -rpath issue. Not very nice */
#define commonRPath -Wl,RPATHLINKEROPTION,$(CASTOR_ROOT)/common
#define upvRPath -Wl,RPATHLINKEROPTION,$(CASTOR_ROOT)/upv
#define securityRPath -Wl,RPATHLINKEROPTION,$(CASTOR_ROOT)/security
#define dlfRPath -Wl,RPATHLINKEROPTION,$(CASTOR_ROOT)/dlf
#define rfioRPath -Wl,RPATHLINKEROPTION,$(CASTOR_ROOT)/rfio
#define nsRPath -Wl,RPATHLINKEROPTION,$(CASTOR_ROOT)/ns
#define vmgrRPath -Wl,RPATHLINKEROPTION,$(CASTOR_ROOT)/vmgr
#define vdqmRPath -Wl,RPATHLINKEROPTION,$(CASTOR_ROOT)/vdqm
#define castorRPath -Wl,RPATHLINKEROPTION,$(CASTOR_ROOT)/castor
#define cnvRPath -Wl,RPATHLINKEROPTION,$(CASTOR_ROOT)/castor/db/cnv
#define oraRPath -Wl,RPATHLINKEROPTION,$(CASTOR_ROOT)/castor/db/newora
#define BuildRPathcastorcommon 
#define BuildRPathcastorupv commonRPath
#define BuildRPathcastorsecurity commonRPath
#define BuildRPathcastordlf commonRPath
#define BuildRPathcastorcnvs commonRPath castorRPath dlfRPath nsRPath securityRPath
#define BuildRPathcastorvdqm commonRPath
#define BuildRPathcastorvmgr commonRPath upvRPath
#define BuildRPathcastorns commonRPath securityRPath upvRPath
#define BuildRPathcastorclient commonRPath securityRPath upvRPath dlfRPath nsRPath
#define BuildRPathcastorexpert commonRPath upvRPath nsRPath vmgrRPath vdqmRPath
#define BuildRPathcastorrmc commonRPath
#define BuildRPathcastorrtcopy commonRPath dlfRPath castorRPath 
#define BuildRPathcastorrfio commonRPath securityRPath castorRPath dlfRPath nsRPath
#define BuildRPathcastortape commonRPath dlfRPath securityRPath rfioRPath vmgrRPath upvRPath castorRPath vdqmRPath nsRPath
#define BuildRPathcastormonitor commonRPath castorRPath
#define BuildRPathcastorcommonora commonRPath cnvRPath dlfRPath vmgrRPath upvRPath
#define BuildRPathcastorvdqmora commonRPath cnvRPath dlfRPath vmgrRPath upvRPath oraRPath
#define BuildRPathcastortapegatewayprotocol commonRPath securityRPath nsRPath dlfRPath castorRPath
#define BuildRPathcastortapelegacymsg commonRPath securityRPath nsRPath dlfRPath castorRPath
#define BuildRPathcastortapenet commonRPath securityRPath nsRPath dlfRPath castorRPath
#define BuildRPathcastortapeutils commonRPath securityRPath nsRPath dlfRPath castorRPath
#define BuildRPathcastortapebridge

#define DependsOnLibrary(directory,libname)                                           \
PREFIX(DEPLIB) += DepSharedLibraryTargetName(directory,libname)                     @@\
PREFIX(LIBS) += DepSharedLibraryTargetName(directory,libname) BuildRPath/**/libname @@\
include $(CASTOR_ROOT)/directory/Makefile

#define ClientDependsOnLibrary(directory,libname)                                           \
PREFIX(CLIENTDEPLIB) += DepSharedLibraryTargetName(directory,libname)                     @@\
PREFIX(CLIENTLIBS) += DepSharedLibraryTargetName(directory,libname) BuildRPath/**/libname @@\
include $(CASTOR_ROOT)/directory/Makefile

#define TapeDependsOnLibrary(directory,libname)                                           \
PREFIX(TAPEDEPLIB) += DepSharedLibraryTargetName(directory,libname)                     @@\
PREFIX(TAPELIBS) += DepSharedLibraryTargetName(directory,libname) BuildRPath/**/libname @@\
include $(CASTOR_ROOT)/directory/Makefile

#define CommonDependsOnLibrary(directory,libname)                                           \
PREFIX(COMMONDEPLIB) += DepSharedLibraryTargetName(directory,libname)                     @@\
PREFIX(COMMONLIBS) += DepSharedLibraryTargetName(directory,libname) BuildRPath/**/libname @@\
include $(CASTOR_ROOT)/directory/Makefile


#define LOGROTATE(file,tgt)                                  \
$(DESTDIR)/etc/logrotate.d/file: LOCAL_PATH/file.logrotate @@\
	install -d $(DESTDIR)/etc/logrotate.d -m 0755      @@\
	install $< $@                                      @@\
tgt: $(DESTDIR)/etc/logrotate.d/file

#define internalSYSCONFIG(destfile,origfile,tgt)         \
$(DESTDIR)/etc/sysconfig/destfile: LOCAL_PATH/origfile @@\
	install -d $(DESTDIR)/etc/sysconfig -m 0755    @@\
	install -m 644 $< $@                           @@\
tgt: $(DESTDIR)/etc/sysconfig/destfile

#define SYSCONFIG(file,tgt) \
internalSYSCONFIG(file.example,file.sysconfig,tgt)

#define INITSCRIPT(file,tgt)                       \
$(DESTDIR)/etc/init.d/file: LOCAL_PATH/file.init @@\
	install -d $(DESTDIR)/etc/init.d -m 0755 @@\
	install -m 755 $< $@                     @@\
tgt: $(DESTDIR)/etc/init.d/file

#define CONFIGFILE(file,tgt)                                                         \
$(DESTDIR)/etc/castor/file/**/CONFIG.example: LOCAL_PATH/file/**/CONFIG @@\
	install -d $(DESTDIR)/etc/castor -m 0755                                   @@\
	install -m 640 $< $@                                                       @@\
tgt: $(DESTDIR)/etc/castor/file/**/CONFIG.example

#define EXAMPLEFILE(file,dest,tgt)                         \
$(DESTDIR)/dest/file.example: $(CASTOR_ROOT)/debian/file @@\
	install -d $(DESTDIR)/dest -m 0755               @@\
	install -m 644 $< $@                             @@\
tgt: $(DESTDIR)/dest/file.example

#define COMPILECPP(file,flags)                           \
LOCAL_PATH/$(patsubst %.cpp,%.o,file): LOCAL_PATH/file @@\
	@echo Compiling $@                             @@\
	$(COMPILE.cpp) $(OUTPUT_OPTION) flags $<       @@\
LOCAL_PATH/$(patsubst %.cpp,%.d,file): LOCAL_PATH/file @@\
	gcc -MM $(CPPFLAGS) flags $< | sed -n "H;$$ {g;s,\($*\)\.o[ :]*,\1.o $@ : ,;p;}" > $@

#define COMPILEC(file,flags)                           \
LOCAL_PATH/$(patsubst %.c,%.o,file): LOCAL_PATH/file @@\
	@echo Compiling $@                           @@\
	$(COMPILE.c) $(OUTPUT_OPTION) flags $<       @@\
LOCAL_PATH/$(patsubst %.c,%.d,file): LOCAL_PATH/file @@\
	gcc -MM $(CPPFLAGS) flags $< | sed -n "H;$$ {g;s,\($*\)\.o[ :]*,\1.o $@ : ,;p;}" > $@

COMM Replacement for the default rules, in order to not display all compilation commands by default

%.o: %.c %.d
	@echo Compiling $@
	$(COMPILE.c) $(OUTPUT_OPTION) $<

%.o: %.cpp %.d
	@echo Compiling $@
	$(COMPILE.cpp) $(OUTPUT_OPTION) $<
