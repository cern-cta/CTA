/*
 * Copyright (C) 1993-2001 by CERN/IT/PDP/DM
 * All rights reserved
 */

/*
 * @(#)$RCSfile: Imake.rules,v $ $Revision: 1.33 $ $Date: 2009/06/05 08:11:27 $ CERN IT-PDP/DM   Jean-Philippe Baud
 */

#define NullParameter

#define ManPageTargetName(name,suffix) $(EXPORTMAN)/man/**/suffix/name.suffix/**/castor
#define UglyTarget(suffix) 's/^\.so \.?\/?(\w+)(.*)/\.so man'/**/suffix/**/'\/$${1}\.'/**/suffix/**/'castor/g'

#define MANPAGE(name,suffix) \
ManPageTargetName(name,suffix):	$(MANSUBDIR)name.man	@@\
	@install -d $(EXPORTMAN)/man/**/suffix          @@\
	@echo Installing man page name.man              @@\
	@cat $(MANSUBDIR)name.man | perl -pe 's/^.TH +([^ ]+) *\"?(\d+)\"?/\.TH $${1} \"$${2}castor\"/g' | perl -pe UglyTarget(suffix) > ManPageTargetName(name,suffix) @@\
exportman: ManPageTargetName(name,suffix)

#define EXEMANPAGE(name) MANPAGE(name,1)
#define SYSMANPAGE(name) MANPAGE(name,2)
#define LIBMANPAGE(name) MANPAGE(name,3)
#define FILEMANPAGE(name) MANPAGE(name,4)
#define ADMMANPAGE(name) MANPAGE(name,8)

#define RemoveFiles(files) rm -f files

#define InternalInstallTarget(file,mode,dest,insttarget,deps) \
$(DESTDIR)/dest/file: $(INSUBDIR)file deps  @@\
	install -d $(DESTDIR)/dest -m 0755  @@\
	install -m mode $< $(DESTDIR)/dest  @@\
insttarget: $(DESTDIR)/dest/file            @@\

#define InstallTarget(file,mode,dest) \
InternalInstallTarget(file,mode,dest,install,)

#define InstallLink(tofile,fromfile,mode,dest,component) \
$(DESTDIR)/dest/tofile: fromfile           @@\
	install -d $(DESTDIR)/dest -m 0755 @@\
	RemoveFiles($@)                    @@\
	ln -s $< $@                        @@\
install/**/component: $(DESTDIR)/dest/tofile

#define LinkFile(tofile,fromfile,mode,component) \
tofile: fromfile                @@\
	RemoveFiles($@)         @@\
	ln -s $< $@             @@\
component: tofile               @@\
FilesToClobber += tofile        @@ \
InstallLink(tofile,fromfile,mode,$(BIN),component)

#define DepSourceName(dirname,source)../dirname/source
#define BareSharedLibraryTargetName(libname)libname.so
#define SharedLibraryName(libname)BareSharedLibraryTargetName(libname).$(MAJOR_CASTOR_VERSION)
#define SharedLibraryFullName(libname)SharedLibraryName(libname).$(MINOR_CASTOR_VERSION)
#define SharedLibraryTargetName(libname)SharedLibraryName(lib/**/libname)
#define DepSharedLibraryTargetName(dir,libname)../dir/SharedLibraryName(lib/**/libname)
#define InstallLibraryTargetNames(deplibs)$(if deplibs,$(addprefix $(DESTDIR)/$(LIBDIR)/,$(subst .$(MAJOR_CASTOR_VERSION),,$(notdir deplibs))))

#define SchModTarget(libname,obj,deplibs,libs,dir)                                                                \
BareSharedLibraryTargetName(libname): obj deplibs                                                               @@\
	$(LD) DYLIBLINKEROPTION -fPIC -o $@ $(CPPFLAGS) obj libs                                                @@\
$(DESTDIR)/dir/BareSharedLibraryTargetName(libname): BareSharedLibraryTargetName(libname)                       @@\
	@install -d $(DESTDIR)/dir                                                                              @@\
	install -m 644 BareSharedLibraryTargetName(libname) $(DESTDIR)/dir/BareSharedLibraryTargetName(libname) @@\
install: dir $(DESTDIR)/dir/BareSharedLibraryTargetName(libname)                                                @@\
all: BareSharedLibraryTargetName(libname)                                                                       @@\
FilesToClean += obj BareSharedLibraryTargetName(libname)                                                            @@\
FilesToClobber += BareSharedLibraryTargetName(libname)

#define BareSharedLibraryTarget(libname,objects,deplibs,libs,dir,alltgt,installtgt)            \
SharedLibraryName(libname): objects deplibs                                                  @@\
	$(LD) DYLIBLINKEROPTION --no-undefined -o $@ $(LDFLAGS) -Wl,SONAMELINKEROPTION,SharedLibraryName(libname) objects libs @@\
$(DESTDIR)/dir/BareSharedLibraryTargetName(libname): SharedLibraryName(libname) InstallLibraryTargetNames(deplibs)             @@\
	@install -d $(DESTDIR)/dir                                                           @@\
	install $< $(DESTDIR)/dir/SharedLibraryFullName(libname)                             @@\
	rm -f $(DESTDIR)/dir/SharedLibraryName(libname) $@                                   @@\
	ln -s SharedLibraryFullName(libname) $(DESTDIR)/dir/SharedLibraryName(libname)       @@\
	ln -s SharedLibraryName(libname) $@                                                  @@\
installtgt: $(DESTDIR)/dir/BareSharedLibraryTargetName(libname)                              @@\
alltgt: SharedLibraryName(libname)                                                           @@\
FilesToClean += objects                                                                      @@\
FilesToClobber += SharedLibraryName(libname)

#define SharedLibraryTarget(libname,objects,deplibs,libs) BareSharedLibraryTarget(lib/**/libname,objects,deplibs,libs,$(LIBDIR),all,install)
#define PlacedSharedLibraryTarget(libname,objects,deplibs,libs,dir) BareSharedLibraryTarget(lib/**/libname,objects,deplibs,libs,dir,all,install)
#define ClientSharedLibraryTarget(libname,objects,deplibs,libs) BareSharedLibraryTarget(lib/**/libname,objects,deplibs,libs,$(LIBDIR),client,installclient)
#define TapeSharedLibraryTarget(libname,objects,deplibs,libs) BareSharedLibraryTarget(lib/**/libname,objects,deplibs,libs,$(LIBDIR),tape,installtape)

#define MakeDepSharedLibrary(dir,libname)                    \
../dir/SharedLibraryName(libname):		           @@\
	cd ../dir ; $(MAKE) SharedLibraryName(libname)     @@\
$(DESTDIR)/$(LIBDIR)/BareSharedLibraryTargetName(libname): @@\
	cd ../dir ; $(MAKE) $@

#define DealWithSubdirs(cmd,dir)             \
	if [ -d dir ] ;                      \
	then                                 \
	  (echo " dir:" ; cd dir ;           \
	  $(MAKE) cmd) ;                     \
	else                                 \
	  (echo "ERROR : No directory dir" ; \
	  exit 1) ;                          \
	fi;

#define GotoSubdirs(dirs)         \
	@for i in dirs ; do       \
	  (DealWithSubdirs($@, $$i)); \
	done;

#define ClientInstallNonExecFile(file,dest,mode) \
InternalInstallTarget(file,mode,dest,installclient,)

#define InstallNonExecFile(file,dest,mode) \
InternalInstallTarget(file,mode,dest,install,)

#define MakeDir(dirname,mode)   \
$(DESTDIR)/dirname:                           @@\
	install -d $(DESTDIR)/dirname -m mode @@\
install: $(DESTDIR)/dirname
#define MakeDirWithOwnership(dirname,owner,group,mode)   \
$(DESTDIR)/dirname:                           @@\
	if [ "`whoami`" = "root" ]; then install -d $(DESTDIR)dirname -o owner -g group -m mode; else install -d $(DESTDIR)dirname -m mode; fi @@\
install: $(DESTDIR)/dirname

#define ProgramTarget(program,objects,deplibs,libs,mode,alltarget,installtarget) \
program: objects deplibs		      @@\
	$(LD) -o $@ $(LDFLAGS) objects libs   @@\
alltarget: program                            @@\
InternalInstallTarget(program,mode,$(BIN),install/**/installtarget,InstallLibraryTargetNames(deplibs)) @@\
FilesToClean += objects                       @@\
FilesToClobber += program

#define NormalProgramTarget(program,objects,deplibs,libs,mode) \
ProgramTarget(program,objects,deplibs,libs,mode,all,)

#define ClientProgramTarget(program,objects,deplibs,libs,mode) \
ProgramTarget(program,objects,deplibs,libs,mode,client,client)

#define TapeProgramTarget(program,objects,deplibs,libs,mode) \
ProgramTarget(program,objects,deplibs,libs,mode,tape,tape)


/* manual list of dependencies to solve the -rpath issue. Not very nice */
#define commonRPath -Wl,RPATHLINKEROPTION,$(CASTOR_ROOT)/common
#define upvRPath -Wl,RPATHLINKEROPTION,$(CASTOR_ROOT)/upv
#define securityRPath -Wl,RPATHLINKEROPTION,$(CASTOR_ROOT)/security
#define dlfRPath -Wl,RPATHLINKEROPTION,$(CASTOR_ROOT)/dlf
#define rfioRPath -Wl,RPATHLINKEROPTION,$(CASTOR_ROOT)/rfio
#define nsRPath -Wl,RPATHLINKEROPTION,$(CASTOR_ROOT)/ns
#define vmgrRPath -Wl,RPATHLINKEROPTION,$(CASTOR_ROOT)/vmgr
#define vdqmRPath -Wl,RPATHLINKEROPTION,$(CASTOR_ROOT)/vdqm
#define castorRPath -Wl,RPATHLINKEROPTION,$(CASTOR_ROOT)/castor
#define cnvRPath -Wl,RPATHLINKEROPTION,$(CASTOR_ROOT)/castor/db/cnv
#define oraRPath -Wl,RPATHLINKEROPTION,$(CASTOR_ROOT)/castor/db/newora
#define BuildRPathcastorcommon 
#define BuildRPathcastorupv commonRPath
#define BuildRPathcastorsecurity commonRPath
#define BuildRPathcastordlf commonRPath
#define BuildRPathcastorcnvs commonRPath castorRPath dlfRPath nsRPath securityRPath
#define BuildRPathcastorvdqm commonRPath
#define BuildRPathcastorvmgr commonRPath upvRPath
#define BuildRPathcastorns commonRPath securityRPath upvRPath
#define BuildRPathcastorclient commonRPath securityRPath upvRPath dlfRPath nsRPath
#define BuildRPathcastorexpert commonRPath upvRPath nsRPath vmgrRPath vdqmRPath
#define BuildRPathcastorrtcopy commonRPath dlfRPath castorRPath 
#define BuildRPathcastorrfio commonRPath securityRPath castorRPath dlfRPath nsRPath
#define BuildRPathcastortape commonRPath securityRPath rfioRPath vmgrRPath upvRPath castorRPath vdqmRPath nsRPath
#define BuildRPathcastormonitor commonRPath castorRPath
#define BuildRPathcastorcommonora commonRPath cnvRPath dlfRPath vmgrRPath upvRPath
#define BuildRPathcastorinfopolicy commonRPath castorRPath oraRPath cnvRPath
#define BuildRPathcastortapeutils commonRPath securityRPath nsRPath dlfRPath castorRPath

#define DependsOnLibrary(dir,libname)                                   \
DEPLIB += DepSharedLibraryTargetName(dir,libname)                     @@\
LIBS += DepSharedLibraryTargetName(dir,libname) BuildRPath/**/libname @@\
MakeDepSharedLibrary(dir,lib/**/libname)

#define ClientDependsOnLibrary(dir,libname)                                   \
CLIENTDEPLIB += DepSharedLibraryTargetName(dir,libname)                     @@\
CLIENTLIBS += DepSharedLibraryTargetName(dir,libname) BuildRPath/**/libname

#define LOGROTATE(file,rootdir,tgt)                              \
$(DESTDIR)/etc/logrotate.d/file: rootdir/debian/file.logrotate @@\
	install -d $(DESTDIR)/etc/logrotate.d -m 0755          @@\
	install $< $@                                          @@\
tgt: $(DESTDIR)/etc/logrotate.d/file

#define internalSYSCONFIG(destfile,origfile,tgt)      \
$(DESTDIR)/etc/sysconfig/destfile: origfile         @@\
	install -d $(DESTDIR)/etc/sysconfig -m 0755 @@\
	install -m 644 $< $@                        @@\
tgt: $(DESTDIR)/etc/sysconfig/destfile

#define SYSCONFIG(file,tgt) \
internalSYSCONFIG(file.example,file.sysconfig,tgt)

#define INITSCRIPT(file,tgt)                           \
$(DESTDIR)/etc/init.d/file: file.init                @@\
	install -d $(DESTDIR)/etc/init.d -m 0755     @@\
	install -m 644 $< $@                         @@\
tgt: $(DESTDIR)/etc/init.d/file

#define CONFIGFILE(file,rootdir,tgt)                                \
$(DESTDIR)/etc/castor/file/**/CONFIG.example: rootdir/debian/file/**/CONFIG @@\
	install -d $(DESTDIR)/etc/castor -m 0755                  @@\
	install -m 640 $< $@                                      @@\
tgt: $(DESTDIR)/etc/castor/file/**/CONFIG.example

#define EXAMPLEFILE(file,orig,dest,tgt)        \
$(DESTDIR)/dest/file.example: orig/file      @@\
	install -d $(DESTDIR)/dest -m 0755   @@\
	install -m 644 $< $@                 @@\
tgt: $(DESTDIR)/dest/file.example
