/*
 * SPDX-FileCopyrightText: 2025 CERN
 * SPDX-License-Identifier: GPL-3.0-or-later
 */

CREATE SCHEMA IF NOT EXISTS __SCHEDULER_SCHEMA_NAME__ AUTHORIZATION __USERNAME__;
SET search_path TO __SCHEDULER_SCHEMA_NAME__ /* we mention __USERNAME__ in this comment to allow removal of this line if no username was provided */;

/* the following statement will change the search_path for future sessions only
 * see (https://stackoverflow.com/questions/57726737/postgres-finding-search-path-for-given-user-and-modifying-it-permanently)
 * the change does not take effect in the current session. That is why we still need the previous statement */
ALTER ROLE __USERNAME__ SET search_path TO @CTA_SCHEDULER_SCHEMA_NAME@, public, pg_catalog;

CREATE TABLE CTA_SCHEDULER(
  SCHEMA_VERSION_MAJOR    NUMERIC(20, 0) CONSTRAINT CTA_SCHEDULER_SVM1_NN NOT NULL,
  SCHEMA_VERSION_MINOR    NUMERIC(20, 0) CONSTRAINT CTA_SCHEDULER_SVM2_NN NOT NULL,
  NEXT_SCHEMA_VERSION_MAJOR NUMERIC(20, 0),
  NEXT_SCHEMA_VERSION_MINOR NUMERIC(20, 0),
  STATUS                  VARCHAR(100),
  IS_PRODUCTION           CHAR(1)         DEFAULT '0' CONSTRAINT CTA_SCHEDULER_IP_NN NOT NULL,
  CONSTRAINT CTA_SCHEDULER_IP_BOOL_CK     CHECK(IS_PRODUCTION IN ('0','1'))
);

INSERT INTO CTA_SCHEDULER(
  SCHEMA_VERSION_MAJOR,
  SCHEMA_VERSION_MINOR,
  STATUS)
VALUES(
  @CTA_SCHEDULER_SCHEMA_VERSION_MAJOR@,
  @CTA_SCHEDULER_SCHEMA_VERSION_MINOR@,
  'PRODUCTION');
