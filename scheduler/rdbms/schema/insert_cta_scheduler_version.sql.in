/*
 * SPDX-FileCopyrightText: 2025 CERN
 * SPDX-License-Identifier: GPL-3.0-or-later
 */

CREATE SCHEMA IF NOT EXISTS @CTA_SCHEDULER_SCHEMA_NAME@ AUTHORIZATION __USERNAME__;
SET search_path TO @CTA_SCHEDULER_SCHEMA_NAME@ /* __USERNAME__ is added here inside a comment to make sureit would be removed for the unit tests */;
/* This is a gross hack that acts as a temporary solution to the following problem:
 * For the unit tests, in order to ensure schema isolation per test, we want the scheduler tables to be created
 * in their own schema. However, this line will always create the scheduler schema in a dedicated schema,
 * overwriting the search path that was set by the unit tests.
 * As a result, when running the unit tests, schema creation would fail.
 * A cleaner solution would be to parametrize the CTA_SCHEDULER_SCHEMA_NAME exactly the way it is done
 * for __USERNAME__, and specify scheduler for the deployment, and a test-specific schema for each unit test. */

/* the following statement will change the search_path for future sessions only
 * see (https://stackoverflow.com/questions/57726737/postgres-finding-search-path-for-given-user-and-modifying-it-permanently)
 * the change does not take effect in the current session. That is why we still need the previous statement */
ALTER ROLE __USERNAME__ SET search_path TO @CTA_SCHEDULER_SCHEMA_NAME@, public, pg_catalog;

CREATE TABLE CTA_SCHEDULER(
  SCHEMA_VERSION_MAJOR    NUMERIC(20, 0) CONSTRAINT CTA_SCHEDULER_SVM1_NN NOT NULL,
  SCHEMA_VERSION_MINOR    NUMERIC(20, 0) CONSTRAINT CTA_SCHEDULER_SVM2_NN NOT NULL,
  NEXT_SCHEMA_VERSION_MAJOR NUMERIC(20, 0),
  NEXT_SCHEMA_VERSION_MINOR NUMERIC(20, 0),
  STATUS                  VARCHAR(100),
  IS_PRODUCTION           CHAR(1)         DEFAULT '0' CONSTRAINT CTA_SCHEDULER_IP_NN NOT NULL,
  CONSTRAINT CTA_SCHEDULER_IP_BOOL_CK     CHECK(IS_PRODUCTION IN ('0','1'))
);

INSERT INTO CTA_SCHEDULER(
  SCHEMA_VERSION_MAJOR,
  SCHEMA_VERSION_MINOR,
  STATUS)
VALUES(
  @CTA_SCHEDULER_SCHEMA_VERSION_MAJOR@,
  @CTA_SCHEDULER_SCHEMA_VERSION_MINOR@,
  'PRODUCTION');
