COMM
COMM  Copyright (C) 1990-2003 by CERN/IT/PDP/DM
COMM  All rights reserved
COMM
COMM       @(#)$RCSfile: Imakefile,v $ $Revision: 1.22 $ $Date: 2009/08/18 09:43:02 $ CERN IT-PDP/DM Jean-Philippe Baud

COMM 	Make tape daemon programs.

TMS = NOTMS
OPSGRP = OperatorGid
LOGDIR = /var/log/castor
SACCTDIR = SacctDir
SACCTFILE = SacctDir/sacct
SCONFIGFILE = ShiftConfigFile
TAPEACCT = tapeacct.o
TPCONFIG = TapeConfigFile
#if !CASTOR_NOSTK
CDKFLG = -DCDK -DLINUX
CDKINC = -I/usr/include/CDK
LIBCDK = -L InstallLibDir/CDK -lapi -lutl -lipc -lcl
#endif
#if BuildSecureTape
SECURITYFLAG=-DCSEC
LDFLAGS += -ldl
#endif

COMM######################### FLAGS ##############################

CPPFLAGS += -DBIN=\"$(BIN)\" -DLOGFILE=\"$(LOGDIR)/taped_legacy.log\" \
	    $(STAGERSUPERUSER) -DTPCONFIG=\"$(TPCONFIG)\" \
	    -D$(TMS) $(PCTAFLAG) -DSACCT -DACCTFILE=\"$(SACCTFILE)\" \
	    -DCONFIGFILE=\"$(SCONFIGFILE)\" $(CDKFLG) -DVDQM -DVMGR \
	    $(CDKINC) $(SECURITYFLAG) -DSCSIINC="\"/usr/include/scsi/sg.h\""

usrlocate.c:	locate.c
	RemoveFiles(usrlocate.c)
	cp locate.c usrlocate.c
usrreadlbl.c:	readlbl.c
	RemoveFiles(usrreadlbl.c)
	cp readlbl.c usrreadlbl.c
usrrwndtape.c:	rwndtape.c
	RemoveFiles(usrrwndtape.c)
	cp rwndtape.c usrrwndtape.c
usrskiptape.c:	skiptape.c
	RemoveFiles(usrskiptape.c)
	cp skiptape.c usrskiptape.c
usrsmcsubr.c:	smcsubr.c
	RemoveFiles(usrsmcsubr.c)
	cp smcsubr.c usrsmcsubr.c
usrsmcsubr2.c:	smcsubr2.c
	RemoveFiles(usrsmcsubr2.c)
	cp smcsubr2.c usrsmcsubr2.c
usrtperror.c:	tperror.c
	RemoveFiles(usrtperror.c)
	cp tperror.c usrtperror.c
usrusrmsg.c:	usrmsg.c
	RemoveFiles(usrusrmsg.c)
	cp usrmsg.c usrusrmsg.c
usrwritelbl.c:	writelbl.c
	RemoveFiles(usrwritelbl.c)
	cp writelbl.c usrwritelbl.c
usrwrttpmrk.c:	wrttpmrk.c
	RemoveFiles(usrwrttpmrk.c)
	cp wrttpmrk.c usrwrttpmrk.c

FilesToClean += usrlocate.c usrreadlbl.c usrrwndtape.c usrskiptape.c usrsmcsubr.c usrsmcsubr2.c usrtperror.c usrusrmsg.c usrwritelbl.c usrwrttpmrk.c

sendscsicmd.o: sendscsicmd.c
	$(COMPILE.c) $(OUTPUT_OPTION) -DTAPE $<
usrlocate.o: usrlocate.c ../h/Ctape.h ../h/serrno.h
	$(COMPILE.c) $(OUTPUT_OPTION) -DNOTRACE $<
usrreadlbl.o: usrreadlbl.c ../h/Ctape.h ../h/serrno.h
	$(COMPILE.c) $(OUTPUT_OPTION) -DNOTRACE $<
usrrwndtape.o: usrrwndtape.c ../h/Ctape.h
	$(COMPILE.c) $(OUTPUT_OPTION) -DNOTRACE $<
usrskiptape.o: usrskiptape.c ../h/Ctape.h
	$(COMPILE.c) $(OUTPUT_OPTION) -DNOTRACE $<
usrsmcsubr.o: usrsmcsubr.c ../h/Ctape.h ../h/scsictl.h ../h/smc.h
	$(COMPILE.c) $(OUTPUT_OPTION) -DNOTRACE $<
usrsmcsubr2.o: usrsmcsubr2.c ../h/Ctape.h ../h/smc.h
	$(COMPILE.c) $(OUTPUT_OPTION) -DNOTRACE $<
usrtperror.o: usrtperror.c ../h/Ctape.h ../h/serrno.h
	$(COMPILE.c) $(OUTPUT_OPTION) -DNOTRACE $<
usrusrmsg.o:	usrusrmsg.c ../h/Ctape.h
	$(COMPILE.c) $(OUTPUT_OPTION) -DNOTRACE $<
usrwritelbl.o: usrwritelbl.c ../h/Ctape.h
	$(COMPILE.c) $(OUTPUT_OPTION) -DNOTRACE $<
usrwrttpmrk.o: usrwrttpmrk.c ../h/Ctape.h
	$(COMPILE.c) $(OUTPUT_OPTION) -DNOTRACE $<

TapeDependsOnLibrary(common,castorcommon)
TapeDependsOnLibrary(vdqm,castorvdqm)
TapeDependsOnLibrary(vmgr,castorvmgr)
TapeDependsOnLibrary(dlf,castordlf)
TapeDependsOnLibrary(rfio,castorrfio)
TapeDependsOnLibrary(upv,castorupv)

TPLIB_OBJS = Ctape_config.o Ctape_devinfo.o Ctape_dmpfil.o Ctape_drvinfo.o Ctape_errmsg.o Ctape_info.o Ctape_kill.o Ctape_label.o Ctape_mount.o Ctape_position.o Ctape_reserve.o Ctape_rls.o Ctape_rstatus.o Ctape_status.o asc2ebc.o chkdirw.o cvtden.o ebc2asc.o findpgrp.o getcompstat.o initlabel.o send2tpd.o tmscheck.o usrlbl.o usrlocate.o usrreadlbl.o usrrwndtape.o usrskiptape.o usrsmcsubr.o usrsmcsubr2.o usrtperror.o usrusrmsg.o usrwritelbl.o usrwrttpmrk.o tplogger.o tplogger_messages.o sendscsicmd.o
RMCLIB_OBJS = ../rmc/rmc_dismount.o ../rmc/rmc_errmsg.o ../rmc/rmc_export.o ../rmc/rmc_find_cartridge.o ../rmc/rmc_get_geometry.o ../rmc/rmc_import.o ../rmc/rmc_mount.o ../rmc/rmc_read_elem_status.o ../rmc/send2rmc.o
TapeSharedLibraryTarget(castortape,$(TPLIB_OBJS) $(RMCLIB_OBJS) $(IBMR2_OBJS),,)

LIBMANPAGE(Ctape_dmpfil)
LIBMANPAGE(Ctape_info)
LIBMANPAGE(Ctape_kill)
LIBMANPAGE(Ctape_label)
LIBMANPAGE(Ctape_mount)
LIBMANPAGE(Ctape_position)
LIBMANPAGE(Ctape_reserve)
LIBMANPAGE(Ctape_rls)
LIBMANPAGE(Ctape_rstatus)
LIBMANPAGE(Ctape_status)
LIBMANPAGE(getcompstat)
LIBMANPAGE(readlbl)
LIBMANPAGE(rwndtape)
LIBMANPAGE(skiptape)
LIBMANPAGE(usrlbl)
LIBMANPAGE(wrttpmrk)

TAPELIB = SharedLibraryTargetName(castortape)

TapeProgramTarget(tpconfig,tpconfig.o,$(TAPELIB),$(TAPELIB),755)
TapeProgramTarget(tprstat,tprstat.o,$(TAPELIB),$(TAPELIB),755)
TapeProgramTarget(tpstat,tpstat.o,$(TAPELIB),$(TAPELIB),755)
EXEMANPAGE(tpconfig)
EXEMANPAGE(tprstat)
EXEMANPAGE(tpstat)

TapeMakeDir($(LOGDIR),0755)
TAPED_OBJS = tpdaemon.o checkjobdied.o cvtden.o sendrep.o tplogit.o usrmsg.o
CONFDRIVE_OBJS = confdrive.o sendrep.o tplogit.o
MOUNTTAPE_OBJS = mounttape.o asc2ebc.o buildhdrlbl.o buildvollbl.o ebc2asc.o getdrvstatus.o inquiry.o rbtsubr.o readlbl.o rwndtape.o send2tpd.o sendrep.o sendtmsmount.o setdens.o skiptape.o smcsubr.o tperror.o tplogit.o unldtape.o usrmsg.o writelbl.o wrttpmrk.o mircheck.o
POSOVL_OBJS = posovl.o buildhdrlbl.o builduhl.o buildvollbl.o ebc2asc.o getdrvstatus.o inquiry.o locate.o posittape.o readlbl.o rwndtape.o send2tpd.o sendrep.o skiptape.o tperror.o tplogit.o usrmsg.o
RLSTAPE_OBJS = rlstape.o getdrvstatus.o rbtsubr.o send2tpd.o smcsubr.o sendrep.o sendtmsmount.o tperror.o tplogit.o usrmsg.o unldtape.o tapealertcheck.o
TapeProgramTarget(taped,$(TAPED_OBJS) $(IBMR2_OBJS) $(TAPEACCT),$(TAPELIB),$(TAPELIB),750)
TapeProgramTarget(confdrive,$(CONFDRIVE_OBJS) $(TAPEACCT),$(TAPELIB),$(TAPELIB),750)
TapeProgramTarget(mounttape,$(MOUNTTAPE_OBJS) $(TAPEACCT),$(TAPELIB),$(TAPELIB) $(LIBCDK),750)
TapeProgramTarget(posovl,$(POSOVL_OBJS) $(TAPEACCT),$(TAPELIB),$(TAPELIB),750)
TapeProgramTarget(rlstape,$(RLSTAPE_OBJS) $(TAPEACCT),$(TAPELIB),$(TAPELIB) $(LIBCDK),750)
TapeProgramTarget(smc,smc.o,$(TAPELIB),$(TAPELIB),6755)
TapeProgramTarget(tpdump,tpdump.o,$(TAPELIB),$(TAPELIB),755)
TapeProgramTarget(tplabel,tplabel.o,$(TAPELIB),$(TAPELIB),755)
ADMMANPAGE(taped)
EXEMANPAGE(smc)
EXEMANPAGE(tplabel)
EXEMANPAGE(tpdump)
EXEMANPAGE(tape_oper)
LOGROTATE(castor-tape-server,..,installtape)
LOGROTATE(castor-sacct,..,installtape)
SYSCONFIG(taped,installtape)
INITSCRIPT(taped,installtape)
CONFIGFILE(TP,..,installtape)
