COMM
COMM  Copyright (C) 1990-2003 by CERN/IT/PDP/DM
COMM  All rights reserved
COMM

COMM 	Make tape daemon programs.

TAPEACCT = tapeacct.o

CPPFLAGS += -DBIN=\"$(BINDIR)\"

COMM ######################### FLAGS ##############################

LOCAL_PATH/usrlocate.c: LOCAL_PATH/locate.c
	RemoveFiles($@)
	cp $< $@
LOCAL_PATH/usrreadlbl.c: LOCAL_PATH/readlbl.c
	RemoveFiles($@)
	cp $< $@
LOCAL_PATH/usrrwndtape.c: LOCAL_PATH/rwndtape.c
	RemoveFiles($@)
	cp $< $@
LOCAL_PATH/usrskiptape.c: LOCAL_PATH/skiptape.c
	RemoveFiles($@)
	cp $< $@
LOCAL_PATH/usrtperror.c: LOCAL_PATH/tperror.c
	RemoveFiles($@)
	cp $< $@
LOCAL_PATH/usrusrmsg.c: LOCAL_PATH/usrmsg.c
	RemoveFiles($@)
	cp $< $@
LOCAL_PATH/usrwritelbl.c: LOCAL_PATH/writelbl.c
	RemoveFiles($@)
	cp $< $@
LOCAL_PATH/usrwrttpmrk.c: LOCAL_PATH/wrttpmrk.c
	RemoveFiles($@)
	cp $< $@

PREFIX(FilesToClean) += LOCAL_PATH/usrlocate.c LOCAL_PATH/usrreadlbl.c LOCAL_PATH/usrrwndtape.c LOCAL_PATH/usrskiptape.c LOCAL_PATH/usrtperror.c LOCAL_PATH/usrusrmsg.c LOCAL_PATH/usrwritelbl.c LOCAL_PATH/usrwrttpmrk.c

COMPILEC(sendscsicmd.c,)
COMPILEC(usrlocate.c,-DNOTRACE)
COMPILEC(usrreadlbl.c,-DNOTRACE)
COMPILEC(usrrwndtape.c,-DNOTRACE)
COMPILEC(usrskiptape.c,-DNOTRACE)
COMPILEC(usrtperror.c,-DNOTRACE)
COMPILEC(usrusrmsg.c,-DNOTRACE)
COMPILEC(usrwritelbl.c,-DNOTRACE)
COMPILEC(usrwrttpmrk.c,-DNOTRACE)

TapeDependsOnLibrary(common,castorcommon)
TapeDependsOnLibrary(vdqm,castorvdqm)
TapeDependsOnLibrary(vmgr,castorvmgr)
TapeDependsOnLibrary(dlf,castordlf)
TapeDependsOnLibrary(rfio,castorrfio)
TapeDependsOnLibrary(upv,castorupv)

TPLIB_OBJS = Ctape_config.o Ctape_devinfo.o Ctape_dmpfil.o Ctape_drvinfo.o Ctape_errmsg.o Ctape_info.o Ctape_kill.o Ctape_label.o Ctape_mount.o Ctape_position.o Ctape_reserve.o Ctape_rls.o Ctape_rstatus.o Ctape_status.o asc2ebc.o chkdirw.o cvtden.o ebc2asc.o findpgrp.o getcompstat.o initlabel.o send2tpd.o usrlbl.o usrlocate.o usrreadlbl.o usrrwndtape.o usrskiptape.o usrtperror.o usrusrmsg.o usrwritelbl.o usrwrttpmrk.o tplogger.o tplogger_messages.o sendscsicmd.o
TapeSharedLibraryTarget(castortape,$(TPLIB_OBJS),,)

CLIENTLIBMANPAGE(Ctape_dmpfil)
CLIENTLIBMANPAGE(Ctape_info)
CLIENTLIBMANPAGE(Ctape_kill)
CLIENTLIBMANPAGE(Ctape_label)
CLIENTLIBMANPAGE(Ctape_mount)
CLIENTLIBMANPAGE(Ctape_position)
CLIENTLIBMANPAGE(Ctape_reserve)
CLIENTLIBMANPAGE(Ctape_rls)
CLIENTLIBMANPAGE(Ctape_rstatus)
CLIENTLIBMANPAGE(Ctape_status)
CLIENTLIBMANPAGE(getcompstat)
CLIENTLIBMANPAGE(readlbl)
CLIENTLIBMANPAGE(rwndtape)
CLIENTLIBMANPAGE(skiptape)
CLIENTLIBMANPAGE(usrlbl)
CLIENTLIBMANPAGE(wrttpmrk)

TAPELIB = DepSharedLibraryTargetName(tape,castortape)

TapeProgramTarget(tpconfig,tpconfig.o,$(TAPELIB),$(TAPELIB),755)
TapeProgramTarget(tprstat,tprstat.o,$(TAPELIB),$(TAPELIB),755)
TapeProgramTarget(tpstat,tpstat.o,$(TAPELIB),$(TAPELIB),755)
EXEMANPAGE(tpconfig)
EXEMANPAGE(tprstat)
EXEMANPAGE(tpstat)

TapeMakeDir($(LOGPATH),0755)
TAPED_OBJS = tpdaemon.o checkjobdied.o cvtden.o sendrep.o tplogit.o usrmsg.o
CONFDRIVE_OBJS = confdrive.o sendrep.o tplogit.o
POSOVL_OBJS = posovl.o buildhdrlbl.o builduhl.o buildvollbl.o ebc2asc.o getdrvstatus.o inquiry.o locate.o posittape.o readlbl.o rwndtape.o send2tpd.o sendrep.o skiptape.o tperror.o tplogit.o usrmsg.o
TapeProgramTarget(taped,$(TAPED_OBJS) $(TAPEACCT),$(TAPELIB),$(TAPELIB),755)
TapeProgramTarget(confdrive,$(CONFDRIVE_OBJS) $(TAPEACCT),$(TAPELIB),$(TAPELIB),755)
TapeProgramTarget(posovl,$(POSOVL_OBJS) $(TAPEACCT),$(TAPELIB),$(TAPELIB),755)
TapeProgramTarget(tplabel,tplabel.o,$(TAPELIB),$(TAPELIB),755)
ADMMANPAGE(taped)
EXEMANPAGE(tplabel)
EXEMANPAGE(tape_oper)
LOGROTATE(castor-tape-server,installtape)
LOGROTATE(castor-sacct,installtape)
SYSCONFIG(taped,installtape)
INITSCRIPT(taped,installtape)
CONFIGFILE(TP,installtape)

COMM The mounttape process depends on libcastorrmc.so therefore the rules to
COMM build it need to be included
include $(CASTOR_ROOT)/rmc/Makefile

# Compile no STK version
MOUNTTAPE_NOSTK_OBJS = mounttape.o asc2ebc.o buildhdrlbl.o buildvollbl.o ebc2asc.o getdrvstatus.o inquiry.o rbtsubr.o readlbl.o rwndtape.o send2tpd.o sendrep.o setdens.o skiptape.o tperror.o tplogit.o unldtape.o usrmsg.o writelbl.o wrttpmrk.o mircheck.o
MOUNTTAPE_NOSTK_DEPLIBS = DepSharedLibraryTargetName(tape,castortape) DepSharedLibraryTargetName(rmc,castorrmc)
MOUNTTAPE_NOSTK_LIBS = $(MOUNTTAPE_NOSTK_DEPLIBS) BuildRPathcastorrmc
TapeProgramTarget(mounttape-nostk,$(MOUNTTAPE_NOSTK_OBJS) $(TAPEACCT),$(MOUNTTAPE_NOSTK_DEPLIBS),$(MOUNTTAPE_NOSTK_LIBS),755)

RLSTAPE_NOSTK_OBJS = rlstape.o getdrvstatus.o rbtsubr.o send2tpd.o sendrep.o tperror.o tplogit.o usrmsg.o unldtape.o tapealertcheck.o
RLSTAPE_NOSTK_DEPLIBS = DepSharedLibraryTargetName(tape,castortape) DepSharedLibraryTargetName(rmc,castorrmc)
RLSTAPE_NOSTK_LIBS = $(RLSTAPE_NOSTK_DEPLIBS) BuildRPathcastorrmc
TapeProgramTarget(rlstape-nostk,$(RLSTAPE_NOSTK_OBJS) $(TAPEACCT),$(RLSTAPE_NOSTK_DEPLIBS),$(RLSTAPE_NOSTK_LIBS),755)

# Compile STK objects. Note: only 2 objects, mounttape and rbtsubr need to be recompiled with STK options
ifeq ($(CASTOR_NOSTK),)
CDKFLG = -DCDK -DLINUX
CDKINC = -I/usr/include/CDK
LIBCDK = -L $(LIBDIR)/CDK -lapi -lutl -lipc -lcl

LOCAL_PATH/mounttape-stk.c: $(CASTOR_ROOT)/tape/mounttape.c
	RemoveFiles($@)
	cp $< $@
PREFIX(FilesToClean) += LOCAL_PATH/mounttape-stk.c
COMPILEC(mounttape-stk.c, $(CDKFLG) $(CDKINC))

LOCAL_PATH/rbtsubr-stk.c: $(CASTOR_ROOT)/tape/rbtsubr.c
	RemoveFiles($@)
	cp $< $@
PREFIX(FilesToClean) += LOCAL_PATH/rbtsubr-stk.c
COMPILEC(rbtsubr-stk.c, $(CDKFLG) $(CDKINC))

# Compile STK version
MOUNTTAPE_STK_OBJS = mounttape-stk.o asc2ebc.o buildhdrlbl.o buildvollbl.o ebc2asc.o getdrvstatus.o inquiry.o rbtsubr-stk.o readlbl.o rwndtape.o send2tpd.o sendrep.o setdens.o skiptape.o tperror.o tplogit.o unldtape.o usrmsg.o writelbl.o wrttpmrk.o mircheck.o
MOUNTTAPE_STK_DEPLIBS = DepSharedLibraryTargetName(tape,castortape) DepSharedLibraryTargetName(rmc,castorrmc)
MOUNTTAPE_STK_LIBS = $(LIBCDK) $(MOUNTTAPE_STK_DEPLIBS) BuildRPathcastorrmc
TapeProgramTarget(mounttape,$(MOUNTTAPE_STK_OBJS) $(TAPEACCT),$(MOUNTTAPE_STK_DEPLIBS),$(MOUNTTAPE_STK_LIBS),755)

RLSTAPE_STK_OBJS = rlstape.o getdrvstatus.o rbtsubr-stk.o send2tpd.o sendrep.o tperror.o tplogit.o usrmsg.o unldtape.o tapealertcheck.o
RLSTAPE_STK_DEPLIBS = DepSharedLibraryTargetName(tape,castortape) DepSharedLibraryTargetName(rmc,castorrmc)
RLSTAPE_STK_LIBS = $(LIBCDK) $(RLSTAPE_STK_DEPLIBS) BuildRPathcastorrmc
TapeProgramTarget(rlstape,$(RLSTAPE_STK_OBJS) $(TAPEACCT),$(RLSTAPE_STK_DEPLIBS),$(RLSTAPE_STK_LIBS),755)
endif
