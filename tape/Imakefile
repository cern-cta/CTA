COMM
COMM  Copyright (C) 1990-2003 by CERN/IT/PDP/DM
COMM  All rights reserved
COMM
COMM       @(#)$RCSfile: Imakefile,v $ $Revision: 1.17 $ $Date: 2009/02/16 10:56:36 $ CERN IT-PDP/DM Jean-Philippe Baud

COMM 	Make tape daemon programs. 

INCLUDES = ../h
#if BuildRtcopyClient != YES && BuildTapeDaemon == YES
MANDUMP = $(MANDIR)/dumptape.$(MANSUFFIX)
#endif
TMS = NOTMS
VMGRFLG = -DVMGR
VDQMFLG = -DVDQM
OPSGRP = OperatorGid
SPOOL = TapeSpool
SACCTDIR = SacctDir
SACCTFILE = SacctDir/sacct
ACCTFILE = -DACCTFILE=\"$(SACCTFILE)\"
SCONFIGFILE = ShiftConfigFile
CONFIGFILE = -DCONFIGFILE=\"$(SCONFIGFILE)\"
TAPEACCT = tapeacct.Osuf
STAGERSUPERUSER = StagerSuperUser
TPCONFIG = TapeConfigFile
#if !CASTOR_NOSTK && HasCDK
CDK = CDKDir
CDKFLG = -DCDK -DLINUX
CDKINC = -I$(CDK)/include/CDK
#ifdef __x86_64
LIBCDK = -L$(CDK)/lib64/CDK -lapi -lutl -lapi -lipc -lcl
#else
LIBCDK = -L$(CDK)/lib/CDK -lapi -lutl -lapi -lipc -lcl
#endif
#endif
#if BuildSecureTape
SECURITYFLAG=-DCSEC
LIBS+= -ldl
#endif  

COMM######################### FLAGS ##############################

DFLAGS = -DBIN=\"$(BIN)\" \
	 -DLOGFILE=\"$(SPOOL)/log\" \
	 -DSTAGERSUPERUSER=\"$(STAGERSUPERUSER)\" \
	 -DTPCONFIG=\"$(TPCONFIG)\" \
	 -D$(TMS) $(PCTAFLAG) $(ADSTARFLG) $(ACCTFLAG) $(ACCTFILE) \
	 $(CONFIGFILE) $(CDKFLG) $(VDQMFLG) $(VMGRFLG) 

CFLAGS = -I$(INCLUDES) $(MTCCFLAGS) $(DFLAGS) $(CDKINC) $(SECURITYFLAG)

sendscsicmd.c:	DepSourceName(common,sendscsicmd.c)
	RemoveFiles(sendscsicmd.c)
	$(CP) DepSourceName(common,sendscsicmd.c) sendscsicmd.c
usrlocate.c:	locate.c
	RemoveFiles(usrlocate.c)
	$(CP) locate.c usrlocate.c
usrreadlbl.c:	readlbl.c
	RemoveFiles(usrreadlbl.c)
	$(CP) readlbl.c usrreadlbl.c
usrrwndtape.c:	rwndtape.c
	RemoveFiles(usrrwndtape.c)
	$(CP) rwndtape.c usrrwndtape.c
usrskiptape.c:	skiptape.c
	RemoveFiles(usrskiptape.c)
	$(CP) skiptape.c usrskiptape.c
usrsmcsubr.c:	smcsubr.c
	RemoveFiles(usrsmcsubr.c)
	$(CP) smcsubr.c usrsmcsubr.c
usrsmcsubr2.c:	smcsubr2.c
	RemoveFiles(usrsmcsubr2.c)
	$(CP) smcsubr2.c usrsmcsubr2.c
usrtperror.c:	tperror.c
	RemoveFiles(usrtperror.c)
	$(CP) tperror.c usrtperror.c
usrusrmsg.c:	usrmsg.c
	RemoveFiles(usrusrmsg.c)
	$(CP) usrmsg.c usrusrmsg.c
usrwritelbl.c:	writelbl.c
	RemoveFiles(usrwritelbl.c)
	$(CP) writelbl.c usrwritelbl.c
usrwrttpmrk.c:	wrttpmrk.c
	RemoveFiles(usrwrttpmrk.c)
	$(CP) wrttpmrk.c usrwrttpmrk.c

FilesToClean += sendscsicmd.c usrlocate.c usrreadlbl.c usrrwndtape.c usrskiptape.c usrsmcsubr.c usrsmcsubr2.c usrtperror.c usrusrmsg.c usrwritelbl.c usrwrttpmrk.c

sendscsicmd.Osuf:	sendscsicmd.c ../h/Ctape.h ../h/scsictl.h
	@if [ -f "/usr/src/linux/include/scsi/sg.h" ] ;\
	then \
		echo $(CC) -c -I$(INCLUDES) $(MTCCFLAGS) -DTAPE -DSCSIINC="\"/usr/src/linux/include/scsi/sg.h\"" sendscsicmd.c ;\
		$(CC) -c -I$(INCLUDES) $(MTCCFLAGS) -DTAPE -DSCSIINC="\"/usr/src/linux/include/scsi/sg.h\"" sendscsicmd.c ;\
	else \
		echo $(CC) -c -I$(INCLUDES) $(MTCCFLAGS) -DTAPE -DSCSIINC="\"/usr/include/scsi/sg.h\"" sendscsicmd.c ;\
		$(CC) -c -I$(INCLUDES) $(MTCCFLAGS) -DTAPE -DSCSIINC="\"/usr/include/scsi/sg.h\"" sendscsicmd.c ;\
	fi

usrlocate.Osuf:	usrlocate.c ../h/Ctape.h ../h/serrno.h
	$(CC) -c -I$(INCLUDES) $(MTCCFLAGS) -DNOTRACE usrlocate.c
usrreadlbl.Osuf:	usrreadlbl.c ../h/Ctape.h ../h/serrno.h
	$(CC) -c -I$(INCLUDES) $(MTCCFLAGS) -DNOTRACE $(PCTAFLAG) $(ADSTARFLG) usrreadlbl.c
usrrwndtape.Osuf:	usrrwndtape.c ../h/Ctape.h
	$(CC) -c -I$(INCLUDES) $(MTCCFLAGS) -DNOTRACE usrrwndtape.c
usrskiptape.Osuf:	usrskiptape.c ../h/Ctape.h
	$(CC) -c -I$(INCLUDES) $(MTCCFLAGS) -DNOTRACE usrskiptape.c
usrsmcsubr.Osuf:	usrsmcsubr.c ../h/Ctape.h ../h/scsictl.h ../h/smc.h
	$(CC) -c -I$(INCLUDES) $(MTCCFLAGS) -DNOTRACE usrsmcsubr.c
usrsmcsubr2.Osuf:	usrsmcsubr2.c ../h/Ctape.h ../h/smc.h
	$(CC) -c -I$(INCLUDES) $(MTCCFLAGS) -DNOTRACE usrsmcsubr2.c
usrtperror.Osuf:	usrtperror.c ../h/Ctape.h ../h/serrno.h
	$(CC) -c -I$(INCLUDES) $(MTCCFLAGS) -DNOTRACE usrtperror.c
usrusrmsg.Osuf:	usrusrmsg.c ../h/Ctape.h
	$(CC) -c -I$(INCLUDES) $(MTCCFLAGS) -DNOTRACE usrusrmsg.c
usrwritelbl.Osuf:	usrwritelbl.c ../h/Ctape.h
	$(CC) -c -I$(INCLUDES) $(MTCCFLAGS) -DNOTRACE usrwritelbl.c
usrwrttpmrk.Osuf:	usrwrttpmrk.c ../h/Ctape.h
	$(CC) -c -I$(INCLUDES) $(MTCCFLAGS) -DNOTRACE usrwrttpmrk.c

DependsOnLibrary(common,castorcommon)
DependsOnLibrary(vdqm,castorvdqm)
DependsOnLibrary(vmgr,castorvmgr)
DependsOnLibrary(dlf,castordlf)
DependsOnLibrary(rfio,castorrfio)
DependsOnLibrary(upv,castorupv)
TAPELIB = -L. -lcastortape
TAPEDEP = SharedLibraryTargetName(castortape)

#if BuildTapeClient
NormalProgramTarget(tpconfig,tpconfig.Osuf,$(TAPEDEP) $(DEPLIB),$(LIBS) $(TAPELIB),root,$(OPSGRP),755)
NormalProgramTarget(tprstat,tprstat.Osuf,$(TAPEDEP) $(DEPLIB),$(LIBS) $(TAPELIB),root,bin,755)
NormalProgramTarget(tpstat,tpstat.Osuf,$(TAPEDEP) $(DEPLIB),$(LIBS) $(TAPELIB),root,bin,755)
EXEMANPAGE(tpconfig)
EXEMANPAGE(tprstat)
EXEMANPAGE(tpstat)
#endif

#if BuildTapeDaemon
MakeDir($(SPOOL),root,bin,0755)
MakeDir($(SACCTDIR),root,bin,0777)
TPDAEMON_OBJS = tpdaemon.Osuf checkjobdied.Osuf cvtden.Osuf sendrep.Osuf tplogit.Osuf usrmsg.Osuf
CONFDRIVE_OBJS = confdrive.Osuf sendrep.Osuf tplogit.Osuf
MOUNTTAPE_OBJS = mounttape.Osuf asc2ebc.Osuf buildhdrlbl.Osuf buildvollbl.Osuf ebc2asc.Osuf getdrvstatus.Osuf inquiry.Osuf lddisplay.Osuf rbtsubr.Osuf readlbl.Osuf rwndtape.Osuf send2tpd.Osuf sendrep.Osuf sendtmsmount.Osuf sendscsicmd.Osuf setdens.Osuf skiptape.Osuf smcsubr.Osuf tperror.Osuf tplogit.Osuf unldtape.Osuf usrmsg.Osuf writelbl.Osuf wrttpmrk.Osuf mircheck.Osuf
POSOVL_OBJS = posovl.Osuf buildhdrlbl.Osuf builduhl.Osuf buildvollbl.Osuf ebc2asc.Osuf getdrvstatus.Osuf inquiry.Osuf locate.Osuf posittape.Osuf readlbl.Osuf rwndtape.Osuf send2tpd.Osuf sendrep.Osuf sendscsicmd.Osuf skiptape.Osuf tperror.Osuf tplogit.Osuf usrmsg.Osuf
RLSTAPE_OBJS = rlstape.Osuf getdrvstatus.Osuf lddisplay.Osuf rbtsubr.Osuf send2tpd.Osuf sendscsicmd.Osuf smcsubr.Osuf sendrep.Osuf sendtmsmount.Osuf tperror.Osuf tplogit.Osuf usrmsg.Osuf unldtape.Osuf tapealertcheck.Osuf 
NormalProgramTarget(tpdaemon,$(TPDAEMON_OBJS) $(IBMR2_OBJS) $(TAPEACCT), $(TAPEDEP) $(DEPLIB),$(LIBS) $(TAPELIB),root,$(OPSGRP),750)
NormalProgramTarget(confdrive,$(CONFDRIVE_OBJS) $(TAPEACCT),$(TAPEDEP) $(DEPLIB),$(LIBS) $(TAPELIB),root,$(OPSGRP),750)
NormalProgramTarget(mounttape,$(MOUNTTAPE_OBJS) $(TAPEACCT),$(TAPEDEP) $(DEPLIB),$(LIBS) $(TAPELIB) $(LIBCDK),root,$(OPSGRP),750)
NormalProgramTarget(posovl,$(POSOVL_OBJS) $(TAPEACCT),$(TAPEDEP) $(DEPLIB),$(LIBS) $(TAPELIB),root,$(OPSGRP),750)
NormalProgramTarget(rlstape,$(RLSTAPE_OBJS) $(TAPEACCT), $(TAPEDEP) $(DEPLIB),$(LIBS) $(TAPELIB) $(LIBCDK),root,$(OPSGRP),750)
NormalProgramTarget(smc,smc.Osuf,$(TAPEDEP) $(DEPLIB),$(LIBS) $(TAPELIB),root,bin,6755)
NormalProgramTarget(tpdump,tpdump.Osuf,$(TAPEDEP) $(DEPLIB),$(LIBS) $(TAPELIB),root,bin,755)
NormalProgramTarget(tplabel,tplabel.Osuf,$(TAPEDEP) $(DEPLIB),$(LIBS) $(TAPELIB),root,bin,755)
LinkFile(dumptape,tpdump,root,bin,755)
FilesToClobber += dumptape
ADMMANPAGE(tpdaemon)
EXEMANPAGE(smc)
EXEMANPAGE(tplabel)
EXEMANPAGE(dumptape)
EXEMANPAGE(tape_oper)
#endif

#if BuildTpusage
NormalProgramTarget(tpusage,tpusage.Osuf,$(TAPEDEP) $(DEPLIB),$(LIBS) $(TAPELIB),root,bin,755)
EXEMANPAGE(tpusage)
#endif

#if BuildTapeLibrary
TPLIB_OBJS = Ctape_config.Osuf Ctape_devinfo.Osuf Ctape_dmpfil.Osuf Ctape_drvinfo.Osuf Ctape_errmsg.Osuf Ctape_info.Osuf Ctape_kill.Osuf Ctape_label.Osuf Ctape_mount.Osuf Ctape_position.Osuf Ctape_reserve.Osuf Ctape_rls.Osuf Ctape_rstatus.Osuf Ctape_status.Osuf asc2ebc.Osuf chkdirw.Osuf cvtden.Osuf ebc2asc.Osuf findpgrp.Osuf getcompstat.Osuf initlabel.Osuf send2tpd.Osuf tmscheck.Osuf usrlbl.Osuf usrlocate.Osuf usrreadlbl.Osuf usrrwndtape.Osuf usrskiptape.Osuf usrsmcsubr.Osuf usrsmcsubr2.Osuf usrtperror.Osuf usrusrmsg.Osuf usrwritelbl.Osuf usrwrttpmrk.Osuf tplogger.Osuf tplogger_messages.Osuf 
RMCLIB_OBJS = ../rmc/rmc_dismount.Osuf ../rmc/rmc_errmsg.Osuf ../rmc/rmc_export.Osuf ../rmc/rmc_find_cartridge.Osuf ../rmc/rmc_get_geometry.Osuf ../rmc/rmc_import.Osuf ../rmc/rmc_mount.Osuf ../rmc/rmc_read_elem_status.Osuf ../rmc/send2rmc.Osuf
SharedLibraryTarget(castortape,$(TPLIB_OBJS) $(RMCLIB_OBJS) $(IBMR2_OBJS),$(DEPLIB),$(LIBS))
#endif

LIBMANPAGE(Ctape_dmpfil)
LIBMANPAGE(Ctape_info)
LIBMANPAGE(Ctape_kill)
LIBMANPAGE(Ctape_label)
LIBMANPAGE(Ctape_mount)
LIBMANPAGE(Ctape_position)
LIBMANPAGE(Ctape_reserve)
LIBMANPAGE(Ctape_rls)
LIBMANPAGE(Ctape_rstatus)
LIBMANPAGE(Ctape_status)
LIBMANPAGE(getcompstat)
LIBMANPAGE(readlbl)
LIBMANPAGE(rwndtape)
LIBMANPAGE(skiptape)
LIBMANPAGE(usrlbl)
LIBMANPAGE(wrttpmrk)
