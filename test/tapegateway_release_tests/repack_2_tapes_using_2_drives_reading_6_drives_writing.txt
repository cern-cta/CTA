THE NAME OF TEST
================

Repack 2 tapes using 2 drives reading 6 drives writing


THE PURPOSE OF THE TEST
=======================

The principle responsibility of the tape gateway is to coordinate the transfer
of files to and from tape.

This test verifies that the tape-gateway will.... 

The tape-gateway is responsible for retying failed recall based on a
user-define policy. The tape-gateway does this by executing a Python-script
which provides the policy user-coded logic for deciding whether or not a failed
recall should be repeated based on the error code that is being generating
and the number of prevous retries.


THE PREREQUISITES OF THE TEST
=============================

* A test-stager running the tape-gateway where you can carry out the test.
* A user account that permits the modification of the service-class within the
  stager.
* Eight free tape-drive which can access the test-tapes.
* A user account that permits the dedication of drives within the VDQM.
* Set TAPEGATEWAY REC_RETRY_POLICY in castor.conf to point to a Python module
  which contains a function of the same name which returns 0 in the case of a
  ........ error code.


INSTRUCTIONS DESCRIBING HOW TO SET UP THE ENVIRONMENT OF THE TEST
=================================================================

1. Dedicate read-only (mode=0), 2 tape drives which can read the 2 input test-tapes:

vdqm_admin -dedicate -dgn 359B1B -drive 35921011 -server tpsrv212 -match 'mode=0'
vdqm_admin -dedicate -dgn 359B1B -drive 35921012 -server tpsrv213 -match 'mode=0'

2. Create yourself a repack-destination tape-pool with 6 tapes.  It would be ideal if
   there are enough drives to mount in parallel each tape for writing.

vmgrenterpool --name gatewayrepack --user murrayc3 --group c3

vmgrmodifytape -V I12021 --pool gatewayrepack
vmgrmodifytape -V I12025 --pool gatewayrepack
vmgrmodifytape -V I12027 --pool gatewayrepack
vmgrmodifytape -V I12029 --pool gatewayrepack
vmgrmodifytape -V I12030 --pool gatewayrepack
vmgrmodifytape -V I12031 --pool gatewayrepack

3. Choose a service class for your test and make sure it has your newly created tape pool as its one and only tape pool:

modifySvcClass --Name default --AddTapePools gatewaytest

4. Make sure your service class will use exactly 6 drives for migrations:

modifySvcClass --Name default --NbDrives 6


modifySvcClass --Name largedisk1 --RemoveTapePools gatewaystress
modifySvcClass --Name largedisk1 --AddTapePools gatewayrepack

5. Modify the migrate an stram policies to return always TRUE.

vi /etc/castor/policies/migration.py
...
def migratorPolicyAlwaysReturning1(tapepool, castorfilename,copynb,fileId,fileSize,fileMode,uid,gid,aTime,mTime,cTime,fileClass):
  return 1
...


vi /etc/castor/policies/stream.py
...
def streamPolicyAlwaysReturning1(runningStreams,numFiles,dataVolume,maxNumStreams,age):
  return 1
...

modifySvcClass --Name largedisk1 --MigratorPolicy migratorPolicyAlwaysReturning1
modifySvcClass --Name largedisk1 --StreamPolicy streamPolicyAlwaysReturning1


INSTRUCTIONS DESCRIBING HOW TO CARRY OUT THE TEST
=================================================

1. For each of the two input test-tapes, store the list of files on the tape in
   file.

nslisttape -V I12018 > ~/nslisttape_I12018.txt
nslisttape -V I12017 > ~/nslisttape_I12017.txt

5. repack 2 tapes

repack -V I12017:I12018 -o largedisk1
[Output]Operation succeeded for tape I12017
[Output]Operation succeeded for tape I12018

6. Monitor the repack process until its end.

7. Check that all files on the 2 tapes has been repacked.

EXPECTED RESULTS
================



INSTRUCTIONS DESCRIBING HOW TO TEAR DOWN THE ENVIRONMENT OF THE TEST
====================================================================

