THE NAME OF THE TEST
====================

Migrate until end of 2 tapes


THE PURPOSE OF THE TEST
=======================

The rtcpd daemon running on a tape server will appear to migrate many files to
a tape concurrently even though files are physically written to tape in a
strictly sequential manner.  The apparent concurrency is achieved by multiple
threads within the rtcpd daemon concurrently reading mutliple files from one
or more CASTOR disk servers into the internal memory-resident cache of the
rtcpd daemon.  This caching mechanism is used to increase performance.

It is the responsibility of the tape gateway to respond to the end of a tape
by retrying the migration of all the files that were being worked on by the
corresponding rtcpd daemon at the moment in time the end of tape was reached.


THE PREREQUISITES OF THE TEST
=============================

TBD


INSTRUCTIONS DESCRIBING HOW TO SET UP THE ENVIRONMENT OF THE TEST
=================================================================

TBD


INSTRUCTIONS DESCRIBING HOW TO CARRY OUT THE TEST
=================================================

1. Create yourself a tape-pool with 2 tapes that can be accessed by your 2
   drives:

vmgrenterpool --name gatewayendtape --user murrayc3 --group c3
vmgrmodifytape -V I12017 --pool gatewayendtape
vmgrmodifytape -V I12018 --pool gatewayendtape

2. Choose a service class for your test and make sure it has your newly created tape pool as its one and only tape pool:

modifySvcClass --Name default --RemoveTapePools
modifySvcClass --Name default --AddTapePools

3. Make sure your service class will use exactly 2 drives for migrations:

modifySvcClass --Name default --NbDrives 1

4. Create an empty directory in CASTOR to store the test files used to fill
   the two tapes.

nsmkdir /castor/cern.ch/user/m/murrayc3/gatewayendtape

5. Make sure the directory has a file class with one tape copy

nslistclass | egrep 'CLASS_ID|CLASS_NAME|NBCOPIES' | grep -B2 'NBCOPIES 1'
...
CLASS_ID 95
CLASS_NAME largeuser
NBCOPIES 1
...
nschclass largeuser /castor/cern.ch/user/m/murrayc3/gatewayendtape

6. Dedicate the 2 test-drives to the test-stager.

vdqm_admin -dedicate -dgn 359B1B -drive 35921011 -server tpsrv212 -match 'host=^lxbrl270[89].cern.ch$'
vdqm_admin -dedicate -dgn 359B1B -drive 35921012 -server tpsrv213 -match 'host=^lxbrl270[89].cern.ch$'

7. Start the remote copy of 2 Terabytes

for I in `seq 20`; do bsub -q 8nh
/afs/cern.ch/user/m/murrayc3/castor/checkout/trunk/test/tapegateway_release_tests/createAndCopyFilesToCastor.sh
castorcert5-A default castorcert5-lb
/castor/cern.ch/user/m/murrayc3/gatewayendtape 100 1024; done


EXPECTED RESULTS
================

TBD


INSTRUCTIONS DESCRIBING HOW TO TEAR DOWN THE ENVIRONMENT OF THE TEST
====================================================================

TBD
