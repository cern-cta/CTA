THE NAME OF TEST
================

Repack 2 tapes.


THE PURPOSE OF THE TEST
=======================

The principle responsibility of the tape gateway is to coordinate the transfer
of files to and from tape.

This test verifies that the tape-gateway will be able to repack 2 tapes
without mixing up the files.


THE PREREQUISITES OF THE TEST
=============================

* A test-stager running the tape-gateway where you can carry out the test.
* A test service-class to act as the destination for repack with the following
  properties:
  - A set of one or more disk-pools that has enough free space to store 2TB
    worth of 100MB test-files.
  - A set of one or more tape-pools that has enough free space to store 2TB
    worth of 100MB test-files. Ideally a total 6 tapes would be advantageous
    because writing 100MB is generally 3 times slower than reaidng 100MB files
  - nbDrives set to at least 1 but 6 is advised because migrating 100 MB is
    generally 3 times slower than recalling them.
  - A stream policy which always returns 1.
  - A migrator policy which always returns 1.
  - Recaller policy set to 'None'.
* Two input test-tapes to be repacked.
* Free tape-drives which can access both the two input test-tapes and the tapes
  in the test repack destination service-class.  An ideal setup would be two
  tape-drives for reading and six tape-drives for writing.  This is ideal
  because the writing of 100MB files is roughly 3 times slower than reading
  100 MB files.


INSTRUCTIONS DESCRIBING HOW TO SET UP THE ENVIRONMENT OF THE TEST
=================================================================

1. Completely fill the two input test-tapes full with 100MB tes-files.  The
   contents of each test-file should be unique.  Two such tapes can be created
   by carrying out the following test and not deleting the files from the name
   server at the end:

svn+ssh://svn.cern.ch/reps/CASTOR/CASTOR2/trunk/test/tapegateway_release_tests/migrate_until_end_of_2_tapes


INSTRUCTIONS DESCRIBING HOW TO CARRY OUT THE TEST
=================================================

1. Create two files each listing the full contents of one of the input
   test-tapes.

CNS_HOST=castorns nslisttape -V I12019 > ~/castorns_nslisttape_I12019
CNS_HOST=castorns nslisttape -V I12022 > ~/castorns_nslisttape_I12022


2. Start repacking the 2 test-tapes.

repack -V I12019:I12022 -o largedisk2
[Output]Operation succeeded for tape I12019
[Output]Operation succeeded for tape I12022

6. Monitor the repack of the two test-tapes until they have been both repacked.

-bash-3.2$ repack -s


EXPECTED RESULTS
================

Using the two file screated at step 1 of the test, verify that all of the
files have been repacked to one of the 6 tapes in the test service-class.

1. Determine the 6 destination tapes:

-bash-3.2$ vmgrlisttape -P gatewayrepack2
I02001   I02001 IBMLIB1B 1000GC   aul gatewayrepack2   931.00GiB 20100211
I02008   I02008 IBMLIB1B 1000GC   aul gatewayrepack2   931.00GiB 20100211
I05581   I05581 IBMLIB1B 1000GC   aul gatewayrepack2   931.00GiB 20091219
I05583   I05583 IBMLIB1B 1000GC   aul gatewayrepack2   931.00GiB 20091218
I05584   I05584 IBMLIB1B 1000GC   aul gatewayrepack2   931.00GiB 20100216
I05587   I05587 IBMLIB1B 1000GC   aul gatewayrepack2   931.00GiB 20091217

2. From the 2 files craeted in step 1 of the test create 2 more files, each
   listing the segment information of each test-file.

for F in `awk '{print $NF;}' ~/castorns_nslisttape_I12019`; do CNS_HOST=castorns nsls -T $F; done > ~/castorns_nsls_T_I12019
for F in `awk '{print $NF;}' ~/castorns_nslisttape_I12022`; do CNS_HOST=castorns nsls -T $F; done > ~/castorns_nsls_T_I12022

3. Check that each file has a segment.  The number of files on each tape
   should match the number of segments found in the previous step.

wc -l ~/castorns_nslisttape_I12019
wc -l ~/castorns_nsls_T_I12019
wc -l ~/castorns_nslisttape_I12022
wc -l ~/castorns_nsls_T_I12022

4. Using the list of 6 destination tapes, count the number of segments on
   those tapes.  The result should each the total number of test-files which
   were on each of input test-tapes before repack was started.

wc -l ~/castorns_nslisttape_I12019
egrep 'I02001|I02008|I05581|I05583|I05584|I05587' castorns_nsls_T_I12019 | wc
wc -l ~/castorns_nslisttape_I12022
egrep 'I02001|I02008|I05581|I05583|I05584|I05587' castorns_nsls_T_I12022 | wc
-l


INSTRUCTIONS DESCRIBING HOW TO TEAR DOWN THE ENVIRONMENT OF THE TEST
====================================================================

Remove all of the 100 MB test-files from the name server.

for F in `awk '{print $NF;}' ~/castorns_nslisttape_I12019`; do CNS_HOST=castorns nsrm $F; done
