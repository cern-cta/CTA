THE NAME OF TEST
================

Repack 2 tapes.


THE PURPOSE OF THE TEST
=======================

The principle responsibility of the tape gateway is to coordinate the transfer
of files to and from tape.

This test verifies that the tape-gateway will be able to repack 2 tapes
without mixing up the files.


THE PREREQUISITES OF THE TEST
=============================

* A test-stager running the tape-gateway where you can carry out the test.
* A test service-class to act as the destination for repack with the following
  properties:
  - A set of one or more disk-pools that has enough free space to store 2TB
    worth of 100MB test-files.
  - A set of one or more tape-pools that has enough free space to store 2TB
    worth of 100MB test-files. Ideally a total 6 tapes would be advantageous
    because writing 100MB is generally 3 times slower than reaidng 100MB files
  - nbDrives set to at least 1 but 6 is advised because migrating 100 MB is
    generally 3 times slower than recalling them.
  - A stream policy which always returns 1.
  - A migrator policy which always returns 1.
  - Recaller policy set to 'None'.
* Two input test-tapes to be repacked.
* Free tape-drives which can access both the two input test-tapes and the tapes
  in the test repack destination service-class.  An ideal setup would be two
  tape-drives for reading and six tape-drives for writing.  This is ideal
  because the writing of 100MB files is roughly 3 times slower than reading
  100 MB files.


INSTRUCTIONS DESCRIBING HOW TO SET UP THE ENVIRONMENT OF THE TEST
=================================================================

1. Completely fill the two input test-tapes full with 100MB tes-files.  The
   contents of each test-file should be unique.  Two such tapes can be created
   by carrying out the following test and not deleting the files from the name
   server at the end:

svn+ssh://svn.cern.ch/reps/CASTOR/CASTOR2/trunk/test/tapegateway_release_tests/migrate_until_end_of_2_tapes


INSTRUCTIONS DESCRIBING HOW TO CARRY OUT THE TEST
=================================================

1. Make sure the two input test-tapes are marked as FULL in the vmgr

vmgrmodifytape -V I02001 --st FULL
vmgrmodifytape -V I05581 --st FULL

2. Create two files each listing the full contents of one of the input
   test-tapes.

VIDS='I02001 I05581';for VID in $VIDS; do CNS_HOST=castorns nslisttape -V $VID | awk '{print $NF;}' > ~/castorns_nslisttape_repack_src_$VID; done

3. Split the lists of files into lists wit 5120 entries:

VIDS='I02001 I05581'; for VID in $VIDS; do split -d -l 5120 ~/castorns_nslisttape_repack_src_$VID ~/castorns_nslisttape_repack_src_split_$VID; done

4. Clear the disk cache of all the files on the 2 tapes to be repacked:

for F in `ls ~ | grep castorns_nslisttape_repack_src_split_* | grep -v after_`; do stager_rm -S '*' -f ~/$F; done

5. Get the status of each of the files to be repacked

for F in `ls ~ | grep castorns_nslisttape_repack_src_split_* | grep -v after_`; do stager_qry -S '*' -f ~/$F > ~/${F}_after_stager_rm; done

6. Check that all of the files to be repacked have been cleared from the disk
   cache.

for F in ~/castorns_nslisttape_repack_src_split_*_after_stager_rm; do echo $F; wc -l $F; egrep 'INVALID|not on disk cache' $F | wc -l; done
[ouput] 5120
[ouput] /afs/cern.ch/user/m/murrayc3/castorns_nslisttape_repack_src_split_I0200100_after_stager_rm
[ouput] 5120
[ouput] /afs/cern.ch/user/m/murrayc3/castorns_nslisttape_repack_src_split_I0200101_after_stager_rm
[ouput] 4886
[ouput] /afs/cern.ch/user/m/murrayc3/castorns_nslisttape_repack_src_split_I0200101_after_stager_rm
[ouput] 4886
[ouput] /afs/cern.ch/user/m/murrayc3/castorns_nslisttape_repack_src_split_I0558100_after_stager_rm
[ouput] 4628
[ouput] /afs/cern.ch/user/m/murrayc3/castorns_nslisttape_repack_src_split_I0558100_after_stager_rm
[ouput] 4628

7. Start repacking the 2 test-tapes.

repack -V I02001 -o largedisk2
[Output]Operation succeeded for tape I02001

repack -V I05581 -o largedisk2
[Output]Operation succeeded for tape I05581

8. Monitor the repack of the two test-tapes until they have both been repacked.

-bash-3.2$ repack -s


EXPECTED RESULTS
================

1. From the 2 files created in step 2 of the test create 2 more files, each
   listing the segment information of each test-file.

VIDS='I02001 I05581'; for VID in $VIDS; do for F in `cat ~/castorns_nslisttape_repack_src_$VID`; do CNS_HOST=castorns nsls -T $F; done > ~/castorns_nslisttape_repack_dst_from_$VID; done

2. Check that each file has a segment.  The number of files on each tape
   should match the number of segments found in the previous step.

wc -l ~/castorns_nslisttape_repack_src_I02001
wc -l ~/castorns_nslisttape_repack_dst_from_I02001
wc -l ~/castorns_nslisttape_repack_src_I05581
wc -l ~/castorns_nslisttape_repack_dst_from_I05581

3. Check that each file has moved to one of the destination tapes


wc -l ~/castorns_nslisttape_repack_src_I02001
egrep 'I02008|I05583|I05584|I05587' ~/castorns_nslisttape_repack_dst_from_I02001 | wc -l
wc -l ~/castorns_nslisttape_repack_src_I05581
egrep 'I02008|I05583|I05584|I05587' ~/castorns_nslisttape_repack_dst_from_I05581 | wc -l


INSTRUCTIONS DESCRIBING HOW TO TEAR DOWN THE ENVIRONMENT OF THE TEST
====================================================================

Remove all of the 100 MB test-files from the name server.

for F in `cat ~/castorns_nslisttape_repack_src_I02001`; do CNS_HOST=castorns nsrm $F; done
for F in `cat ~/castorns_nslisttape_repack_src_I05581`; do CNS_HOST=castorns nsrm $F; done
