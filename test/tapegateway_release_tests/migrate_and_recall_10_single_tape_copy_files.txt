THE NAME OF TEST
================

Migrate and recall 10 single tape-copy files


THE PURPOSE OF THE TEST
=======================

The principle responsibility of the tape gateway is coordinate the transfer of
files to and from tape.

This test verifies that the tape gateway can correctly store and retrive 10 single
tape-copy files to and from tape.


THE PREREQUISITES OF THE TEST
=============================

* A test-stager where you can carry out the test.
* A test-service-class with a set of one or more disk-pools that has enough free
  space to store ten 100MB on disk.
* A user account that permits the modification of the service-class within the
  stager.
* One test-tape which must have enough free space to store ten 100MB files.
* A user account that permits the creation of a new tape-pool within the VMGR
* One free tape-drive which can access both the test-tape.
* A user account that permits the dedication of drives within the VDQM.
* A file class with one tape-copy or a user account that permits the creation
  of a new one with one tape-copy.  Do not modify the number of tape-copies
  attribute of an existing file class.
* A user account that allows the creation and population of a CASTOR directory
  with a tape backend.
* A copy of the utility test script from the CASTOR svn repository,
  "trunk/test/tapegateway_release_tests/createAndCopyFilesToCastor.sh".


INSTRUCTIONS DESCRIBING HOW TO SET UP THE TEST'S ENVIRONMENT
============================================================

1. Check that the tapeGateway is up and running.

ps -ef | egrep 'tapegatewayd|rtcpclientd' | grep -v grep

2. Create yourself a tape-pool containing the test-tape.

vmgrenterpool --name gatewaytest --user murrayc3 --group c3
vmgrmodifytape -V I12017 --pool gatewaytest

3. Choose a service class for your test and make sure it has your newly created
   tape-pool as its one and only tape-pool.

modifySvcClass --Name default --AddTapePools gatewaytest

4. Make sure your service class will use exactly 1 drive for migrations.

modifySvcClass --Name default --NbDrives 1

5. Check that there is a migHunter daemon running for the selected 
   test-service-class.

ps -ef | egrep "/usr/bin/mighunterd.* <test-service-class>" | grep -v grep

   If one is not already runnig, start it.

[root]  /usr/bin/mighunterd -t 60  <test-service-class>

6. Create yourself an empty test-directory in CASTOR where you will copy your
   test-files.

nsmkdir /castor/cern.ch/dev/m/murrayc3/migrate_and_recall_10_single_tape_copy_files

7. Make sure the directory has a file-class with one tape-copy.

nslistclass | egrep 'CLASS_ID|CLASS_NAME|NBCOPIES' | grep -B2 "NBCOPIES 1"

nschclass <fileclass> /castor/cern.ch/dev/m/murrayc3/migrate_and_recall_10_single_tape_copy_files

8. Dedicate the 1 free tape-drive to the test-stager.

vdqm_admin -dedicate -dgn 359B1B -drive 35921011 -server tpsrv212 -match 'host=lxcastordev04'


INSTRUCTIONS DESCRIBING HOW TO CARRY OUT THE TEST
=================================================

1. Stop the mighunter daemons of the test-stager.

ps -ef | egrep "/usr/bin/mighunterd.* <test-service-class>" | grep -v grep | awk '{print $2}'| xargs kill -9

2. Create and copy to CASTOR the ten 100MB test-files using the
   createAndCopyFilesToCastor.sh script.

sh createAndCopyFilesToCastor.sh lxcastordev04 default lxcastorsrv101 /castor/cern.ch/dev/m/murrayc3/migrate_and_recall_10_single_tape_copy_files 100 10

3. Start the mighunter daemons of the test-stager.

/usr/bin/mighunterd -t 60 <test-service-class>

4. Using nsls -l wait for all ten 100 MB files to be migrated to tape.

watch 'nsls -l /castor/cern.ch/dev/m/murrayc3/migrate_and_recall_10_single_tape_copy_files'

5. Remove the test-files from the disk cache.

TESTDIR=/castor/cern.ch/dev/m/murrayc3/migrate_and_recall_10_single_tape_copy_files; for F in `nsls -l $TESTDIR | awk '{print $NF;}'`; do stager_rm $TESTDIR/$F; done

6. Using stager_qry wait for all ten 100 MB files to be INVALID.

watch 'stager_qry -M /castor/cern.ch/dev/m/murrayc3/migrate_and_recall_10_single_tape_copy_files'

7. Recall the files back from tape.

TESTDIR=/castor/cern.ch/dev/m/murrayc3/migrate_and_recall_10_single_tape_copy_files; for F in `nsls -l $TESTDIR | awk '{print $NF;}'`; do stager_get -M $TESTDIR/$F; done

8. Using stager_qry wait for all ten 100 MB files to be STAGED.

watch 'stager_qry -M /castor/cern.ch/dev/m/murrayc3/migrate_and_recall_10_single_tape_copy_files'


EXPECTED RESULTS
================

The 10 recalls should have completed successfully, in other words, stager_qry
should show the files have been successfully recalled from tape back onto disk.
Running "nsls -l" on the test-directory should show each file has one
tape-segment on the test tape.
