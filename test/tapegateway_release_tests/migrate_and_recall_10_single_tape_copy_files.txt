THE NAME OF TEST
================

Migrate and recall 10 single tape-copy files


THE PURPOSE OF THE TEST
=======================

The principle responsibility of the tape gateway is coordinate the transfer of
files to and from tape.

This test verifies that the tape gateway can correctly store and retrive 10 single
tape-copy files to and from tape.


THE PREREQUISITES OF THE TEST
=============================

* A test-stager running the tape-gateway where you can carry out the test.
* A test service-class with the following properties:
  - A set of one or more disk-pools that has enough free space to store ten
    100MB test-files.
  - Stream policy set to one which always returns 1.
  - Migrator policy set to one which always returns 1.
  - Recaller policy set to 'None'.
* A user account that permits the modification of the service-class within the
  stager.
* One test-tape which must have enough free space to store ten 100MB files.
* A user account that permits the creation of a new tape-pool within the VMGR.
* One free tape-drive which can access the test-tape.
* A user account that permits the dedication of drives within the VDQM.
* A file class with one tape-copy or a user account that permits the creation
  of a new one with one tape-copy.  Do not modify the number of tape-copies
  attribute of an existing file class.
* A user account that allows the creation and population of a CASTOR directory
  with a tape backend.
* A copy of the utility test script from the CASTOR svn repository,
  "trunk/test/tapegateway_release_tests/createAndCopyFilesToCastor.sh".


INSTRUCTIONS DESCRIBING HOW TO SET UP THE ENVIRONMENT OF THE TEST
=================================================================

1. Check that the tapeGateway is up and running.

ps -ef | grep 'tapegatewayd|rtcpclientd' | grep -v grep

2. Create yourself a tape-pool containing the test-tape.

vmgrenterpool --name gatewaytest --user murrayc3 --group c3
vmgrmodifytape -V I12017 --pool gatewaytest

3. Make sure the test service-class has the test tape-pool as its one and only
   tape-pool.

modifySvcClass --Name default --AddTapePools gatewaytest

4. Make sure the test service-class will use exactly 1 drive for migrations.

modifySvcClass --Name default --NbDrives 1

5. Create the empty test-directory in CASTOR where test-files will be copied
   to.

nsmkdir /castor/cern.ch/dev/m/murrayc3/migrate_and_recall_10_single_tape_copy_files

6. Determine the name of a file-class with one tape-copy.

nslistclass | egrep 'CLASS_ID|CLASS_NAME|NBCOPIES' | grep -B2 'NBCOPIES 1'
[output] ...
[output] CLASS_ID 95
[output] CLASS_NAME largeuser
[output] NBCOPIES 1
[output] ...

7. Set the file-class of the test-directory to be that of the previous step.

nschclass largeuser /castor/cern.ch/user/m/murrayc3/gatewayendtape

8. Dedicate the test-drive to the test-stager.

vdqm_admin -dedicate -dgn 359B1B -drive 35921011 -server tpsrv212 -match 'host=lxcastordev04'

9. Determine whether or not there is a migHunter daemon running for the 
    test-service-class.

ps -ef | egrep "/usr/bin/mighunterd.* <test-service-class>" | grep -v grep

10. If no mighunter daemon is running for the test-service-class, then start
    one as user root.

/usr/bin/mighunterd -t 60 default


INSTRUCTIONS DESCRIBING HOW TO CARRY OUT THE TEST
=================================================

1. Stop the mighunter daemons of the test-stager as user root.

ps -ef | egrep "/usr/bin/mighunterd.* <test-service-class>" | grep -v grep | awk '{print $2}'| xargs kill -9

2. Create and copy to CASTOR the ten 100MB test-files using the
   createAndCopyFilesToCastor.sh script.

sh createAndCopyFilesToCastor.sh lxcastordev04 default lxcastorsrv101 /castor/cern.ch/dev/m/murrayc3/migrate_and_recall_10_single_tape_copy_files 100 10

3. Start the mighunter daemons of the test-stager.

/usr/bin/mighunterd -t 60 <test-service-class>

4. Using nsls -l wait for all ten 100 MB files to be migrated to tape.

watch 'nsls -l /castor/cern.ch/dev/m/murrayc3/migrate_and_recall_10_single_tape_copy_files'

5. Remove the test-files from the disk cache.

TESTDIR=/castor/cern.ch/dev/m/murrayc3/migrate_and_recall_10_single_tape_copy_files; for F in `nsls -l $TESTDIR | awk '{print $NF;}'`; do stager_rm $TESTDIR/$F; done

6. Using stager_qry wait for all ten 100 MB files to be INVALID.

watch 'stager_qry -M /castor/cern.ch/dev/m/murrayc3/migrate_and_recall_10_single_tape_copy_files'

7. Recall the files back from tape.

TESTDIR=/castor/cern.ch/dev/m/murrayc3/migrate_and_recall_10_single_tape_copy_files; for F in `nsls -l $TESTDIR | awk '{print $NF;}'`; do stager_get -M $TESTDIR/$F; done

8. Using stager_qry wait for all ten 100 MB files to be STAGED.

watch 'stager_qry -M /castor/cern.ch/dev/m/murrayc3/migrate_and_recall_10_single_tape_copy_files'


EXPECTED RESULTS
================

The 10 recalls should have completed successfully, in other words, stager_qry
should show the files have been successfully recalled from tape back onto disk.
Running "nsls -l" on the test-directory should show each file has one
tape-segment on the test tape.


INSTRUCTIONS DESCRIBING HOW TO SET UP THE ENVIRONMENT OF THE TEST
=================================================================

1. Revoke the dedication the test-drive from the test-stager.

vdqm_admin -dedicate -dgn 359B1B -drive 35921011 -server tpsrv212

2. Remove the test-directory and its contents from the CASTOR name-space.

nsrm -r /castor/cern.ch/user/m/murrayc3/migrate_and_recall_10_single_tape_copy_files
