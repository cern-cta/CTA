THE NAME OF TEST
================

Migrate and recall 10 single tape-copy files


THE PURPOSE OF THE TEST
=======================

The principle responsibility of the tape-gateway is to coordinate the transfer
of files to and from tape.

This test verifies that the tape-gateway can correctly store and retrive 10 single
tape-copy files to and from tape.


THE PREREQUISITES OF THE TEST
=============================

* A test-stager running the tape-gateway where you can carry out the test.
* A test service-class with the following properties:
  - A set of one or more disk-pools that has enough free space to store ten
    100MB test-files.
  - A set of one or more tape-pools that has enough free space to store ten
    100MB test-files.
  - nbDrivs set to at least 1.
  - A stream policy which always returns 1.
  - A migrator policy which always returns 1.
  - Recaller policy set to 'None'.
* One free tape-drive which can access the test-tape.
* A file class with a value of 1 for nbCopies (the number of desired
  tape-copies).
* A user account that allows the creation and population of a CASTOR directory
  with a tape backend.
* A copy of the utility test script from the CASTOR svn repository,
  "trunk/test/tapegateway_release_tests/createAndCopyFilesToCastor.sh".


INSTRUCTIONS DESCRIBING HOW TO SET UP THE ENVIRONMENT OF THE TEST
=================================================================

1. Create the empty test-directory in CASTOR where test-files will be copied
   to.

nsmkdir /castor/cern.ch/dev/m/murrayc3/migrate_and_recall_10_single_tape_copy_files

2. Determine the name of a file-class with one tape-copy.

nslistclass | egrep 'CLASS_ID|CLASS_NAME|NBCOPIES' | grep -B2 'NBCOPIES 1'
[output] ...
[output] CLASS_ID 95
[output] CLASS_NAME largeuser
[output] NBCOPIES 1
[output] ...

3. Set the file-class of the test-directory to be that of the previous step.

nschclass largeuser /castor/cern.ch/user/m/murrayc3/gatewayendtape

4. Determine whether or not there is a migHunter daemon running for the 
   service class <service class> (can be "default").

ps -ef | egrep "/usr/bin/mighunterd.* <service class>" | grep -v grep

5. If no mighunter daemon is running for the test service class, then start
    one as user root.

/usr/bin/mighunterd -t 60 <service class>


INSTRUCTIONS DESCRIBING HOW TO CARRY OUT THE TEST
=================================================

1. Create and copy to CASTOR the ten 100MB test-files using the
   createAndCopyFilesToCastor.sh script.

createAndCopyFilesToCastor.sh lxcastordev04 default lxcastorsrv101 \
    /castor/cern.ch/dev/m/murrayc3/migrate_and_recall_10_single_tape_copy_files 100 10

2. Using nsls -l wait for all ten 100 MB files to be migrated to tape.

watch 'nsls -l /castor/cern.ch/dev/m/murrayc3/migrate_and_recall_10_single_tape_copy_files'

3. Remove the test-files from the disk cache.

TESTDIR=/castor/cern.ch/dev/m/murrayc3/migrate_and_recall_10_single_tape_copy_files; nsls $TESTDIR | \
    xargs -i stager_rm -S'*' -M $TESTDIR/{}

4. Using stager_qry wait for all ten 100 MB files to be INVALID.

watch 'stager_qry -M /castor/cern.ch/dev/m/murrayc3/migrate_and_recall_10_single_tape_copy_files'

5. Recall the files back from tape.

TESTDIR=/castor/cern.ch/dev/m/murrayc3/migrate_and_recall_10_single_tape_copy_files; nsls $TESTDIR | \
    xargs -i do stager_get -M $TESTDIR/{}

6. Using stager_qry wait for all ten 100 MB files to be STAGED.

watch 'stager_qry -M /castor/cern.ch/dev/m/murrayc3/migrate_and_recall_10_single_tape_copy_files'


EXPECTED RESULTS
================

The 10 recalls should have completed successfully, in other words, stager_qry
should show the files have been successfully recalled from tape back onto disk.
Running "nsls -l" on the test-directory should show each file has one
tape-segment on the test tape.


INSTRUCTIONS DESCRIBING HOW TO CLEAN UP THE ENVIRONMENT OF THE TEST
=================================================================

1. Remove the test-directory and its contents from the CASTOR name-space.

nsrm -r /castor/cern.ch/user/m/murrayc3/migrate_and_recall_10_single_tape_copy_files
