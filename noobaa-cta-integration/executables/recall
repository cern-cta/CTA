#!/bin/bash

# Simple recall script for NooBaa NSFS Glacier - CTA integration
# Based on successful manual testing and CTA reference implementation

set -e

# Configuration
TOKEN_FILE="/tmp/eos_power_token"
API_ENDPOINT="https://eos-mgm-0.eos-mgm.dev.svc.cluster.local:8443/api/v1"
TIMEOUT=300

# Logging
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') [RECALL] $*"
}

# Check if file list provided
if [[ $# -eq 0 ]]; then
    log "Usage: $0 <file_list>"
    exit 1
fi

FILE_LIST="$1"

if [[ ! -f "${FILE_LIST}" ]]; then
    log "ERROR: File list not found: ${FILE_LIST}"
    exit 1
fi

# Check if token exists
if [[ ! -f "${TOKEN_FILE}" ]]; then
    log "ERROR: Token file not found: ${TOKEN_FILE}"
    exit 1
fi

log "Starting recall process for files in: ${FILE_LIST}"

# Get token (skip timestamp)
TOKEN=$(cut -d: -f2- "${TOKEN_FILE}")

# Process each file
while IFS= read -r file_path; do
    # Skip empty lines and comments
    [[ -z "${file_path}" ]] || [[ "${file_path}" =~ ^[[:space:]]*# ]] && continue
    
    log "Processing file: ${file_path}"
    
    # Send stage request - exact pattern from manual testing
    log "Sending stage request..."
    curl -L --insecure \
        -H "Accept: application/json" \
        -H "Authorization: Bearer ${TOKEN}" \
        -d "{\"files\":[{\"path\":\"${file_path}\"}]}" \
        "${API_ENDPOINT}/stage/" 2>/dev/null || {
        log "ERROR: Stage request failed for ${file_path}"
        echo "FAILED ${file_path} Stage request failed"
        continue
    }
    
    log "Stage request sent successfully for ${file_path}"
    echo "COMPLETED ${file_path} Stage request submitted"
    
done < "${FILE_LIST}"

log "Recall process completed"