#!/bin/bash

# @project      The CERN Tape Archive (CTA) - NooBaa Integration  
# @copyright    Copyright Â© 2024 CERN
# @license      This program is free software, distributed under the terms of the GNU General Public
#               Licence version 3 (GPL Version 3), copied verbatim in the file "COPYING".

# Simplified NooBaa NSFS Glacier migrate executable
# Based on working manual curl command
# Input: File containing list of files to archive
# Output: eeadm migrate-compliant format

set -eo pipefail

# Configuration
EOS_MGM_HOST="eos-mgm-0.eos-mgm.dev.svc.cluster.local"
EOS_PORT="8443"
TOKEN_CACHE_FILE="/tmp/eos_power_token"

# Counters
TOTAL_FILES=0
SUCCEEDED_FILES=0
FAILED_FILES=0

# Logging function
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') [MIGRATE] $*"
}

# Get token from cache file
get_token() {
    if [[ ! -f "${TOKEN_CACHE_FILE}" ]]; then
        log "ERROR: Token cache file not found: ${TOKEN_CACHE_FILE}"
        return 1
    fi
    
    local cached_token
    cached_token=$(cat "${TOKEN_CACHE_FILE}")
    echo "${cached_token}" | cut -d: -f2-
}

# Archive single file using working curl command
archive_file() {
    local file_path="$1"
    
    log "Processing file: ${file_path}"
    
    # Check if file exists and is readable
    if [[ ! -f "${file_path}" ]] || [[ ! -r "${file_path}" ]]; then
        echo "FAILED ${file_path} File not readable or does not exist"
        return 1
    fi
    
    # Get token
    local token
    token=$(get_token) || {
        echo "FAILED ${file_path} Could not get valid token"
        return 1
    }
    
    # Generate archive path 
    local archive_path="/eos/ctaeos/preprod/$(basename "${file_path}")"
    
    log "Uploading to: ${archive_path}"
    
    # Use exact working curl command
    local upload_response
    upload_response=$(curl -L --insecure \
        -H "Accept: application/json" \
        -H "Authorization: Bearer ${token}" \
        --upload-file "${file_path}" \
        "https://${EOS_MGM_HOST}:${EOS_PORT}${archive_path}" 2>&1)
    
    local curl_exit_code=$?
    
    log "Upload response: ${upload_response}"
    
    # Check for success (curl exit code 0 and no error messages)
    if [[ ${curl_exit_code} -eq 0 ]] && [[ ! "${upload_response}" == *"Unable to"* ]] && [[ ! "${upload_response}" == *"Operation not permitted"* ]]; then
        echo "COMPLETED ${file_path} File successfully uploaded"
        SUCCEEDED_FILES=$((SUCCEEDED_FILES + 1))
        return 0
    else
        echo "FAILED ${file_path} Upload failed - ${upload_response}"
        FAILED_FILES=$((FAILED_FILES + 1))
        return 1
    fi
}

# Process file list
process_files() {
    local file_list="$1"
    
    if [[ ! -f "${file_list}" ]]; then
        log "ERROR: File list not found: ${file_list}"
        return 1
    fi
    
    log "Processing file list: ${file_list}"
    
    while IFS= read -r file_path; do
        # Skip empty lines and comments
        [[ -z "${file_path}" ]] || [[ "${file_path}" =~ ^[[:space:]]*# ]] && continue
        
        log "Read file from list: '${file_path}'"
        TOTAL_FILES=$((TOTAL_FILES + 1))
        log "Total files counter: ${TOTAL_FILES}"
        
        if archive_file "${file_path}"; then
            log "Successfully processed: ${file_path}"
        else
            log "Failed to process: ${file_path}"
        fi
    done < "${file_list}"
    
    log "Finished processing file list, total files: ${TOTAL_FILES}"
}

# Output eeadm-compatible summary
output_summary() {
    local task_id=$((RANDOM % 10000))
    
    echo "$(date '+%Y-%m-%d %H:%M:%S') GLESL700I: Task migrate was created successfully, task ID is ${task_id}."
    echo "$(date '+%Y-%m-%d %H:%M:%S') GLESM896I: Starting the stage 1 of 3 for migration task ${task_id} (qualifying the state of migration candidate files)."
    echo "$(date '+%Y-%m-%d %H:%M:%S') GLESM897I: Starting the stage 2 of 3 for migration task ${task_id} (copying the files to CTA via EOS)."
    echo "$(date '+%Y-%m-%d %H:%M:%S') GLESM898I: Starting the stage 3 of 3 for migration task ${task_id} (changing the state of files on disk)."
    
    if [[ ${SUCCEEDED_FILES} -gt 0 ]]; then
        echo "$(date '+%Y-%m-%d %H:%M:%S') GLESL839I: All ${SUCCEEDED_FILES} file(s) has been successfully processed."
        echo "$(date '+%Y-%m-%d %H:%M:%S') GLESL841I:   Succeeded: ${SUCCEEDED_FILES} migrated, 0 already_migrated."
    else
        echo "$(date '+%Y-%m-%d %H:%M:%S') GLESL839E: No files were successfully processed."
        echo "$(date '+%Y-%m-%d %H:%M:%S') GLESL841E:   Succeeded: 0 migrated, ${FAILED_FILES} failed."
    fi
}

# Main function
main() {
    local file_list="${1:-}"
    
    if [[ -z "${file_list}" ]]; then
        log "Usage: $0 <file_list>"
        echo "$(date '+%Y-%m-%d %H:%M:%S') GLESL277I: The \"eeadm migrate\" command is called without specifying an input file. Waiting for standard input."
        echo "If necessary press ^D to continue."
        exit 1
    fi
    
    log "Starting migration process for files in: ${file_list}"
    
    # Process files
    process_files "${file_list}"
    
    # Output summary
    output_summary
    
    log "Migration process completed"
    log "Summary: ${SUCCEEDED_FILES}/${TOTAL_FILES} files successfully processed"
    
    # Exit with error code if any files failed
    [[ ${FAILED_FILES} -eq 0 ]]
}

# Run main function
main "$@"