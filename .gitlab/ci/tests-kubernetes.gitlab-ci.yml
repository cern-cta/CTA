# All of the below tests use only the docker image generated in the build:image stage
# These are also the only tests executed on our personal cirunners instead of the GitLab runners

.kubernetes-test:
  needs:
    - job: docker-build-ctageneric
      optional: true # Otherwise the SYSTEMTESTS_ONLY flag won't work
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: never
    - if: $CI_COMMIT_TAG
      when: never
    - when: on_success
  variables:
    TEST_SCRIPT:
    # Passed to the run_systemtest.sh script verbatim
    EXTRA_ARGS: ""
    # Passed to the create_instance.sh script verbatim
    EXTRA_SPAWN_ARGS: ""
    # Passed to the test script verbatim
    EXTRA_TEST_ARGS: ""
  before_script:
    - bash ./continuousintegration/ci_helpers/install_helm.sh
  script:
    # Keep the namespace name under 64 characters;
    - export NAMESPACE="${CI_JOB_NAME_SLUG:0:10}-${CTA_BUILD_ID}-${CI_JOB_ID}"
    - git submodule update --init --recursive
    # Which scheduler to use
    - |
      if [ $SCHED_TYPE == "objectstore" ]; then
        SCHEDULER_CONFIG=/opt/kubernetes/CTA/scheduler/ci-ceph-values.yaml
      else
        SCHEDULER_CONFIG=/opt/kubernetes/CTA/scheduler/ci-postgres-values.yaml
      fi
    # Which catalogue to use
    - |
      if [ $ORACLE_SUPPORT == "ON" ]; then
        CATALOGUE_CONFIG=/opt/kubernetes/CTA/catalogue/ci-oracle-values.yaml
      else
        CATALOGUE_CONFIG=presets/dev-postgres-catalogue-values.yaml
      fi
    # Which image tag to use
    - |
      if [ $SYSTEMTESTS_ONLY == "TRUE" ]; then
        GET_IMAGE_TAG_OPTS=" --systemtest-only"
      fi
    - cd continuousintegration/ci_helpers/
    # - IMAGE_TAG=$(./get_image_tag.sh ${GET_IMAGE_TAG_OPTS})
    - IMAGE_TAG=8325945git52652e71 # Hardcode the tag for now so that I can test this properly
    # Set up the additional arguments array to pass to the run_systemtest.sh script
    - args_array=($EXTRA_ARGS)
    - |
      if [[ -n "${EXTRA_SPAWN_ARGS}" ]]; then
        extra_args+=(--spawn-options "${EXTRA_SPAWN_ARGS}")
      fi
    - |
      if [[ -n "${EXTRA_TEST_ARGS}" ]]; then
        extra_args+=(--test-options "${EXTRA_TEST_ARGS}")
      fi
    # Run test
    - cd ../orchestration/
    - bash -x run_systemtest.sh --namespace ${NAMESPACE}
                          --image-tag ${IMAGE_TAG}
                          --test-script ${TEST_SCRIPT}
                          --cleanup-namespaces
                          --catalogue-config ${CATALOGUE_CONFIG}
                          --scheduler-config ${SCHEDULER_CONFIG}
                          "${extra_args[@]}"
  artifacts:
    when: always
    expire_in: 30 days
    paths:
      - pod_logs
  tags: # Used to indicate that these jobs should run on our own cirunner machines
    - kubernetes
    - mhvtl

# Tests

k8s-test-client:
  stage: test
  extends:
    - .kubernetes-test
  variables:
    TEST_SCRIPT: "tests/test_client.sh"
    EXTRA_ARGS: "--test-timeout 2400"

k8s-test-client-gfal2:
  stage: test
  extends:
    - .kubernetes-test
  variables:
    TEST_SCRIPT: "tests/test_client-gfal2.sh"
    EXTRA_ARGS: "--test-timeout 2400"

k8s-test-repack:
  stage: test
  extends:
    - .kubernetes-test
  variables:
    TEST_SCRIPT: "tests/repack_systemtest_wrapper.sh"
    EXTRA_ARGS: "--test-timeout 2400"

k8s-test-cta-admin:
  stage: test
  extends:
    - .kubernetes-test
  variables:
    TEST_SCRIPT: "tests/test_cta-admin.sh"
    EXTRA_ARGS: "--test-timeout 2400"

k8s-unit-test-oracle:
  stage: test
  extends:
    - .kubernetes-test
  variables:
    TEST_SCRIPT: "tests/unit_test_oracle.sh"
    # The oracle pod needs the image tag as well
    EXTRA_ARGS: "--test-timeout 2400"
    EXTRA_TEST_ARGS: "--image-tag ${IMAGE_TAG}"

# Manually triggered

.manual-rules:
  rules:
    # For pivot CTA releases: vX.Y.0
    - if: $CI_COMMIT_TAG && $CI_COMMIT_TAG =~ /^.*\.0\.[0-9]+-[^-]*$/
      when: on_success
    # For non-pivot CTA releases
    - if: $CI_COMMIT_TAG && $CI_COMMIT_TAG !~ /^.*\.0\.[0-9]+-[^-]*$/
      when: manual
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
      allow_failure: true
    - if: $CI_PIPELINE_SOURCE == "push"
      when: manual
      allow_failure: true
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: on_success

k8s-test-liquibase-update:
  stage: test
  extends:
    - .kubernetes-test
  rules:
    - !reference [.manual-rules, rules]
  variables:
    TEST_SCRIPT: "tests/test_liquibase_update.sh"
    # TODO: pass in a previous catalogue version (not hardcoded)
    EXTRA_ARGS: "--test-timeout 2400"
    EXTRA_SPAWN_ARGS: "--catalogue-version 14.0"

k8s-test-external-tape-formats:
  stage: test
  extends:
    - .kubernetes-test
  rules:
    - !reference [.manual-rules, rules]
  variables:
    TEST_SCRIPT: "tests/external_tapes_test.sh"
    EXTRA_OPTIONS: "--test-timeout 2400"

k8s-test-regression-dCache:
  stage: test
  extends:
    - .kubernetes-test
  rules:
    - !reference [.manual-rules, rules]
  variables:
    TEST_SCRIPT: "tests/test_regression_dCache.sh"
    EXTRA_OPTIONS: "--test-timeout 2400"
  tags:
    - kubernetes
    - xlarge
