cppcheck:
  stage: analysis
  image:
    name: neszt/cppcheck-docker
    entrypoint: ["/usr/bin/env"]
  before_script:
    - ''
  script:
    - cppcheck --xml --force --enable=warning,performance --inline-suppr --suppressions-list=.cppcheck-suppressions.txt . 2> cppcheck_out.xml
  artifacts:
    expire_in: 2 days
    paths:
    - cppcheck_out.xml
  rules:
    !reference [.skip_rules, rules]


# based on https://gitlab.com/ahogen/cppcheck-codequality
cppcheck_report:
  stage: analysis
  needs: [ cppcheck ]
  image: centos:7
  before_script:
    - yum -y install python3-pip
    - python3 -m pip install -U cppcheck_codequality
  script:
    - cppcheck-codequality --input-file=cppcheck_out.xml --output-file=cppcheck.json
    - if cat cppcheck_out.xml | grep -q "<error\s"; then echo "ERRORS have been detected"; exit 1; fi;
  artifacts:
    reports:
      codequality: cppcheck.json
  rules:
    !reference [.skip_rules, rules]

clang_format:
  allow_failure: true
  stage: analysis
  image:
    name: gitlab-registry.cern.ch/linuxsupport/alma9-base
    entrypoint: [""]
  script:
    # Remove CC7-specific repos copied by defalt:before_script in .gitlab-ci.yml 
    - rm -rf /etc/yum.repos.d/centos-cernonly.repo
    - rm -rf /etc/yum.repos.d/cta-ci.repo
    - rm -rf /etc/yum.repos.d/eos-quarkdb.repo
    - yum clean all
    - yum install -y git-clang-format
    - find . -type f \( -name "*.cpp" -o -name "*.hpp" \) -exec clang-format --dry-run -Werror --style=file {} + > clang-format.output
  artifacts:
    paths:
    - clang-format.output
  rules:
    !reference [.skip_rules, rules]
