build-cta-tagged-rpm:
  stage: build:tagged
  retry: 1
  rules:
    - if: $ALMA9 == "OFF" && $CI_COMMIT_TAG
  image: gitlab-registry.cern.ch/linuxsupport/cc7-base
  script:
    - if [ -z "${CI_COMMIT_TAG}" ]; then echo "This is not a tagged commit, exiting"; exit 0; fi
    - echo "Building package for tag ${CI_COMMIT_TAG}. CTA_VERSION=${TAG_VERSION} - CTA_RELEASE=${TAG_RELEASE}"
    - yum install -y git
    - git submodule update --init --recursive
    - cd xrootd-ssi-protobuf-interface && export XROOTD_SSI_PROTOBUF_INTERFACE_VERSION=$(git describe --tags --abbrev=0) && cd ..
    # Note that unit tests cannot be disabled here
    - ./continuousintegration/ci_helpers/build_rpm.sh --build-dir build_tagged_rpm
                                                      --build-generator "${BUILD_GENERATOR}"
                                                      --create-build-dir
                                                      --srpm-dir build_srpm/RPM/SRPMS
                                                      --cta-version ${TAG_VERSION}
                                                      --vcs-version ${TAG_RELEASE}
                                                      --xrootd-version ${XROOTD_VERSION}
                                                      --xrootd-ssi-version ${XROOTD_SSI_PROTOBUF_INTERFACE_VERSION}
                                                      --scheduler-type ${SCHED_TYPE}
                                                      --jobs $(nproc --ignore=1)
                                                      --install
  artifacts:
    expire_in: 30 days
    paths:
      - build_tagged_rpm/RPM/RPMS

build-cta-tagged-rpm-alma9:
  stage: build:tagged
  retry: 1
  rules:
    - if: $ALMA9 == "ON" && $CI_COMMIT_TAG
  image: gitlab-registry.cern.ch/linuxsupport/alma9-base
  script:
    - if [ -z "${CI_COMMIT_TAG}" ]; then echo "This is not a tagged commit, exiting"; exit 0; fi
    - echo "Building package for tag ${CI_COMMIT_TAG}. CTA_VERSION=${TAG_VERSION} - CTA_RELEASE=${TAG_RELEASE}"
    - yum install -y git
    - git submodule update --init --recursive
    - cd xrootd-ssi-protobuf-interface && export XROOTD_SSI_PROTOBUF_INTERFACE_VERSION=$(git describe --tags --abbrev=0) && cd ..
    # Note that unit tests cannot be disabled here
    - ./continuousintegration/ci_helpers/build_rpm.sh --build-dir build_tagged_rpm
                                                      --build-generator "${BUILD_GENERATOR}"
                                                      --create-build-dir
                                                      --srpm-dir build_srpm/RPM/SRPMS
                                                      --cta-version ${TAG_VERSION}
                                                      --vcs-version ${TAG_RELEASE}
                                                      --xrootd-version ${XROOTD_VERSION}
                                                      --xrootd-ssi-version ${XROOTD_SSI_PROTOBUF_INTERFACE_VERSION}
                                                      --scheduler-type ${SCHED_TYPE}
                                                      --jobs $(nproc --ignore=1)
                                                      --install
  artifacts:
    expire_in: 30 days
    paths:
      - build_tagged_rpm/RPM/RPMS
