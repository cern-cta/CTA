COMM
COMM Imakefile,v 1.26 2005/10/17 11:38:52 CERN IT-PDP/DM Olof Barring
COMM

COMM
COMM Copyright (C) 1999-2001 by CERN/IT/PDP/DM
COMM  All rights reserved
COMM

COMM         Make RTCOPY API library and server

COMM
COMM Define the remote tape copy daemon log file.
COMM
LOGDIR = /var/log/castor
LOGFILE = $(LOGDIR)/rtcpd_legacy.log

COMM
COMM Define the working directory of
COMM the remote tape copy jobs.
COMM
RTCOPYWORKDIR = /var/lib/castor/rtcpd

COMM
COMM Define the file indicating that more
COMM tape request should be submit on the
COMM server.
COMM
NOMORETAPES = OperatorDir.nomoretapes

COMM
COMM Define the file indicating the hosts
COMM authorized to use remotely rtcopy server
COMM
AUTHORIZEDHOSTS = AuthorizedHosts

COMM
COMM Define CASTOR Name server root path name to prevent
COMM tpread/tpwrite request to/from HSM files
COMM
NS_ROOT = NsRoot

COMM
COMM Set this flag to -O for optimization, or -g for debug
COMM

VDQMFLG = -DVDQM
CTAPEFLG = -DCTAPE
ACCTON= -DACCTON
SACCTDIR = SacctDir
SACCTFILE = $(SACCTDIR)/sacct
ACCTFILE = -DACCTFILE=\"$(SACCTFILE)\"

SCONFIGFILE = ShiftConfigFile
CONFIGFILE = -DCONFIGFILE=\"$(SCONFIGFILE)\"

TPCONFIGFILE = TapeConfigFile
TPCONFIG = -DTPCONFIG=\"$(TPCONFIGFILE)\"

RTCPCLDHOST = RtcpclientdHost

#ifdef StagerSuperUser
RTCPCLDUSER = StagerSuperUser
#else
RTCPCLDUSER = stage
#endif

#ifdef StagerSuperGroup
RTCPCLDGROUP = StagerSuperGroup
#else
RTCPCLDGROUP = st
#endif

RTCPCLDFLAGS = -DRTCPCLD_NOTIFY_HOST=\"$(RTCPCLDHOST)\" -DRTCPCLD_USER=\"$(RTCPCLDUSER)\" -DRTCPCLD_GROUP=\"$(RTCPCLDGROUP)\"

#if BuildSecureRtcopy
SECURITYFLAG=-DCSEC
LIBS += -ldl
#endif

CPPFLAGS += -DBIN=\"$(BIN)\" -DRTCOPY_LOGFILE=\"$(LOGFILE)\" -DNOMORETAPES=\"$(NOMORETAPES)\" \
	    -DAUTH_HOSTS=\"$(AUTHORIZEDHOSTS)\" -DWORKDIR=\"$(RTCOPYWORKDIR)\" \
	    -DNS_ROOT=\"$(NS_ROOT)\" $(ACCTON) $(CONFIGFILE) $(TPCONFIG) \
	    -DRTCP_SERVER -DVMGR $(VDQMFLG) $(CTAPEFLG) -DSACCT $(ACCTFILE) $(RTCPCLDFLAGS)
CFLAGS += $(SECURITYFLAG)

DependsOnLibrary(common,castorcommon)
DependsOnLibrary(dlf,castordlf)
DependsOnLibrary(castor,castorclient)
DependsOnLibrary(ns,castorns)
DependsOnLibrary(vmgr,castorvmgr)
DependsOnLibrary(vdqm,castorvdqm)
DependsOnLibrary(tape,castortape)
DependsOnLibrary(expert,castorexpert)

rtcpc_SendRecv.c:	DepSourceName(rtcopy,rtcp_SendRecv.c)
			RemoveFiles(rtcpc_SendRecv.c)
			$(CP) rtcp_SendRecv.c rtcpc_SendRecv.c
rtcpc_log.c:		DepSourceName(rtcopy,rtcp_log.c)
			RemoveFiles(rtcpc_log.c)
			$(CP) rtcp_log.c rtcpc_log.c
rtcpc_CallVMGR.c:	DepSourceName(rtcopy,rtcp_CallVMGR.c)
			RemoveFiles(rtcpc_CallVMGR.c)
			$(CP) rtcp_CallVMGR.c rtcpc_CallVMGR.c
rtcpc_CheckReq.c:	DepSourceName(rtcopy,rtcp_CheckReq.c)
			RemoveFiles(rtcpc_CheckReq.c)
			$(CP) rtcp_CheckReq.c rtcpc_CheckReq.c
rtcpc_SendRecv.Osuf: rtcpc_SendRecv.c
	$(COMPILE.c) $(OUTPUT_OPTION) -URTCP_SERVER $<
rtcpc_log.Osuf: rtcpc_log.c
	$(COMPILE.c) $(OUTPUT_OPTION) -URTCP_SERVER $<
rtcpc_CallVMGR.Osuf: rtcpc_CallVMGR.c
	$(COMPILE.c) $(OUTPUT_OPTION) -URTCP_SERVER $<
rtcpc_CheckReq.Osuf: rtcpc_CheckReq.c
	$(COMPILE.c) $(OUTPUT_OPTION) -URTCP_SERVER $<
FileToClean += rtcpc_log.c rtcpc_SendRecv.c rtcpc_CallVMGR.c rtcpc_CheckReq.c

RTCPLIB_OBJS =	rtcpc_SendRecv.Osuf rtcp_InitNW.Osuf rtcpc_log.Osuf rtcpc_CallVMGR.Osuf rtcp_Listen.Osuf rtcpapi.Osuf rtcpc_BuildReq.Osuf rtcp_RetvalSHIFT.Osuf rtcpc_CheckReq.Osuf
SharedLibraryTarget(castorrtcopy,$(RTCPLIB_OBJS),$(DEPLIB),$(LIBS))
RTCPLIBS = SharedLibraryTargetName(castorrtcopy)

TapeProgramTarget(tpread,tpread.Osuf,$(RTCPLIBS) $(DEPLIB),$(RTCPLIBS) $(LIBS),0755)
LinkFile(tpwrite,tpread,755,tape)
EXEMANPAGE(tpread)
EXEMANPAGE(tpwrite)

RTCPCLD_MT_OBJS = rtcpcldcommon_mt.Osuf
RTCPCLD_OBJS =	rtcpcldcommon.Osuf rtcpcldCatalogueInterface.Osuf rtcpcldVmgrInterface.Osuf rtcpcldNsInterface.Osuf
NormalProgramTarget(rtcpclientd,rtcpclientd.Osuf $(RTCPCLD_OBJS),$(RTCPLIBS) $(DEPLIB),$(RTCPLIBS) $(LIBS),0750)
NormalProgramTarget(recaller,recaller.Osuf $(RTCPCLD_OBJS) $(RTCPCLD_MT_OBJS),$(RTCPLIBS) $(DEPLIB),$(RTCPLIBS) $(LIBS),0750)
NormalProgramTarget(migrator,migrator.Osuf $(RTCPCLD_OBJS) $(RTCPCLD_MT_OBJS),$(RTCPLIBS) $(DEPLIB),$(RTCPLIBS) $(LIBS),0750)
NormalProgramTarget(tperrhandler,TapeErrorHandler.Osuf $(RTCPCLD_OBJS),$(RTCPLIBS) $(DEPLIB),$(RTCPLIBS) $(LIBS),0750)
EXEMANPAGE(rtcpclientd)
TapeMakeDir($(LOGDIR),0755)
LOGROTATE(castor-rtcopy-clientserver,..,install)
SYSCONFIG(rtcpclientd,install)
INITSCRIPT(rtcpclientd,install)

MakeDir($(RTCOPYWORKDIR),777)
RTCPD_OBJS =	rtcpd.Osuf rtcp_CallVMGR.Osuf rtcp_CheckReq.Osuf \
		rtcp_Listen.Osuf rtcp_SendRecv.Osuf rtcp_log.Osuf \
		rtcpd_ClientListen.Osuf rtcpd_Ctape.Osuf rtcpd_Disk.Osuf \
		rtcpd_MainCntl.Osuf rtcpd_SelfMonitor.Osuf rtcpd_Tape.Osuf \
		rtcpd_TapeIO.Osuf rtcp_InitNW.Osuf \
		rtcpd_ConvertData.Osuf \
		rtcpc_BuildReq.Osuf rtcpapi.Osuf rtcp_RetvalSHIFT.Osuf \
		rtcpd_tpdump.Osuf Ctape_dummies.Osuf rtcp_accounting.Osuf
TapeProgramTarget(rtcpd,$(RTCPD_OBJS),$(DEPLIB),$(LIBS) -lz,0750)
TapeProgramTarget(killjid,killjid.Osuf,$(RTCPLIBS) $(DEPLIB),$(RTCPLIBS) $(LIBS),0750)
EXEMANPAGE(rtcpd)
EXEMANPAGE(killjid)
LOGROTATE(castor-rtcopy-server,..,installtape)
SYSCONFIG(rtcpd,installtape)
INITSCRIPT(rtcpd,installtape)
