COMM
COMM Imakefile,v 1.26 2005/10/17 11:38:52 CERN IT-PDP/DM Olof Barring
COMM

COMM
COMM Copyright (C) 1999-2001 by CERN/IT/PDP/DM
COMM  All rights reserved
COMM

COMM         Make RTCOPY API library and server

COMM
COMM Define the remote tape copy daemon log file.
COMM
LOGDIR = /var/log/castor
LOGFILE = $(LOGDIR)/rtcpd_legacy.log

COMM
COMM Define the working directory of
COMM the remote tape copy jobs.
COMM
RTCOPYWORKDIR = /var/lib/castor/rtcpd

COMM
COMM Define the file indicating that more
COMM tape request should be submit on the
COMM server.
COMM
NOMORETAPES = OperatorDir.nomoretapes

COMM
COMM Define the file indicating the hosts
COMM authorized to use remotely rtcopy server
COMM
AUTHORIZEDHOSTS = AuthorizedHosts

COMM
COMM Define CASTOR Name server root path name to prevent
COMM tpread/tpwrite request to/from HSM files
COMM
NS_ROOT = NsRoot

COMM
COMM Set this flag to -O for optimization, or -g for debug
COMM

VDQMFLG = -DVDQM
CTAPEFLG = -DCTAPE
ACCTON= -DACCTON
SACCTDIR = SacctDir
SACCTFILE = $(SACCTDIR)/sacct
ACCTFILE = -DACCTFILE=\"$(SACCTFILE)\"

SCONFIGFILE = ShiftConfigFile
CONFIGFILE = -DCONFIGFILE=\"$(SCONFIGFILE)\"

TPCONFIGFILE = TapeConfigFile
TPCONFIG = -DTPCONFIG=\"$(TPCONFIGFILE)\"

RTCPCLDHOST = RtcpclientdHost

#ifdef StagerSuperUser
RTCPCLDUSER = StagerSuperUser
#else
RTCPCLDUSER = stage
#endif

#ifdef StagerSuperGroup
RTCPCLDGROUP = StagerSuperGroup
#else
RTCPCLDGROUP = st
#endif

RTCPCLDFLAGS = -DRTCPCLD_NOTIFY_HOST=\"$(RTCPCLDHOST)\" -DRTCPCLD_USER=\"$(RTCPCLDUSER)\" -DRTCPCLD_GROUP=\"$(RTCPCLDGROUP)\"

#if BuildSecureRtcopy
SECURITYFLAG=-DCSEC
LDFLAGS += -ldl
#endif

CPPFLAGS += -DBIN=\"$(BIN)\" -DRTCOPY_LOGFILE=\"$(LOGFILE)\" -DNOMORETAPES=\"$(NOMORETAPES)\" \
	    -DAUTH_HOSTS=\"$(AUTHORIZEDHOSTS)\" -DWORKDIR=\"$(RTCOPYWORKDIR)\" \
	    -DNS_ROOT=\"$(NS_ROOT)\" $(ACCTON) $(CONFIGFILE) $(TPCONFIG) \
	    -DRTCP_SERVER -DVMGR $(VDQMFLG) $(CTAPEFLG) -DSACCT $(ACCTFILE) $(RTCPCLDFLAGS)
CFLAGS += $(SECURITYFLAG)

CommonDependsOnLibrary(common,castorcommon)
CommonDependsOnLibrary(dlf,castordlf)
CommonDependsOnLibrary(castor,castorclient)
CommonDependsOnLibrary(ns,castorns)
CommonDependsOnLibrary(vmgr,castorvmgr)
CommonDependsOnLibrary(vdqm,castorvdqm)
CommonDependsOnLibrary(tape,castortape)
CommonDependsOnLibrary(expert,castorexpert)

rtcpc_SendRecv.c:	DepSourceName(rtcopy,rtcp_SendRecv.c)
			RemoveFiles(rtcpc_SendRecv.c)
			cp rtcp_SendRecv.c rtcpc_SendRecv.c
rtcpc_log.c:		DepSourceName(rtcopy,rtcp_log.c)
			RemoveFiles(rtcpc_log.c)
			cp rtcp_log.c rtcpc_log.c
rtcpc_CallVMGR.c:	DepSourceName(rtcopy,rtcp_CallVMGR.c)
			RemoveFiles(rtcpc_CallVMGR.c)
			cp rtcp_CallVMGR.c rtcpc_CallVMGR.c
rtcpc_CheckReq.c:	DepSourceName(rtcopy,rtcp_CheckReq.c)
			RemoveFiles(rtcpc_CheckReq.c)
			cp rtcp_CheckReq.c rtcpc_CheckReq.c
rtcpc_SendRecv.o: rtcpc_SendRecv.c
	$(COMPILE.c) $(OUTPUT_OPTION) -URTCP_SERVER $<
rtcpc_log.o: rtcpc_log.c
	$(COMPILE.c) $(OUTPUT_OPTION) -URTCP_SERVER $<
rtcpc_CallVMGR.o: rtcpc_CallVMGR.c
	$(COMPILE.c) $(OUTPUT_OPTION) -URTCP_SERVER $<
rtcpc_CheckReq.o: rtcpc_CheckReq.c
	$(COMPILE.c) $(OUTPUT_OPTION) -URTCP_SERVER $<
FilesToClean += rtcpc_log.c rtcpc_SendRecv.c rtcpc_CallVMGR.c rtcpc_CheckReq.c

RTCPLIB_OBJS =	rtcpc_SendRecv.o rtcp_InitNW.o rtcpc_log.o rtcpc_CallVMGR.o rtcp_Listen.o rtcpapi.o rtcpc_BuildReq.o rtcp_RetvalSHIFT.o rtcpc_CheckReq.o
SharedLibraryTarget(castorrtcopy,$(RTCPLIB_OBJS),,)
RTCPLIBS = SharedLibraryTargetName(castorrtcopy)

TapeProgramTarget(tpread,tpread.o,$(RTCPLIBS),$(RTCPLIBS),0755)
LinkFile(tpwrite,tpread,755,tape)
EXEMANPAGE(tpread)
EXEMANPAGE(tpwrite)

RTCPCLD_MT_OBJS = rtcpcldcommon_mt.o
RTCPCLD_OBJS =	rtcpcldcommon.o rtcpcldCatalogueInterface.o rtcpcldVmgrInterface.o rtcpcldNsInterface.o
NormalProgramTarget(rtcpclientd,rtcpclientd.o $(RTCPCLD_OBJS),$(RTCPLIBS),$(RTCPLIBS),0750)
NormalProgramTarget(recaller,recaller.o $(RTCPCLD_OBJS) $(RTCPCLD_MT_OBJS),$(RTCPLIBS),$(RTCPLIBS),0750)
NormalProgramTarget(migrator,migrator.o $(RTCPCLD_OBJS) $(RTCPCLD_MT_OBJS),$(RTCPLIBS),$(RTCPLIBS),0750)
NormalProgramTarget(tperrhandler,TapeErrorHandler.o $(RTCPCLD_OBJS),$(RTCPLIBS),$(RTCPLIBS),0750)
EXEMANPAGE(rtcpclientd)
TapeMakeDir($(LOGDIR),0755)
LOGROTATE(castor-rtcopy-clientserver,..,install)
SYSCONFIG(rtcpclientd,install)
INITSCRIPT(rtcpclientd,install)

MakeDir($(RTCOPYWORKDIR),777)
RTCPD_OBJS =	rtcpd.o rtcp_CallVMGR.o rtcp_CheckReq.o \
		rtcp_Listen.o rtcp_SendRecv.o rtcp_log.o \
		rtcpd_ClientListen.o rtcpd_Ctape.o rtcpd_Disk.o \
		rtcpd_MainCntl.o rtcpd_SelfMonitor.o rtcpd_Tape.o \
		rtcpd_TapeIO.o rtcp_InitNW.o \
		rtcpd_ConvertData.o \
		rtcpc_BuildReq.o rtcpapi.o rtcp_RetvalSHIFT.o \
		rtcpd_tpdump.o Ctape_dummies.o rtcp_accounting.o
TapeProgramTarget(rtcpd,$(RTCPD_OBJS),,-lz,0750)
TapeProgramTarget(killjid,killjid.o,$(RTCPLIBS),$(RTCPLIBS),0750)
EXEMANPAGE(rtcpd)
EXEMANPAGE(killjid)
LOGROTATE(castor-rtcopy-server,..,installtape)
SYSCONFIG(rtcpd,installtape)
INITSCRIPT(rtcpd,installtape)
