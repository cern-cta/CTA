COMM       @(#)Imakefile,v 1.12 2002/11/28 06:54:12 CERN IT-PDP/DM Jean-Philippe Baud
COMM
COMM  Copyright (C) 1990-2002 by CERN/IT/PDP/DM
COMM  All rights reserved
COMM

COMM		Make CASTOR libraries and executables

#include <Library.tmpl>

SUBDIRS = $(LIBDIR) $(SHLIBDIR) $(COMMONDIR) $(UPVDIR) $(DBDIR) $(NSDIR) $(RFIODIR) \
	  $(DLFDIR) $(EXPERTDIR) $(RMCDIR) $(SYSREQDIR) $(RTCOPYDIR) $(CLIENTSDIR) $(STAGEDIR) \
	  $(STAGEDIROLD) $(TAPEDIR) $(VDQMDIR) $(VMGRDIR) $(COPYTAPEDIR) \
	  $(EXAMPLESDIR) $(HPSSDIR) $(HSMTOOLSDIR) h $(COMMONCPPDIR) $(SECURITYDIR) config \
	  $(RESOURCEMONITORINGDIR) $(JOBDIR) $(GRIDFTPDIR)

EXPORTSUBDIRS = $(LIBDIR) $(SHLIBDIR) $(COMMONDIR) $(UPVDIR) $(DBDIR) $(NSDIR) $(RFIODIR) \
	  $(DLFDIR) $(EXPERTDIR) $(RMCDIR) $(SYSREQDIR) $(RTCOPYDIR) $(CLIENTSDIR) $(STAGEDIR) $(STAGEDIROLD) \
	  $(TAPEDIR) $(VDQMDIR) $(VMGRDIR) $(COPYTAPEDIR) $(EXAMPLESDIR) \
	  $(HPSSDIR) $(HSMTOOLSDIR) h config $(COMMONCPPDIR) $(RESOURCEMONITORINGDIR) $(JOBDIR) \
	  $(GRIDFTPDIR)

DEPENDDIRS = $(COMMONDIR) $(UPVDIR) $(DBDIR) $(NSDIR) $(RFIODIR) $(DLFDIR) $(EXPERTDIR) \
	  $(RMCDIR) $(SYSREQDIR) $(RTCOPYDIR) $(CLIENTSDIR) $(STAGEDIR) $(STAGEDIROLD) $(TAPEDIR) \
	  $(VDQMDIR) $(VMGRDIR) $(COMMANDSDIR) $(COPYTAPEDIR) $(EXAMPLESDIR) \
	  $(HPSSDIR) $(HSMTOOLSDIR) $(COMMONCPPDIR) $(RESOURCEMONITORINGDIR) $(JOBDIR) \
	  $(GRIDFTPDIR)

EXPORTBIN=$(EXPORT)/bin
EXPORTLIB=$(EXPORT)/lib
EXPORTINC=$(EXPORTSHR)/include
EXPORTH=$(EXPORTINC)/shift

MakeSubdirs(all,$(SUBDIRS))
MakeSubdirs(install,$(SUBDIRS))
MakeSubdirs(install.man,$(SUBDIRS))
MakeCondSubdirs(clean,$(SUBDIRS),imakeclean)
MakeCondSubdirs(clobber,$(SUBDIRS),imakeclobber)

#ifndef _WIN32
purge: clobber
	find . -name Makefile -print | grep -v codeGeneration | xargs rm -f;	\
	find . -name Makefile.bak -print | grep -v codeGeneration | xargs rm -f
#else
purge: clobber
#endif

#if defined(_WIN32)
cernlib:
	@(cd lib & $(MAKE) $(MFLAGS) & cd ..)
imakeclean:
	@(cd imake & $(MAKE) $(MFLAGS) -f Makefile.ini.Win32 clean & cd ..)
imakeclobber:
	@(cd imake & $(MAKE) $(MFLAGS) -f Makefile.ini.Win32 clobber & cd ..)
#else
cernlib:
	@(cd lib; $(MAKE) $(MFLAGS))
imakeclean:
	@(cd imake; $(MAKE) $(MFLAGS) -f Makefile.ini clean)
imakeclobber:
	@(cd imake; $(MAKE) $(MFLAGS) -f Makefile.ini clobber)
#endif

export:
	(if [ "x$(EXPORT)" = "x" ] ; \
	 then \
	 echo "EXPORT must be set (thru make or environment)" ; exit 1 ; \
	 else \
	 echo "exporting to $(EXPORT)" ; \
	fi ; \
	for i in $(EXPORTSUBDIRS) ;\
	do (echo " $$i (EXPORT):" ; cd $$i ; \
	    $(MAKE) $(MFLAGS) EXPORTBIN=$(EXPORTBIN) EXPORTLIB=$(EXPORTLIB) $@ ; \
	 ) ; done ; \
	) ;

exportman:
	(if [ "x$(EXPORTMAN)" = "x" ] ; \
	 then \
	 echo "EXPORTMAN must be set (thru make or environment)" ; exit 1 ; \
	 else \
	 echo "exporting to $(EXPORTMAN)" ; \
	fi ; \
	for i in $(EXPORTSUBDIRS) ;\
	do (echo " $$i (EXPORTMAN):" ; cd $$i ; \
	    $(MAKE) $(MFLAGS) EXPORTMAN=$(EXPORTMAN) $@ ; \
	 ) ; done ; \
	) ;

exportshr:
	(if [ "x$(EXPORTSHR)" = "x" ] ; \
	 then \
	 echo "EXPORTSHR must be set (thru make or environment)" ; exit 1 ; \
	 else \
	 echo "exporting to $(EXPORTSHR)" ; \
	fi ; \
	for i in $(EXPORTSUBDIRS) ;\
	do (echo " $$i (EXPORTSHR):" ; cd $$i ; \
	    $(MAKE) $(MFLAGS) EXPORTSHR=$(EXPORTSHR) EXPORTINC=$(EXPORTINC) EXPORTH=$(EXPORTH) $@ ; \
	 ) ; done ; \
	) ;

tar:
	sh ./maketar.sh

deb:
	sh ./makedeb.sh

sql:
	sh ./makesql.sh

deploy: install FORCE 
	@(cd deploy ; perl ./proto_deploy.pl)

FORCE:

#if defined(_WIN32)
test: Makefiles
	cd test & $(MAKE) all & cd ..

Makefiles:
	@for %i in ( $(SUBDIRS) test ) \
	do @(echo %i - & cd %i & \
		..\imake\imake -I..\config & \
		$(MAKE) $(MFLAGS) $@ & cd .. )

depend:
	@echo Not supported on this platform
#else
test: Makefiles
	(cd test; $(MAKE) all)

Makefiles:
	@. ./setosflags ;\
	for i in $(SUBDIRS) test ;\
	do (if [ -d $$i ] ;\
	    then \
	      (echo " $$i:" ; cd $$i ;\
	      ../imake/imake -I../config -DOSMajorVersion="$$OSMAJNO" -DOSMinorVersion="$$OSMINNO" ;\
	      $(MAKE) $(MFLAGS) $@) ;\
	    else \
	      (echo "ERROR : No directory $$i" ;\
	      exit 1) ;\
	    fi )\
	done ;

depend:
	for i in $(DEPENDDIRS) test ;\
	do (if [ -d $$i ] ;\
	    then \
	      (echo " $$i:" ; cd $$i ;\
	      $(MAKE) $(MFLAGS) $@) ;\
	    else \
	      (echo "ERROR : No directory $$i" ;\
	      exit 1) ;\
	    fi )\
	done ;

#endif

#ifndef _WIN32
doxygen: tools/doxyconfig
	doxygen tools/doxyconfig
#endif
