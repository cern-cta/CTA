#       @(#)$RCSfile: Makefile.ini,v $ $Revision: 1.6 $ $Date: 2009/07/09 15:55:21 $ CERN IT-PDP/DM Jean-Philippe Baud
#
#  Copyright (C) 1993-1999 by CERN/IT/PDP/DM
#  All rights reserved
#
# Makefile.ini	Startup Makefile
#
#
#

.PHONY: Makefiles
Makefiles: imake/imake
	@echo "Building Makefiles"
	@for i in `find ./ -name Imakefile -exec dirname {} \;`; do                                \
             if [ $${i} == "." ]; then back_to_root=".";                                           \
	     else back_to_root=`echo $${i} | sed -r 's|^./(.)|\\1|' | sed 's|[^/][^/]*|..|g'`;     \
	     fi;                                                                                   \
	     echo " $${i}";                                                                        \
             echo $${back_to_root}; \
	     local_path_underscored=`echo $${i} | sed 's/^\.\//_/' | tr "[/]" _ | sed 's/$$/_/'`;  \
	     i_escaped=`echo $${i} | awk '{ gsub(/\//,"\\\/"); print}'`;                           \
	     back_to_root_escaped=`echo $${back_to_root} | awk '{ gsub(/\//,"\\\/"); print}'`;     \
	     (cd $$i; $${back_to_root}/imake/imake -I$${back_to_root}/config;);                    \
             sed -i -e "s/__local_path__/$$i_escaped/g"                   $${i}/Makefile 2>&1;     \
	     sed -i -e "s/__root_prefix__/$${local_path_underscored}/g"   $${i}/Makefile 2>&1;     \
	     sed -i -e "s/__back_to_root__/$${back_to_root_escaped}/g"    $${i}/Makefile 2>&1 ;	   \
	done;

imake/imake:
	$(MAKE) $(MFLAGS) -C imake -f Makefile.ini BOOTSTRAPCFLAGS="$$BOOTSTRAPCFLAGS"
