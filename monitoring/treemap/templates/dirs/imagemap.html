{% load userDefinedFilters %}

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd" >
<html>
<head>
<META HTTP-EQUIV="CACHE-CONTROL" CONTENT="PRIVATE">
<title>TreeMaps</title>

<script LANGUAGE="JavaScript">
//define global menu values

function DropDownPair(text, value)
{
	this.text = text;
	this.value = value;
}

function Modelmenu(levels,models,metrics,childrenmethods,postprocessors) 
{
	this.levels = levels;
	this.models = models;
	this.metrics = metrics;
	this.childrenmethods = childrenmethods;
	this.postprocessors = postprocessors
}

modeldynamic = new Object();

function initMenu()
{

{% for submenuname, submenu in modeldynamics.items %}
	levels = [];
	models = [];
	metrics = [];
	childrenmethods = [];
	postprocessors = [];
	
	{% for dropdownname, dropdown in submenu.items %}
	
		{% if dropdownname|equals:"levels" %}
			{% for ddentry in dropdown %}
	levels[{{forloop.counter0}}] = new DropDownPair("{{ddentry.text}}", "{{ddentry.value}}");
			{% endfor %}
		{% endif %}
		{% if dropdownname|equals:"models" %}
			{% for ddentry in dropdown %}
	models[{{forloop.counter0}}] = new DropDownPair("{{ddentry.text}}", "{{ddentry.value}}");
			{% endfor %}
		{% endif %}
		{% if dropdownname|equals:"metrics" %}
			{% for ddentry in dropdown %}
	metrics[{{forloop.counter0}}] = new DropDownPair("{{ddentry.text}}", "{{ddentry.value}}");
			{% endfor %}
		{% endif %}
		{% if dropdownname|equals:"childrenmethods" %}
			{% for ddentry in dropdown %}
	childrenmethods[{{forloop.counter0}}] = new DropDownPair("{{ddentry.text}}", "{{ddentry.value}}");
			{% endfor %}
		{% endif %}
		{% if dropdownname|equals:"postprocessors" %}
			{% for ddentry in dropdown %}
	postprocessors[{{forloop.counter0}}] = new DropDownPair("{{ddentry.text}}", "{{ddentry.value}}");
			{% endfor %}
		{% endif %}
		
	{% endfor %}
	
	modeldynamic["{{submenuname}}"] = new Modelmenu(levels, models, metrics, childrenmethods, postprocessors);
{% endfor %}

//structure:

//cookielr[level]
//	nblevels
//	models["modelname"]
//		["childrenmethod"]
//  	["metric"] todo 
//		...extendable here
cookielr = new Array();
cookielr.nblevels = {{cookierules|length}};

{% for rule in cookierules %}
	cookielr[{{forloop.counter0}}] = new Object();
	cookielr[{{forloop.counter0}}].models = []; 
	{% for model in rule.getUsedClassNames %} {% if not model|equals:'Annex' %} cookielr[{{forloop.parentloop.counter0}}].models.push("{{model}}"); {% endif %}{% endfor %}
	{% for modelname in rule.getUsedClassNames %}
		{% if not modelname|equals:'Annex' %}
			cookielr[{{forloop.parentloop.counter0}}]["{{modelname}}"] = new Object();
			cookielr[{{forloop.parentloop.counter0}}]["{{modelname}}"]["childrenmethod"] = {% for mname, methodname in rule.getModelToMethod %}{% if mname|equals:modelname%}"{{methodname}}";{% endif %}{% endfor %}
			cookielr[{{forloop.parentloop.counter0}}]["{{modelname}}"]["metric"] = {% for md, metric in rule.getModelToColumn %}{% if md|equals:modelname%}"{{metric}}";{% endif %}{% endfor %}
			cookielr[{{forloop.parentloop.counter0}}]["{{modelname}}"]["postprocessor"] = {% for md, postprocessor in rule.getModelToPostProcessor %}{% if md|equals:modelname%}"{{postprocessor}}";{% endif %}{% endfor %}
		{% endif %}
	{% endfor %}
{% endfor %}


activateJsObjects();
}

function activateJsObjects()
{		
	modelsmenu = document.getElementsByName("model")[0];
	modelsmenu.options.lenght = 0
	modelsmenu.options.add(new Option("Directory", "Dirs"))
	modelsmenu.selectedIndex = 0
	
	setModel();
	setDefaultLevel();
	setDefaultPostProcessor();
	//var optmenu = document.getElementsByName("optionsmenu")[0];
	//optmenu.style.display = "inline"
	document.getElementById("thesubtable").style.display = "inline";
}

function notImplementedWarning()
{
	childrenmenu = document.getElementsByName("childrenmethod")[0];
	//childrenmenu.disabled = false;
	levelsmenu = document.getElementsByName("level")[0];
	levelsmenu.disabled = false;
	alert("This is in a very early stage! If something doesn't work any more ,delete your cookies to restore the session and reload the page");
}

function setDefaultLevel()
{
	selected = modelsmenu.options[modelsmenu.selectedIndex].value;
	newmenu = modeldynamic[selected];
	levelsmenu = document.getElementsByName("level")[0];
	//levelsmenu
	{% for key, value in advanceddefault.items %}{% if key|equals:"level" %}valueofdefaultitem = {{value}};{% endif %}{% endfor %}
	levelsmenu.options.length = 0;
	for (var i = 0; i < newmenu.levels.length; i++)
	{
		levelsmenu.options.add(new Option(newmenu.levels[i].text, newmenu.levels[i].value));
		if (newmenu.levels[i].value == valueofdefaultitem) 
		{
			levelsmenu.selectedIndex = i;
		}
	}
	//levelsmenu.disabled = true;
}

function setModel()
{
	modelsmenu = document.getElementsByName("model")[0];
	levelsmenu = document.getElementsByName("level")[0];
	metricsmenu = document.getElementsByName("metric")[0];
	childrenmenu = document.getElementsByName("childrenmethod")[0];
	
	selected = modelsmenu.options[modelsmenu.selectedIndex].value;
	newmenu = modeldynamic[selected];
	
	//modelsmenu
	{% for key, value in advanceddefault.items %}{% if key|equals:"model" %}valueofdefaultitem = "{{value}}";{% endif %}{% endfor %}
	modelsmenu.options.length = 0;
	for (var i = 0; i < newmenu.models.length; i++)
	{	
		modelsmenu.options.add(new Option(newmenu.models[i].text, newmenu.models[i].value));
		if (newmenu.models[i].value == selected)
		{
			modelsmenu.selectedIndex = i;
		}
	}

	//metricsmenu
	{% for key, value in advanceddefault.items %}{% if key|equals:"metric" %}valueofdefaultitem = "{{value}}";{% endif %}{% endfor %}
	metricsmenu.options.length = 0;
	for (var i = 0; i < newmenu.metrics.length; i++)
	{
		metricsmenu.options.add(new Option(newmenu.metrics[i].text, newmenu.metrics[i].value));
		if (newmenu.metrics[i].value == valueofdefaultitem) 
		{
			metricsmenu.selectedIndex = i;
		}
	}
		
	//childrenmenu
	{% for key, value in advanceddefault.items %}{% if key|equals:"childrenmethod" %}valueofdefaultitem = "{{value}}";{% endif %}{% endfor %}
	childrenmenu.options.length = 0;
	for (var i = 0; i < newmenu.childrenmethods.length; i++)
	{
		childrenmenu.options.add(new Option(newmenu.childrenmethods[i].text, newmenu.childrenmethods[i].value)); 
		if (newmenu.childrenmethods[i].value == valueofdefaultitem) 
		{
			childrenmenu.selectedIndex = i;
		}
	}	
	//childrenmenu.disabled = true;
	//alert("Changing to " + modelsmenu.options[modelsmenu.selectedIndex].value + " not implemented yet!");
	//window.open('updatemodel=' + this.options[this.selectedIndex].value,'_top')
	//optmenu.style.display = "inline"
}

function setLevel()
{
	modelsmenu = document.getElementsByName("model")[0];
	levelsmenu = document.getElementsByName("level")[0];
	metricsmenu = document.getElementsByName("metric")[0];
	childrenmenu = document.getElementsByName("childrenmethod")[0];
	
	selectedlevel = levelsmenu.options[levelsmenu.selectedIndex].value;
	var success = selectLevel(selectedlevel);
	if (!success) return;
	
	if (selectedlevel < 0) selectedlevel = 0;
	modeltoset = cookielr[selectedlevel].models[0];
	var success = selectModel(modeltoset);
	if (!success) return;
	setModel();

	metrictoset = cookielr[selectedlevel][modeltoset]["metric"];
	var success = selectMetric(metrictoset);
	if (!success) return;

	childrenmethodtoset = cookielr[selectedlevel][modeltoset]["childrenmethod"];
	var success = selectChildrenMethod(childrenmethodtoset);
	if (!success) return;

	postprocessortoset = cookielr[selectedlevel][modeltoset]["postprocessor"];
	var success = selectPostprocessor(postprocessortoset);
	if (!success) return;
}

function setDefaultPostProcessor()
{
	postprocessorsmenu = document.getElementsByName("postprocessor")[0];
	modelsmenu = document.getElementsByName("model")[0];
	
	selected = modelsmenu.options[modelsmenu.selectedIndex].value;
	newmenu = modeldynamic[selected];
	
	//postprocessorsmenu
	{% for key, value in advanceddefault.items %}{% if key|equals:"postprocessor" %}valueofdefaultitem = "{{value}}";{% endif %}{% endfor %}
	postprocessorsmenu.options.length = 0;
	for (var i = 0; i < newmenu.postprocessors.length; i++)
	{	
		postprocessorsmenu.options.add(new Option(newmenu.postprocessors[i].text, newmenu.postprocessors[i].value));
		if (newmenu.postprocessors[i].value == valueofdefaultitem)
		{
			postprocessorsmenu.selectedIndex = i;
		}
	}
	
}

function selectLevel(levelvalue)
{
	levelsmenu = document.getElementsByName("level")[0];
	var index = -1;
	for(var i = 0; i < levelsmenu.options.length; ++i)
	{
		if (levelsmenu.options[i].value == levelvalue) {index = i;}
	}	          
	if(index < 0) return false;                                 	
	levelsmenu.selectedIndex = parseInt(index);
	return true;
}

function selectModel(modelvalue)
{
	modelsmenu = document.getElementsByName("model")[0];
	var index = -1;
	for(var i = 0; i < modelsmenu.options.length; ++i)
	{
		if (modelsmenu.options[i].value == modelvalue) index = i;
	}	          
	if(index < 0) return false;                                   	
	modelsmenu.selectedIndex = index;
	return true;
}

function selectMetric(metricvalue)
{
	metricsmenu = document.getElementsByName("metric")[0];
	var index = -1;
	for(var i = 0; i < metricsmenu.options.length; ++i)
	{
		if (metricsmenu.options[i].value == metricvalue) index = i;
	}	          
	if(index < 0) return false;                                   	
	metricsmenu.selectedIndex = index;
	return true;
}

function selectPostprocessor(postpvalue)
{
	postprocessormenu = document.getElementsByName("postprocessor")[0];
	var index = -1;
	for(var i = 0; i < postprocessormenu.options.length; ++i)
	{
		if (postprocessormenu.options[i].value == postpvalue) index = i;
	}	          
	if(index < 0) return false;                                   	
	postprocessormenu.selectedIndex = index;
	return true;
}

function selectChildrenMethod(childrenmethodvalue)
{
	childrenmethodsmenu = document.getElementsByName("childrenmethod")[0];
	var index = -1;
	for(var i = 0; i < childrenmethodsmenu.options.length; ++i)
	{
		if (childrenmethodsmenu.options[i].value == childrenmethodvalue) index = i;
	}	          
	if(index < 0) return false;                                   	
	childrenmethodsmenu.selectedIndex = index;
	return true;
}

function showHelp()
{
	var text = "The advanced configuration is not user friendly yet. \nAnyway, here is an example how you are influencing a single level in the data tree:\n\n";
	{% for explanation in ruleexplanations %}
		text = text + "{{explanation|escapefilter}}\n";
	{% endfor %}
	text = text.replaceAll("<br>", "\n");
	text = text + "If you choose \"all levels\" the same Rule will be applied to all levels.\n"
	alert(text);
}

// Replaces all instances of the given substring.
String.prototype.replaceAll = function(oldsubstr, substr)
{
	var filtered = this;
	var match = filtered.indexOf(oldsubstr);
	 
	while (match != -1)
	{
		filtered = filtered.replace(oldsubstr, substr);
		match = filtered.indexOf(oldsubstr);
	}
	return filtered;
}

</script>

</head>
<body bgcolor="#1F1F1F" text = "#7F7F7F" link = "#FFFFFF" vlink = "#7F7F7F" alink = "#9F9F9F" onload="initMenu()">
    {% if nodes %}

    <table style="width: auto; height: auto;" align="center">
    
    <tr>
      <td align="center" valign="middle">
    	<p><a href="/treemaps/{{parentid}}"> <img border="0" title="one level back" src="{{icondir}}/arrow.png"></a></p>
      </td>
    </tr>
    
    
    <tr>
    
    <!-- The map -->
    <td align="center" valign="middle" width={{imagewidth}} style="height: auto">     	
        	<ul id="map">
 			{% for x1, y1 ,x2 , y2, hash, theid, info in mapparams %}
					<li>
						<a class="cls{{hash}}" href="/treemaps/{{theid}}" title = "">
							<span>
								{{ info|escapefilter }}
							</span>
						</a>
					</li>
        	{% endfor %}
        	</ul>  
	   <br>{% for dirname, flname, theid in navilink %}<a href="/treemaps/{{theid}}" title = {{flname}}>{{dirname}}</a>{% if forloop.counter0 %}/{% endif %}{% endfor %}
	</td>	
	
		<!-- The options -->
		<td align="left" valign="top" height={{imageheight}}>	
		
		
		<!--  make the menu visible if JavaScript is activated -->
		<!-- The dropdown menus are hold in a table to have them ordered right -->
			<table id = "thesubtable" name = "optionsmenu" style="display:none;">
			<tr>
				<form action="/treemaps/{{rootsuffix}}/preset/" method="post">
					<tr>
					<td class="descriptiontext">Presets:</td> 
					
					<td><select class="dmenuwidth" name="preset" id="id_preset">
						{% for presetname in presetnames %}
							<option {% spaceless %}
							{% for key, value in presetdefault.items %}
								{% if key|equals:"presetname" and value|equals:presetname %}selected{% endif %}
							{% endfor %}
							{% endspaceless %} value="{{presetname}}">{{presetname}}</option>
						{% endfor %}
					</select></td></tr>
					
					<tr><td></td><td class="descriptiontext">
						<input id="id_flat" type="checkbox" name="flat_view" value="true" {% spaceless %}{% for key, value in presetdefault.items %}{% if key|equals:"flat" and value|bool %}checked{% endif %}{% endfor %}{% endspaceless %}> Flat view
					</td></tr>
					<tr><td></td><td class="descriptiontext">
						<input id="id_smalltobig" type="checkbox" name="smalltobig" value="true" {% spaceless %}{% for key, value in presetdefault.items %}{% if key|equals:"smalltobig" and value|bool %}checked{% endif %}{% endfor %}{% endspaceless %}> Lowest values
					</td></tr>
					
					<tr><td>
						<input class="applybutton" type="submit" value="Apply"/>
					</td></tr>
				</form>
					
				<form action="/treemaps/{{rootsuffix}}/changemetrics/" method="post" onsubmit="notImplementedWarning()">
					
					<tr><td><br></td></tr>
					<tr><td class="advancedtext">Advanced</td> </td></tr>
				
					<tr>
					<td class="descriptiontext">Level:</td> 
					
					<td><select class="dmenuwidth" name="level" id="id_level" onchange="setLevel()">
					</select></td></tr>
					
					<tr>
					<td class="descriptiontext">Model:</td>
					<td><select class="dmenuwidth" name="model" id="id_model" onchange="setModel()">
					</select></td></tr>
					
					<tr>
					<td class="descriptiontext">Metric:</td>
					<td><select class="dmenuwidth" name="metric" id="id_metric">
					</select></td></tr>
					
					<tr>
					<td class="descriptiontext">Getting children:</td>
					<td><select class="dmenuwidth" name="childrenmethod" id="id_childrenmethod">
					</select></td></tr>
					
					<tr>
					<td class="descriptiontext">Value processing:</td>
					<td><select class="dmenuwidth" name="postprocessor" id="id_postprocessor">
					</select></td></tr>
					<tr><td>
						<br>
						<input class="applybutton" type="submit" value="Apply"/>
						<input class="applybutton" type="button" value="Help" onclick="showHelp()"/>

					</td></tr>
				</form>

			</tr>
			</table>
		</td>	
		<noscript>
			<div style="color:#7F1F1F" align = "center">
				This page will have limited functionality <br>
				Please enable JavaScript and reload the page
			</div>
		</noscript>
		
	</tr></table>
    {% else %}
        <p>No data available / A file or an empty folder</p>
    {% endif %}
</body>


    <style type="text/css">
     .dmenuwidth {
     width:200px;
     background-color:#1F1F1F;
     color:#7F7F7F;
     }
    </style>
    
    <style type="text/css">
     .descriptiontext {
		font-size: 14px;
		color:#CFCFCF;
     }
    </style>
    
    <style type="text/css">
     .advancedtext {
		font-size: 14px;
		color:#00CF00;
     }
    </style>
    
    <style type="text/css">
     .applybutton {
     background-color:#000000;
     color:#FF0000;
     }
    </style>
<style type="text/css">
					#map {
						position:relative;
						margin:0;
						padding:0;
						width:{{imagewidth}}px;
						height:{{imageheight}}px;
						background:url({{treemapdir}}/{{filename}}) top left no-repeat #fff;
						font-family:arial, helvetica, sans-serif;
						font-size:{{tooltipfontsize}}pt;
						color:#FFF;
						text-align: left;
					}
					
					#map li {
						margin:0;
						padding:0;
						list-style:none;
					}
					
					#map li a {
						position:absolute;
						display:block;
						/*style="width: auto"
						   Specifying a background image
						   (a 1px by 1px transparent gif)
						   fixes a bug in older versions of
						   IE that causeses the block to not
						   render at its full dimensions.
						*/
			   			background:url({{icondir}}/blank.gif);
			   			text-decoration:none;
						color:#000;
					}
					
					#map li a span { display:none; }
					
				{% for shiftx, shifty, twidth, theight, hash, theid in tooltipshift %}
					#map li a.cls{{hash}}:hover span 
					{
						position:relative;
						display:block;
						width:{{twidth}}px;
						height:{{theight}}px;
						left:{{shiftx}}px;
						top:{{shifty}}px;
						border:1px solid #000;
						background:#fff;
						padding:5px;
			 			filter:alpha(opacity=70);
						opacity:0.8;
			  		}
			  	{% endfor %}
				
				{% for x1, y1 ,x2 ,y2, hash, theid, info in mapparams %}
					#map a.cls{{hash}} 
					{
						top:{{y1}}px;
						left:{{x1}}px;
						width:{{x2|sub:x1}}px;
						height:{{y2|sub:y1}}px;
					}
				{% endfor %}
				
			   </style>
</html>
