COMM       @(#)$RCSfile: Imakefile,v $ $Revision: 1.18 $ $Date: 2004/06/30 16:34:04 $ CERN IT-PDP/DM Jean-Philippe Baud
COMM
COMM  Copyright (C) 2000-2002 by CERN/IT/PDP/DM
COMM  All rights reserved
COMM

COMM 		Make CASTOR shared libraries           GENERIC

#include <Library.tmpl>

LIB = InstallLibDir

COMM Archive symbol table entry name
#if __osf__ && __alpha
SYMTABNAM = ________64ELEL_
#else
SYMTABNAM = __.SYMDEF
#endif

COMM Libraries to include in SharedLibraryTargetName(shift)
LIBRARIES0 = $(COMMONLIB) $(RFIOLIB) $(SYSREQLIB) $(HPSSLIB) $(NSLIB) $(STGLIB) $(VMGRLIB) $(UPVLIB) $(RHCLIENTLIB) $(SECURITYLIB) $(RTCOPYLIB) $(VDQMLIB) $(DLFLIB) $(TAPELIB) $(DBLIB) $(MONITORLIB) $(EXPERTLIB)
LIBRARIES2 = $(RHORALIB)
SHLIBREQLIBS2 = $(SHLIBREQLIBS) -L$(ORACLE_HOME)/lib -locci -lclntsh -L . -lshift
LIBRARIES3 = $(RHPROTOLIB)
SHLIBREQLIBS3 = $(SHLIBREQLIBS)

ALL0=SharedLibraryTargetName(shift)
#if BuildOraCpp
ALL1=SharedLibraryTargetName(castorCommonOra)
#endif
#if BuildProtoCppStager
ALL2=SharedLibraryTargetName(castorProto)
#endif

all:    $(ALL0) $(ALL1) $(ALL2)

INSTALL0=FileName($(LIB),SharedLibraryTargetName(shift))
#if BuildOraCpp
INSTALL1=FileName($(LIB),SharedLibraryTargetName(castorCommonOra))
#endif
#if BuildProtoCppStager
INSTALL2=FileName($(LIB),SharedLibraryTargetName(castorProto))
#endif

install: $(LIB) $(INSTALL0) $(INSTALL1) $(INSTALL2)

EXPORT0=$(EXPORTLIB)/SharedLibraryTargetName(shift)
#if BuildOraCpp
EXPORT1=$(EXPORTLIB)/SharedLibraryTargetName(castorCommonOra)
#endif
#if BuildProtoCppStager
EXPORT2=$(EXPORTLIB)/SharedLibraryTargetName(castorProto)
#endif

export: $(EXPORT0) $(EXPORT1) $(EXPORT2)

exportman: 

exportshr: 

libshift.sl libshift.so:     $(LIBRARIES0)
	@echo " making $@ in `pwd`"
	@-rm -rf tmp
	@mkdir tmp
	@for i in $(LIBRARIES0) ;\
	do (cd tmp; $(AR) x ../$$i; rm -f $(SYMTABNAM)) done
	@(cd tmp; $(CXX) $(SHLIBLDFLAGS) -o ../$@ *.o $(SHLIBREQLIBS))
	@-rm -rf tmp

libcastorCommonOra.so: $(LIBRARIES2)
	@echo " making $@ in `pwd`"
	@-rm -rf tmp
	@mkdir tmp
	@for i in $(LIBRARIES2) ;\
	do (cd tmp; $(AR) x ../$$i; rm -f $(SYMTABNAM)) done
	@(cd tmp; $(CXX) $(SHLIBLDFLAGS) -o ../$@ *.o $(SHLIBREQLIBS2))
	@-rm -rf tmp

libcastorProto.so: $(LIBRARIES3)
	@echo " making $@ in `pwd`"
	@-rm -rf tmp
	@mkdir tmp
	@for i in $(LIBRARIES3) ;\
	do (cd tmp; $(AR) x ../$$i; rm -f $(SYMTABNAM)) done
	@(cd tmp; $(CXX) $(SHLIBLDFLAGS) -o ../$@ *.o $(SHLIBREQLIBS3))
	@-rm -rf tmp

shift.dll:	$(LIBRARIES0)
	@echo  making $@ in CurDir
	link /dll /noentry /nologo /out:$@ $**

libcastorCommonOra.dll:	$(LIBRARIES2)
	@echo  making $@ in CurDir
	link /dll /noentry /nologo /out:$@ $**

libcastorProto.dll:	$(LIBRARIES2)
	@echo  making $@ in CurDir
	link /dll /noentry /nologo /out:$@ $**

MakeDir($(LIB),root,bin,0755)

InstallSharedLibrary(shift,__CASTOR_VERSION__,$(LIB))
InstallSharedLibrary(castorCommonOra,__CASTOR_VERSION__,$(LIB))
InstallSharedLibrary(castorProto,__CASTOR_VERSION__,$(LIB))

InstallSharedLibrary(shift,__CASTOR_VERSION__,$(EXPORTLIB))
InstallSharedLibrary(castorCommonOra,__CASTOR_VERSION__,$(EXPORTLIB))
InstallSharedLibrary(castorProto,__CASTOR_VERSION__,$(EXPORTLIB))

install.man:

#if _WIN32
clean:
	@echo cleaning in CurDir
	-@RemoveFiles(FilesToClean)
#else
clean:
	@echo cleaning in CurDir
	-@RemoveFiles(FilesToClean)
	-@rm -rf tmp > /dev/null 2>&1
#endif
clobber:        clean

Makefiles:

MakeDepLibrary(common,common)

MakeDepLibrary(rfio,rfio)

MakeDepLibrary(sysreq,sysreq)

#if BuildHpssClient
MakeDepLibrary(hpss,hpss_common)
#endif

MakeDepLibrary(ns,ns)

MakeDepLibrary(stage,stage)

MakeDepLibrary(vmgr,vmgr)

MakeDepLibrary(upv,upv)

MakeDepLibrary(castor,castorClient)

MakeDepLibrary(castor/proto,castorProto)

MakeDepLibrary(rtcopy,rtcpapi)

MakeDepLibrary(vdqm,vdqmapi)

MakeDepLibrary(dlf,dlf)

MakeDepLibrary(tape,tape)

MakeDepLibrary(castor/db/ora,castorCommonOra)

FORCE:

