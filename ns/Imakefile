COMM
COMM  Copyright (C) 1999-2003 by CERN/IT/PDP/DM
COMM  All rights reserved
COMM
COMM       @(#)Imakefile,v 1.51 2004/06/09 16:10:35 CERN IT-PDP/DM Jean-Philippe Baud

COMM    Make name server programs.

CNS_HOST = NsHost
SCNS_HOST = SNsHost
CNSHOSTPFX = NsHostPfx
SCNSHOSTPFX = SNsHostPfx

LDFLAGS += -luuid
NSLIB = SharedLibraryTargetName(castorns)
LOGDIR = /var/log/castor
LOGFILE = $(LOGDIR)/nsd.log
LCGDM_MAPFILE = IdMapFile
NSCONFIG = NsConfigFile

#if UseGSI
GLOBUS_LOCATION=GlobusLocation
#if defined(__STDC__)
GLOBUS_FLAVOUR=GlobusFlavour##pthr
#else
GLOBUS_FLAVOUR=GlobusFlavour/**/pthr
#endif
GLOBUS_LIBS=-L$(GLOBUS_LOCATION)/lib
LIB_CRYPTO=$(shell if [ -r "$(GLOBUS_LOCATION)/lib/libcrypto_$(GLOBUS_FLAVOUR).so" ]; then echo -lcrypto_$(GLOBUS_FLAVOUR); else echo -lcrypto; fi)
LIBCSEC += $(GLOBUS_LIBS) $(LIB_CRYPTO)
#endif
LIBCSEC += -ldl

CPPFLAGS += -DBIN=\"$(BIN)\" -DCNS_HOST=\"$(CNS_HOST)\" \
            -DSCNS_HOST=\"$(SCNS_HOST)\" \
            -DCNSHOSTPFX=\"$(CNSHOSTPFX)\" \
            -DSCNSHOSTPFX=\"$(SCNSHOSTPFX)\" \
            -DLCGDM_MAPFILE=\"$(LCGDM_MAPFILE)\" \
            -DLOGFILE=\"$(LOGFILE)\" \
            -DNSCONFIG=\"$(NSCONFIG)\" \
            $(RDSFLG) -DUSE_ORACLE -DCSEC

CPPFLAGS += -I$(ORACLE_HOME)/precomp/public

NSD_OBJS	=	Cns_main.o \
			Cns_acl.o \
			Cns_chkperm.o \
			Cns_oracle_ifce.o \
			Cns_procreq.o \
			sendrep.o \
			nslogit.o
NSLIB_OBJS	=	Cns_aborttrans.o \
                        Cns_access.o \
                        Cns_apiinit.o \
                        Cns_auth.o \
                        Cns_bulkexist.o \
                        Cns_chclass.o \
                        Cns_chdir.o \
                        Cns_chmod.o \
                        Cns_chown.o \
                        Cns_closedir.o \
                        Cns_creat.o \
                        Cns_delcomment.o \
                        Cns_delete.o \
                        Cns_deleteclass.o \
                        Cns_dropsegs.o \
                        Cns_delsegbycopyno.o \
                        Cns_du.o \
                        Cns_endsess.o \
                        Cns_endtrans.o \
                        Cns_enterclass.o \
                        Cns_errmsg.o \
                        Cns_getacl.o \
                        Cns_getcomment.o \
                        Cns_getcwd.o \
                        Cns_getlinks.o \
                        Cns_getpath.o \
                        Cns_getsegattrs.o \
                        Cns_lastfseq.o \
                        Cns_listclass.o \
                        Cns_listtape.o \
                        Cns_listlinks.o \
                        Cns_mkdir.o \
                        Cns_modifyclass.o \
                        Cns_opendir.o \
                        Cns_ping.o \
                        Cns_queryclass.o \
                        Cns_readdir.o \
                        Cns_readdirc.o \
                        Cns_readdirg.o \
                        Cns_readdirx.o \
                        Cns_readdirxc.o \
                        Cns_readdirxt.o \
                        Cns_readlink.o \
                        Cns_rename.o \
                        Cns_rewinddir.o \
                        Cns_replaceseg.o \
                        Cns_replacetapecopy.o \
                        Cns_rmdir.o \
                        Cns_selectsrvr.o \
                        Cns_setacl.o \
                        Cns_setatime.o \
                        Cns_setcomment.o \
                        Cns_setfsize.o \
                        Cns_setsegattrs.o \
                        Cns_startsess.o \
                        Cns_starttrans.o \
                        Cns_stat.o \
                        Cns_symlink.o \
                        Cns_tapesum.o \
                        Cns_umask.o \
                        Cns_undelete.o \
                        Cns_unlink.o \
                        Cns_unlinkbyvid.o \
                        Cns_updateseg_checksum.o \
                        Cns_updateseg_status.o \
                        Cns_updatefile_checksum.o \
                        Cns_utime.o \
                        send2nsd.o

CommonDependsOnLibrary(common,castorcommon)
CommonDependsOnLibrary(security,castorsecurity)
ClientSharedLibraryTarget(castorns,$(NSLIB_OBJS),,)

ClientProgramTarget(nschclass,nschclass.o,$(NSLIB),$(NSLIB),755)
ClientProgramTarget(nschmod,nschmod.o,$(NSLIB),$(NSLIB),755)
ClientProgramTarget(nschown,nschown.o,$(NSLIB),$(NSLIB),755)
ClientProgramTarget(nsdelcomment,nsdelcomment.o,$(NSLIB),$(NSLIB),755)
ClientProgramTarget(nsdeleteclass,nsdeleteclass.o,$(NSLIB),$(NSLIB),755)
ClientProgramTarget(nsdelsegment,nsdelsegment.o,$(NSLIB),$(NSLIB),755)
ClientProgramTarget(nsenterclass,nsenterclass.o,$(NSLIB),$(NSLIB),755)
ClientProgramTarget(nsfind,nsfind.o,$(NSLIB),$(NSLIB),755)
ClientProgramTarget(nsgetacl,nsgetacl.o,$(NSLIB),$(NSLIB),755)
ClientProgramTarget(nsgetpath,nsgetpath.o,$(NSLIB),$(NSLIB),755)
ClientProgramTarget(nslistclass,nslistclass.o,$(NSLIB),$(NSLIB),755)
ClientProgramTarget(nslisttape,nslisttape.o,$(NSLIB), $(NSLIB),755)
ClientProgramTarget(nsln,nsln.o,$(NSLIB),$(NSLIB),755)
ClientProgramTarget(nsls,nsls.o,$(NSLIB),$(NSLIB),755)
ClientProgramTarget(nsmkdir,nsmkdir.o,$(NSLIB),$(NSLIB),755)
ClientProgramTarget(nsmodifyclass,nsmodifyclass.o,$(NSLIB),$(NSLIB),755)
ClientProgramTarget(nsping,nsping.o,$(NSLIB),$(NSLIB),755)
ClientProgramTarget(nsrename,nsrename.o,$(NSLIB),$(NSLIB),755)
ClientProgramTarget(nsrm,nsrm.o,$(NSLIB),$(NSLIB),755)
ClientProgramTarget(nsrmdir,nsrmdir.o,$(NSLIB),$(NSLIB),755)
ClientProgramTarget(nsrmvid,nsrmvid.o,$(NSLIB),$(NSLIB),755)
ClientProgramTarget(nssetchecksum,nssetchecksum.o,$(NSLIB), $(NSLIB),755)
ClientProgramTarget(nssetacl,nssetacl.o,$(NSLIB),$(NSLIB),755)
ClientProgramTarget(nssetcomment,nssetcomment.o,$(NSLIB),$(NSLIB),755)
ClientProgramTarget(nssetfsize,nssetfsize.o,$(NSLIB),$(NSLIB),755)
ClientProgramTarget(nssetsegment,nssetsegment.o,$(NSLIB),$(NSLIB),755)
ClientProgramTarget(nstouch,nstouch.o,$(NSLIB),$(NSLIB),755)

LIBMANPAGE(Cns_aborttrans)
LIBMANPAGE(Cns_access)
LIBMANPAGE(Cns_chclass)
LIBMANPAGE(Cns_chdir)
LIBMANPAGE(Cns_chmod)
LIBMANPAGE(Cns_chown)
LIBMANPAGE(Cns_closedir)
LIBMANPAGE(Cns_creat)
LIBMANPAGE(Cns_creatg)
LIBMANPAGE(Cns_delcomment)
LIBMANPAGE(Cns_delete)
LIBMANPAGE(Cns_deleteclass)
LIBMANPAGE(Cns_dropsegs)
LIBMANPAGE(Cns_delsegbycopyno)
LIBMANPAGE(Cns_endsess)
LIBMANPAGE(Cns_endtrans)
LIBMANPAGE(Cns_enterclass)
LIBMANPAGE(Cns_getacl)
LIBMANPAGE(Cns_getcomment)
LIBMANPAGE(Cns_getcwd)
LIBMANPAGE(Cns_getsegattrs)
LIBMANPAGE(Cns_lastfseq)
LIBMANPAGE(Cns_listclass)
LIBMANPAGE(Cns_listtape)
LIBMANPAGE(Cns_listlinks)
LIBMANPAGE(Cns_mkdir)
LIBMANPAGE(Cns_mkdirg)
LIBMANPAGE(Cns_modifyclass)
LIBMANPAGE(Cns_opendir)
LIBMANPAGE(Cns_opendirg)
LIBMANPAGE(Cns_ping)
LIBMANPAGE(Cns_queryclass)
LIBMANPAGE(Cns_readdir)
LIBMANPAGE(Cns_readdirc)
LIBMANPAGE(Cns_readdirg)
LIBMANPAGE(Cns_readdirx)
LIBMANPAGE(Cns_readdirxc)
LIBMANPAGE(Cns_readdirxt)
LIBMANPAGE(Cns_readlink)
LIBMANPAGE(Cns_rename)
LIBMANPAGE(Cns_replaceseg)
LIBMANPAGE(Cns_rewinddir)
LIBMANPAGE(Cns_rmdir)
LIBMANPAGE(Cns_selectsrvr)
LIBMANPAGE(Cns_setacl)
LIBMANPAGE(Cns_setatime)
LIBMANPAGE(Cns_setcomment)
LIBMANPAGE(Cns_setfsize)
LIBMANPAGE(Cns_setsegattrs)
LIBMANPAGE(Cns_startsess)
LIBMANPAGE(Cns_starttrans)
LIBMANPAGE(Cns_stat)
LIBMANPAGE(Cns_statg)
LIBMANPAGE(Cns_symlink)
LIBMANPAGE(Cns_tapesum)
LIBMANPAGE(Cns_umask)
LIBMANPAGE(Cns_undelete)
LIBMANPAGE(Cns_unlink)
LIBMANPAGE(Cns_unlinkbyvid)
LIBMANPAGE(Cns_updateseg_checksum)
LIBMANPAGE(Cns_updateseg_status)
LIBMANPAGE(Cns_updatefile_checksum)
LIBMANPAGE(Cns_utime)
EXEMANPAGE(nschclass)
EXEMANPAGE(nschmod)
EXEMANPAGE(nschown)
EXEMANPAGE(nsdelcomment)
EXEMANPAGE(nsdeleteclass)
EXEMANPAGE(nsdelsegment)
EXEMANPAGE(nsenterclass)
EXEMANPAGE(nsfind)
EXEMANPAGE(nsgetacl)
EXEMANPAGE(nsgetpath)
EXEMANPAGE(nslistclass)
EXEMANPAGE(nslisttape)
EXEMANPAGE(nsln)
EXEMANPAGE(nsls)
EXEMANPAGE(nsmkdir)
EXEMANPAGE(nsmodifyclass)
EXEMANPAGE(nsping)
EXEMANPAGE(nsrename)
EXEMANPAGE(nsrm)
EXEMANPAGE(nsrmdir)
EXEMANPAGE(nsrmvid)
EXEMANPAGE(nssetchecksum)
EXEMANPAGE(nssetacl)
EXEMANPAGE(nssetcomment)
EXEMANPAGE(nssetfsize)
EXEMANPAGE(nssetsegment)
EXEMANPAGE(nstouch)

DependsOnLibrary(upv,castorupv)
DependsOnLibrary(dlf,castordlf)

Cns_oracle_ifce.c: Cns_oracle_ifce.pc
	proc iname=Cns_oracle_ifce include=$(CASTOR_ROOT)/h threads=yes char_map=string parse=full prefetch=1000
COMM We overwrite here the default rule for the compilation of Cns_oracle_ifce in order
COMM to be able to discard the -Werror present in the standard flags. The reason is that
COMM the code generated by proc is full of warnings...
Cns_oracle_ifce.o: Cns_oracle_ifce.c
	$(COMPILE.c) $(OUTPUT_OPTION) -Wno-error $<
FilesToClean += Cns_oracle_ifce.c Cns_oracle_ifce.lis
MakeDir($(LOGDIR),0755)
ORALIBS= -L$(ORACLE_HOME)/lib -lclntsh

NormalProgramTarget(nsd,$(NSD_OBJS),,$(ORALIBS) $(LIBCSEC),750)
ADMMANPAGE(nsd)
LOGROTATE(castor-ns-server,..,install)
SYSCONFIG(nsd,install)
INITSCRIPT(nsd,install)
CONFIGFILE(NS,..,install)
