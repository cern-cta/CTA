COMM
COMM  Copyright (C) 1999-2003 by CERN/IT/PDP/DM
COMM  All rights reserved
COMM
COMM       @(#)Imakefile,v 1.51 2004/06/09 16:10:35 CERN IT-PDP/DM Jean-Philippe Baud

COMM    Make name server programs.

CNS_HOST = NsHost
SCNS_HOST = SNsHost
CNSHOSTPFX = NsHostPfx
SCNSHOSTPFX = SNsHostPfx

INCLUDES = ../h
LIBS = -luuid
NSLIB = SharedLibraryTargetName(castorns)
SPOOL = /var/spool/ns
LOGFILE = $(SPOOL)/log
LCGDM_MAPFILE = IdMapFile
NSCONFIG = NsConfigFile
ORAFLG = -DUSE_ORACLE
ORAINC = -I$(ORACLE_HOME)/precomp/public

#if UseGSI
GLOBUS_LOCATION=GlobusLocation
#if defined(__STDC__)
GLOBUS_FLAVOUR=GlobusFlavour##pthr
#else
GLOBUS_FLAVOUR=GlobusFlavour/**/pthr
#endif
GLOBUS_LIBS=-L$(GLOBUS_LOCATION)/lib
LIB_CRYPTO=$(shell if [ -r "$(GLOBUS_LOCATION)/lib/libcrypto_$(GLOBUS_FLAVOUR).so" ]; then echo -lcrypto_$(GLOBUS_FLAVOUR); else echo -lcrypto; fi)
LIBCSEC += $(GLOBUS_LIBS) $(LIB_CRYPTO)
#endif
LIBCSEC += -ldl

DFLAGS = -DBIN=\"$(BIN)\" -DCNS_HOST=\"$(CNS_HOST)\" \
         -DSCNS_HOST=\"$(SCNS_HOST)\" \
         -DCNSHOSTPFX=\"$(CNSHOSTPFX)\" \
         -DSCNSHOSTPFX=\"$(SCNSHOSTPFX)\" \
         -DLCGDM_MAPFILE=\"$(LCGDM_MAPFILE)\" \
         -DLOGFILE=\"$(LOGFILE)\" \
         -DNSCONFIG=\"$(NSCONFIG)\" \
         $(RDSFLG) $(ORAFLG)

CFLAGS = -g -I$(INCLUDES) $(MTCCFLAGS) $(DFLAGS) $(RDSINC) $(ORAINC) -DCSEC

NSDAEMON_OBJS	=	Cns_main.Osuf \
			Cns_acl.Osuf \
			Cns_chkperm.Osuf \
			Cns_oracle_ifce.Osuf \
			Cns_procreq.Osuf \
			sendrep.Osuf \
			nslogit.Osuf
NSLIB_OBJS	=	Cns_aborttrans.Osuf \
                        Cns_access.Osuf \
                        Cns_apiinit.Osuf \
                        Cns_auth.Osuf \
                        Cns_bulkexist.Osuf \
                        Cns_chclass.Osuf \
                        Cns_chdir.Osuf \
                        Cns_chmod.Osuf \
                        Cns_chown.Osuf \
                        Cns_closedir.Osuf \
                        Cns_creat.Osuf \
                        Cns_delcomment.Osuf \
                        Cns_delete.Osuf \
                        Cns_deleteclass.Osuf \
                        Cns_dropsegs.Osuf \
                        Cns_du.Osuf \
                        Cns_endsess.Osuf \
                        Cns_endtrans.Osuf \
                        Cns_enterclass.Osuf \
                        Cns_errmsg.Osuf \
                        Cns_getacl.Osuf \
                        Cns_getcomment.Osuf \
                        Cns_getcwd.Osuf \
                        Cns_getlinks.Osuf \
                        Cns_getpath.Osuf \
                        Cns_getsegattrs.Osuf \
                        Cns_lastfseq.Osuf \
                        Cns_listclass.Osuf \
                        Cns_listtape.Osuf \
                        Cns_listlinks.Osuf \
                        Cns_mkdir.Osuf \
                        Cns_modifyclass.Osuf \
                        Cns_opendir.Osuf \
                        Cns_ping.Osuf \
                        Cns_queryclass.Osuf \
                        Cns_readdir.Osuf \
                        Cns_readdirc.Osuf \
                        Cns_readdirg.Osuf \
                        Cns_readdirx.Osuf \
                        Cns_readdirxc.Osuf \
                        Cns_readdirxt.Osuf \
                        Cns_readlink.Osuf \
                        Cns_rename.Osuf \
                        Cns_rewinddir.Osuf \
                        Cns_replaceseg.Osuf \
                        Cns_replacetapecopy.Osuf \
                        Cns_rmdir.Osuf \
                        Cns_selectsrvr.Osuf \
                        Cns_setacl.Osuf \
                        Cns_setatime.Osuf \
                        Cns_setcomment.Osuf \
                        Cns_setfsize.Osuf \
                        Cns_setsegattrs.Osuf \
                        Cns_startsess.Osuf \
                        Cns_starttrans.Osuf \
                        Cns_stat.Osuf \
                        Cns_symlink.Osuf \
                        Cns_tapesum.Osuf \
                        Cns_umask.Osuf \
                        Cns_undelete.Osuf \
                        Cns_unlink.Osuf \
                        Cns_updateseg_checksum.Osuf \
                        Cns_updateseg_status.Osuf \
                        Cns_updatefile_checksum.Osuf \
                        Cns_utime.Osuf \
                        send2nsd.Osuf

ClientDependsOnLibrary(common,castorcommon)
ClientDependsOnLibrary(security,castorsecurity)
ClientSharedLibraryTarget(castorns,$(NSLIB_OBJS),$(CLIENTDEPLIB),$(CLIENTLIBS))

ClientProgramTarget(nschclass,nschclass.Osuf,$(NSLIB) $(CLIENTDEPLIB),$(NSLIB) $(CLIENTLIBS),755)
ClientProgramTarget(nschmod,nschmod.Osuf,$(NSLIB) $(CLIENTDEPLIB),$(NSLIB) $(CLIENTLIBS),755)
ClientProgramTarget(nschown,nschown.Osuf,$(NSLIB) $(CLIENTDEPLIB),$(NSLIB) $(CLIENTLIBS),755)
ClientProgramTarget(nsdelcomment,nsdelcomment.Osuf,$(NSLIB) $(CLIENTDEPLIB),$(NSLIB) $(CLIENTLIBS),755)
ClientProgramTarget(nsdeleteclass,nsdeleteclass.Osuf,$(NSLIB) $(CLIENTDEPLIB),$(NSLIB) $(CLIENTLIBS),755)
ClientProgramTarget(nsenterclass,nsenterclass.Osuf,$(NSLIB) $(CLIENTDEPLIB),$(NSLIB) $(CLIENTLIBS),755)
ClientProgramTarget(nsfind,nsfind.Osuf,$(NSLIB) $(CLIENTDEPLIB),$(NSLIB) $(CLIENTLIBS),755)
ClientProgramTarget(nsgetacl,nsgetacl.Osuf,$(NSLIB) $(CLIENTDEPLIB),$(NSLIB) $(CLIENTLIBS),755)
ClientProgramTarget(nsgetpath,nsgetpath.Osuf,$(NSLIB) $(CLIENTDEPLIB),$(NSLIB) $(CLIENTLIBS),755)
ClientProgramTarget(nslistclass,nslistclass.Osuf,$(NSLIB) $(CLIENTDEPLIB),$(NSLIB) $(CLIENTLIBS),755)
ClientProgramTarget(nslisttape,nslisttape.Osuf,$(NSLIB) $(CLIENTDEPLIB), $(NSLIB) $(CLIENTLIBS),755)
ClientProgramTarget(nsln,nsln.Osuf,$(NSLIB) $(CLIENTDEPLIB),$(NSLIB) $(CLIENTLIBS),755)
ClientProgramTarget(nsls,nsls.Osuf,$(NSLIB) $(CLIENTDEPLIB),$(NSLIB) $(CLIENTLIBS),755)
ClientProgramTarget(nsmkdir,nsmkdir.Osuf,$(NSLIB) $(CLIENTDEPLIB),$(NSLIB) $(CLIENTLIBS),755)
ClientProgramTarget(nsmodifyclass,nsmodifyclass.Osuf,$(NSLIB) $(CLIENTDEPLIB),$(NSLIB) $(CLIENTLIBS),755)
ClientProgramTarget(nsping,nsping.Osuf,$(NSLIB) $(CLIENTDEPLIB),$(NSLIB) $(CLIENTLIBS),755)
ClientProgramTarget(nsrename,nsrename.Osuf,$(NSLIB) $(CLIENTDEPLIB),$(NSLIB) $(CLIENTLIBS),755)
ClientProgramTarget(nsrm,nsrm.Osuf,$(NSLIB) $(CLIENTDEPLIB),$(NSLIB) $(CLIENTLIBS),755)
ClientProgramTarget(nsrmdir,nsrmdir.Osuf,$(NSLIB) $(CLIENTDEPLIB),$(NSLIB) $(CLIENTLIBS),755)
ClientProgramTarget(nssetchecksum,nssetchecksum.Osuf,$(NSLIB) $(CLIENTDEPLIB), $(NSLIB) $(CLIENTLIBS),755)
ClientProgramTarget(nssetacl,nssetacl.Osuf,$(NSLIB) $(CLIENTDEPLIB),$(NSLIB) $(CLIENTLIBS),755)
ClientProgramTarget(nssetcomment,nssetcomment.Osuf,$(NSLIB) $(CLIENTDEPLIB),$(NSLIB) $(CLIENTLIBS),755)
ClientProgramTarget(nssetfsize,nssetfsize.Osuf,$(NSLIB) $(CLIENTDEPLIB),$(NSLIB) $(CLIENTLIBS),755)
ClientProgramTarget(nssetsegment,nssetsegment.Osuf,$(NSLIB) $(CLIENTDEPLIB),$(NSLIB) $(CLIENTLIBS),755)
ClientProgramTarget(nstouch,nstouch.Osuf,$(NSLIB) $(CLIENTDEPLIB),$(NSLIB) $(CLIENTLIBS),755)

LIBMANPAGE(Cns_aborttrans)
LIBMANPAGE(Cns_access)
LIBMANPAGE(Cns_chclass)
LIBMANPAGE(Cns_chdir)
LIBMANPAGE(Cns_chmod)
LIBMANPAGE(Cns_chown)
LIBMANPAGE(Cns_closedir)
LIBMANPAGE(Cns_creat)
LIBMANPAGE(Cns_creatg)
LIBMANPAGE(Cns_delcomment)
LIBMANPAGE(Cns_delete)
LIBMANPAGE(Cns_deleteclass)
LIBMANPAGE(Cns_dropsegs)
LIBMANPAGE(Cns_endsess)
LIBMANPAGE(Cns_endtrans)
LIBMANPAGE(Cns_enterclass)
LIBMANPAGE(Cns_getacl)
LIBMANPAGE(Cns_getcomment)
LIBMANPAGE(Cns_getcwd)
LIBMANPAGE(Cns_getsegattrs)
LIBMANPAGE(Cns_lastfseq)
LIBMANPAGE(Cns_listclass)
LIBMANPAGE(Cns_listtape)
LIBMANPAGE(Cns_listlinks)
LIBMANPAGE(Cns_mkdir)
LIBMANPAGE(Cns_mkdirg)
LIBMANPAGE(Cns_modifyclass)
LIBMANPAGE(Cns_opendir)
LIBMANPAGE(Cns_opendirg)
LIBMANPAGE(Cns_ping)
LIBMANPAGE(Cns_queryclass)
LIBMANPAGE(Cns_readdir)
LIBMANPAGE(Cns_readdirc)
LIBMANPAGE(Cns_readdirg)
LIBMANPAGE(Cns_readdirx)
LIBMANPAGE(Cns_readdirxc)
LIBMANPAGE(Cns_readdirxt)
LIBMANPAGE(Cns_readlink)
LIBMANPAGE(Cns_rename)
LIBMANPAGE(Cns_replaceseg)
LIBMANPAGE(Cns_rewinddir)
LIBMANPAGE(Cns_rmdir)
LIBMANPAGE(Cns_selectsrvr)
LIBMANPAGE(Cns_setacl)
LIBMANPAGE(Cns_setatime)
LIBMANPAGE(Cns_setcomment)
LIBMANPAGE(Cns_setfsize)
LIBMANPAGE(Cns_setsegattrs)
LIBMANPAGE(Cns_startsess)
LIBMANPAGE(Cns_starttrans)
LIBMANPAGE(Cns_stat)
LIBMANPAGE(Cns_statg)
LIBMANPAGE(Cns_symlink)
LIBMANPAGE(Cns_tapesum)
LIBMANPAGE(Cns_umask)
LIBMANPAGE(Cns_undelete)
LIBMANPAGE(Cns_unlink)
LIBMANPAGE(Cns_updateseg_checksum)
LIBMANPAGE(Cns_updateseg_status)
LIBMANPAGE(Cns_updatefile_checksum)
LIBMANPAGE(Cns_utime)
EXEMANPAGE(nschclass)
EXEMANPAGE(nschmod)
EXEMANPAGE(nschown)
EXEMANPAGE(nsdelcomment)
EXEMANPAGE(nsdeleteclass)
EXEMANPAGE(nsenterclass)
EXEMANPAGE(nsfind)
EXEMANPAGE(nsgetacl)
EXEMANPAGE(nsgetpath)
EXEMANPAGE(nslistclass)
EXEMANPAGE(nslisttape)
EXEMANPAGE(nsln)
EXEMANPAGE(nsls)
EXEMANPAGE(nsmkdir)
EXEMANPAGE(nsmodifyclass)
EXEMANPAGE(nsping)
EXEMANPAGE(nsrename)
EXEMANPAGE(nsrm)
EXEMANPAGE(nsrmdir)
EXEMANPAGE(nssetchecksum)
EXEMANPAGE(nssetacl)
EXEMANPAGE(nssetcomment)
EXEMANPAGE(nssetfsize)
EXEMANPAGE(nssetsegment)
EXEMANPAGE(nstouch)

DependsOnLibrary(common,castorcommon)
DependsOnLibrary(upv,castorupv)
DependsOnLibrary(security,castorsecurity)
DependsOnLibrary(dlf,castordlf)

Cns_oracle_ifce.c: Cns_oracle_ifce.pc
	proc iname=Cns_oracle_ifce include=$(INCLUDES) threads=yes char_map=string parse=full prefetch=1000
FilesToClean += Cns_oracle_ifce.c Cns_oracle_ifce.lis
MakeDir($(SPOOL),0755)
ORALIBS= -L$(ORACLE_HOME)/lib -lclntsh

NormalProgramTarget(nsdaemon,$(NSDAEMON_OBJS), $(DEPLIB), $(ORALIBS) $(MTLDFLAGS) $(LIBS) $(LIBCSEC),750)
ADMMANPAGE(nsdaemon)
LOGROTATE(castor-ns-server,..,install)
SYSCONFIG(nsdaemon,install)
INITSCRIPT(nsdaemon,install)
CONFIGFILE(NS,..,install)
