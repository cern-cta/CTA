COMM   @(#)Imakefile,v 1.51 2004/06/09 16:10:36 IT-PDP/DM  Jean-Philippe Baud
COMM
COMM  Copyright (C) 1990-2003 by CERN/IT/PDP/DM
COMM  All rights reserved
COMM

COMM 		Make rfio library and daemon            GENERIC

COMM
COMM Define the file indicating that no more RFIO requests
COMM should be issued.
COMM

NOMORERFIO = OperatorDir/nomorerfio
SPOOL = RfioSpool
LOGFILE = $(SPOOL)/rfiod.log
STAGEHOST = StageHost

#if BuildNameServerLibrary
CNS_ROOT_DIR = NsRoot
CNS_ROOT = -DCNS_ROOT=\"$(CNS_ROOT_DIR)\"
#endif

RFIO_ALRM= RfioSpool/RfioAlarmFile

#ifdef StagerSuperUser
STAGERSUPERUSER0 = StagerSuperUser
STAGERSUPERUSER  = -DSTAGERSUPERUSER=\"$(STAGERSUPERUSER0)\"
#endif
#ifdef StagerSuperGroup
STAGERSUPERGROUP0 = StagerSuperGroup
STAGERSUPERGROUP = -DSTAGERSUPERGROUP=\"$(STAGERSUPERGROUP0)\"
#endif

RFIOFLAGS=-DNOMORERFIO=\"$(NOMORERFIO)\" -DLOGFILE=\"$(LOGFILE)\" \
	  -DRFIO_ALRM=\"$(RFIO_ALRM)\" $(CNS_ROOT) $(STAGERSUPERUSER) $(STAGERSUPERGROUP)
CTHREAD_FLAGS = $(MTCCFLAGS)

NFSROOT0 = NfsRoot
NFSROOT  = -DNFSROOT=\"$(NFSROOT0)\"

#if BuildSecureRfio
CSEC = -DCSEC
#endif

CFLAGS = -g -I../h -I.. $(CTHREAD_FLAGS) $(CCOPTFLAGS) $(DEFCFLAGS) $(RFIOFLAGS) $(ACCTFLAG) -DFORTRAN $(SUPPORT_CS2) $(CPPUFL) $(NFSROOT) $(CSEC) -DSTAGEHOST=\"$(STAGEHOST)\"

FIOO=fio.Osuf
FFLAGS = $(FFOPTFLAGS) $(FPPUFL)
LIBS = $(MTLDLIBS)
RFIOLIB = -L. -lcastorrfio

#if BuildSecurity
SECURITYFLAG = -DCSEC
#if UseGSI
GLOBUS_LOCATION=GlobusLocation
#if defined(__STDC__)
GLOBUS_FLAVOUR=GlobusFlavour##pthr
#else
GLOBUS_FLAVOUR=GlobusFlavour/**/pthr
#endif
GLOBUS_LIBS=-L$(GLOBUS_LOCATION)/lib -lcrypto_$(GLOBUS_FLAVOUR)
LIBCSEC += $(GLOBUS_LIBS)
#endif
LIBS += -ldl
#endif

#if UseXFSPrealloc
CFLAGS += -DUSE_XFSPREALLOC
XFSLIBS = -lxfs
#endif

CKSUMLIB = -lz

DependsOnLibrary(common,castorcommon)
DependsOnLibrary(ns,castorns)
DependsOnLibrary(dlf,castordlf)
DependsOnLibrary(security,castorsecurity)
DependsOnLibrary(castor,castorclient)

#if BuildRfioLibrary
OBSOLETE_OBJS = \
            ../client/src/rfio/buildupath.Osuf \
	    ../client/src/rfio/send2stgd_api.Osuf \
	    ../client/src/rfio/send2stgd_compat.Osuf \
	    ../client/src/rfio/stage_api.Osuf \
	    ../client/src/rfio/stage_errmsg.Osuf \
	    ../client/src/rfio/stage_updc.Osuf \
	    ../client/src/rfio/stage_util.Osuf
RFIOLIB_OBJS = access.Osuf alrm.Osuf chdir.Osuf checkkey.Osuf chmod.Osuf \
		chown.Osuf close.Osuf closedir.Osuf connect.Osuf error.Osuf \
		fchmod.Osuf fchown.Osuf fclose.Osuf feof.Osuf ferror.Osuf \
		fflush.Osuf fileno.Osuf $(FIOO) fopen.Osuf \
		fread.Osuf fseek.Osuf fstat.Osuf ftell.Osuf \
		fwrite.Osuf getc.Osuf getcwd.Osuf lockf.Osuf \
		lseek.Osuf lstat.Osuf lun2fn.Osuf misc.Osuf \
		mkdir.Osuf mstat.Osuf msymlink.Osuf munlink.Osuf open.Osuf opendir.Osuf parse.Osuf  \
		pclose.Osuf popen.Osuf pread.Osuf preseek.Osuf pwrite.Osuf \
		read.Osuf readdir.Osuf readlink.Osuf rename.Osuf rewinddir.Osuf \
		rfio_HsmIf.Osuf rfio_rdirfdt.Osuf rfio_rfilefdt.Osuf \
		rfstatfs.Osuf rmdir.Osuf setopt.Osuf stat.Osuf statfs.Osuf stream.Osuf \
		switch_req.Osuf symlink.Osuf unlink.Osuf write.Osuf xyclose.Osuf xyopen.Osuf \
		xyread.Osuf xywrite.Osuf \
		fopen64.Osuf fseeko64.Osuf fstat64.Osuf ftello64.Osuf \
		lockf64.Osuf lseek64.Osuf open64.Osuf \
		preseek64.Osuf read64.Osuf stream64.Osuf write64.Osuf RfioTURL.Osuf $(OBSOLETE_OBJS)
SharedLibraryTarget(castorrfio,$(RFIOLIB_OBJS),$(DEPLIB),$(LIBS))
#endif

#if BuildRfioClient
RFIOTARGETLIB = SharedLibraryTargetName(castorrfio)
NormalProgramTarget(rfcat,rfcat.Osuf, $(RFIOTARGETLIB) $(DEPLIB), $(RFIOLIB) $(LIBS),root,bin,755)
NormalProgramTarget(rfchmod,rfchmod.Osuf, $(RFIOTARGETLIB) $(DEPLIB), $(RFIOLIB) $(LIBS),root,bin,755)
NormalProgramTarget(rfcp,rfcp.Osuf, $(RFIOTARGETLIB) $(DEPLIB), $(RFIOLIB) $(LIBS),root,bin,755)
NormalProgramTarget(rfstat,rfstat.Osuf, $(RFIOTARGETLIB) $(DEPLIB), $(RFIOLIB) $(LIBS),root,bin,755)
NormalProgramTarget(rfrm,rfrm.Osuf, $(RFIOTARGETLIB) $(DEPLIB), $(RFIOLIB) $(LIBS),root,bin,755)
NormalProgramTarget(rfdir,rfdir.Osuf, $(RFIOTARGETLIB) $(DEPLIB), $(RFIOLIB) $(LIBS),root,bin,755)
NormalProgramTarget(rfmkdir,rfmkdir.Osuf, $(RFIOTARGETLIB) $(DEPLIB), $(RFIOLIB) $(LIBS),root,bin,755)
NormalProgramTarget(rfrename,rfrename.Osuf, $(RFIOTARGETLIB) $(DEPLIB), $(RFIOLIB) $(LIBS),root,bin,755)
#endif

#if BuildRfioServer
MakeDir($(SPOOL),root,bin,0755)
SRVOBJS = Csemaphore.Osuf rfio_serv.Osuf rfio_calls.Osuf \
		rfio_call64.Osuf rfio_fcalls.Osuf rfio_callhandlers.Osuf switch_req.Osuf \
		checkkey.Osuf $(FIOO) rfstatfs.Osuf alrm.Osuf \
		rfioacct.Osuf RemoteJobSvc.Osuf stager_catalogInterface.Osuf \
		stager_util.Osuf stager_messages.Osuf stager_extern_globals.Osuf \
		stager_uuid.Osuf
#if UseXFSPrealloc
SRVOBJS += rfio_alignedbuf.Osuf rfio_xfsprealloc.Osuf
#endif
NormalProgramTarget(rfiod,$(SRVOBJS),$(RFIOTARGETLIB) $(DEPLIB), $(MTLDFLAGS) $(RTFLAGS) $(RTLIBS) $(LIBCSEC) $(RFIOLIB) $(LIBS) $(XFSLIBS) $(CKSUMLIB),root,bin,755)
#endif

EXEMANPAGE(rfiod)
EXEMANPAGE(rfcat)
EXEMANPAGE(rfchmod)
EXEMANPAGE(rfcp)
EXEMANPAGE(rfdir)
EXEMANPAGE(rfmkdir)
EXEMANPAGE(rfrename)
EXEMANPAGE(rfrm)
LIBMANPAGE(rfio_access)
LIBMANPAGE(rfio_chmod)
LIBMANPAGE(rfio_chown)
LIBMANPAGE(rfio_close)
LIBMANPAGE(rfio_closedir)
LIBMANPAGE(rfio_fchmod)
LIBMANPAGE(rfio_fclose)
LIBMANPAGE(rfio_feof)
LIBMANPAGE(rfio_ferror)
LIBMANPAGE(rfio_fflush)
LIBMANPAGE(rfio_fileno)
LIBMANPAGE(rfio_fopen)
LIBMANPAGE(rfio_fopen64)
LIBMANPAGE(rfio_fread)
LIBMANPAGE(rfio_fseek)
LIBMANPAGE(rfio_fseeko64)
LIBMANPAGE(rfio_fstat)
LIBMANPAGE(rfio_fstat64)
LIBMANPAGE(rfio_ftell)
LIBMANPAGE(rfio_ftello64)
LIBMANPAGE(rfio_fwrite)
LIBMANPAGE(rfio_lockf)
LIBMANPAGE(rfio_lockf64)
LIBMANPAGE(rfio_lseek)
LIBMANPAGE(rfio_lseek64)
LIBMANPAGE(rfio_lstat)
LIBMANPAGE(rfio_lstat64)
LIBMANPAGE(rfio_mkdir)
LIBMANPAGE(rfio_mstat)
LIBMANPAGE(rfio_mstat64)
LIBMANPAGE(rfio_munlink)
LIBMANPAGE(rfio_msymlink)
LIBMANPAGE(rfio_open)
LIBMANPAGE(rfio_open64)
LIBMANPAGE(rfio_opendir)
LIBMANPAGE(rfio_pclose)
LIBMANPAGE(rfio_perror)
LIBMANPAGE(rfio_popen)
LIBMANPAGE(rfio_preseek)
LIBMANPAGE(rfio_preseek64)
LIBMANPAGE(rfio_read)
LIBMANPAGE(rfio_readdir)
LIBMANPAGE(rfio_readlink)
LIBMANPAGE(rfio_rename)
LIBMANPAGE(rfio_rewinddir)
LIBMANPAGE(rfio_rmdir)
LIBMANPAGE(rfio_serror)
LIBMANPAGE(rfio_stat)
LIBMANPAGE(rfio_stat64)
LIBMANPAGE(rfio_statfs)
LIBMANPAGE(rfio_symlink)
LIBMANPAGE(rfio_unlink)
LIBMANPAGE(rfio_write)
LIBMANPAGE(rfioreadopt)
LIBMANPAGE(rfiosetopt)
