.\" @(#)$RCSfile: vdqmserv.man,v $ $Revision: 1.6 $ $Date: 2004/09/14 13:33:55 $ CERN IT-ADC Olof Barring
.\" Copyright (C) 2001 by CERN/IT/ADC
.\" All rights reserved
.\"
.TH VDQMSERV 1 "$Date: 2004/09/14 13:33:55 $" CASTOR "VDQM server daemon"
.SH NAME
vdqmserv \- Volume and Drive Queue Manager (VDQM) server
.SH SYNOPSIS
.BI "vdqmserv"

.SH DESCRIPTION
.B vdqmserv
is the central CASTOR server handling all tape volume and drive queues.
It runs as a daemon on a host, which must be known to all clients and
tape servers. The host name is normally configured in the clients at
compile time through the \fBVdqmHost\fP
macro in the "config/site.def" file in the CASTOR build directory.
The host name can also be set through an entry \fBVDQM HOST\fP
in the "/etc/shift.conf" file. While this is optional for VDQM
client hosts, it is mandatory for the VDQM server hosts: the
\fBvdqmserv\fP program will not start on a host where the \fBVDQM HOST\fP
entry in "/etc/shift.conf" is missing or wrongly specified.
.PP
The \fBvdqmserv\fP
listens to a well-known port number configured through the \fBvdqm\fP
service (tcp) in the "/etc/services" file
on all client and server hosts.
.PP
By default, the \fBvdqmserv\fP
only accepts request from clients from the same network (e.g. 137.138). To accepts requests from clients on other networks, a "/etc/shift.localhost" file must be created, with one line per network authorized, containing the IP of the network.

.PP
Because of its high importance for the functioning of the CASTOR tape
services the \fBvdqmserv\fP
service must be highly available. To reduce the impact of a crash of the
central server node, VDQM therefore provides an inherent replication
mechanism of the service. A VDQM
.I replica
is an instance of \fBvdqmserv\fP 
running on a different host. There might be several replica instances.
A VDQM replica is configured by adding the name of the host where the
replica runs to the VDQM host configuration (see example below). The
first host name in the list of hosts is always the primary server. 
Since a VDQM replica is an instance of \fBvdqmserv\fP that is
ready to take over in case the primary server goes down it has
to be configured similarly to the primary server. This means that
the name of the VDQM replica host must appear in the \fBVDQM HOST\fP 
entry of the "/etc/shift.conf" file (see above) on both the primary
and replica hosts.
.PP
The VDQM replica receives replication updates over a permanently
open TCP connection to the primary server. If the TCP connection
is dropped by the primary server, the replica will make a few
retries (3 by default) to reconnect to the primary server. The number
of retries can be changed via the macro \fBVDQM_REPLICA_RETRIES\fP 
in "vdqm_constants.h".
In case the retries fail the replica will automatically enter
production mode and begin to answer incoming client request. When the 
primary server starts up it will connect to the first replica that
replies and receive the full snapshot of the database. The contacted
replica will thereafter re-enter replication mode (not responding to
further incoming requests) while the primary server takes over the
service.

.PP
The clients will always first try to
contact the primary server and if it is not responding they will try
the VDQM replicas in the order they appear in the VDQM host list.
While the primary server is up and running all VDQM replica servers
are automatically running in "held" mode (not processing any requests).
Note that all VDQM replicas will enter service mode if the primary
server goes down. It is therefore recommended that only one replica
is running otherwise a client may get inconsistent results in case
of, for instance, a network "glitch".

.PP
The \fBvdqmserv\fP responds to requests from the \fBvdqm_admin(1)\fP
utility.

.SH ENVIRONMENT
The \fBvdqmserv\fP daemon does not take any arguments. Apart from the
VDQM host list the \fBvdqmserv\fP daemon does normally not require any special 
configuration. CASTOR tape server software uses the VDQM client API routine
\fBvdqm_UnitStatus(3)\fP to publish existence of tape drives and their 
status and CASTOR RTCOPY clients publish their requests through the
VDQM client API \fBvdqm_SendVolReq(3)\fP.
.PP
In case of problems with running
.B vdqmserv
it can be started with debug logging level by setting the environment
variable \fBLOG_PRIORITY\fP to \fB7\fP. This will cause intensive logging
(producing huge log-files).

.PP
VDQM configuration parameters in "/etc/shift.conf" :
.TP
.B VDQM HOST <hostname1 ...>
Set the VDQM primary and replica hosts. This configuration is required on
the node running the vdqmserv daemon. The order among the hosts is significant:
the first host name is always the primary server and the second host name
is the replica. All the following host names (if any) are allowed to send
replica connection requests.
.TP
.B VDQM WRITE_PRIORITY <YES/NO>
Give priority to tape write requests. This feature was added as a quick solution
for the feature request #3612. The effect of setting this configuration to
.B YES
is that all tape write requests will be given priority over tape read requests.
Setting the configuration to any other value than
.B YES
or omitting the configuration implies the default behaviour giving same priority
to all requests.

.PP
The following environment variables can be used to override existing
defaults (mostly for debugging purpose):
.TP
.B VDQM_PORT
override the default port number set in "/etc/services"
.TP
.B VDQM_THREAD_POOL
set the VDQM thread pool size (default is 10 worker threads).
.TP
.B RTCP_PORT, RTCOPY_PORT, RTCOPYPORT
override the default port number used by VDQM to contact the tape
mover (RTCOPY server).

.SH FILES
.TP 1.5i
.B /etc/shift.conf
CASTOR configuration file
.TP
.B /etc/shift.localhost
Contains the list of networks from which the requests are accepted
.TP
.B /usr/spool/vdqm/vdqm.log
VDQM server log file
.TP
.B /usr/spool/vdqm/vdqm.drives
Persistent list of drives, and their dedications. This file is used to reload the list of drives when vdqmserv is restarted.

.SH EXAMPLE
.nf
.ft CW
Configure a VDQM client to use primary server on the host "castor" and 
a replica on the host "castor-replica" through editing the file
"config/site.def" in the CASTOR build directory. The result should be:
% grep VdqmHost config/site.def
#define VdqmHost	"castor castor-replica"
% make
Configure a VDQM primary server on the host "castor" and a replica
on the host "castor-replica" through editing the file "/etc/shift.conf"
on the two server hosts ("castor" and "castor-replica").
The result should be:
%grep 'VDQM.*HOST' /etc/shift.conf
VDQM	HOST	castor castor-replica
%
.ft
.fi

.SH SEE ALSO
.BR vdqm_admin(1) ,
.BR vdqm_SendVolReq(3) ,
.BR vdqm_UnitStatus(3)
.SH AUTHOR
\fBCASTOR\fP Team <castor.support@cern.ch>
