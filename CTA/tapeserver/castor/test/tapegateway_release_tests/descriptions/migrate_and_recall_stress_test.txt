THE NAME OF TEST
================

Migrate and recall stress test.


THE PURPOSE OF THE TEST
=======================

The principle responsibility of the tape-gateway is to coordinate the transfer
of files to and from tape.

The purpose of this test is to verify the tape-gateway can do its job correctly
when faced with 8 TB of 100 MB test files and migrations in parallel with
recalls.


THE PREREQUISITES OF THE TEST
=============================

* A test-stager running the tape-gateway where you can carry out the test.
* A test service-class with the following properties:
  - A set of one or more disk-pools that has enough free space to store
    81920 100 MB test-files (a total of 8 TB).
  - A set of one or more tape-pools that has enough free space to store
    81920 100 MB test-files (a total of 8 TB).
  - nbDrives set to at least 2 but 10 is advised.
  - A stream policy which always returns 1.
  - A migrator policy which always returns 1.
  - Recaller policy set to 'None'.
* At least two free tape-drives which can access all of the tapes in the
  tape-pools of the test service-class.  Ten free tape-drives is advised.
* A file class with a value of 1 for nbCopies (the number of desired
  tape-copies).
* A copy of the utility test script from the CASTOR svn repository,
  "trunk/test/tapegateway_release_tests/createAndCopyFilesToCastor.sh".


INSTRUCTIONS DESCRIBING HOW TO SET UP THE ENVIRONMENT OF THE TEST
=================================================================

1. Check that the tapeGateway is up and running.

ps -ef | grep 'tapegatewayd|rtcpclientd' | grep -v grep

2. Create the empty test-directory in CASTOR where test-files will be copied
   to.

nsmkdir /castor/cern.ch/user/m/murrayc3/gatewaystress

3. Determine the name of a file-class with one tape-copy.

nslistclass | egrep 'CLASS_ID|CLASS_NAME|NBCOPIES' | grep -B2 'NBCOPIES 1'
[output] ...
[output] CLASS_ID 95
[output] CLASS_NAME largeuser
[output] NBCOPIES 1
[output] ...

4. Set the file-class of the test-directory to be that of the previous step.

nschclass largeuser /castor/cern.ch/user/m/murrayc3/gatewaystress

5. Determine whether or not there is a migHunter daemon running for the test
   service-class.

ps -ef | egrep "/usr/bin/mighunterd.* largedisk2" | grep -v grep

6. If no mighunter daemon is running for the test service-class, then start
    one as user root.

/usr/bin/mighunterd -t 60 largedisk2


INSTRUCTIONS DESCRIBING HOW TO CARRY OUT THE TEST
=================================================

1. Create and copy to CASTOR 40960 100MB test-files (a total of 4TB) using the
   createAndCopyFilesToCastor.sh script.

for I in `seq 40`; do bsub -q 8nh /afs/cern.ch/user/m/murrayc3/castor/checkout/trunk/test/tapegateway_release_tests/createAndCopyFilesToCastor.sh castorcert5-A largedisk2 castorcert5-lb /castor/cern.ch/user/m/murrayc3/gatewaystress 100 1024; done

2. Using nsls -l wait for all ten 100 MB files to be migrated to tape.  By
   grepping for migrated files in the output of nsls -l and counting the
   number lines, all the files will have been migrated when the count reaches
   40960.

CNS_HOST=castorcert5-lb nsls -l /castor/cern.ch/user/m/murrayc3/gatewaystress > ~/gatewaystress_nsls_l.txt
egrep ^m ~/gatewaystress_nsls_l.txt | wc -l

3. Create a list of all 40960 test-files.

TEST_DIR=/castor/cern.ch/user/m/murrayc3/gatewaystress; CNS_HOST=castorcert5-lb nsls $TEST_DIR | awk "{print \"${TEST_DIR}/\" \$NF;}" > ~/gatewaystress_file_list.txt

4. The -f hsm-FileList option of the stager_rm and stager_qry commands will
   probably will not work with 40960 files, therefore split the list of
   test-files into 10 lists of 4096 test-files.

split -d -l 4096 ~/gatewaystress_file_list.txt ~/gatewaystress_file_list_split.txt
ls -rt ~ | tail -n 11
[output] gatewaystress_file_list.txt
[output] gatewaystress_file_list_split.txt09
[output] gatewaystress_file_list_split.txt08
[output] gatewaystress_file_list_split.txt07
[output] gatewaystress_file_list_split.txt06
[output] gatewaystress_file_list_split.txt05
[output] gatewaystress_file_list_split.txt04
[output] gatewaystress_file_list_split.txt03
[output] gatewaystress_file_list_split.txt02
[output] gatewaystress_file_list_split.txt01
[output] gatewaystress_file_list_split.txt00

5. Remove the 40960 test-files from the disk cache.

for I in `seq 0 9`; do stager_rm -S '*' -f ~/gatewaystress_file_list_split.txt0$I; done

6. Determine the status of the 40960 test-files in the disk-cache.

for I in `seq 0 9`; do stager_qry -S '*' -f ~/gatewaystress_file_list_split.txt0$I; done > ~/gatewaystress_file_status_after_stager_rm.txt

7. Verify that all 40960 test-files have been removed from the disk-cache.

egrep 'INVALID|not on disk cache' ~/gatewaystress_file_status_after_stager_rm.txt | wc -l
[output] 40960

8. If there are not enough tape-drives to migrate and recall in parallel, then
   make sure some of them are dedicated as read-only drives

vdqm_admin -dedicate -dgn 359B1B -drive 35921002 -server tpsrv203 -match 'mode=0'
vdqm_admin -dedicate -dgn 359B1B -drive 35921001 -server tpsrv202 -match 'mode=0'

9. Recall all 40960 test-files back from tape whilst migrating a second batch
   of 40960 test-files in parallel.

for I in `seq 0 9`; do stager_get -S largedisk2 -f ~/gatewaystress_file_list_split.txt0$I; done

for I in `seq 40`; do bsub -q 8nh /afs/cern.ch/user/m/murrayc3/castor/checkout/trunk/test/tapegateway_release_tests/createAndCopyFilesToCastor.sh castorcert5-A largedisk2 castorcert5-lb /castor/cern.ch/user/m/murrayc3/gatewaystress 100 1024; done

10. Determine the status of all of the test-files in the first set of 40960.

for I in `seq 0 9`; do stager_qry -S '*' -f ~/gatewaystress_file_list_split.txt0$I; done > ~/gatewaystress_file_status_after_stager_get.txt

11. Verify that all of the test-files from the first set of 40960 have been
    successfully recalled.

grep STAGED ~/gatewaystress_file_status_after_stager_get.txt | wc -l
[output] 40960

11. Create a list of all 81920 test-files.

TEST_DIR=/castor/cern.ch/user/m/murrayc3/gatewaystress; CNS_HOST=castorcert5-lb nsls $TEST_DIR | awk "{print \"${TEST_DIR}/\" \$NF;}" > ~/gatewaystress_81920_file_list.txt

12. The -f hsm-FileList option of the stager_rm and stager_qry commands will
   probably will not work with 81920 files, therefore split the list of
   test-files into 10 lists of 8192 test-files.

split -d -l 8192 ~/gatewaystress_81920_file_list.txt ~/gatewaystress_81920_file_list_split.txt
ls -rt ~ | tail -n 11
[output] gatewaystress_81920_file_list.txt
[output] gatewaystress_81920_file_list_split.txt09
[output] gatewaystress_81920_file_list_split.txt08
[output] gatewaystress_81920_file_list_split.txt07
[output] gatewaystress_81920_file_list_split.txt06
[output] gatewaystress_81920_file_list_split.txt05
[output] gatewaystress_81920_file_list_split.txt04
[output] gatewaystress_81920_file_list_split.txt03
[output] gatewaystress_81920_file_list_split.txt02
[output] gatewaystress_81920_file_list_split.txt01
[output] gatewaystress_81920_file_list_split.txt00

13. Remove all 81920 test-files from the disk cache.

for I in `seq 0 9`; do stager_rm -S '*' -f ~/gatewaystress_81920_file_list_split.txt0$I; done

14.  Determine the status of all 81920 test-files in the disk-cache.

for I in `seq 0 9`; do stager_qry -S '*' -f ~/gatewaystress_81920_file_list_split.txt0$I; done > ~/gatewaystress_81920_file_status_after_stager_rm.txt

15. Verify that all 81920 test-files have been removed from the disk-cache.

egrep 'INVALID|not on disk cache' ~/gatewaystress_81920_file_status_after_stager_rm.txt | wc -l
[output] 81920

16. Recall all 81920 test-files back from tape.

for I in `seq 0 9`; do stager_get -S largedisk2 -f ~/gatewaystress_81920_file_list_split.txt0$I; done

17. Determine the status of all of 81920 test-files.

for I in `seq 0 9`; do stager_qry -S '*' -f ~/gatewaystress_81920_file_list_split.txt0$I; done > ~/gatewaystress_81920_file_status_after_stager_get.txt

18. Verify that all 81920 of the test-files have been successfully recalled.

grep STAGED ~/gatewaystress_81920_file_status_after_stager_get.txt | wc -l
[output]


EXPECTED RESULTS
================

All 81920 files must have migrated and recalled successfully.


INSTRUCTIONS DESCRIBING HOW TO TEAR DOWN THE ENVIRONMENT OF THE TEST
====================================================================

1. Revoke any read-only dedications of the test-drives made in step 8.

vdqm_admin -dedicate -dgn 359B1B -drive 35921002 -server tpsrv203
vdqm_admin -dedicate -dgn 359B1B -drive 35921001 -server tpsrv202

2. Remove the test-directory and its contents from the CASTOR name-space.

nsrm -r /castor/cern.ch/user/m/murrayc3/gatewaystress
