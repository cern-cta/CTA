THE NAME OF THE TEST
====================

Migrate until end of 2 tapes


THE PURPOSE OF THE TEST
=======================

The rtcpd daemon running on a tape server will appear to migrate many files to
a tape concurrently even though files are physically written to tape in a
strictly sequential manner.  The apparent concurrency is achieved by multiple
threads within the rtcpd daemon concurrently reading mutliple files from one
or more CASTOR disk servers into the internal memory-resident cache of the
rtcpd daemon.  This caching mechanism is used to increase performance.

It is the responsibility of the tape-gateway to respond to the end of a tape
by retrying the migration of all the files that were being worked on by the
corresponding rtcpd daemon at the moment in time the end of tape was reached.

Is is also the responsibility of the tape-gateway to continuously ask for a
new tape when the tape pool in question is empty.  This test should limit the
number of tapes in the destination tape pool so that this behaviour of the
tape-gateway can be exercised.


THE PREREQUISITES OF THE TEST
=============================

* A test-stager running the tape-gateway where you can carry out the test.
* A test service-class with the following properties:
  - A set of one or more disk-pools that has enough free space to store 2TB of
    data.
  - Stream policy set to one which always returns 1.
  - Migrator policy set to one which always returns 1.
  - Recaller policy set to 'None'.
* A user account that permits the modification of the service-class within the
  stager.
* Three empty 1TB test-tapes.
* A user account that permits the creation of a new tape-pool within the VMGR.
* At least 2 free tape-drives, both of which can access the 3 test-tapes.
* A user account that permits the dedication of drives within the VDQM.
* A file class with a value of 1 for nbCopies (the number of desired
  tape-copies).
* A user account that allows the creation and population of a CASTOR directory
  with a tape backend.
* A copy of the utility test script from the CASTOR svn repository,
  "trunk/test/tapegateway_release_tests/createAndCopyFilesToCastor.sh".


INSTRUCTIONS DESCRIBING HOW TO SET UP THE ENVIRONMENT OF THE TEST
=================================================================

1. Check that the tapeGateway is up and running.

ps -ef | egrep 'tapegatewayd|rtcpclientd' | grep -v grep

2. Create yourself a test tape-pool containing only  2 of the 3 test-tapes.
   Make sure that the thrid test-tape is not in the test-tape pool.

vmgrenterpool --name gatewayendtape --user murrayc3 --group c3
vmgrmodifytape -V I12017 --pool gatewayendtape
vmgrmodifytape -V I12018 --pool gatewayendtape

3. Make sure the test service-class has the test tape-pool as its one and only
   tape-pool.

modifySvcClass --Name default --RemoveTapePools itdc_mixed_new
modifySvcClass --Name default --AddTapePools gatewayendtape

4. Make sure the test service-class will use exactly 2 drives for migrations:

modifySvcClass --Name default --NbDrives 2

5. Create the empty test-directory in CASTOR where test-files will be copied
   to.

nsmkdir /castor/cern.ch/user/m/murrayc3/gatewayendtape

6. Determine the name of a file-class with one tape-copy.

nslistclass | egrep 'CLASS_ID|CLASS_NAME|NBCOPIES' | grep -B2 'NBCOPIES 1'
[output] ...
[output] CLASS_ID 95
[output] CLASS_NAME largeuser
[output] NBCOPIES 1
[output] ...

7. Set the file-class of the test-directory to be that of the previous step.

nschclass largeuser /castor/cern.ch/user/m/murrayc3/gatewayendtape

8. Dedicate the 2 test-drives to the test-stager.

vdqm_admin -dedicate -dgn 359B1B -drive 35921011 -server tpsrv212 -match 'host=^lxbrl270[89].cern.ch$'
vdqm_admin -dedicate -dgn 359B1B -drive 35921012 -server tpsrv213 -match 'host=^lxbrl270[89].cern.ch$'


INSTRUCTIONS DESCRIBING HOW TO CARRY OUT THE TEST
=================================================

1. Start the remote copy of 2 Terabytes

for I in `seq 20`; do bsub -q 8nh
/afs/cern.ch/user/m/murrayc3/castor/checkout/trunk/test/tapegateway_release_tests/createAndCopyFilesToCastor.sh
castorcert5-A default castorcert5-lb
/castor/cern.ch/user/m/murrayc3/gatewayendtape 100 1024; done

2. Wait for the VMGR state of the 2 test-tapes to become FULL.  This state
   change can be detected using the vmgrlisttape command.

watch "vmgrlisttape | egrep 'I12017|I12018'"

3. Determine that the tape-gateway is continuously asking for another tape, but
   cannot get one due to lack of space in the test tape-pool.

grep "No tape available in such tapepool.*poolname='gatewayendtape'"
/var/log/castor/tapegatewayd.log | tail

4. Determine the mount transaction ids of the mounts which resulted in the
   ends of the 2 test-tapes being reached

grep 'submitting to vdqm.* TPVID=I12017 ' /var/log/castor/tapegatewayd.log | tail -n 1 | sed 's/ /\n/g' | grep mountTransactionId
[output] mountTransactionId=414885

grep 'submitting to vdqm.* TPVID=I12018 ' /var/log/castor/tapegatewayd.log | tail -n 1 | sed 's/ /\n/g' | grep mountTransactionId
[output] mountTransactionId=414863

11. Using the mount transaction ids from the previous step, check that the
    tap-gateway logged a warning when the end of each test-tape was reached.

egrep "mountTransactionId=(414885|414863) .* TAPE VOLUMES OVERFLOW" /var/log/castor/tapegatewayd.log
[output] 2010-06-30T00:27:44.311889+02:00 lxbrl2709 tapegatewayd[18348]: LVL=Warn TID=18403 MSG="Worker: received end notification error report" mountTransactionId=414863 tapebridgeTransId=16389 errorcode=28 errorMessage="File=BridgeProtocolEngine.cpp Line=964 Function=rtcpFileErrReqRtcpdCallback: Received an error from rtcpd:  CPDSKTP !  ERROR, TAPE VOLUMES OVERFLOW  CPDSKTP ! TAPE IS NOW INCORRECTLY TERMINATED"
[output] 2010-06-30T03:46:43.788630+02:00 lxbrl2709 tapegatewayd[18348]: LVL=Warn TID=18385 MSG="Worker: received end notification error report" mountTransactionId=414885 tapebridgeTransId=10777 errorcode=28 errorMessage="File=BridgeProtocolEngine.cpp Line=964 Function=rtcpFileErrReqRtcpdCallback: Received an error from rtcpd:  CPDSKTP !  ERROR, TAPE VOLUMES OVERFLOW  CPDSKTP ! TAPE IS NOW INCORRECTLY TERMINATED"

12. Add a third tape to the test-tapepool so that the rest of the files making
up the 2 Terabytes can be migrated.

vmgrmodifytape -V I12020 --pool gatewayendtape

13. Wait for all of the remaining migrations to complete with the new third
    test-tape.

watch 'showqueues -x | grep I12020'

14. Check that all 20480 100MB files making up the 2TB of test-data have been
    succesfully migrated.

nsls -l /castor/cern.ch/user/m/murrayc3/gatewayendtape | egrep ^m | wc -l
[output] 20480


EXPECTED RESULTS
================

The tape-gateway should have succesfully filled the first 2 test-tapes entered
into the test tape-pool and the tape-gateway should have successfully finished
migrating the entire set of test-files using the thrird test-tape which was
added later to the test tape-pool.  In addition to step 14 of the above test
instructions, it should be possible to remove all of the test-files from the
test-stager disk cache and then successfully recall all of them from the 3
test-tapes.  This acceptance-test can be done as follows.

1. Create a file containing the full paths of all 20480 of the test-files in
   the test-directory.

TEST_DIR=/castor/cern.ch/user/m/murrayc3/gatewayendtape; nsls $TEST_DIR | awk "{print \"$TEST_DIR/\"\$NF;}" | sort > gatewayendtape_file_list.txt

2. Split the file of the previous step into 4 files with 5120 test-files each.

split -d -l 5120 ~/gatewayendtape_file_list.txt ~/gatewayendtape_file_list_split.txt
ls -rt ~ | tail -n 5
[output] gatewayendtape_file_list.txt
[output] gatewayendtape_file_list_split.txt03
[output] gatewayendtape_file_list_split.txt02
[output] gatewayendtape_file_list_split.txt01
[output] gatewayendtape_file_list_split.txt00

3. Remove all of the test-files from the test-stager disk cache.

stager_rm -S '*' -f ~/gatewayendtape_file_list_split.txt00
stager_rm -S '*' -f ~/gatewayendtape_file_list_split.txt01
stager_rm -S '*' -f ~/gatewayendtape_file_list_split.txt02
stager_rm -S '*' -f ~/gatewayendtape_file_list_split.txt03

4. Create 4 files containing the stager status of 5120 of the test-files.

stager_qry -S '*' -f ~/gatewayendtape_file_list_split.txt00 > ~/gatewayendtape_file_status_after_stager_rm_list_split.txt00
stager_qry -S '*' -f ~/gatewayendtape_file_list_split.txt01 > ~/gatewayendtape_file_status_after_stager_rm_list_split.txt01
stager_qry -S '*' -f ~/gatewayendtape_file_list_split.txt02 > ~/gatewayendtape_file_status_after_stager_rm_list_split.txt02
stager_qry -S '*' -f ~/gatewayendtape_file_list_split.txt03 > ~/gatewayendtape_file_status_after_stager_rm_list_split.txt03

5. Check that all 20480 of the test-files have been removed from the disk cache.

egrep 'INVALID|not on disk cache' ~/gatewayendtape_file_status_after_stager_rm_list_split.txt00 | wc -l
[output] 5120
egrep 'INVALID|not on disk cache' ~/gatewayendtape_file_status_after_stager_rm_list_split.txt01 | wc -l
[output] 5120
egrep 'INVALID|not on disk cache' ~/gatewayendtape_file_status_after_stager_rm_list_split.txt02 | wc -l
[output] 5120
egrep 'INVALID|not on disk cache' ~/gatewayendtape_file_status_after_stager_rm_list_split.txt03 | wc -l
[output] 5120

6. Recall all 20480 of the test-files from the 3 test-tapes.

stager_get -f ~/gatewayendtape_file_list_split.txt00
stager_get -f ~/gatewayendtape_file_list_split.txt01
stager_get -f ~/gatewayendtape_file_list_split.txt02
stager_get -f ~/gatewayendtape_file_list_split.txt03

7. Wait for all of the files to be recalled.

watch "showqueues -x | egrep 'I12018|I12019|I12020'"

8. Create a file containing the stager status of each of the test-files.

stager_qry -S '*' -f ~/gatewayendtape_file_list_split.txt00 > ~/gatewayendtape_file_status_after_stager_get_list_split.txt00
stager_qry -S '*' -f ~/gatewayendtape_file_list_split.txt01 > ~/gatewayendtape_file_status_after_stager_get_list_split.txt01
stager_qry -S '*' -f ~/gatewayendtape_file_list_split.txt02 > ~/gatewayendtape_file_status_after_stager_get_list_split.txt02
stager_qry -S '*' -f ~/gatewayendtape_file_list_split.txt03 > ~/gatewayendtape_file_status_after_stager_get_list_split.txt03

9. Check that all 20480 test-files have been successfully recalled.

grep STAGED ~/gatewayendtape_file_status_after_stager_get_list_split.txt00 | wc -l
[output] 5120
grep STAGED ~/gatewayendtape_file_status_after_stager_get_list_split.txt01 | wc -l
[output] 5120
grep STAGED ~/gatewayendtape_file_status_after_stager_get_list_split.txt02 | wc -l
[output] 5120
grep STAGED ~/gatewayendtape_file_status_after_stager_get_list_split.txt03 | wc -l
[output] 5120


INSTRUCTIONS DESCRIBING HOW TO TEAR DOWN THE ENVIRONMENT OF THE TEST
====================================================================

1. Revoke the dedication the two test-drives from the test-stager.

vdqm_admin -dedicate -dgn 359B1B -drive 35921011 -server tpsrv212
vdqm_admin -dedicate -dgn 359B1B -drive 35921012 -server tpsrv213

2. Remove the test-directory and its contents from the CASTOR name-space.

nsrm -r /castor/cern.ch/user/m/murrayc3/gatewayendtape
