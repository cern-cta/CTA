image:
  repository: registry.cern.ch/ghcr.io/open-telemetry/opentelemetry-collector-releases/opentelemetry-collector-contrib
  tag: 0.129.1

mode: deployment

config:
  receivers:
    otlp:
      protocols:
        http:
          endpoint: 0.0.0.0:4318

  processors:
    groupbyattrs/aggregate_per_instance:
      keys: ["job", "transfer_type"]  # aggregate over all 'instance's for each job/type

    metricstransform/drop_instance_label:
      transforms:
        - include: "taped_transfer_count_total"
          match_type: strict
          action: update
          operations:
            - action: delete_label
              label: "instance"

  exporters:
    prometheus:
      endpoint: ${env:MY_POD_IP}:8889

  service:
    pipelines:
      metrics:
        receivers:
        - otlp
        processors:
          - groupbyattrs/aggregate_per_instance
          - metricstransform/drop_instance_label
        exporters:
        - prometheus

    telemetry:
      logs:
        level: "info"

ports:
  metrics:
    enabled: true
    containerPort: 8889
    servicePort: 8889
    protocol: TCP
