global:
  # Note that the repository and tag are manually overriden by the create_instance script
  repository:
  tag:
  pullPolicy: IfNotPresent

  eos:
    instancename: ctaeos

  http:
    enabled: true

  sssKeytab:
    # This secret is generated by the authentication chart
    secret: eos-sss-keytab

  extraObjects:
    # Ensure the MGM is addressable by its instancename
    - |
      apiVersion: v1
      kind: Service
      metadata:
        name: {{ include "mgm.instancename" . }}
      spec:
        type: ExternalName
        externalName: {{ include "utils.mgm_fqdn" . }}
    # Create configmap for the cta-fst-gcd
    - |
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: cfgmap-cta-fst-gcd
        labels:
          {{- include "fst.labels" . | nindent 4 }}
      data:
        cta-fst-gcd.conf: |
          [main]
          log_file = /var/log/eos/fst/cta-fst-gcd.log
          mgm_host = {{ include "utils.mgm_fqdn" . }}
          eos_spaces = default
          eos_space_to_min_free_bytes = default:0
          gc_age_secs = 1
          absolute_max_age_secs = 604800
          query_period_secs = 20
          main_loop_period_secs = 10
          xrdsecssskt = /etc/eos.keytab


mgm:
  # Must match the authentication chart
  kerberos:
    enabled: true
    clientConfig:
      configMap: krb5-conf
    defaultRealm: TEST.CTA
    adminPrinc:
      name: root
      password: "defaultcipassword"

  # Ensure we can delete the pods quickly in CI
  pod:
    extraSpec:
      terminationGracePeriodSeconds: 1

  http:
    # Generated using: openssl rand -base64 64 | base64 -w 0
    macaroonsSecretKey: ZjZsMWxPT1lEc1poNFBKRTJiK05aaEhMdC9iUzdsSmxxNGZXT1Z4dE9PWElsR2I0MHhqZ3RnRDNzWnhVTW5iZAp1YWFSYmR6d0hSL3FMem1ncDNCWHFRPT0K

  xrd:
    # Additional tape-specific config
    extraConfig: |
      xrootd.chksum  adler32
      mgmofs.archivedir /var/eos/archive
      mgmofs.prepare.dest.space default
      mgmofs.tapeenabled true
      mgmofs.protowfendpoint cta-frontend:10955
      mgmofs.protowfresource /ctafrontend
      tpc.trace  all
      tpc.header2cgi  ArchiveMetadata archivemetadata
      taperestapi.sitename  cern-tape-archive-{{ include "mgm.instancename" . }}

  # Liveness probes are disabled for all pods as we specifically do not want the pod to restart in case of an error for CI
  # Additionally, these liveness probes cause a lot of extra messages in the logs
  probes:
    liveness: false

  extraEnv:
  - name: EOS_HA_REDIRECT_READS
    value: "1"
  - name: LD_PRELOAD
    value: "/usr/lib64/libjemalloc.so.2"
  # For some reason EOS is on another time zone, so set this to CET
  - name: TZ
    value: "CET"

  # Generate the self-signed certificates for http
  initContainer:
    enabled: true
    script: |
      #!/usr/bin/bash
      /mkcert-ssl.sh
      chown -R daemon:daemon /etc/grid-security/certificates
    volumeMounts:
    - name: grid-security
      mountPath: /etc/grid-security

  extraVolumes:
    volumeMounts:
    # varlog-tmp is the location where core dumps will end up
    - name: varlog-tmp
      mountPath: /var/log/tmp
    - name: grid-security
      mountPath: /etc/grid-security
      readOnly: true
    volumes:
    - name: varlog-tmp
      emptyDir: {}
    - name: grid-security
      emptyDir: {}

fst:
  replicaCount: 1

  pod:
    extraSpec:
      terminationGracePeriodSeconds: 1

  xrd:
    extraConfig: |
      xrootd.redirect {{ include "utils.mgm_fqdn" . }}:1094 chksum
      fstofs.protowfendpoint cta-frontend:10955
      fstofs.protowfresource /ctafrontend
      fstofs.filemd_handler  attr
      tpc.trace  all

  probes:
    liveness: false

  extraEnv:
  - name: TZ
    value: "CET"

  # As we only get to specify 1 custom init container, this container sets up both
  # the certificates and runs the cta-fst-gcd
  # Note that init containers with restartpolicy: Always are sidecar containers
  initContainer:
    enabled: true
    script: |
      #!/usr/bin/bash
      /mkcert-ssl.sh
      chown -R daemon:daemon /etc/grid-security/certificates
      dnf install -y cta-fst-gcd
      runuser -u daemon -- /usr/bin/cta-fst-gcd --stdout
    volumeMounts:
    - name: grid-security
      mountPath: /etc/grid-security
    - name: cta-fst-gcd
      mountPath: /etc/cta/cta-fst-gcd.conf
      subPath: cta-fst-gcd.conf
    - name: cta-artefacts-repo
      mountPath: /etc/yum.repos.d/cta-artefacts.repo
      subPath: cta-artefacts.repo
    - name: fst-cfgmap-xrd-cf-fst
      mountPath: /etc/xrd.cf.fst
      subPath: xrd.cf.fst
    - name: eos-sss-keytab-fixedownership
      mountPath: /etc/eos.keytab
      subPath: eos.keytab
    - name: fst-storage
      # Note that if the storageMountPath in the configuration is updated, this value should change accordingly
      mountPath: /fst_storage
    spec:
      restartPolicy: Always

  extraVolumes:
    volumeMounts:
    - name: varlog-tmp
      mountPath: /var/log/tmp
    - name: grid-security
      mountPath: /etc/grid-security
      readOnly: true

    volumes:
    - name: varlog-tmp
      emptyDir: {}
    - name: grid-security
      emptyDir: {}
    - name: cta-fst-gcd
      configMap:
        name: cfgmap-cta-fst-gcd
        defaultMode: 0755
    - name: cta-artefacts-repo
      configMap:
        name: cta-artefacts-repo
        defaultMode: 0755

qdb:
  replicaCount: 1

  pod:
    extraSpec:
      terminationGracePeriodSeconds: 1

  extraEnv:
  - name: LD_PRELOAD
    value: "/usr/lib64/libjemalloc.so.2"
  - name: TZ
    value: "CET"

  probes:
    liveness: false
