{{- $namespace := .Release.Namespace }}
{{- $name := "oracle-unit-tests" }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ $name }}-job
  labels:
    app.kubernetes.io/name: {{ $name }}
    helm.sh/hook: test
spec:
  backoffLimit: 0
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: {{ $name }}
        image: {{ include "oracleUnitTest.image" . }}
        imagePullPolicy: {{ include "oracleUnitTest.imagePullPolicy" . }}
        stdin: true
        env:
        - name: MY_NAME
          value: {{ $name | quote}}
        - name: MY_NAMESPACE
          value: {{ $namespace | quote}}
        - name: INSTANCE_NAME
          value: {{ $namespace | quote}}
        - name: TERM
          value: "xterm"
        command: ['/opt/run/bin/oracleunittests.sh']
        args: ["none"]
        volumeMounts:
        - name: cta-conf-volume
          mountPath: /etc/cta/cta-catalogue.conf
          subPath: cta-catalogue.conf
        - mountPath: /mnt/logs
          name: logstorage
        - mountPath: /shared
          name: shared
        securityContext:
          privileged: true
      volumes:
      - name: cta-conf-volume
        configMap:
          name: cta-catalogue-conf
      - name: shared
        hostPath:
          path: /opt/cta
      - name: logstorage
        persistentVolumeClaim:
          claimName: claimlogs
      imagePullSecrets:
      {{- include "oracleUnitTest.imagePullSecrets" . | nindent 8 }}