{{ $namespace := .Release.Namespace }}
{{ $name := "oracle-unit-tests" }}

apiVersion: batch/v1
# Note that this pod only relies on the configmaps/volumes generated by the init chart; not the actual pods there.
# This is only valid when configured for an Oracle catalogue, which uses a centrally managed DB (i.e. not spawned locally)
kind: Job
metadata:
  name: {{ $name }}-job
  labels:
    app.kubernetes.io/name: {{ $name }}
    helm.sh/hook: test
spec:
  backoffLimit: 0
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: {{ $name }}
        image: {{ include "oracle-unit-tests.image" . }}
        imagePullPolicy: {{ include "oracle-unit-tests.imagePullPolicy" . }}
        stdin: true
        env:
        - name: MY_NAME
          value: {{ $name | quote}}
        - name: MY_NAMESPACE
          value: {{ $namespace | quote}}
        - name: INSTANCE_NAME
          value: {{ $namespace | quote}}
        - name: TERM
          value: "xterm"
        command: ['/opt/run/bin/oracleunittests.sh']
        args: ["none"]
        volumeMounts:
        - name: cta-conf-volume
          mountPath: /etc/cta/cta-catalogue.conf
          subPath: cta-catalogue.conf
        - mountPath: /mnt/logs
          name: logstorage
        - mountPath: /shared
          name: shared
        securityContext:
          privileged: true

      volumes:
      - name: cta-conf-volume
        configMap:
          name: etc-cta-init
      - name: shared
        hostPath:
          path: /opt/cta
      - name: logstorage
        persistentVolumeClaim:
          claimName: claimlogs
      imagePullSecrets:
      {{- include "oracle-unit-tests.imagePullSecrets" . | nindent 8 }}