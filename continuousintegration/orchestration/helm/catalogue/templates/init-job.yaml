{{$namespace := .Release.Namespace }}
{{$name := "init-catalogue" }}
# This allows the user to set the configuration using either --set-file or using --values
{{- $config := .Values.configuration }}
{{- if eq (typeOf $config) "string" -}}
  {{- $config = $config | fromYaml }}
{{- end }}

apiVersion: batch/v1
kind: Job
metadata:
  name: {{ $name }}-job
  namespace: {{ $namespace | quote}}
  annotations:
    "helm.sh/hook": post-install   # Note that we need to be sure the postgres pod has been started before we do anything with it
    "helm.sh/hook-delete-policy": keep
spec:
  backoffLimit: 0
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: {{ $name }}
          image: {{ include "initImage.url" . }}
          imagePullPolicy: {{ .Values.initImage.pullPolicy }}
          command: ['/opt/run/bin/setup_catalogue.sh']
          args: []
          securityContext:
            privileged: {{ .Values.isPriviliged }}
          stdin: true
          env:
            - name: MY_NAME
              value: {{ $name }}
            - name: MY_NAMESPACE
              value: {{ $namespace | quote}}
            - name: INSTANCE_NAME
              value: {{ $namespace | quote}}
            - name: WIPE_CATALOGUE
              value: "{{ .Values.wipeCatalogue }}"
            - name: SCHEMA_VERSION
              value: {{ .Values.schemaVersion | quote}}
            - name: CATALOGUE_BACKEND
              value: {{ $config.backend | quote}}
            - name: CATALOGUE_URL
              value: {{ include "catalogue.url" . | quote}}
            {{- if .Values.env }}
            {{ .Values.env | toYaml | nindent 12 }}
            {{- end }}
          volumeMounts:
            - name: catalogue-config
              mountPath: /etc/cta/cta-catalogue.conf
              subPath: cta-catalogue.conf
            - mountPath: /mnt/logs
              name: logstorage
            - mountPath: /shared
              name: shared
      volumes:
        - name: catalogue-config
          configMap:
            name: catalogue-configmap
        - name: shared
          hostPath:
            path: /opt/cta
        - name: logstorage
          persistentVolumeClaim:
            claimName: claimlogs
      imagePullSecrets:
      {{- range .Values.initImage.pullSecrets }}
      - name: {{ . | quote }}
      {{- end }}
