# This allows the user to set the configuration using either --set-file or using --values
{{- $config := .Values.configuration }}
{{- if eq (typeOf $config) "string" -}}
  {{- $config = $config | fromYaml }}
{{- end }}
{{- if eq $config.backend "postgres" -}}
{{$namespace := .Release.Namespace }}
{{$name := "postgres" }}
apiVersion: v1
kind: Pod
metadata:
  name: {{ $name }}
  namespace: {{ $namespace | quote}}
  labels:
    app.kubernetes.io/name: postgres
spec:
  restartPolicy: Never
  containers:
  - name: {{ $name }}
    image: docker.io/postgres:14.10
    stdin: true
    env:
    - name: MY_NAME
      value: {{ $name }}
    - name: MY_NAMESPACE
      value: {{ $namespace | quote}}
    - name: INSTANCE_NAME
      value: {{ $namespace | quote}}
    - name: SCHEMA_VERSION
      value: {{ $.Values.schemaVersion | quote}}
    - name: PGDATA
      value: /var/lib/postgresql/data/pgdata
    - name: POSTGRES_USER
      value: {{ $config.postgresConfig.username }}
    - name: POSTGRES_PASSWORD
      value: {{ $config.postgresConfig.password }}
    - name: POSTGRES_DB
      value: {{ $config.postgresConfig.database }}
    {{- if (.env) }}
        {{- .env | toYaml | nindent 4}}
    {{- end}}
    command: {{.command}}
    args: {{.args}}
{{- end }}
