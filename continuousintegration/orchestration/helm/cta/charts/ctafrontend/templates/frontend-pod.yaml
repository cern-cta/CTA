{{$namespace := .Release.Namespace }}
{{$name := include "ctafrontend.name" . }}
{{- $schedulerConfig := .Values.global.configuration.scheduler }}
{{- if eq (typeOf $schedulerConfig) "string" -}}
  {{- $schedulerConfig = $schedulerConfig | fromYaml }}
{{- end }}

apiVersion: v1
kind: Pod
metadata:
  name: {{ $name }}
  namespace: {{ $namespace | quote}}
  annotations:
    catalogue-schema-version: "{{ .Values.global.catalogueSchemaVersion }}"
  labels:
    app.kubernetes.io/name: {{ include "ctafrontend.name" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/version: {{ .Chart.AppVersion | quote }}
    app.kubernetes.io/component: frontend
    app.kubernetes.io/part-of: {{ .Values.partOf | default "cta" }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version }}
spec:
  restartPolicy: Never
  containers:
  - name: {{ $name }}
    image: {{ include "ctafrontend.image" . }}
    imagePullPolicy: {{ include "ctafrontend.imagePullPolicy" . }}
    stdin: true
    env:
    - name: MY_NAME
      value: {{ $name }}
    - name: MY_NAMESPACE
      value: {{ $namespace | quote}}
    - name: INSTANCE_NAME
      value: {{ $namespace | quote}}
    {{- if (.Values.env) }}
        {{- .Values.env | toYaml | nindent 4}}
    {{- end}}
    {{- if (.Values.customEntrypoint)}}
    command: {{.Values.customEntrypoint.command  | toJson}}
    args: {{.Values.customEntrypoint.args}}
    {{- end}}
    {{- if (.Values.readinessProbe)}}
    {{include "ctafrontend.readinessProbe" .Values.readinessProbe | nindent 4}}
    {{- end}}
    securityContext:
      privileged: {{ .Values.isPriviliged }}
    {{- if (.Values.ports)}}
    ports:
        {{- .Values.ports | toYaml | nindent 4}}
    {{- end}}
    volumeMounts:
    - name: catalogue-config
      mountPath: /etc/cta/cta-catalogue.conf
      subPath: cta-catalogue.conf
    - name: scheduler-config
      mountPath: /etc/cta/cta-objectstore-tools.conf
      subPath: cta-objectstore-tools.conf
    - name: xrootd-config
      mountPath: /etc/cta/cta-frontend-xrootd.conf
      subPath: cta-frontend-xrootd.conf
    {{- if eq $schedulerConfig.backend "ceph" }}
    - name: cta-ceph-volume
      mountPath: /etc/ceph/ceph.conf
      subPath: ceph.conf
    - name: cta-ceph-volume
      mountPath: /etc/ceph/ceph.client.{{ $schedulerConfig.cephConfig.id }}.keyring
      subPath: ceph.client.{{ $schedulerConfig.cephConfig.id }}.keyring
    {{- end }}
    {{ include "ctafrontend.volumeMounts" . | nindent 4 }}
  volumes:
  - name: xrootd-config
    configMap:
      name: cta-frontend-xrootd-configmap
  - name: catalogue-config
    configMap:
      name: cta-catalogue-conf
  - name: scheduler-config
    configMap:
      name: scheduler-configmap
  {{- if eq $schedulerConfig.backend "ceph" }}
  - name: cta-ceph-volume
    configMap:
      name: ceph-configmap
  {{- end}}
  {{include "ctafrontend.volumes" . | nindent 2}}

  imagePullSecrets:
  {{ include "ctafrontend.imagePullSecrets" . | nindent 4 }}
