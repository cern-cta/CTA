# If required, the user can specify a custom image here
image:
component: tpsrv
partOf: cta

# TODO: this will be provided eventually instead of hardcoded here
tapeServers:
  - name: tpsrv01
    libraryDevice: "sg0"
    libraryType: "mhvtl"
    libraryName: "?"
    drivesnames:
    - "VDSTK01"
  - name: tpsrv02
    libraryDevice: "sg0"
    libraryType: "mhvtl"
    libraryName: "?"
    drivesnames:
    - "VDSTK02"
    - "VDSTK03"

conf:
  rmcd:
    coreFileLimit: "unlimited"
    options: "/dev/smc"
  taped:
    bufferSizeBytes: 262144
    bufferCount: 200
    mountCriteria: "2000000, 100"
    watchdogIdleSessionTimer: 2 # Make tape servers more responsive, thus improving CI test speed
    useEncryption: "no"
    tapeCacheMaxAgeSecs: 1
    retrieveQueueCacheMaxAgeSecs: 1
    secProtocol: "sss"
    secSssktPath: "/etc/cta"
    ctaTapedSss: "cta-taped.sss.keytab"
  general:
    instanceName: "CI"
    scheduler.backendName: "VFS"

taped:
  command: ["/bin/sh", "-c"]
  # Not moving chown here due to the fact that the user might not yet exists
  args:
  - |
    cat /tmp/dump/cta/cta-tpsrv-tmp.sss.keytab > /etc/cta/cta-taped.sss.keytab;
    chmod 600 /etc/cta/cta-taped.sss.keytab;
    /opt/run/bin/taped.sh;
  readinessProbe:
    commandsAtRuntime: ["test", "-f", "/TAPED_READY"]
    delay: 2
    periodSeconds: 1
    failureTolerance: 60
  env:
  - name: MY_CONTAINER
    value: "taped"
  - name: eoshost
    value: "mgm"
  - name: TERM
    value: "xterm"
  volumeMounts:
  - mountPath: /tmp/dump/cta/cta-tpsrv-tmp.sss.keytab
    name: tape-sss
    subPath: cta-tpsrv-tmp.sss.keytab
  volumes:
  - name: tape-sss
    secret:
      secretName: tpsrv-sss-keytab
