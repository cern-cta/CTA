
{{$namespace := .Release.Namespace }}
{{$imageVersion := include "tpsrv.image" . }}
{{$imagePullPolicy := include "tpsrv.imagePullPolicy" . }}
{{$imagePullSecrets := include "tpsrv.imagePullSecrets" . }}
{{- $schedulerConfig := .Values.global.configuration.scheduler }}
{{- if eq (typeOf $schedulerConfig) "string" -}}
  {{- $schedulerConfig = $schedulerConfig | fromYaml }}
{{- end }}
{{- $tapeConfig := .Values.tapeConfig }}
{{- if eq (typeOf $tapeConfig) "string" -}}
  {{- $tapeConfig = $tapeConfig | fromYaml }}
{{- end }}

# Spawn numTapeServers pods
{{- range $i := until (int .Values.tpsrv.numTapeServers) }}
{{- $podName := printf "tpsrv%02d" (add $i 1) }} # server names start from 1
{{- $driveName := index $tapeConfig.library.drivenames $i }}

apiVersion: v1
kind: Pod
metadata:
  name: {{$podName | quote}}
  namespace: {{ $namespace | quote}}
  annotations:
    catalogue-schema-version: "{{ $.Values.global.catalogueSchemaVersion }}"
  labels:
    app.kubernetes.io/name: {{ include "tpsrv.name" $ }}
    app.kubernetes.io/instance: {{ $.Release.Name }}
    app.kubernetes.io/version: {{ $.Chart.AppVersion | quote }}
    app.kubernetes.io/component: tape
    app.kubernetes.io/part-of: {{ $.Values.partOf | default "cta" }}
    app.kubernetes.io/managed-by: {{ $.Release.Service }}
    helm.sh/chart: {{ $.Chart.Name }}-{{ $.Chart.Version }}
    cta/library-device: {{ $tapeConfig.library.device }}
spec:
  restartPolicy: Always
  containers:
  {{- range $.Values.tpsrv.containers }}
  - name: {{ .name | default $podName | quote }}
    image: {{ $imageVersion }}
    imagePullPolicy: {{ $imagePullPolicy }}
    {{- if (.commandsAtRuntime)}}
    readinessProbe:
      exec:
        command: {{.commandsAtRuntime | toJson}}
      initialDelaySeconds: {{.delay}}
      periodSeconds: 10
      failureThreshold: {{.failureTolerance}}
    {{- end}}
    stdin: true
    env:
    - name: MY_NAME
      value: {{ $podName | quote}}
    - name: MY_NAMESPACE
      value: {{ $namespace | quote}}
    - name: INSTANCE_NAME
      value: {{ $namespace | quote}}
    - name: LIBRARYTYPE
      value: {{ $tapeConfig.library.type | quote }}
    - name: LIBRARYNAME
      value: {{ $tapeConfig.library.name | quote }}
    - name: LIBRARYDEVICE
      value: {{ $tapeConfig.library.device | quote }}
    - name: DRIVENAME
      value: {{ $driveName }}
    - name: DRIVENAMES
      value: {{ $tapeConfig.library.drivenames | join "," | quote }}
    - name: DRIVEDEVICES
      value: {{ $tapeConfig.library.drivedevices | join "," | quote }}
    {{- if $tapeConfig.library.driveserials }}
    - name: DRIVESERIALS
      value: {{ $tapeConfig.library.driveserials | join "," | quote }}
    {{- end }}
    - name: TAPES
      value: {{ $tapeConfig.library.tapes | join "," | quote }}
    {{- if (.env) }}
        {{- .env | toYaml | nindent 4}}
    {{- end}}
    command: {{.command | toJson}}
    {{- if (.args)}}
    args: {{.args}}
    {{- end}}
    securityContext:
      privileged: {{.isPriviliged}}
    {{- if (.ports)}}
    ports:
        {{- .ports | toYaml | nindent 4}}
    {{- end}}
    {{- if (.volumeMounts)}}
    volumeMounts:
    - name: cta-taped-config
      mountPath: /etc/cta/cta-taped-{{ $driveName }}.conf
      subPath: cta-taped-{{ $driveName }}.conf
    - name: catalogue-config
      mountPath: /etc/cta/cta-catalogue.conf
      subPath: cta-catalogue.conf
    - name: scheduler-config
      mountPath: /etc/cta/cta-objectstore-tools.conf
      subPath: cta-objectstore-tools.conf
    {{- if ($.Values.global.useSystemd) }}
    - name: sysconfig-tpsrv-config
      mountPath: /etc/sysconfig/cta-rmcd
      subPath: cta-rmcd
    {{- end }}
    - name: sysconfig-tpsrv-config
      mountPath: /etc/sysconfig/cta-taped
      subPath: cta-taped
    {{- if eq $schedulerConfig.backend "ceph" }}
    - name: cta-ceph-volume
      mountPath: /etc/ceph/ceph.conf
      subPath: ceph.conf
    - name: cta-ceph-volume
      mountPath: /etc/ceph/ceph.client.{{ $schedulerConfig.cephConfig.id }}.keyring
      subPath: ceph.client.{{ $schedulerConfig.cephConfig.id }}.keyring
    {{- end }}
    {{- .volumeMounts | toYaml | nindent 4}}
    {{- if ($.Values.global.volumes) }}
      {{- $.Values.global.volumeMounts | toYaml | nindent 4}}
    {{- end}}
    {{- end}}
  {{- end}} # End of container loop
  volumes:
  - name: catalogue-config
    configMap:
      name: catalogue-configmap
  - name: scheduler-config
    configMap:
      name: scheduler-configmap
  - name: cta-taped-config
    configMap:
      name: cta-taped-tpsrv-{{ $i }}-configmap
  - name: sysconfig-tpsrv-config
    configMap:
      name: sysconfig-tpsrv-{{ $i }}-configmap
  {{- if eq $schedulerConfig.backend "ceph" }}
  - name: cta-ceph-volume
    configMap:
      name: ceph-configmap
  {{- end}}
  {{- $.Values.tpsrv.volumes | toYaml | nindent 2}}
  {{- if ($.Values.global.volumes) }}
    {{- $.Values.global.volumes | toYaml | nindent 2}}
  {{- end}}
  imagePullSecrets:
  {{ $imagePullSecrets | nindent 4 }}
---
{{- end}} # End of tape server count range loop
