
{{- $schedulerConfig := include "scheduler.config" . | fromYaml -}}
{{- $tapeConfig := include "tpsrv.tapeConfig" . | fromYaml -}}
{{- $numTapeServers := int .Values.tpsrv.numTapeServers }}
{{- $drivenamesCount := len $tapeConfig.library.drivenames }}
{{- if gt $numTapeServers $drivenamesCount }}
  {{- fail (printf "Error: numTapeServers (%d) is larger than the number of available drives (%d)" $numTapeServers $drivenamesCount) }}
{{- end }}
{{- range $i := until ($numTapeServers) }}
{{- $driveSlot := int $i }}
{{- $driveName := index $tapeConfig.library.drivenames $i }}
# Generate unique config map for each tape server pod
apiVersion: v1
kind: ConfigMap
metadata:
  # The name cannot use the drivename as this contains uppercase letters
  name: cta-taped-tpsrv-{{ $i }}-configmap
  labels:
    {{-  include "common.labels.standard" $ | nindent 4 }}
data:
  cta-taped-{{ $driveName }}.conf: |-
    # cta-taped setup
    taped BufferSizeBytes {{ $.Values.conf.taped.bufferSizeBytes }}
    taped BufferCount {{ $.Values.conf.taped.bufferCount }}
    taped MountCriteria {{ $.Values.conf.taped.mountCriteria }}
    taped WatchdogIdleSessionTimer {{ $.Values.conf.taped.watchdogIdleSessionTimer }}
    taped UseEncryption {{ $.Values.conf.taped.useEncryption }}
    taped DriveName {{ $driveName }}
    taped DriveLogicalLibrary {{ $driveName }}
    taped DriveDevice /dev/{{ index $tapeConfig.library.drivedevices $driveSlot }}
    taped DriveControlPath smc{{ $driveSlot }}
    # Decrease schedulerDB cache timeout for tests
    taped TapeCacheMaxAgeSecs {{ $.Values.conf.taped.tapeCacheMaxAgeSecs }}
    taped RetrieveQueueCacheMaxAgeSecs {{ $.Values.conf.taped.retrieveQueueCacheMaxAgeSecs }}
    # Objectstore
    ObjectStore BackendPath {{ include "global.schedulerUrl" $ }}
    # General
    general InstanceName {{ $.Values.conf.general.instanceName }}
    general SchedulerBackendName {{ $schedulerConfig.backendName }}
---
{{- end }}
