
{{$namespace := .Release.Namespace }}
{{$imageVersion := include "tpsrv.image" . }}
{{$imagePullPolicy := include "tpsrv.imagePullPolicy" . }}
{{$imagePullSecrets := include "tpsrv.imagePullSecrets" . }}

# Spawn replicaCount pods
{{- range $i := until (int .Values.tpsrv.replicaCount) }}
{{- $podName := printf "tpsrv%02d" (add $i 1) }} # server names start from 1

apiVersion: v1
kind: Pod
metadata:
  name: {{$podName | quote}}
  namespace: {{ $namespace | quote}}
  labels:
  {{- if ($.Values.tpsrv.labels)}}
    {{$.Values.tpsrv.labels | toYaml  | nindent 4}}
  {{- else}}
    k8s-app: {{$podName | quote}}
  {{- end}}
spec:
  restartPolicy: Never
  containers:
  {{- range $.Values.tpsrv.containers}}
  {{$containerName := .name | default $podName | quote }}
  - name: {{ $containerName }}
    image: {{ $imageVersion }}
    imagePullPolicy: {{ $imagePullPolicy }}
    {{- if (.commandsAtRuntime)}}
    readinessProbe:
      exec:
        command: {{.commandsAtRuntime | toJson}}
      initialDelaySeconds: {{.delay}}
      periodSeconds: 10
      failureThreshold: {{.failureTolerance}}
    {{- end}}
    stdin: true
    env:
    - name: MY_NAME
      value: {{ $podName | quote}}
    - name: MY_NAMESPACE
      value: {{ $namespace | quote}}
    - name: INSTANCE_NAME
      value: {{ $namespace | quote}}
    - name: driveslot
      value: {{ mod $i (index $.Values.tpsrv.numDrivesAvailable) | quote }}
    {{- if (.env) }}
        {{- .env | toYaml | nindent 4}}
    {{- end}}
    command: {{.command | toJson}}
    {{- if (.args)}}
    args: {{.args}}
    {{- end}}
    securityContext:
      privileged: {{.isPriviliged}}
    {{- if (.ports)}}
    ports:
        {{- .ports | toYaml | nindent 4}}
    {{- end}}
    {{- if (.volumeMounts)}}
    volumeMounts:
    {{- .volumeMounts | toYaml | nindent 4}}
    {{- if ($.Values.global.volumes) }}
      {{- $.Values.global.volumeMounts | toYaml | nindent 4}}
    {{- end}}
    {{- end}}
  {{- end}}
  {{- if ($.Values.tpsrv.volumes)}}
  volumes:
    {{- $.Values.tpsrv.volumes | toYaml | nindent 2}}
    {{- if ($.Values.global.volumes) }}
      {{- $.Values.global.volumes | toYaml | nindent 2}}
    {{- end}}
  {{- end}}
  imagePullSecrets:
  {{ $imagePullSecrets | nindent 4 }}
---
{{- end}}