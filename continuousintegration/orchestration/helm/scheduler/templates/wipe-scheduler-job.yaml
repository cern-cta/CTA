{{- if .Values.wipeScheduler -}}
{{- $namespace := .Release.Namespace }}
{{- $name := "wipe-scheduler" }}
{{- $schedulerConfig := include "scheduler.config" . | fromYaml }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ $name }}-job
  namespace: {{ $namespace | quote}}
spec:
  backoffLimit: 0
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: {{ $name }}
          image: {{ include "schedulerWipe.image" . }}
          imagePullPolicy: {{ include "schedulerWipe.imagePullPolicy" . }}
          command: ['/opt/run/bin/wipe_scheduler.sh']
          args: []
          securityContext:
            privileged: {{ .Values.isPriviliged }}
          stdin: true
          env:
            - name: MY_NAME
              value: {{ $name }}
            - name: MY_NAMESPACE
              value: {{ $namespace | quote}}
            - name: INSTANCE_NAME
              value: {{ $namespace | quote}}
            - name: WIPE_SCHEDULER
              value: "{{ .Values.wipeScheduler }}"
            - name: SCHEDULER_BACKEND
              value: {{ $schedulerConfig.backend | quote}}
            - name: SCHEDULER_URL
              value: {{ include "scheduler.url" . | quote}}
            {{- if eq $schedulerConfig.backend "ceph" }}
            - name: SCHEDULER_CEPH_NAMESPACE
              value: {{ $schedulerConfig.cephConfig.namespace | quote}}
            - name: SCHEDULER_CEPH_ID
              value: {{ $schedulerConfig.cephConfig.id | quote}}
            - name: SCHEDULER_CEPH_POOL
              value: {{ $schedulerConfig.cephConfig.pool | quote}}
            {{- end }}
            {{- if .Values.env }}
            {{ .Values.env | toYaml | nindent 12 }}
            {{- end }}
          volumeMounts:
            - name: scheduler-config
              mountPath: /etc/cta/cta-objectstore-tools.conf
              subPath: cta-objectstore-tools.conf
            - mountPath: /mnt/logs
              name: logstorage
            - mountPath: /shared
              name: shared
            {{- if eq $schedulerConfig.backend "ceph" }}
            - name: ceph-config
              mountPath: /etc/ceph/ceph.conf
              subPath: ceph.conf
            - name: ceph-config
              mountPath: /etc/ceph/ceph.client.{{ $schedulerConfig.cephConfig.id }}.keyring
              subPath: ceph.client.{{ $schedulerConfig.cephConfig.id }}.keyring
            {{- end }}
      volumes:
        - name: scheduler-config
          configMap:
            name: scheduler-configmap
        - name: shared
          hostPath:
            path: /opt/cta
        - name: logstorage
          persistentVolumeClaim:
            claimName: claimlogs
        {{- if eq $schedulerConfig.backend "ceph" }}
        - name: ceph-config
          configMap:
            name: ceph-configmap
        {{- end}}
      imagePullSecrets:
      {{- include "schedulerWipe.imagePullSecrets" . | nindent 6 }}
{{- end }}
