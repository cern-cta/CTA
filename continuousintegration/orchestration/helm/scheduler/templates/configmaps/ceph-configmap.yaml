# This allows the user to set the configuration using either --set-file or using --values
{{- $config := .Values.configuration }}
{{- if eq (typeOf $config) "string" -}}
  {{- $config = $config | fromYaml }}
{{- end }}
{{- if eq $config.backend "ceph" }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: ceph-configmap
  labels:
    app.kubernetes.io/name: scheduler
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/version: {{ .Chart.AppVersion | quote }}
    app.kubernetes.io/component: scheduler
    app.kubernetes.io/part-of: {{ .Values.partOf | default "cta" }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version }}
data:
  ceph.conf: |
    [global]
      mon host = {{ $config.cephConfig.mon }}:{{ $config.cephConfig.monport }}
    
  ceph.client.{{ $config.cephConfig.id }}.keyring: |
    [client.{{ $config.cephConfig.id }}]
      key = {{ $config.cephConfig.key }}
      caps mon = "allow r"
      caps osd = "allow rwx pool={{ $config.cephConfig.pool }} namespace={{ $config.cephConfig.namespace }}"

{{- end }}
