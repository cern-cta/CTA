{{- if .Values.runOracleUnitTests }}
{{- if not (eq .Values.global.catalogue.backend "oracle") }}
  {{- fail "ERROR: configuration has enabled runOracleUnitTests, but the catalogue backend is not Oracle" }}
{{- end }}

{{ $name := "oracle-unit-tests" }}
{{ $namespace := .Release.Namespace }}

apiVersion: batch/v1
# Note that this pod should be a post-install hook if it weren't for the fact that this is not relying on the pods spawned by the init
# This is only valid when configured for an Oracle catalogue, which uses a centrally managed DB (i.e. not spawned locally)
kind: Job
metadata:
  name: {{ $name }}
  labels:
    app.kubernetes.io/name: {{ $name }}
    helm.sh/hook: test
spec:
  ttlSecondsAfterFinished: 120
  backoffLimit: 0
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: {{ $name }}
        image: "{{ .Values.global.image.registry }}/{{ .Values.global.image.repository }}:{{ .Values.global.image.tag }}"
        imagePullPolicy: {{ .Values.global.image.pullPolicy }}
        stdin: true
        env:
        - name: MY_NAME
          value: {{ $name | quote}}
        - name: MY_NAMESPACE
          value: {{ $namespace | quote}}
        - name: INSTANCE_NAME
          value: {{ $namespace | quote}}
        - name: TERM
          value: "xterm"
        command: ['/opt/run/bin/oracleunittests.sh']
        args: ["none"]
        volumeMounts:
        - name: cta-conf-volume
          mountPath: /etc/cta/cta-catalogue.conf
          subPath: cta-catalogue.conf
        - mountPath: /mnt/logs
          name: logstorage
        - mountPath: /shared
          name: shared
        securityContext:
          privileged: true

      volumes:
      - name: cta-conf-volume
        configMap:
          name: etc-cta-init
      - name: shared
        hostPath:
          path: /opt/cta
      - name: logstorage
        persistentVolumeClaim:
          claimName: claimlogs
      imagePullSecrets:
      {{- include "init.imagePullSecrets" . | nindent 8 }}
{{- end }}