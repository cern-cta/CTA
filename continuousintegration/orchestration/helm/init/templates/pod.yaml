{{- if false }}
{{$namespace := .Release.Namespace }}
{{$name := include "init.name" . }}

apiVersion: v1
kind: Pod
metadata:
  name: {{$name}}
  namespace: {{ $namespace | quote}}
  labels:
    k8s-app: {{$name}}
spec:
  restartPolicy: Never
  containers:
  - name: {{$name}}
    image: {{ include "init.image" . }}
    imagePullPolicy: {{ include "init.imagePullPolicy" . }}
    stdin: true
    env:
    - name: MY_NAME
      value: {{$name}}
    - name: MY_NAMESPACE
      value: {{ $namespace | quote}}
    - name: INSTANCE_NAME
      value: {{ $namespace | quote}}
    - name: SCHEMA_VERSION
      value: {{ .Values.catalogue.schemaVersion | quote}}
    - name: CATALOGUE_BACKEND
      value: {{ .Values.global.catalogue.backend | quote}}
    - name: CATALOGUE_URL
      value: {{ include "init.catalogue.url" . | quote}}
    - name: SCHEDULER_BACKEND
      value: {{ .Values.global.scheduler.backend | quote}}
    - name: SCHEDULER_URL
      value: {{ include "init.scheduler.url" . | quote}}
    {{- if eq .Values.global.scheduler.backend "ceph" }}
    - name: SCHEDULER_CEPH_NAMESPACE
      value: {{ .Values.global.scheduler.config.ceph.namespace | quote}}
    - name: SCHEDULER_CEPH_ID
      value: {{ .Values.global.scheduler.config.ceph.id | quote}}
    - name: SCHEDULER_CEPH_POOL
      value: {{ .Values.global.scheduler.config.ceph.pool | quote}}
    {{- end}}
    {{- if (.Values.env) }}
        {{- .Values.env | toYaml | nindent 4}}
    {{- end}}
    {{- if (.Values.customEntrypoint)}}
    # TODO: add readiness probe to ensure pod is only ready after this script is done
    command: {{.Values.customEntrypoint.command}}
    args: {{.Values.customEntrypoint.args}}
    {{- end}}
    readinessProbe:
      exec:
        command: ["cat", "/tmp/INIT_COMPLETE"]
      initialDelaySeconds: 5
      periodSeconds: 2
    securityContext:
      privileged: {{ .Values.isPriviliged }}
    volumeMounts:
    - name: cta-conf-volume
      mountPath: /etc/cta/cta-catalogue.conf
      subPath: cta-catalogue.conf
    - name: cta-conf-volume
      mountPath: /etc/cta/cta-objectstore-tools.conf
      subPath: cta-objectstore-tools.conf
    {{- include "init.volumeMounts" . | nindent 4 }}
  volumes:
  - name: cta-conf-volume
    configMap:
      name: etc-cta
  {{- include "init.volumes" . | nindent 2}}

  imagePullSecrets:
  {{- include "init.imagePullSecrets" . | nindent 4 }}
{{ end }}