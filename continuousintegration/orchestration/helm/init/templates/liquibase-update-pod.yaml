{{- if .Values.updateDBTests.enabled }}
{{ $name := "liquibase-update" }}
{{ $namespace := .Release.Namespace }}

apiVersion: v1
kind: Pod
metadata:
  name: {{ $name }}
  labels:
    app.kubernetes.io/name: {{ $name }}
spec:
  restartPolicy: Never
  containers:
  - name: {{ $name }}
    image: "{{ .Values.updateDBTests.image.registry }}/{{ .Values.updateDBTests.image.repository }}{{ .Values.updateDBTests.image.tag }}" # TODO: this image name only works with sha for now
    imagePullPolicy: {{ .Values.updateDBTests.image.pullPolicy }}
    stdin: true
    env:
    - name: MY_NAME
      value: {{ $name | quote }}
    - name: MY_NAMESPACE
      value: {{ $namespace | quote }}
    - name: INSTANCE_NAME
      value: {{ $namespace | quote }}
    - name: TERM
      value: "xterm"
    # This sets up the script used in the liquibase update test
    command: ["/bin/bash", "-c"]
    args:
      - |
        echo "#!/bin/bash" > /launch_liquibase.sh && \
        echo "COMMAND=\$1" >> /launch_liquibase.sh && \
        echo "/entrypoint.sh -d -f '{{ .Values.updateDBTests.catalogueSourceVersion }}' -t '{{ .Values.updateDBTests.catalogueDestinationVersion }}' -i '{{ .Values.updateDBTests.commitId }}' -c \"\$COMMAND\"" >> /launch_liquibase.sh && \
        chmod +x /launch_liquibase.sh
        sleep infinity
    volumeMounts:
    - name: yum-repos
      mountPath: /shared/etc_yum.repos.d
    - name: cta-conf-volume
      mountPath: /shared/etc_cta/cta-catalogue.conf # TODO: this should eventually just go into /etc/cta
      subPath: cta-catalogue.conf
    - name: logstorage
      mountPath: /mnt/logs
    securityContext:
      privileged: true

    readinessProbe:
      exec:
        command:
          - /bin/sh
          - "-c"
          - "test -f /launch_liquibase.sh"
      initialDelaySeconds: 5
      periodSeconds: 5
      timeoutSeconds: 2
      failureThreshold: 3
      successThreshold: 1

  volumes:
  - name: yum-repos
    configMap:
      name: yum.repos.d-config
  - name: cta-conf-volume
    configMap:
      name: etc-cta-init
  - name: logstorage
    persistentVolumeClaim:
      claimName: claimlogs

  imagePullSecrets:
  {{- range .Values.updateDBTests.image.pullSecrets }}
  - name: {{ . }}
  {{- end }}
{{- end }}
