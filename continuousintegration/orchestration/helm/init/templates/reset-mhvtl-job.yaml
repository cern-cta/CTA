{{- if .Values.resetMhvtl -}}
{{- $namespace := .Release.Namespace }}
{{- $name := "reset-mhvtl" }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ $name }}-job
  namespace: {{ $namespace | quote}}
spec:
  backoffLimit: 0
  template:
    spec:
      restartPolicy: Never
      imagePullSecrets:
      {{- include "init.imagePullSecrets" . | nindent 6 }}
      containers:
        - name: {{ $name }}
          image: {{ include "init.image" . }}
          imagePullPolicy: {{ include "init.imagePullPolicy" . }}
          command:
          - "/opt/run/bin/reset_mhvtl.sh"
          args:
          - "{{ include "init.libraryDevices" . }}"
          securityContext:
            privileged: true # Because of MHVTL
          stdin: true
          env:
            - name: MY_NAME
              value: {{ $name }}
            - name: MY_NAMESPACE
              value: {{ $namespace | quote}}
            - name: INSTANCE_NAME
              value: {{ $namespace | quote}}
          volumeMounts:
            - mountPath: /mnt/logs
              name: logstorage
            - mountPath: /shared
              name: shared
      volumes:
        - name: shared
          hostPath:
            path: /opt/cta
        - name: logstorage
          persistentVolumeClaim:
            claimName: claimlogs
{{- end }}
