#!/bin/sh
#
# Test archive, retrieval and deletion of a file

. ./test.conf

##
## Archive
##

FILENAME=file.$$

# Copy small file into EOS
echoc $LT_GREEN "Copying file into EOS..."
eos cp /etc/motd ${EOS_TEST_DIR}/${FILENAME}

echoc $LT_BLUE "\nDisk file info:"
eos fileinfo ${EOS_TEST_DIR}/${FILENAME}
getEOSDiskFileInfo ${EOS_TEST_DIR} ${FILENAME}
echoc $LT_BLUE "EOS Disk ID: $EOS_DISK_ID\nDisk copies: $DISK_COPIES\nTape copies: $TAPE_COPIES\n"

echo_start "\nWaiting for SYNC::CREATE event."
getEOSWFE SYNC::CREATE ${EOS_TEST_DIR}/${FILENAME}
echo_end "done"
echo -e "$LOGLINE\n"

echo_start "Checking CTA Frontend log for CTA Archive ID."
getArchiveID $EOS_DISK_ID
echo_end "done"
echo $LOGLINE
echo_start ARCHIVE_FILE_ID=$ARCHIVE_FILE_ID
echo_end '\n'

echo_start "Waiting for CLOSEW event."
getEOSWFE CLOSEW ${EOS_TEST_DIR}/${FILENAME}
echo_end "done"
echo -e "$LOGLINE\n"

echo_start "Waiting for file to be archived to tape."
getTapeLog $ARCHIVE_FILE_ID 'Reported to the client a full file archival'
echo_end "done"
echo -e "$LOGLINE\n"

echoc $LT_BLUE "List archived file on tape:"
getArchiveFileList ${EOS_DISK_ID}
echo -e "${FILE_LIST}"

echo_start "\nWaiting for ARCHIVED event."
getEOSWFE ARCHIVED ${EOS_TEST_DIR}/${FILENAME}
echo_end "done"
echo -e "$LOGLINE\n"

getEOSDiskFileInfo ${EOS_TEST_DIR} ${FILENAME}
echoc $LT_BLUE "Disk copies: $DISK_COPIES\nTape copies: $TAPE_COPIES\n"

##
## Retrieval
##

echoc $LT_GREEN "Retrieving file from CTA..."
XrdSecPROTOCOL=sss XrdSecSSSKT=/etc/cta/eos.sss.keytab |\
sudo xrdfs root://localhost/ prepare -s "${EOS_TEST_DIR}/${FILENAME}?eos.ruid=${EOS_RUID}"

echo_start "Waiting for SYNC::PREPARE event."
getEOSWFE SYNC::PREPARE ${EOS_TEST_DIR}/${FILENAME}
echo_end "done"
echo -e "$LOGLINE\n"

echo_start "Checking CTA Frontend log for PREPARE event."
getFrontendLog "[Rr]etrieve" $ARCHIVE_FILE_ID
echo_end "done"
echo -e "$LOGLINE\n"

echo_start "Waiting for file to be retrieved from tape."
getTapeLog $ARCHIVE_FILE_ID 'Reported to the client a full file archival' 'File successfully transfered to disk'
echo_end "done"
echo -e "$LOGLINE\n"

getEOSDiskFileInfo ${EOS_TEST_DIR} ${FILENAME}
echoc $LT_BLUE "Disk copies: $DISK_COPIES\nTape copies: $TAPE_COPIES\n"

echoc $LT_GREEN "Copying file out of EOS..."
eos cp ${EOS_TEST_DIR}/${FILENAME} /tmp/${FILENAME}
ls -l /tmp/${FILENAME}
diff /tmp/${FILENAME} /etc/motd
if [ $? -eq 0 ]
then
  echoc $LT_GREEN "Files match, OK.\n"
else
  error "Files differ."
fi
rm -f /tmp/${FILENAME}

##
## Delete
##

echoc $LT_GREEN "Deleting file from EOS..."
eos rm ${EOS_TEST_DIR}/${FILENAME}

echo_start "Waiting for SYNC::DELETE event."
getEOSWFE SYNC::DELETE ${EOS_TEST_DIR}/${FILENAME}
echo_end "done"
echo -e "$LOGLINE\n"

echo_start "Checking CTA Frontend log for DELETE event."
getFrontendLog "delete" $ARCHIVE_FILE_ID
echo_end "done"
echo -e "$LOGLINE\n"

getEOSDiskFileInfo ${EOS_TEST_DIR} ${FILENAME}
echo -e "${ERRINFO}"
getArchiveFileList ${EOS_DISK_ID}
echo -e "${FILE_LIST}"
